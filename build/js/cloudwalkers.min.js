var Cloudwalkers={version:1,Views:{Settings:{},Widgets:{Charts:{}}},Router:{},Models:{},Collections:{},Utilities:{},init:function(){var a=window.localStorage.getItem("token");a&&9<a.length?Cloudwalkers.Session.authenticationtoken=a:(console.log("token error",a),window.location="/login.html");Cloudwalkers.Session.api=config.apiurl+Cloudwalkers.version;Cloudwalkers.Session.loadEssentialData(function(){Cloudwalkers.RootView=new Cloudwalkers.Views.Root;Cloudwalkers.Session.UrlShortener=new Cloudwalkers.UrlShortener;
Cloudwalkers.Router.Instance=new Cloudwalkers.Router;Backbone.history.start()})}};function AuthorizationError(a){this.name="Not Authorized";this.message=a||"Not authorized for the current user (no matching authorization token)";this.stack=Error().stack}AuthorizationError.prototype=Error();AuthorizationError.prototype.constructor=AuthorizationError;
Backbone.ajax=function(){Cloudwalkers.Session.authenticationtoken&&(arguments[0].headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"});return Backbone.$.ajax.apply(Backbone.$,arguments)};
Backbone.Model=Backbone.Model.extend({url:function(a){return this.endpoint?Cloudwalkers.Session.api+"/"+this.typestring+"/"+this.id+this.endpoint:Cloudwalkers.Session.api+"/"+this.typestring+"/"+this.id},parse:function(a){"number"==typeof a?a={id:a}:this.stamp(a);return a},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};this.endpoint=c.endpoint?"/"+c.endpoint:!1;return"update"==a?!1:Backbone.sync(a,b,c)},stamp:function(a){a||
(a={id:this.id});a.stamp=Math.round(0.001*(new Date).getTime());Store.set(this.typestring,a);return this},loaded:function(a){return void 0!==this.get(a?a:"objectType")}});
Backbone.Collection=Backbone.Collection.extend({distantAdd:function(a){this.get(a.id)||this.add(a)},url:function(a){this.parentmodel&&!this.parenttype&&(this.parenttype=this.parentmodel.get("objectType"));a=this.parentmodel?Cloudwalkers.Session.api+"/"+this.parenttype+"/"+this.parentmodel.id:Cloudwalkers.Session.api+"/"+this.typestring;this.endpoint&&(a+="/"+this.endpoint);return this.parameters?a+"?"+$.param(this.parameters):a},parse:function(a){this.parentmodel&&!this.parenttype&&(this.parenttype=
this.parentmodel.get("objectType"));this.parentmodel&&(a=a[this.parenttype]);a&&this.setcursor(a.paging);a.paging||this.ready();return a[this.typestring]},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};return Backbone.sync(a,b,c)},setcursor:function(a){if(!a)return!1;this.cursor=a.cursors?a.cursors.after:!1},updates:function(a){for(n in a){var b=this.get(a[n]);b&&b.get("objectType")&&(Store.set(this.typestring,{id:a[n],outdated:!0}),
b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])},touch:function(a,b){this.parentmodel=a;this.endpoint=this.modelstring+"ids";this.parameters=b;this.fetch({success:this.touchresponse.bind(this,this.url())})},touchlocal:function(a){a&&a.modelids.length?(this.cursor=a.cursor,this.seed(a.modelids),this.ready()):this.fetch({success:this.touchresponse.bind(this,this.url())})},touchresponse:function(a,b,c){b=c[this.parenttype][this.typestring];
Store.set("touches",{id:a,modelids:b,cursor:this.cursor,ping:Cloudwalkers.Session.getPing().cursor});this.seed(b)},seed:function(a){a||(a=[]);var b=[];a=_.compact(a.map(function(a){var e=this.get(a);e||(e=Cloudwalkers.Session.user.account[this.typestring].get(a));e?this.add(e):e=this.create({id:a});b.push(e);return a},this));a.length&&(this.endpoint=this.parentmodel?this.typestring:null,this.parameters={ids:a.join(",")},this.fetch({remove:!1}));this.trigger("seed",b);return b},more:function(a,b){if(!this.cursor)return!1;
b.after=this.cursor;this.touch(a,b);return this},ready:function(){var a=this;setTimeout(function(){a.trigger("ready",a)},1,this)}});Cloudwalkers.Session={langs:[{id:"en_EN",name:"International English"},{id:"fr_FR",name:"Fran\u00e7ais"},{id:"nl_NL",name:"Nederlands"},{id:"pt_PT",name:"Portugu\u00eas"}],user:null,version:"1.0.0.0",localversion:null,isLoaded:function(){return null!=this.user},loadEssentialData:function(a){this.user=new Cloudwalkers.Models.Me;this.getversion();this.user.once("activated",function(){this.setLang()}.bind(this));this.listenTo(this,"translation:done",a);this.user.fetch({error:this.user.offline.bind(this.user)})},
refresh:function(){console.log("Session.refresh triggered")},reset:function(){window.localStorage.clear()},home:function(){Cloudwalkers.Router.Instance.home()},updateSetting:function(a,b,c){Cloudwalkers.Session.user.attributes.settings[a]!=b&&(Cloudwalkers.Session.user.attributes.settings[a]=b,c=$.extend(c,{patch:!0})||{patch:!0},Cloudwalkers.Session.user.save({settings:Cloudwalkers.Session.user.attributes.settings},c))},get:function(a){return this.user.get("settings")[a]},clone:function(a){if(null==
a||"object"!=typeof a)return a;var b=a.constructor(),c;for(c in a)b[c]=this.clone(a[c]);return b},viewsettings:function(a,b){var c="account_"+this.getAccount().id;Cloudwalkers.Session.user.attributes.settings.viewsettings||(Cloudwalkers.Session.user.attributes.settings.viewsettings={});Cloudwalkers.Session.user.attributes.settings.viewsettings[c]||(Cloudwalkers.Session.user.attributes.settings.viewsettings[c]=Cloudwalkers.RootView.navigation.mapViews());var e=this.clone(this.get("viewsettings"));
if(b){if(a&&b)return e[c][a]=$.extend(e[c][a],b),this.updateSetting("viewsettings",e),e[c][a];throw TypeError("Not the right parameters were met for function viewsettings");}return e[c][a]},manage:function(){200<Store.count("messages")&&Store.filter("messages",null,function(a){a.sort(function(a,c){return a.stamp>c.stamp?1:a.stamp<c.stamp?-1:0});a=a.slice(0,100);Store.write("messages",a);Store.filter("touches",null,function(a){var c=Cloudwalkers.Session.getPing().cursor;a=a.filter(function(a){return a.ping==
c});Store.write("touches",a)})});25<Store.count("reports")&&Store.filter("reports",null,function(a){a.sort(function(a,c){return a.stamp>c.stamp?1:a.stamp<c.stamp?-1:0});a=a.slice(0,10);Store.write("messages",a)})},getversion:function(){Store.get("version",null,function(a){a&&(this.localversion=a.version)}.bind(this))},isupdated:function(){return this.localversion?this.localversion==this.version:!1},isAuthorized:function(a){return a?this.user.isauthorized(a):this.user.authorized},censuretemplate:function(a){a||
(a={});var b=this.getUser().censuretokens;a.authorized=b},getPing:function(){return this.user.account.ping},ping:function(){this.user.account.ping.forceping()},getAccount:function(a){return a?this.user.accounts.get(a):this.user.account},getAccounts:function(a){return this.user.accounts},getChannel:function(a){return"number"==typeof a?this.user.account.channels.get(a):this.user.account.channels.findWhere({type:a})},getChannels:function(a){return this.user.account.channels},storeChannel:function(a){a.channels&&
a.channels.length&&(a.channels=a.channels.map(function(a){Cloudwalkers.Session.storeChannel(a);return a.id}));a.streams&&a.streams.length&&(a.streams=a.streams.map(function(a){Store.post("streams",a);return a.id}));Store.post("channels",a)},getStream:function(a){return"number"==typeof a?this.user.account.streams.get(a):this.user.account.streams.findWhere({token:a})},getStreams:function(){return this.user.account.streams},addStream:function(a){return this.user.account.streams.add(a)},getUser:function(a){return a?
this.user.account.users.get(a):this.user},getUsers:function(){return this.user.account.users},getContact:function(a){return this.user.account.contacts.get(a)},getContacts:function(){return this.user.account.contacts},getMessage:function(a){return this.user.account.messages.get(a)},getMessages:function(){return this.user.account.messages},getCannedResponse:function(a){return this.user.account.cannedresponses.get(a)},getCannedResponses:function(){return this.user.account.cannedresponses},getNotification:function(a){return this.user.account.notifications.get(a)},
getNotifications:function(){return this.user.account.notifications},getStatistic:function(a){return this.user.account.statistics.get(a)},getStatistics:function(){return this.user.account.statistics},getReport:function(a){return this.user.account.reports.get(a)},getReports:function(){return this.user.account.reports},getComment:function(a){return this.user.account.comments.get(a)},getComments:function(){return this.user.account.comments},setLang:function(a){var b;moment.lang(this.user.attributes.locale);
b=new Cloudwalkers.Models.Polyglot;b.fetch({success:function(){this.translationLang=b.get("translation");this.polyglot=new Polyglot({phrases:this.translationLang});this.trigger("translation:done")}.bind(this)})}};_.extend(Cloudwalkers.Session,Backbone.Events);Cloudwalkers.Router=Backbone.Router.extend({routes:{"dashboard/:accountid":"changeaccount","demo(/:demotype)":"demo","inbox/drafts":"ib-drafts","inbox/sent":"ib-sent","inbox/scheduled":"ib-scheduled","inbox/trash":"ib-trash",write:"write",share:"share","inbox(/:type)(/:streamid)":"inbox",drafts:"drafts",notes:"notes",scheduled:"scheduled",calendar:"calendar",coworkers:"coworkers","channel/:channel(/:subchannel)(/:stream)(/:messageid)":"channel","timeline/:channel(/:stream)":"timeline","trending/:channel(/:subchannel)(/:stream)(/:messageid)":"trending",
"monitoring/accounts":"manageaccounts","monitoring/:channel(/:subchannel)(/:messageid)":"monitoring",keywords:"managekeywords","reports/:streamid":"reports",statistics:"statistics","statistics/:streamid":"statistics","settings(/:sub)(/:service)":"settings",firsttime:"firsttime",work:"coworkdashboard",resync:"resync",home:"home",logout:"home","*path":"dashboard"},initialize:function(){},demo:function(a){var b=Cloudwalkers.Session.getChannel("inbox");Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Demo({channel:b,
type:"messages",demotype:a}))},dashboard:function(){if(Cloudwalkers.Session.getAccount().get("firstTime"))return this.navigate("#firsttime",!0);if(!Cloudwalkers.Session.isAuthorized("_CW_INBOX_VIEW"))return this.navigate("#work",!0);Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Dashboard)},changeaccount:function(a){a!=Cloudwalkers.Session.get("currentAccount")&&Cloudwalkers.Session.updateSetting("currentAccount",a,{success:this.home})},write:function(){Cloudwalkers.RootView.compose()},share:function(){Cloudwalkers.RootView.viewshare("general")},
coworkers:function(){var a=new Cloudwalkers.Views.Coworkers;this.validate(a,"_CW_COWORKERS_VIEW")},"ib-drafts":function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.IB({channeltype:"draft",filter:"editors",title:"Drafts"}))},inbox:function(a,b){var c={MESSAGE_READ_INBOX_NOTIFICATIONS:"#messages/notifications",MESSAGE_READ_INBOX_SCHEDULE:"#scheduled",MESSAGE_READ_DRAFTS:"#drafts",ACCOUNT_NOTES_VIEW:"#notes"},e=_.intersection(_.keys(c),Cloudwalkers.Session.getUser().authorized),f=Cloudwalkers.Session.getChannel("inbox");
if(!f||!e||!e.length)return this.home();a||(a="messages");if(!Cloudwalkers.Session.isAuthorized("MESSAGE_READ_INBOX_"+a.toUpperCase())){if(Cloudwalkers.Session.getUser().authorized&&e.length)return this.navigate(c[e[0]],{trigger:!0});window.location="/"}Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Inbox({channel:f,type:a,streamid:b}))},drafts:function(){var a=new Cloudwalkers.Views.Drafts;this.validate(a,"MESSAGE_READ_DRAFTS")},notes:function(){var a=new Cloudwalkers.Views.Notes;this.validate(a,
"ACCOUNT_NOTES_VIEW")},scheduled:function(){var a=new Cloudwalkers.Views.Scheduled;this.validate(a,"MESSAGE_READ_SCHEDULE")},calendar:function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Calendar)},timeline:function(a,b){var c=b?Cloudwalkers.Session.getStream(Number(b)):Cloudwalkers.Session.getChannel(Number(a)),e=Cloudwalkers.Session.getAccount();e.channels.findWhere({type:"news"})&&e.channels.findWhere({type:"news"});e=e.channels.findWhere({type:"profiles"})?e.channels.findWhere({type:"profiles"}).id:
null;e=a==e?"company":"thirdparty";c=new Cloudwalkers.Views.Timeline({model:c,showcontact:"thirdparty"==e,parameters:{records:40,markasread:!0}});e=e=="MESSAGE_READ_"+e.toUpperCase();this.validate(c,e)},trending:function(a,b){var c=Cloudwalkers.Session.getChannel(Number(a)),e=b?Cloudwalkers.Session.getStream(Number(b)):c,c="news"==c.get("type")?1:7,c={since:3600*Math.round(Date.now()/36E5)-86400*c,sort:"engagement",records:40,markasread:!0},e=new Cloudwalkers.Views.Timeline({model:e,trending:!0,parameters:c});
this.validate(e,"MESSAGE_READ_THIRDPARTY")},manageaccounts:function(){var a=Cloudwalkers.Session.getChannel("news"),a=new Cloudwalkers.Views.ManageAccounts({channel:a});Cloudwalkers.RootView.setView(a)},monitoring:function(a,b,c){a=new Cloudwalkers.Views.KeywordMonitoring({category:Cloudwalkers.Session.getChannel(Number(b))});this.validate(a,"MESSAGE_READ_MONITORING")},managekeywords:function(){var a=new Cloudwalkers.Views.ManageKeywords;this.validate(a,"CHANNEL_MANAGE_EDIT_MONITORING")},reports:function(a){var b=
new Cloudwalkers.Views.Reports({stream:Cloudwalkers.Session.getStream(Number(a))});a&&(b.subnavclass="reports_"+a);this.validate(b,"STATISTICS_VIEW")},statistics:function(a){var b=Cloudwalkers.Session.getAccount();a=a?new Cloudwalkers.Views.StatStream({model:b,streamid:a}):new Cloudwalkers.Views.Statistics({model:b});this.validate(a,"STATISTICS_VIEW")},settings:function(a,b){var c;"users"==a&&(c="USER_INVITE");"services"==a&&(c="SERVICE_CONNECT");"account"==a&&(c="CAMPAIGN_DELETE");var e=new Cloudwalkers.Views.Settings({endpoint:a,
serviceid:b});this.validate(e,c)},firsttime:function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Firsttime)},coworkdashboard:function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Coworkdashboard)},manageusergroups:function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.ManageUserGroups)},resync:function(a){this.navigate("#resync");Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Resync({returnto:a}))},home:function(){$.ajax({url:config.authurl+"revoke",headers:{Authorization:"Bearer "+
Cloudwalkers.Session.authenticationtoken,Accept:"application/json"},success:function(){window.location="/"}});Cloudwalkers.RootView.view.remove();Cloudwalkers.RootView.navigation.remove();Cloudwalkers.Session.reset();return!1},validate:function(a,b){Cloudwalkers.Session.isAuthorized&&Cloudwalkers.Session.isAuthorized(b)?Cloudwalkers.RootView.setView(a):this.home()},exception:function(a){var b="/";switch(a){case 401:case 503:b="/503.html";default:window.location=b}}});Cloudwalkers.Session.Ping=Backbone.Model.extend({interval:3E4,min:1E4,max:9E4,timeout:0,cursor:!1,parameters:{},initialize:function(){Store.exists("ping",{id:this.id})||Store.post("ping",{id:this.id});this.setCursor(!1);this.fetch({success:this.schedule.bind(this),error:this.toing.bind(this)});this.on("change:paging",this.setCursor,this);this.on("change:updates",this.updateModels,this);this.on("change:add",this.addModels,this);this.on("change:remove",this.removeModels,this);this.listenTo(Cloudwalkers.Session,
"ping",this.forceping)},ping:function(){this.fetch({success:this.schedule.bind(this),error:this.toing.bind(this)})},setCursor:function(a,b){a?(this.interval+=Math.round(0.2*(this.min-this.interval)),this.cursor=b.cursors.after,Store.set("ping",{id:this.id,cursor:this.cursor})):Store.get("ping",{id:this.id},function(a){a&&(this.cursor=a.cursor)}.bind(this))},url:function(){this.cursor&&(this.parameters.after=this.cursor);return Cloudwalkers.Session.api+"/account/"+this.id+"/ping?"+$.param(this.parameters)},
parse:function(a){return a.pong},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};return Backbone.sync(a,b,c)},updateModels:function(a,b){b.accounts&&Cloudwalkers.Session.getAccounts().updates(b.accounts);b.streams&&Cloudwalkers.Session.getStreams().updates(b.streams);b.messages&&Cloudwalkers.Session.getMessages().updates(b.messages);b.notifications&&Cloudwalkers.Session.getNotifications().updates(b.notifications);b.users&&
Cloudwalkers.Session.getUsers().updates(b.users);b.contacts&&Cloudwalkers.Session.getContacts().updates(b.contacts)},addModels:function(a,b){if(!b.length)return null;console.log("ping add callback: ",b)},removeModels:function(a,b){if(!b.length)return null;console.log("ping remove callback: ",b)},request:function(){window.clearTimeout(this.timeout);this.fetch({success:this.schedule.bind(this),error:this.toing.bind(this)})},schedule:function(){this.timeout=setTimeout(this.ping.bind(this),this.timer())},
forceping:function(){clearTimeout(this.timeout);this.schedule();this.ping()},timer:function(){return this.interval+=Math.round(0.05*(this.max-this.interval))},toing:function(){Cloudwalkers.RootView.growl(this.translateString("ping"),this.translateString("there_is_no_pong"));this.interval=this.max;this.schedule()},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.UrlShortener=Backbone.Model.extend({initialize:function(a){a&&$.extend(this,a)},parse:function(a){return a},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};this.longurl=c.q;this.campaign=c.campaign;this.parameters={url:this.longurl};this.campaign&&(this.parameters.campaign=this.campaign);return Backbone.sync(a,b,c)},url:function(){var a=[Cloudwalkers.Session.api+"/accounts"],b=Cloudwalkers.Session.getAccount();
b&&(a.push(b.id),a.push("urlshortener/shorten?"));return a.join("/")+$.param(this.parameters)}});var StorageClassLocal=function(a,b){this.get=function(a,b,f){if(a=JSON.parse(window.localStorage.getItem(a)))if(b){for(key in b)a=a.filter(function(a){return a[key]==b[key]});f(a.length?a.shift():null)}else f(a.shift());else f(null);return this};this.filter=function(a,b,f){if(a=JSON.parse(window.localStorage.getItem(a)))if(b){for(key in b)a=a.filter(function(a){return a[key]==b[key]});f(a.length?a:[])}else f(a);else f([]);return this};this.exists=function(a,b,f){if((a=JSON.parse(window.localStorage.getItem(a)))&&
b)for(key in b)a=a.filter(function(a){return a[key]==b[key]});a=a&&a.length;return f?(f(a),this):a};this.post=function(a,b,f){var g=JSON.parse(window.localStorage.getItem(a));g||(g=[]);g.push(b);window.localStorage.setItem(a,JSON.stringify(g));f&&f(b,g.length-1);return this};this.postCollection=function(a,b,f){var g=JSON.parse(window.localStorage.getItem(a));g||(g=[]);b.each(function(a){g.push(a.attributes)});window.localStorage.setItem(a,JSON.stringify(g));f&&f(content,g.length);return this};this.write=
function(a,b,f){try{window.localStorage.setItem(a,JSON.stringify(b))}catch(g){"QUOTA_EXCEEDED_ERR"===g.name&&window.localStorage.clear()}f&&f(b);return this};this.set=function(a,b,f){var g=!1,h=JSON.parse(window.localStorage.getItem(a));h||(h=[]);for(n in h)h[n].id==b.id&&($.extend(h[n],b),g=!0);g||h.push(b);window.localStorage.setItem(a,JSON.stringify(h));f&&f(b);return this};this.update=function(a,b,f,g){var h=JSON.parse(window.localStorage.getItem(a)),m=h;if(b&&m){for(key in b)m=m.filter(function(a,
c){return a[key]==b[key]});for(n in m)for(i in h)h[i].id==m[i].id&&(h[i]=$.extend(m[n],f));window.localStorage.setItem(a,JSON.stringify(h));g&&(m.length?g(m):g(null,f))}else g(null,f);return this};this.updateById=function(a,b,f){var g=JSON.parse(window.localStorage.getItem(a)),h=!1;if(g&&b.id){for(n in g)g[n].id==b.id&&(g[n]=h=$.extend(g[n],b));window.localStorage.setItem(a,JSON.stringify(g));f&&(h?f(h):f(null,b))}else f(null,b);return this};this.remove=function(a,b,f,g){f=JSON.parse(window.localStorage.getItem(a));
if(!b)return window.localStorage.removeItem(a),f;var h=[];for(key in b)for(n in f)f[n][key]==b[key]&&h.push(f.splice(n,1));window.localStorage.setItem(a,JSON.stringify(f));g&&g(h);return this};this.count=function(a){return(a=JSON.parse(window.localStorage.getItem(a)))?a.length:0};this.calc=function(){var a=0,b;for(b in localStorage){var f=2*localStorage[b].length/1024/1024,a=a+f;console.log(b,f.toFixed(4)+" MB")}console.log("Total localStorage",a.toFixed(2)+" MB");return a.toFixed(2)}};var StorageClassIDB=function(a,b){var c,e=indexedDB.open(a,b),f=function(a){console.log("IndexedDB error.",a)};e.onerror=function(a){console.log("IndexedDB locked.");Store=new StorageClassLocal};e.onsuccess=function(a){c=e.result;c.onerror=f};e.onupgradeneeded=IDBstores;this.get=function(a,b,c){if(a=JSON.parse(window.localStorage.getItem(a)))if(b){for(key in b)a=a.filter(function(a){return a[key]==b[key]});c(a.length?a.shift():null)}else c(a.shift());else c(null);return this};this.filter=function(a,
b,c){if(a=JSON.parse(window.localStorage.getItem(a)))if(b){for(key in b)a=a.filter(function(a){return a[key]==b[key]});c(a.length?a:[])}else c(a);else c([]);return this};this.exists=function(a,b,c){if((a=JSON.parse(window.localStorage.getItem(a)))&&b)for(key in b)a=a.filter(function(a){return a[key]==b[key]});a=a&&a.length;return c?(c(a),this):a};this.post=function(a,b,c){var e=JSON.parse(window.localStorage.getItem(a));e||(e=[]);e.push(b);window.localStorage.setItem(a,JSON.stringify(e));c&&c(b,e.length-
1);return this};this.postCollection=function(a,b,c){var e=JSON.parse(window.localStorage.getItem(a));e||(e=[]);b.each(function(a){e.push(a.attributes)});window.localStorage.setItem(a,JSON.stringify(e));c&&c(content,e.length);return this};this.write=function(a,b,c){window.localStorage.setItem(a,JSON.stringify(b));c&&c(b);return this};this.set=function(a,b,c){var e=!1,f=JSON.parse(window.localStorage.getItem(a));f||(f=[]);for(n in f)f[n].id==b.id&&($.extend(f[n],b),e=!0);e||f.push(b);window.localStorage.setItem(a,
JSON.stringify(f));c&&c(b);return this};this.update=function(a,b,c,e){var f=JSON.parse(window.localStorage.getItem(a)),p=f;if(b&&p){for(key in b)p=p.filter(function(a,c){return a[key]==b[key]});for(n in p)for(i in f)f[i].id==p[i].id&&(f[i]=$.extend(p[n],c));window.localStorage.setItem(a,JSON.stringify(f));e&&(p.length?e(p):e(null,c))}else e(null,c);return this};this.updateById=function(a,b,c){var e=JSON.parse(window.localStorage.getItem(a)),f=!1;if(e&&b.id){for(n in e)e[n].id==b.id&&(e[n]=f=$.extend(e[n],
b));window.localStorage.setItem(a,JSON.stringify(e));c&&(f?c(f):c(null,b))}else c(null,b);return this};this.remove=function(a,b,c,e){c=JSON.parse(window.localStorage.getItem(a));if(!b)return window.localStorage.removeItem(a),c;var f=[];for(key in b)for(n in c)c[n][key]==b[key]&&f.push(c.splice(n,1));window.localStorage.setItem(a,JSON.stringify(c));e&&e(f);return this};this.count=function(a){return(a=JSON.parse(window.localStorage.getItem(a)))?a.length:0};this.calc=function(){var a=0,b;for(b in localStorage){var c=
2*localStorage[b].length/1024/1024,a=a+c;console.log(b,c.toFixed(4)+" MB")}console.log("Total localStorage",a.toFixed(2)+" MB");return a.toFixed(2)}};var IDBstores=function(a){console.log("Upgrading IDB.");a=a.target.result;var b;a.createObjectStore("me",{keyPath:"id"});a.createObjectStore("accounts",{keyPath:"id"});b=a.createObjectStore("channels",{keyPath:"id"});b.createIndex("type","type",{unique:!1});b=a.createObjectStore("streams",{keyPath:"id"});b.createIndex("type","token",{unique:!1});b=a.createObjectStore("messages",{keyPath:"id"});b.createIndex("stream","stream",{unique:!1});b=a.createObjectStore("notifications",{keyPath:"id"});b.createIndex("stream",
"stream",{unique:!1});b=a.createObjectStore("users",{keyPath:"id"});b.createIndex("name","displayname",{unique:!1});b=a.createObjectStore("contacts",{keyPath:"id"});b.createIndex("name","displayname",{unique:!1});a.createObjectStore("campaigns",{keyPath:"id"});a.createObjectStore("ping",{keyPath:"id"});a.createObjectStore("touches",{keyPath:"id"})};Cloudwalkers.Utils={months:"Jan Feb Mar Apr May Jun Jul Aug Sept Oct Nov Dec".split(" "),longdate:function(a){return a.getDate()+" "+this.month(a.getMonth()+1)+" "+a.getFullYear()+" "+this.zeroIt(a.getHours(),2)+":"+this.zeroIt(a.getMinutes(),2)},shortdate:function(a){return a.getDate()+" "+this.month(a.getMonth()+1)+" "+a.getFullYear()},time:function(a){return this.zeroIt(a.getHours(),2)+":"+this.zeroIt(a.getMinutes(),2)},zeroIt:function(a,b){for(a=String(a);a.length<b;)a="0"+a;return a},month:function(a){return"undefined"!=
typeof this.months[a-1]?this.months[a-1]:"Month out of range"}};Cloudwalkers.Net={get:function(a,b,c){a=Cloudwalkers.Session.api+"/"+a+(b?"?"+jQuery.param(b):"");$.ajax({type:"get",url:a,cache:!1,success:function(a){c(a)}})},put:function(a,b,c,e){a=Cloudwalkers.Session.api+"/"+a;"undefined"!=typeof b&&b&&(a+="?"+jQuery.param(b));jQuery.ajax({data:JSON.stringify(c),dataType:"json",type:"put",url:a,processData:!1,cache:!1,success:function(a){e(a)}})},post:function(a,b,c,e){a=Cloudwalkers.Session.api+"/"+a;"undefined"!=typeof b&&b&&(a+="?"+jQuery.param(b));jQuery.ajax({data:JSON.stringify(c),
dataType:"json",type:"post",url:a,processData:!1,cache:!1,success:function(a){e(a)}})},remove:function(a,b,c){a=Cloudwalkers.Session.api+"/"+a;"undefined"!=typeof b&&b&&(a+="?"+jQuery.param(b));jQuery.ajax({dataType:"json",type:"delete",url:a,cache:!1,success:function(a){c(a)}})}};Cloudwalkers.Utilities.StreamLibrary={streams:[],reset:function(){this.streams=[]},parse:function(a){for(var b=0;b<a.length;b++)this.touch(a[b]),"undefined"!=typeof a[b].streams&&this.parse(a[b].streams)},parseFromChannel:function(a){for(var b=0;b<a.length;b++)this.touch(a[b])&&(console.log("Stream NOT preloaded!"),console.log(a[b]))},touch:function(a){return null==this.getFromId(a.id)?(this.streams.push(new Cloudwalkers.Models.Stream(a)),!0):!1},getFromId:function(a){for(var b=0;b<this.streams.length;b++)if(this.streams[b].get("id")==
a)return this.streams[b];return null},getStreams:function(){return this.streams}};Cloudwalkers.Utilities.Parser={parseFromMessage:function(a,b){a=a.replace("{{from.name}}",b.get("from")?b.get("from")[0].username:null);return a=a.replace("{{body.plaintext}}",b.get("body")?b.get("body").plaintext:null)}};Cloudwalkers.Models.Account=Backbone.Model.extend({typestring:"accounts",endpoint:"",limits:{users:50,networks:15,keywords:10},initialize:function(){this.channels=new Cloudwalkers.Collections.Channels;this.streams=new Cloudwalkers.Collections.Streams;this.campaigns=new Cloudwalkers.Collections.Campaigns;this.users=new Cloudwalkers.Collections.Users;this.contacts=new Cloudwalkers.Collections.Contacts;this.messages=new Cloudwalkers.Collections.Messages;this.notes=new Cloudwalkers.Collections.Notes;
this.tags=new Cloudwalkers.Collections.Tags;this.notifications=new Cloudwalkers.Collections.Notifications;this.statistics=new Cloudwalkers.Collections.Statistics;this.reports=new Cloudwalkers.Collections.Reports},parse:function(a){this.endpoint="";Store.set("accounts",a.account);return a.account},url:function(){return Cloudwalkers.Session.api+"/account/"+this.id+this.endpoint},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};
this.endpoint=c.endpoint?"/"+c.endpoint:"";return Backbone.sync(a,b,c)},firstload:function(){$.each(this.get("channels"),function(a,b){Cloudwalkers.Session.storeChannel(b)})},activate:function(){Store.exists("channels")||this.firstload();Store.filter("streams",null,function(a){this.streams.add(a)}.bind(this));Store.filter("channels",null,function(a){this.channels.add(a)}.bind(this));Store.filter("campaigns",null,function(a){this.campaigns.add(a)}.bind(this));Store.filter("users",null,function(a){this.users.add(a)}.bind(this));
Store.filter("messages",null,function(a){this.messages.add(a)}.bind(this));Store.filter("statistics",null,function(a){this.statistics.add(a)}.bind(this));Store.filter("reports",null,function(a){this.reports.add(a)}.bind(this));this.get("plan")&&(this.limits=this.get("plan").limits);this.ping=new Cloudwalkers.Session.Ping({id:this.id})},monitorlimit:function(a,b,c){if(b>=this.limits[a])return $(".alert-info").remove(),Cloudwalkers.RootView.information("Upgrade?","You're fresh out of "+a+" slots, maybe you should upgrade."),
c&&("string"==typeof c&&(c=$(c)),c.addClass("limited").attr("disabled",!0)),!0;$("[disabled].limited").size()&&($("[disabled].limited").removeClass("limited").attr("disabled",!1),$("[data-dismiss=alert]").click());return!1},addcampaign:function(a,b){var c=this.get("campaigns");0>c.map(function(a){return a.name}).indexOf(a)&&(c.push({name:a}),this.save({campaigns:c},{patch:!0,wait:!0,success:b}))},removecampaign:function(a,b){this.endpoint="/campaigns/"+a;(new (Backbone.Model.extend({}))({id:a})).destroy({url:this.url(),
success:function(){var c=this.get("campaigns");c.forEach(function(b,f){b.id==a&&c.splice(f,1)});Cloudwalkers.RootView.growl(this.translateString("user_profile"),this.translateString("campaign_successfully_removed"));$(b).closest("li").remove()}.bind(this)})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Models.Service=Backbone.Model.extend({typestring:"services",channels:[],initialize:function(a){this.on("destroy",this.remove)},url:function(){var a=[Cloudwalkers.Session.api];this.parentpoint&&a.push("accounts",Cloudwalkers.Session.getAccount().id);this.typestring&&a.push(this.typestring);this.id&&a.push(this.id);this.endpoint&&a.push(this.endpoint);return a.join("/")},parse:function(a){"number"==typeof a?a={id:a}:a.service&&(a=a.service);return a},sync:function(a,b,c){c.headers={Authorization:"Bearer "+
Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};this.endpoint=c.endpoint?c.endpoint:!1;c.hasOwnProperty("parentpoint")?this.parentpoint=b.parentpoint:this.parentpoint="delete"!=a;return Backbone.sync(a,b,c)},updateStreams:function(a,b){a||(this.backupstreams=this.get("streams").filter(function(a){if(a.profile)return a.profile.id==b.id}));this.once("sync",this.parseStreamChanges.bind(this,b,a)).fetch({parentpoint:!1})},parseStreamChanges:function(a,b){var c;b?this.get("streams")&&
(c=this.get("streams").filter(function(b){if(b.profile)return b.profile.id==a.id})):c=this.backupstreams;if(c&&c.length)for(n in c)this.parsestream(c[n],a.get("activated")?"add":"remove");Cloudwalkers.RootView.navigation.renderHeader();Cloudwalkers.RootView.navigation.render()},addservice:function(){this.once("sync",this.updatechannels.bind(this,"add")).fetch({parentpoint:!1})},updatechannels:function(a){var b=this.get("streams");b||Cloudwalkers.Router.Instance.navigate("#settings/services",!0);for(n in b)this.parsestream(b[n],
a);Cloudwalkers.RootView.navigation.renderHeader();Cloudwalkers.RootView.navigation.render();"add"==a&&Cloudwalkers.Router.Instance.navigate("#settings/services",!0)},parsestream:function(a,b){var c=a.channels,e;if(c.length)for(n in c)if(e=Cloudwalkers.Session.getChannel(parseInt(c[n])))e.streams[b](a)},remove:function(){this.updatechannels("remove",this)}});Cloudwalkers.Models.Channel=Backbone.Model.extend({endpoint:"",parameters:"",initialize:function(a){this.channels=new Cloudwalkers.Collections.Channels;this.channels.seed(this.get("channels"));this.streams=new Cloudwalkers.Collections.Streams;this.streams.seed(this.get("streams"));this.messages=new Cloudwalkers.Collections.Messages;this.notifications=new Cloudwalkers.Collections.Notifications;this.contacts=new Cloudwalkers.Collections.Contacts;this.on("change",function(a){Store.set("channels",a.attributes)});
this.listenTo(this.messages,"change:from",this.seedcontacts);this.listenTo(this.notifications,"change:from",this.seedcontacts)},url:function(){return Cloudwalkers.Session.api+"/channel/"+(this.id?this.id:"")+this.endpoint+this.parameters},parse:function(a){if(a.error)return[];Store.set("channels",a.channel);return a.channel},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};"read"==a?(this.endpoint=c.endpoint?"/"+c.endpoint:
"",this.parameters=c.parameters?"?"+$.param(c.parameters):""):"create"==a?this.endpoint=c.parent?c.parent+"/channels":"":"delete"==a&&(this.endpoint="");return Backbone.sync(a,b,c)},getStream:function(a){var b={};b["string"==typeof a?"token":"id"]=a;return this.streams.findWhere(b)},seedcontacts:function(a){(a=a.get("from"))&&a.length&&this.contacts.add(a)}});Cloudwalkers.Models.Campaign=Backbone.Model.extend({initialize:function(){}});Cloudwalkers.Models.User=Backbone.Model.extend({typestring:"users",initialize:function(){},url:function(){return this.parent?Cloudwalkers.Session.api+"/"+this.parent.typestring+"/"+this.parent.id+"/"+this.typestring+"/"+this.id:"create"==this.method?Cloudwalkers.Session.api+"/accounts/"+Cloudwalkers.Session.getAccount().get("id")+"/users":"delete"==this.method?Cloudwalkers.Session.api+"/accounts/"+Cloudwalkers.Session.getAccount().get("id")+"/users/"+this.id:Cloudwalkers.Session.api+"/users/"+this.id},
parse:function(a){"number"==typeof a?a={id:a}:this.stamp(a);return a},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};this.method=a;return"update"==a?!1:Backbone.sync(a,b,c)},filterData:function(a){var b=this.attributes;"listitem"==a?b.arrow=!0:b.role=this.getRole();return b},getcoworker:function(a){},getRole:function(){var a=Cloudwalkers.Session.getAccount().get("roles"),b=this.get("rolegroup");if(!a||_.isUndefined(b))return Cloudwalkers.RootView.resync("#"+
Backbone.history.fragment);a=a.filter(function(a){return a.id==b});return a.length?a[0]:null}});Cloudwalkers.Models.Contact=Cloudwalkers.Models.User.extend({typestring:"contacts",modelstring:"contact",url:function(){var a=[Cloudwalkers.Session.api];this.parent?a.push(this.parent.typestring,this.parent.id,this.typestring,this.id):this.id?a.push("accounts",Cloudwalkers.Session.getAccount().id,this.typestring,this.id):a.push("accounts",Cloudwalkers.Session.getAccount().id,this.typestring);this.urlparams&&(a=a.concat(this.urlparams));a=a.join("/");return this.parameters?a+"?"+$.param(this.parameters):
a},parse:function(a){a[this.modelstring]&&(a=a[this.modelstring]);"number"==typeof a?a={id:a}:this.stamp(a);return a},initialize:function(a){this.gender=this.get("gender")},getMales:function(){return this.gender?this.gender.male:0},getFemales:function(){return this.gender?this.gender.female:0},getOthers:function(){return this.gender?this.gender.other:0},getGender:function(){return this.gender?this.gender:!1},getAge:function(){return this.age?this.age:!1}});
Cloudwalkers.Models.Contact.actions={templates:{dm:{name:"Direct message",icon:"message",type:"dialog"}}};Cloudwalkers.Models.Note=Backbone.Model.extend({typestring:"notes",type_settings:{CONTACT:{icon:"user",model:"Contact",typestring:"contacts"},MESSAGE:{icon:"inbox",model:"Message",typestring:"messages"},ACCOUNT:{icon:"edit",model:"Account",typestring:"accounts"}},initialize:function(){this.on("action",this.action)},parse:function(a){if("number"==typeof a)return{id:a};a=a.note?a.note:a;a.date&&(a.fulldate=moment(a.date).format("DD MMM YYYY HH:mm"),a.dateonly=moment(a.date).format("DD MMM YYYY"),a.time=
moment(a.date).format("HH:mm"),a.type_icon=this.type_settings[a.model.objectType].icon,a[a.model.objectType]=!0,a.model&&(a.objectType="note"));a.intro=a.text?a.text.substr(0,72):" ";return a},attachParent:function(a,b){a=this.type_settings[a].model;var c=Cloudwalkers.Session["get"+a](b);c&&c.get("objectType")||(c=new Cloudwalkers.Models[a]({id:b}),c.fetch());return c},url:function(){var a=[Cloudwalkers.Session.api];this.id?a.push(this.typestring,this.id):this.parent?"contacts"!=this.parent.typestring?
a.push(this.parent.typestring,this.parent.id,this.typestring):"contacts"==this.parent.typestring&&(a.push("accounts/"+Cloudwalkers.Session.getAccount().id+"/contacts"),a.push(this.parent.id),a.push(this.typestring)):a.push(this.typestring);a=a.join("/");return this.parameters?a+"?"+$.param(this.parameters):a},action:function(a){"delete"==a&&this.deletenote()},deletenote:function(){var a=this;Cloudwalkers.RootView.confirm("Are you sure you want to remove this note?",function(){a.destroy({success:function(){a.trigger("destroy")}})})}});Cloudwalkers.Models.Tag=Backbone.Model.extend({typestring:"tags",initialize:function(a){a&&$.extend(this,a);this.on("action",this.action)},parse:function(a){a=a.tag?a.tag:a;a.date&&(a.fulldate=moment(a.date).format("DD MMM YYYY HH:mm"),a.dateonly=moment(a.date).format("DD MMM YYYY"),a.time=moment(a.date).format("HH:mm"));return a},url:function(){var a=[Cloudwalkers.Session.api];"contacts"==this.parent.typestring&&a.push("accounts/"+Cloudwalkers.Session.getAccount().id);"tags"==this.typestring&&this.id?
a.push(this.parent.typestring,this.parent.id,this.typestring,this.id):this.parent.typestring&&a.push(this.parent.typestring,this.parent.id,this.typestring);a=a.join("/");return this.parameters?a+"?"+$.param(this.parameters):a},deletetag:function(){var a=this;Cloudwalkers.RootView.confirm("Are you sure you want to remove this tag?",function(){a.destroy({success:function(){a.trigger("destroytag")}})})}});Cloudwalkers.Models.Me=Cloudwalkers.Models.User.extend({unreadMessages:null,initialize:function(a){this.once("change",this.activate);this.on("change:id",function(a){this.previous("id")&&Cloudwalkers.Session.home()})},url:function(){var a=this.endpoint?this.endpoint:Store.exists("me")?"?include_accounts=ids":"";return Cloudwalkers.Session.api+"/user/me"+a},parse:function(a){Store.exists("me")||(a.user=this.firstload(a.user));Store.write("me",[a.user]);return a.user},sync:function(a,b,c){c.headers=
{Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};this.endpoint=c.endpoint?"/"+c.endpoint:!1;"read"==a&&Store.get("me",null,function(a){a&&this.set(a)}.bind(this));return Backbone.sync(a,b,c)},firstload:function(a){$.each(a.accounts,function(a,c){Store.set("accounts",c)}.bind(this));a.settings.currentAccount||(a.settings={currentAccount:a.accounts[0].id});return a},activate:function(a){if(!this.get("accounts").length)return Cloudwalkers.RootView.exception(401);
Store.filter("accounts",null,function(a){this.accounts=new Cloudwalkers.Collections.Accounts(a);this.account=this.getCurrentAccount();this.account.activate();this.set("level",Number(this.account.get("currentuser").level));this.set("rolegroup",Number(this.account.get("currentuser").rolegroup));this.authorized=this.account.get("currentuser").authorized;this.removerole("ACCOUNT_TAGS_VIEW");this.removerole("ACCOUNT_TAGS_MANAGE");this.parseauthorized();this.censuretokens=this.censure(this.authorized);
this.trigger("activated")}.bind(this))},isauthorized:function(a){return _.isArray(a)?0!=_.intersection(this.authorized,a).length:_.contains(this.authorized,a)},removerole:function(a){a=this.authorized.indexOf(a);0<=a&&this.authorized.splice(a,a+1)},censure:function(a){var b={};for(n in a)b[a[n]]=!0;return b},parseauthorized:function(){this.isauthorized(["MESSAGE_OUT_EDIT_OWN","MESSAGE_ACTIONS"])&&this.authorized.push("_CW_COWORKERS_VIEW");this.isauthorized(["MESSAGE_READ_INBOX_MESSAGES","MESSAGE_READ_INBOX_NOTIFICATIONS",
"MESSAGE_READ_SCHEDULE","MESSAGE_READ_DRAFTS","ACCOUNT_NOTES_VIEW"])&&this.authorized.push("_CW_INBOX_VIEW")},offline:function(){Cloudwalkers.Session.reset();window.location="/login.html"},getCurrentAccount:function(){var a=Cloudwalkers.Session.get("currentAccount");a||(a=this.accounts.at(0).id,this.save({settings:{currentAccount:a}}));a=this.accounts.get(Number(a));return a&&a.id?a:(this.save({settings:{currentAccount:this.accounts.at(0).id}}),Cloudwalkers.Session.home())}});Cloudwalkers.Models.Stream=Backbone.Model.extend({parameters:{},initialize:function(a){this.messages=new Cloudwalkers.Collections.Messages;this.contacts=new Cloudwalkers.Collections.Contacts;this.get("statistics")&&(this.reports=new Cloudwalkers.Collections.Reports,this.reports.streamid=this.id)},outdated:function(){this.fetch()},update:function(){this.fetch()},url:function(){return Cloudwalkers.Session.api+"/streams/"+(this.id?this.id:"")+this.endpoint+this.parameters},parse:function(a){a.stream&&
(a=a.stream);this.outdated=a.outdated=!1;Store.set("streams",a);return a},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};"read"==a?(this.endpoint=c.endpoint?"/"+c.endpoint:"",this.parameters=c.parameters?"?"+$.param(c.parameters):""):"create"==a&&(this.endpoint=c.parent?c.parent+"/streams":"");return Backbone.sync(a,b,c)},seedusers:function(a){(a=a.get("from"))&&a.length&&this.users.add(a)},getcontacts:function(){return _.isObject(this.get("contacts"))?
this.get("contacts").total:this.get("contacts")},getnotifications:function(){return _.isObject(this.get("notifications"))?this.get("notifications").total:this.get("notifications")},getmessages:function(){return _.isObject(this.get("messages"))?this.get("messages").total:this.get("messages")},getactivities:function(){return _.isObject(this.get("activities"))?this.get("activities").total:this.get("activities")},getimpressions:function(){if(this.impressions)return this.impressions;var a=_.isObject(this.get("messages"))?
this.get("messages"):null;return a&&a.impressions?a.impressions:0},getfollowers:function(){return _.isObject(this.get("contacts"))?_.isObject(this.get("contacts").types)?this.get("contacts").types.followers:0:0},getfollowing:function(){return _.isObject(this.get("contacts"))?_.isObject(this.get("contacts").types)?this.get("contacts").types.following:0:0},getbesttime:function(){if(_.isObject(this.get("messages").besttimetopost))return this.get("messages").besttimetopost},getnetwork:function(){return this.get("network")},
getattribute:function(a){return this["get"+a]()},incrementattr:function(a,b){var c=this.get(a);_.isObject(c)?c.total+=b:c+=b;this.set(a,c);return this},getlimitations:function(a){return(a=this.get("network"))?a.limitations:null}});Cloudwalkers.Models.Message=Backbone.Model.extend({typestring:"messages",limits:{twitter:140,linkedin:700},initialize:function(){"undefined"!=typeof this.attributes.parent&&(this.set("parentmodel",new Cloudwalkers.Models.Message(this.attributes.parent)),this.get("parentmodel").trigger("change"));this.actions=new Cloudwalkers.Collections.Actions(!1,{parent:this});this.notes=new Cloudwalkers.Collections.Notes(!1,{parent:this});this.notifications=new Cloudwalkers.Collections.Notifications(!1,{parent:this});
this.listenToOnce(this.notes,"add",this.updatecollection.bind(this,this.notes));this.notifications=new Cloudwalkers.Collections.Notifications(!1,{parent:this})},url:function(a){return this.id?this.endpoint?Cloudwalkers.Session.api+"/"+this.typestring+"/"+this.id+this.endpoint:Cloudwalkers.Session.api+"/"+this.typestring+"/"+this.id:(a=this.parameters,this.endpoint?Cloudwalkers.Session.api+"/accounts/"+Cloudwalkers.Session.getAccount().id+"/"+this.typestring+this.endpoint+a:Cloudwalkers.Session.api+
"/accounts/"+Cloudwalkers.Session.getAccount().id+"/"+this.typestring)},parse:function(a){if("number"==typeof a)return{id:a};a.message&&(a=a.message);a=this.filterData(a);this.stamp(a);this.checkloaded(a);return a},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};this.endpoint=c.endpoint?"/"+c.endpoint:!1;return"update"==a?!1:Backbone.sync(a,b,c)},updatecollection:function(a){a.updated=!0},validateCustom:function(a){var b;
if(!this.hascontent()&&0>$.inArray("content",a))return this.translateString("you_need_a_bit_of_content");if(!this.validatecontent())return this.translateString("one_or_more_networks_exceed_the_character_limit");if(!this.get("streams").length&&0>$.inArray("streams",a))return this.translateString("please_select_a_network_first");if((b=this.validateschedules())&&0>$.inArray("schedule",a))return b},validateschedules:function(){var a;if(a=this.validateschedule(this.get("schedule")))return a;$.each(this.get("variations"),
function(b,c){return(a=this.validateschedule(c.schedule))?!1:!0}.bind(this));return a},validateschedule:function(a){if(!a)return!1;var b=a.date||null;a=a.repeat?a.repeat.until:null;return b&&b<moment().unix()?"One or more streams are scheduled into the past.":b&&a&&a<b?"One or more streams have the repeat date happening before the scheduled date.":!b&&a&&a<moment().unix()?"One or more streams have the repeat date set to the past.":!1},hascontent:function(){var a;if(this.get("attachments")&&this.get("attachments").length)return this.get("attachments").length;
if(this.get("body").plaintext)return this.get("body").plaintext.length;if(this.get("variations")&&this.get("variations").length)return $.each(this.get("variations"),function(b,c){if(c.attachments&&c.attachments.length)return a=c.attachments.length,!1;if(c.body&&c.body.plaintext)return a=c.body.plaintext.length,!1}.bind(this)),a},validatecontent:function(){var a=1,b;this.get("streams")&&this.get("streams").length&&$.each(this.get("streams"),function(c,e){var f=Cloudwalkers.Session.getStream(e).get("network"),
f=f.limitations["max-length"]?f.limitations["max-length"].limit:null;if(!f)return!0;if(b=this.getvariation(e)){if(b.body&&b.body.plaintext)return a=f-b.body.plaintext.length,0>a?!1:!0}else if(this.get("body")&&this.get("body").plaintext&&(a=f-this.get("body").plaintext.length,0>a))return!1}.bind(this));return 0<a},sanitizepost:function(){this.attributes.body.html&&delete this.attributes.body.html;this.attributes.variations&&this.attributes.variations.forEach(function(a,b){a.body&&(a.body.plaintext?
a.body.html&&delete a.body.html:delete a.body);0>this.attributes.streams.indexOf(a.stream)&&this.attributes.variations.splice(b,1)}.bind(this))},cloneSanitized:function(){var a=this.clone();a.attributes.date&&delete a.attributes.date;a.attributes.from&&delete a.attributes.from;a.attributes.stream&&delete a.attributes.stream;a.attributes.streams=[];a.id&&(delete a.id,delete a.attributes.id);return a},checkloaded:function(a){var b=this;a.objectType&&setTimeout(function(){b.trigger("loaded")},1,this)},
filterData:function(a){var b={};$.each("id objectType actiontokens subject body date engagement from read stream streams attachments parent statistics stats canHaveChildren children_count schedule variations".split(" "),function(c,f){void 0!==a[f]&&(b[f]=a[f])});var c=Cloudwalkers.Session.getStream(a.stream);c&&(b.icon=c.get("network").icon,b.networktoken=c.get("network").token,b.networkdescription=c.get("name"));a.attachments?(a.attachments.length&&(b.media=a.attachments[a.attachments.length-1],
b.media="image"==b.media.type?"picture":b.media.type),b.attached={},$.each(a.attachments,function(a,c){b.attached[c.type]=c})):b.media="reorder";a.engagement&&(b.trending=1E3>a.engagement?a.engagement:"+999");b.schedule&&(b.scheduledate=moment(b.schedule.date).format("DD MMM YYYY HH:mm"));b.body.intro=a.body.plaintext?a.body.plaintext.substr(0,72):" ";a.date&&(b.fulldate=moment(a.date).format("DD MMM YYYY HH:mm"),b.dateonly=moment(a.date).format("DD MMM YYYY"),b.time=moment(a.date).format("HH:mm"));
return b},generateintro:function(){this.get("body")&&!this.get("body").intro&&(this.attributes.body.intro=this.get("body").plaintext.substr(0,72))},filterActions:function(){if(!this.get("actiontokens"))return[];var a=this.actions.rendertokens();a.map(function(a){"note"==a.token&&this.notes.updated&&(a.value=this.notes.length);return a}.bind(this));return a},filterCalReadable:function(){var a=this.get("objectType"),b=a&&"reorder"!=this.get("media");this.calNode||(this.calNode={id:this.id});this.get("schedule")?
this.calNode.start=a?$.fullCalendar.moment(this.get("scheduledate")):$.fullCalendar.moment():this.calNode.start=a?$.fullCalendar.moment(this.get("date")):$.fullCalendar.moment();this.calNode.title=a?(this.get("title")?this.get("title"):this.get("body").plaintext).substring(0,b?12:16):"...";this.calNode.className=a?this.get("networktoken")+"-color":"hidden";this.calNode.networkdescription=a?this.get("networkdescription"):null;this.calNode.intro=a?this.get("body").intro:null;this.calNode.icon=a?this.get("icon"):
null;this.calNode.media=b?this.get("media"):null;a&&72<=this.calNode.intro.length&&(this.calNode.intro+="...");return this},attach:function(a,b,c){c=this.get("attachments")||[];a=b&&c[b]?$.extend(c[b],a):c.push(a);this.set({attachments:c});return a},unattach:function(a){(this.get("attachments")||[]).splice(a,1)},addcampaign:function(){},setvariation:function(a,b,c){var e=this.get("variations")||[],f=e.filter(function(b){if(b.stream==a)return b});if(0==f.length){f={stream:a};if("image"==b||"link"==
b){var g=[c];f.attachments=g}else b&&(f[b]=c);e.push(f)}else f=f[0],"image"==b||"link"==b?(g=f.attachments||[],0==g.length&&"image"==b?(g.push(c),f.attachments=g):"image"==b?g.push(c):(b=g.filter(function(a){if("link"==a.type)return a}),0<b.length?b[0].url=c.url:0!=g.length?f.attachments.push(c):f.attachments=[c])):f[b]=c;return f},getvariation:function(a,b){var c=this.get("variations")||[],c=_.findWhere(c,{stream:a});if("image"==b||"link"==b){if(c&&c.attachments)return c.attachments.filter(function(a){if(a.type==
b)return a})}else{if(c&&c[b])return c[b];if(c&&!b)return c}},original:function(a,b,c){var e=this.get("variations")?this.get("variations").filter(function(b){return a&&b.stream==a.id}):[],f=a?e.length?e[0]:{stream:a.id}:this.attributes;void 0!==c&&(f[b]=c,a&&!e.length&&this.get("variations").push(f));return f[b]},removevariation:function(a){var b=this.get("variations");b&&$.each(b,function(c,e){if(e.stream==a)return b.splice(c,1),!1})},removevarimg:function(a,b){var c=this.getvariation(a),c=c?c.attachments:
[];if(_.isNumber(b))this.addexclude(a,b);else for(n in c)"image"==c[n].type&&c[n].name==b&&c.splice(n,1)},addexclude:function(a,b){var c=this.getvariation(a)||this.setvariation(a);c.excludes?c.excludes.attachments.push(b):c.excludes={attachments:[b]}},checkexclude:function(a,b){var c=this.getvariation(a);if(c)c=c.excludes;else return!1;if(c)for(n in c.attachments)if(c.attachments[n]==b)return!0;return!1},location:function(){return"#"},afterChange:function(){this.addInternalActions();this.get("parent")&&
this.get("parentmodel").set(this.get("parent"))},getActionIcon:function(a){return"internal-share"==a.token?"share-alt":"internal-edit"==a.token?"edit":"internal-delete"==a.token||"delete"==a.token?"remove":"like"==a.token?"thumbs-up":"unlike"==a.token?"thumbs-down":"comment"==a.token?"comment-alt":"reply"==a.token?"comment":"retweet"==a.token?"retweet":"dm"==a.token?"envelope":"internal-reply"==a.token?"comment":"favorite"==a.token?"star":"unfavorite"==a.token?"star-empty":a.token},addInternalActions:function(){var a=
this;if("undefined"!=typeof this.attributes.actions)for(var b=0;b<this.attributes.actions.length;b++){if("internal-"==this.attributes.actions[b].token.substr(0,9))return}else this.attributes.actions=[];"INCOMING"==this.attributes.type?this.attributes.actions.push({name:"Share",parameters:[],token:"internal-share",callback:function(a){Cloudwalkers.RootView.shareMessage(a)}}):"OUTGOING"==this.attributes.type&&(this.attributes.actions.push({name:"Edit",parameters:[],token:"internal-edit",callback:function(b){Cloudwalkers.RootView.editMessage(a)}}),
this.attributes.actions.push({name:"Delete",parameters:[],token:"internal-delete",callback:function(b){a.deleteMessage()}}));var c=this.get("parentmodel");if("undefined"!=typeof c&&c){var e=c.get("actions");if(e)for(b=0;b<e.length;b++)"comment"==e[b].token&&this.attributes.actions.push({name:"Reply",token:"internal-reply",target:c,originalaction:e[b]})}if("undefined"!=typeof this.attributes.actions)for(b=0;b<this.attributes.actions.length;b++)this.attributes.actions[b].icon=this.getActionIcon(this.attributes.actions[b])},
deleteMessage:function(){var a=this;this.repeat().repeat?Cloudwalkers.RootView.dialog(this.translateString("are_you_sure_you_want_to_remove_this_message"),[{label:this.translateString("skip_once"),description:this.translateString("message_will_be_skipped_once"),token:"skip"},{label:this.translateString("delete_forever"),description:this.translateString("message_will_never_be_repeated"),token:"remove"}],function(b){b="post/?"+b.token+"="+a.get("id");jQuery.ajax({dataType:"json",type:"get",url:b,success:function(b){a.trigger("destroy",
{wait:!0})}})}):Cloudwalkers.RootView.confirm(this.translateString("are_you_sure_you_want_to_remove_this_message"),function(){a.destroy({success:function(){a.trigger("destroy",a,a.collection)}})})},humandate:function(a){a=new Date(a?a:this.get("date"));return Cloudwalkers.Utils.longdate(a)},shortdate:function(){var a=this.date();return Cloudwalkers.Utils.shortdate(a)},time:function(){var a=this.date();return Cloudwalkers.Utils.time(a)},date:function(){return new Date(this.get("date"))},getAction:function(a){for(var b=
this.get("actions"),c=0;c<b.length;c++)if(b[c].token==a)return b[c];return null},act:function(a,b,c){Cloudwalkers.RootView.growl(a.name,this.translateString("the")+" "+a.token+" "+this.translateString("is_planned_with_success"));var e=this;"undefined"==typeof b&&(b={});a={actions:[{token:a.token,parameters:b}]};b=CONFIG_BASE_URL+"json/message/"+this.get("id")+"?account="+Cloudwalkers.Session.getAccount().get("id");jQuery.ajax({data:JSON.stringify(a),dataType:"json",type:"put",url:b,processData:!1,
cache:!1,success:function(a){a.removed?e.trigger("destroy",e,e.collection):e.set(a.message);c()}})},scheduledate:function(a){"undefined"==typeof a&&(a=!0);var b=this.get("schedule");return b?a?"ASAP"==b.date?b.date:this.humandate(b.date):"ASAP"==b.date?!1:new Date(b.date):!1},calculateIntervalFromSeconds:function(a){for(var b={},c=[{unit:"minutes",value:60},{unit:"hours",value:3600},{unit:"days",value:86400},{unit:"weeks",value:604800},{unit:"months",value:2678400}],e=c.length-1;0<=e;e--)if(0==a%
c[e].value)return b.interval=Math.round(a/c[e].value),b.unit=c[e].unit,b;for(e=0;e<c.length;e++)if(72>a/c[e].value)return b.interval=Math.round(a/c[e].value),b.unit=c[e].unit,b;return!1},repeat:function(){var a=this.get("schedule"),b={repeat:!1,weekdays:{}};if("undefined"!=typeof a&&"undefined"!=typeof a.repeat){b.repeat=!0;var c=this.calculateIntervalFromSeconds(a.repeat.interval);c&&(b.interval=c.interval,b.unit=c.unit);b.end=null;a.repeat.end&&(b.end=new Date(a.repeat.end));if(a.repeat.weekdays)for(c=
0;c<a.repeat.weekdays.length;c++)b.weekdays[a.repeat.weekdays[c]]=!0}return b},getStream:function(){return this.get("stream")?Cloudwalkers.Session.getAccount().streams.get(this.get("stream")):null},getProcessedAttachments:function(){var a=[],b;if("undefined"!=typeof this.attributes.attachments)for(var c=0;c<this.attributes.attachments.length;c++)b=this.attributes.attachments[c],"link"==b.type?null!=this.attributes.body.plaintext&&-1!==this.attributes.body.plaintext.indexOf(b.url)||a.push(b):a.push(b);
return a},hasAttachement:function(a){if("undefined"!=typeof this.attributes.attachments){for(var b=0;b<this.attributes.attachments.length;b++)if(attachment=this.attributes.attachments[b],attachment.type==a)return this.attributes.attachments[b];return!1}},setRead:function(){if(!this.get("read")){var a=CONFIG_BASE_URL+"json/message/"+this.get("id")+"/read/";jQuery.ajax({type:"get",url:a,success:function(a){}})}},shortBody:function(){var a=this.get("body");return a.plaintext?{html:a.plaintext.substring(0,
100),plaintext:a.plaintext.substring(0,100)}:{html:"",plaintext:""}},messageAction:function(a){if(null==a)console.log("Action not found: "+actiontoken);else{var b=this;"undefined"!=typeof a.target&&(b=a.target,"undefined"!=typeof a.originalaction&&(a=a.originalaction));"undefined"!=typeof a.callback?a.callback(b):a&&("dialog"==a.type?(a=new Cloudwalkers.Views.ActionParameters({message:b,action:a}),Cloudwalkers.RootView.popup(a)):"simple"==a.type?b.act(a,{},function(){}):"write"==a.type&&Cloudwalkers.RootView.writeDialog(b,
a))}},hasattachements:function(){if(this.get("attachments"))return 0<this.get("attachments").length},hasschedule:function(){if(this.get("schedule"))return 0<Object.getOwnPropertyNames(this.get("schedule")).length},hasnotes:function(){var a=this.get("stats");if(a)return a.notes},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Models.CannedResponse=Backbone.Model.extend({typestring:"messages",initialize:function(){this.streams=Cloudwalkers.Session.getStreams("canned")},url:function(){var a=[Cloudwalkers.Session.api];this.id?a.push(this.typestring+"/"+this.id):this.id||a.push("accounts/"+Cloudwalkers.Session.getAccount().id+"/"+this.typestring);return a.join("/")},parse:function(a){return a.message?a.message:a},deletecanned:function(){var a=this;Cloudwalkers.RootView.confirm(this.translateString("are_you_sure_you_want_to_remove_this_template"),
function(){a.destroy({success:function(){a.trigger("destroyed")}})})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Models.Notification=Cloudwalkers.Models.Message.extend({initialize:function(){"undefined"!=typeof this.attributes.parent&&(this.set("parentmodel",new Cloudwalkers.Models.Message(this.attributes.parent)),this.get("parentmodel").trigger("change"));this.actions=new Cloudwalkers.Collections.Actions(!1,{parent:this});this.notes=new Cloudwalkers.Collections.Notes(!1,{parent:this});this.notifications=new Cloudwalkers.Collections.Notifications(!1,{parent:this});this.once("destroy",function(){this.get("parentmodel").fetch()})},
parse:function(a){if("number"==typeof a)return{id:a};a=this.filterData(a);this.stamp(a);return a}});Cloudwalkers.Models.Action=Backbone.Model.extend({typestring:"actions",initialize:function(a,b){a&&$.extend(this,a);b&&(this.parent=b.collection.parent)},url:function(){var a=[Cloudwalkers.Session.api];this.parent&&a.push(this.parent.typestring,this.parent.id);this.typestring&&a.push(this.typestring);this.get("actiontype")&&a.push(this.get("actiontype"));a=a.join("/");return this.parameters?a+"?"+$.param(this.parameters):a},parse:function(a){this.parent&&a[this.parent.get("objectType")]?a=a[this.parent.get("objectType")]:
this.parent&&"comment"==this.parent.get("objectType")&&(a=a.message);return a}});Cloudwalkers.Models.Report=Backbone.Model.extend({initialize:function(a){this.entity="undefined"!=typeof a.entity?a.entity:"report";this.type="undefined"!=typeof a.type?a.type:"time";this.isFetched=!1;this.evolution=this.intervalinput=this.interval=this.display=this.daterange=null},parse:function(a){if("number"==typeof a)return{id:a};a.report&&(a=a.report);this.stamp(a);return a},stamp:function(a){a||(a={id:this.id});a.stamp=Math.round(0.001*(new Date).getTime());Store.set("reports",a);return this},
getDetails:function(){return this[this.attributes.type+"Details"](this.attributes.series[0])},textDetails:function(a){var b=Cloudwalkers.Session.getStream(this.get("streamid"));return{content:a.values[0].value,title:a.name,description:b.get("customname")}},comparisonDetails:function(a){var b=a.values[0].value-a.values[1].value;0<b&&(b="+ "+b);var c=a.values[1].value?" ("+(Math.round(100*(a.values[0].value/a.values[1].value))-100)+"%)":"";return{content:a.values[0].value,title:"<strong>"+b+"</strong>"+
c+" in last "+a.interval,description:a.name}},refresh:function(){var a=this,b=this.getDataURL();$.ajax(Cloudwalkers.Session.api+"/"+b,{success:function(b){if("undefined"!=typeof b[a.entity]){a.setInternalParameters(b[a.entity].series[0]);for(var e=[],f=0;f<b[a.entity].series.length;f++)e.push({values:a.processValues(b[a.entity].series[f].values)});a.trigger("dataset:change",e)}else console.log("Information not expected:"),console.log(b)},beforeSend:function(a){a.setRequestHeader("Accept","application/json");
a.setRequestHeader("Authorization","Bearer "+Cloudwalkers.Session.authenticationtoken)}})},getDataset:function(){console.log("DEPRECATION ALERT")},getDataURL:function(){var a=this.get("url")+"?";this.daterange&&(a+="start="+Math.floor(this.daterange[0].getTime()/1E3)+"&end="+Math.floor(this.daterange[1].getTime()/1E3)+"&");this.intervalinput&&(a+="interval="+this.intervalinput);return a},getDatasetType:function(){return"bars"==this.get("type")?"category":"table"==this.get("type")?"table":"time"==
this.get("type")?"time":"text"==this.get("type")?"text":"category"},getWidget:function(){var a=this.get("type");if("bars"==a)var b=new Cloudwalkers.Views.Widgets.Charts.Barchart({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this});else"pie"==a?b=new Cloudwalkers.Views.Widgets.Charts.Piechart({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"table"==a?b=new Cloudwalkers.Views.Widgets.Charts.Table({model:this,
title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"time"==a?b=new Cloudwalkers.Views.Widgets.Charts.Intervalchart({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"comparison"==a?b=new Cloudwalkers.Views.Widgets.Charts.Comparison({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"number"==a?b=new Cloudwalkers.Views.Widgets.Charts.Numberstat({model:this,
title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"text"==a?b=new Cloudwalkers.Views.Widgets.Charts.Textstat({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):alert("Report type not found: "+a);return b},setDateRange:function(a,b){this.daterange=[a,b];this.refresh()},setInterval:function(a){this.intervalinput=a},getDisplay:function(){return this.display},getInterval:function(){return this.interval},
getEvolution:function(){return this.evolution},getValues:function(a){this.getSeries(function(b){0<b.length?a(b[0].values):a(null)})},getSeries:function(a){var b=this,c=this.getDataURL();this.isFetched=!0;$.ajax(Cloudwalkers.Session.api+"/"+c,{success:function(c){if("undefined"==typeof c[b.entity])a(!1);else{for(var f=[],g=0;g<c[b.entity].series.length;g++)f.push({values:b.processValues(c[b.entity].series[g].values)});b.setInternalParameters(c[b.entity].series[0]);a(f)}},beforeSend:function(a){a.setRequestHeader("Accept",
"application/json");a.setRequestHeader("Authorization","Bearer "+Cloudwalkers.Session.authenticationtoken)}})},setInternalParameters:function(a){"undefined"!=typeof a.display&&(this.display=a.display);"undefined"!=typeof a.evolution&&(this.evolution=a.evolution);"undefined"!=typeof a.interval&&(this.interval=a.interval)},processValues:function(a){var b=[],c;if(!a)return[];if("table"==this.type)return a;for(var e=0;e<a.length;e++)c="time"==this.type?(new Date(a[e].date)).getTime():"category"==this.type||
"text"==this.type||"pie"==this.type?a[e].category:e,b.push([c,"text"!=this.type?parseInt(a[e].value):a[e].value]);return b}});Cloudwalkers.Models.Statistic=Backbone.Model.extend({typestring:"statistics",parameters:{},initialize:function(a){},pluck:function(a,b,c){var e=0;if(this.get("streams"))return c?(key=a[0],subkey=a[1],2<c&&(subsubkey=a[2])):(key=a,subkey="total"),$.each(this.get("streams"),function(a,g){if(b)if(_.isNumber(b)&&b==g.id&&(2>=c||!c))_.isNumber(g[key][subkey])?e+=Number(g[key][subkey]):_.isNumber(g[key])&&!c&&(e+=Number(g[key]));else if(_.isNumber(b)&&b==g.id&&2<c)_.isObject(g[key])&&_.isObject(g[key][subkey])&&
_.isNumber(g[key][subkey][subsubkey])&&(e+=Number(g[key][subkey][subsubkey]));else if(_.isString(b)&&(2>=c||!c)){var h=Cloudwalkers.Session.getStream(g.id).get("network").token;h==b&&(_.isNumber(g[key][subkey])?e+=Number(g[key][subkey]):_.isNumber(g[key])&&!c&&(e+=Number(g[key])))}else _.isString(b)&&2<c&&(h=Cloudwalkers.Session.getStream(g.id).get("network").token,h==b&&_.isObject(g[key])&&_.isObject(g[key][subkey])&&_.isNumber(g[key][subkey][subsubkey])&&(e+=Number(g[key][subkey][subsubkey])));
else _.isNumber(g[key][subkey])?e+=Number(g[key][subkey]):_.isNumber(g[key])&&!c&&(e+=Number(g[key]))}),e},pluckbynetwork:function(){},all:function(a){var b=[];if(!this.get("streams"))return b;$.each(this.get("streams"),function(c,e){!streamid&&e[a]?b.push(e[a]):streamid==e.id&&(b=e[a])});return b},contacts:function(a){var b=[];if(!this.get("streams"))return b;a||$.each(this.get("streams"),function(a,e){var f=Cloudwalkers.Session.getStream(e.id);if(f){var f=f.get("network").token,g=e.contacts;g&&
b.push({color:this.networkcolors[f],value:Number(g)})}}.bind(this));return b},age:function(a){return{counter:[]}},gender:function(a){return{counter:[]}},regional:function(a){return{counter:[]}},countries:function(a){return{counter:[]}},cities:function(a){return{counter:[]}},besttime:function(a){return{counter:[]}},activity:function(a){return{counter:[]}}});Cloudwalkers.Models.Network=Backbone.Model.extend({parameters:{},networkcolors:{facebook:"#3B5998",twitter:"#01a9da",linkedin:"#1783BC",tumblr:"#385775","google-plus":"#DD4C39",youtube:"#CC181E",web:"#f39501",blog:"#f39501","mobile-phone":"#E2EAE9",others:"#E5E5E5",group:"#CCCCCC"},initialize:function(a){this.set("color",this.networkcolors[this.get("token")])},gettoken:function(){return this.get("token")?this.get("token"):!1},getcolor:function(){return this.get("color")?this.get("color"):!1},gettitle:function(){return this.get("name")?
this.get("name"):!1},geticon:function(){return this.get("icon")?this.get("icon"):!1},getcontacts:function(){return this.get("contacts")?this.get("contacts"):0},addcontacts:function(a){this.set("contacts",this.getcontacts()+a);return this}});Cloudwalkers.Models.Polyglot=Backbone.Model.extend({initialize:function(a){a&&$.extend(this,a)},url:function(){return"/locales/"+(Cloudwalkers.Session.user.attributes.locale||"en_EN")+".json"},parse:function(a){return a}});Cloudwalkers.Models.Trigger=Backbone.Model.extend({typestring:"triggers",initialize:function(){this.get("actions")||this.set("actions",[])},getaction:function(a){var b=this.get("actions");if(b=b?b.filter(function(b){if(b.action==a)return b}):null)return b.length?b[0]:null},getmessage:function(a){return(a=this.getaction(a))&&a.message?a.message.body?a.message.body.html:a.message:null},setaction:function(a,b){var c=this.getaction(a);c?$.extend(c,b):this.attributes.actions.push($.extend({action:a},b))},
url:function(){var a=[Cloudwalkers.Session.api];this.id?a.push(this.typestring,this.id):this.parent?a.push(this.parent.typestring,this.parent.id,this.typestring):this.typestring&&a.push(this.typestring);return a.join("/")}});Cloudwalkers.Collections.Accounts=Backbone.Collection.extend({model:Cloudwalkers.Models.Account,fetch:function(a,b,c){return Cloudwalkers.Session.user.get("accounts")},updates:function(a){for(n in a){var b=this.get(a[n]);b&&(Store.set(this.typestring,{id:a[n],outdated:!0}),b.fetch())}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])}});Cloudwalkers.Collections.Services=Backbone.Collection.extend({model:Cloudwalkers.Models.Service,endpoint:"",initialize:function(){this.on("add",this.model.updateStreams)},url:function(){return Cloudwalkers.Session.api+"/accounts/"+Cloudwalkers.Session.getAccount().id+"/services"+this.endpoint},parse:function(a){if(a.services)this.available=a.services.available,this.trigger("available:ready",this,a.services.available);else return this.ready(),a.account.services},sync:function(a,b,c){c.headers={Authorization:"Bearer "+
Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};this.endpoint=c.endpoint?"/"+c.endpoint:"";return Backbone.sync(a,b,c)},fetchAvailable:function(a){this.fetch({endpoint:"available"})}});Cloudwalkers.Collections.Campaigns=Backbone.Collection.extend({model:Cloudwalkers.Models.Campaign,initialize:function(){this.on("destroy",this.store.bind(this,"delete"))},url:function(){return Cloudwalkers.Session.api+"/account/"+Cloudwalkers.Session.getAccount().id+"/campaigns"},parse:function(a){return a.campaigns},store:function(a,b){"delete"==a&&Store.remove("campaigns",{id:b.id})}});Cloudwalkers.Collections.Users=Backbone.Collection.extend({model:Cloudwalkers.Models.User,typestring:"users",modelstring:"user",parenttype:"account",processing:!1,initialize:function(a){a&&$.extend(this,a);Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getUsers().listenTo(this,"add",Cloudwalkers.Session.getUsers().distantAdd)},parse:function(a){this.parentmodel&&(a=a[this.parenttype]);a&&this.setcursor(a.paging);a.paging||this.ready();return a[this.typestring]},url:function(){return Cloudwalkers.Session.api+
"/account/"+Cloudwalkers.Session.getAccount().id+"/"+this.typestring+this.parameters},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};"read"==a&&(this.processing=!0,this.parameters=this.parameters?"?"+$.param(this.parameters):"");return Backbone.sync(a,b,c)},updates:function(a){for(n in a){var b=this.get(a[n]);b&&(Store.set(this.typestring,{id:a[n],outdated:!0}),b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});
this.updates([a])},hook:function(a){a.records&&(this.parameters.records=a.records);this.processing?this.length&&a.success(this):this.fetch({error:a.error});this.on("sync",a.success)}});Cloudwalkers.Collections.Contacts=Cloudwalkers.Collections.Users.extend({model:Cloudwalkers.Models.Contact,typestring:"contacts",modelstring:"contact",parenttype:"account",comparator:"displayname",processing:!1,initialize:function(a,b){Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getContacts().listenTo(this,"add",Cloudwalkers.Session.getContacts().distantAdd)},url:function(){var a=[Cloudwalkers.Session.api,"accounts",Cloudwalkers.Session.getAccount().id];this.endpoint&&a.push(this.typestring,
this.endpoint);this.following&&a.push(this.modelstring+"ids",this.following);this.parameters&&a.push(this.typestring+"?"+$.param(this.parameters));return a.join("/")},parse:function(a){this.parameters="";this.processing=!1;return a[this.typestring]?a[this.typestring]:a.account[this.typestring]},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};"read"==a&&(this.processing=!0);c.parameters&&(this.parameters=c.parameters);c.following||
(this.following=!1);return Backbone.sync(a,b,c)},touch:function(a,b){a?(this.parentmodel=a,this.endpoint=this.modelstring+"ids",this.parameters=b):this.following="following?"+$.param(b);this.fetch({following:!a,success:this.touchresponse.bind(this,this.url())})},updates:function(a){for(n in a){var b=this.get(a[n]);b&&b.get("objectType")&&(Store.set(this.typestring,{id:a[n],outdated:!0}),b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});
this.updates([a])}});Cloudwalkers.Collections.Notes=Backbone.Collection.extend({model:Cloudwalkers.Models.Note,typestring:"notes",modelstring:"note",parameters:{},paging:{},cursor:!1,events:{remove:"destroy"},initialize:function(a,b){b&&$.extend(this,b);this.on("sync",function(){setTimeout(function(){this.isempty()}.bind(this),1)})},destroy:function(){console.log("collection destroyed");this.reset()},isempty:function(){0==this.length&&this.trigger("ready:empty")},url:function(){var a=[Cloudwalkers.Session.api];this.id?
a.push(this.typestring,this.id):this.parentmodel?"contacts"!=this.parentmodel.typestring?a.push(this.parentmodel.typestring,this.parentmodel.id,this.endpoint):"contacts"==this.parent.typestring&&(a.push("accounts/"+Cloudwalkers.Session.getAccount().id+"/contacts"),a.push(this.parent.id),a.push(this.typestring)):a.push(this.typestring);a=a.join("/");return this.parameters?a+"?"+$.param(this.parameters):a}});Cloudwalkers.Collections.Tags=Backbone.Collection.extend({model:Cloudwalkers.Models.Tag,typestring:"tags",modelstring:"tag",parameters:{},paging:{},cursor:!1,events:{remove:"destroy"},initialize:function(a){a&&$.extend(this,a);this.on("sync",function(){setTimeout(function(){this.isempty()}.bind(this),1)})},destroy:function(){this.reset()},isempty:function(){0==this.length&&this.trigger("ready:empty")},url:function(){var a=[Cloudwalkers.Session.api];"contacts"==this.parentmodel.typestring&&a.push("accounts/"+
Cloudwalkers.Session.getAccount().id);this.id?a.push(this.typestring,this.id):this.parentmodel?a.push(this.parentmodel.typestring,this.parentmodel.id,this.endpoint):a.push(this.typestring);a=a.join("/");return this.parameters?a+"?"+$.param(this.parameters):a}});Cloudwalkers.Collections.Channels=Backbone.Collection.extend({model:Cloudwalkers.Models.Channel,initialize:function(){Cloudwalkers.Session.user.account&&(Cloudwalkers.Session.getChannels().listenTo(this,"add",Cloudwalkers.Session.getChannels().distantAdd),this.on("destroy",this.cleanModel))},url:function(){var a=this.parameters?"?"+$.param(this.parameters):"";return Cloudwalkers.Session.api+"/account/"+Cloudwalkers.Session.getAccount().id+"/channels"+a},parse:function(a){this.parameters=!1;return a.channels},
distantAdd:function(a){this.get(a.id)||this.add(a)},seed:function(a){if(!a||!a.length)return[];var b=[];a=_.compact(a.map(function(a){channel=Cloudwalkers.Session.getChannel(a);this.add(channel?channel:{id:a});b.push(channel?channel:this.get(a));if(!channel||channel.outdated)return a},this));a.length&&(this.parameters={ids:a.join(",")},this.fetch());return b},cleanModel:function(a){a.get("parent")&&Cloudwalkers.Session.getChannel(a.get("parent")).set({channels:this.pluck("id")});Store.remove("channels",
{id:a.id})},updates:function(a){for(n in a){var b=this.get(a[n]);b&&b.get("objectType")&&(Store.set(this.typestring,{id:a[n],outdated:!0}),b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])}});Cloudwalkers.Collections.Streams=Backbone.Collection.extend({model:Cloudwalkers.Models.Stream,initialize:function(){Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getStreams().listenTo(this,"add",Cloudwalkers.Session.getStreams().distantAdd)},url:function(){var a=this.parameters?"?"+$.param(this.parameters):"";return Cloudwalkers.Session.api+"/account/"+Cloudwalkers.Session.getAccount().id+"/streams"+a},parse:function(a){this.parameters=!1;return a.streams},sync:function(a,b,c){c.headers=
{Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};return Backbone.sync(a,b,c)},distantAdd:function(a){this.get(a.id)||this.add(a)},updates:function(a){for(n in a){var b=this.get(a[n]);b&&b.get("objectType")&&(Store.set(this.typestring,{id:b.id,outdated:!0}),b.outdated=!0,b.trigger("outdated",b))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])},seed:function(a){if(!a||!a.length)return[];var b=[];a=_.compact(a.map(function(a){stream=
Cloudwalkers.Session.getStream(a);this.add(stream?stream:{id:a});b.push(stream?stream:this.get(a));if(!stream)return a},this));a.length&&(this.parameters={ids:a.join(",")},this.fetch());return b},parsecontacts:function(){console.log(this)},filterNetworks:function(a,b){a||(a=this.models);var c={};$.each(a,function(a,b){var e=b.attributes?b.get("network"):b.network;c[e.token]||(c[e.token]={ids:[],icon:e.icon,token:e.token});c[e.token].ids.push(b.id)});if(!b)return c;var e=[];$.each(c,function(a,b){b.ids=
b.ids.join(" ");e.push(b)});return e},filterReportStreams:function(){return{}}});Cloudwalkers.Collections.Messages=Backbone.Collection.extend({model:Cloudwalkers.Models.Message,typestring:"messages",modelstring:"message",parameters:{},paging:{},cursor:!1,events:{remove:"destroy"},initialize:function(a){a&&$.extend(this,a);Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getMessages().listenTo(this,"add",Cloudwalkers.Session.getMessages().distantAdd);this.on("sync",function(){setTimeout(function(){this.isempty()}.bind(this),1)})},destroy:function(){console.log("collection destroyed");
this.reset()},isempty:function(){0==this.length&&this.trigger("ready:empty")}});Cloudwalkers.Collections.CannedResponses=Backbone.Collection.extend({model:Cloudwalkers.Models.CannedResponse,touched:!1,initialize:function(){Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getCannedResponses().listenTo(this,"add",Cloudwalkers.Session.getCannedResponses().distantAdd)},url:function(){var a=Cloudwalkers.Session.api+"/streams/"+Cloudwalkers.Session.getAccount().id+":canned/messages";return this.parameters?a+"?"+$.param(this.parameters):a},sync:function(a,b,c){c.headers={Authorization:"Bearer "+
Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};this.parameters=c.parameters;return"update"==a?!1:Backbone.sync(a,b,c)},parse:function(a){return a.stream.messages},store:function(a,b){"delete"==a&&Store.remove("campaigns",{id:b.id})},removecanned:function(a){var b;$.each(this.models,function(c,e){if(e.id==a)return b=this.models.splice(c,1),!1}.bind(this));if(b)return b}});Cloudwalkers.Collections.Related=Cloudwalkers.Collections.Messages.extend({typestring:"related",modelstring:"related",parenttype:"message"});Cloudwalkers.Collections.RelatedNotes=Cloudwalkers.Collections.Notes.extend({typestring:"related",modelstring:"related",parenttype:"note"});Cloudwalkers.Collections.Notifications=Cloudwalkers.Collections.Messages.extend({model:Cloudwalkers.Models.Notification,typestring:"notifications",modelstring:"notification",initialize:function(){Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getNotifications().listenTo(this,"add",Cloudwalkers.Session.getNotifications().distantAdd);this.on("destroy",this.destroy);this.on("sync",function(){setTimeout(function(){this.isempty()}.bind(this),1)})}});Cloudwalkers.Collections.Actions=Backbone.Collection.extend({model:Cloudwalkers.Models.Action,typestring:"actions",modelstring:"action",token:"",templates:{share:{name:"Share",icon:"share-alt",token:"share",type:"write",maxsize:{twitter:140},clone:!0,redirect:!1},"delete":{name:"Delete",icon:"remove",token:"delete",type:"confirm"},edit:{name:"Edit",icon:"edit",token:"edit",type:"edit",redirect:!1},note_view:{name:"Note",icon:"edit",token:"note",type:"note",compound:"note",valuetag:"notes",hidemetoken:"hidden"},
note_manage:{name:"Add note",icon:"edit",token:"note",type:"note",compound:"note"},tag:{name:"tag",icon:"edit",token:"tag",type:"tag"},reply:{name:"Reply",icon:"comments-alt",token:"reply",type:"write",clone:!0,parameters:[{token:"message",name:"Message",type:"string",required:!1,value:"@{{from.name}} "}]},dm:{name:"DM",icon:"comments-alt",token:"dm",type:"dialog",clone:!0,parameters:[{token:"message",name:"Message",type:"string",required:!1,value:""}]},comment:{name:"Comment",icon:"comment",token:"comment",
type:"dialog",clone:!0,maxsize:{twitter:140},parameters:[{token:"message",name:"Message",type:"string",required:!1,value:""}]},retweet:{name:"Retweet",icon:"retweet",token:"retweet",type:"options"},like:{name:"Like",icon:"thumbs-up",token:"like",type:"options",toggle:"unlike"},unlike:{name:"Unlike",icon:"thumbs-down",token:"unlike",type:"growl",toggle:"like",actiontype:"like"},favorite:{name:"Favorite",icon:"star",token:"favorite",type:"options",toggle:"unfavorite"},unfavorite:{name:"Unfavorite",
icon:"star-empty",token:"unfavorite",type:"growl",toggle:"favorite",actiontype:"favorite"},plusone:{name:"Unfavorite",icon:"google-plus-sign",token:"plusone",type:"options",toggle:"unplusone"},unplusone:{name:"Unfavorite",icon:"google-plus-sign",token:"unplusone",type:"growl",toggle:"plusone",actiontype:"plusone"}},initialize:function(a,b){b&&$.extend(this,b);this.listenTo(this.parent,"action",this.startaction)},parse:function(a){return a},url:function(){var a=this.parameters?"?"+$.param(this.parameters):
"",b=this.parent?this.parent.get("objectType")+"s/"+this.parent.id:"";return Cloudwalkers.Session.api+"/"+b+"/actions"+a},rendertokens:function(a){var b=this.parent.get("stats");a||(a=this.parent.get("actiontokens"));return a.map(function(a){b&&this.appendstat(a);return this.templates[a]}.bind(this))},appendstat:function(a){if(this.templates[a]){var b=this.templates[a].valuetag||null;b&&this.parent.get("stats").hasOwnProperty(b)&&(this.templates[a].value=this.parent.get("stats")[b])}},startaction:function(a){var b=
this.templates[a];this.listenTo(Cloudwalkers.RootView,a.concat(":success"),this.toggleAction);if("confirm"==b.type)this[a](this.parent);else{if("growl"==b.type)return Cloudwalkers.RootView.growl(b.name,this.translateString("the")+" "+b.token+" "+this.translateString("is_planned_with_success")),b.id=1,b.parent=this.parent,(new Cloudwalkers.Models.Action(b)).destroy();if("note"==b.type)Cloudwalkers.RootView.writeNote(this.parent);else var c="edit"==b.type?{model:this.parent}:{reference:this.parent,
action:new Cloudwalkers.Models.Action(b)};Cloudwalkers.RootView.compose(c)}},"delete":function(a){a.deleteMessage()},like:function(){},toggleAction:function(a){this.parent.trigger("action:toggle",a,this.templates[this.templates[a].toggle])},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Collections.Reports=Backbone.Collection.extend({model:Cloudwalkers.Models.Report,typestring:"statistics",modelstring:"report",processing:!1,parameters:{},paging:{},cursor:!1,initialize:function(a){a&&$.extend(this,a);Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getReports().listenTo(this,"add",Cloudwalkers.Session.getReports().distantAdd)},distantAdd:function(a){this.get(a.id)||this.add(a)},url:function(){return Cloudwalkers.Session.api+"/streams/"+this.streamid+"/reports?complete=1"},
parse:function(a){this.parentmodel&&(a=a[this.parenttype]);for(n in a.reports)a.reports[n].streamid=this.streamid;return a.reports},sync:function(a,b,c){c.headers={Authorization:"Bearer "+Cloudwalkers.Session.authenticationtoken,Accept:"application/json"};this.processing=!0;return Backbone.sync(a,b,c)},hook:function(a){this.processing?this.length&&a.success():this.fetch({error:a.error});this.on("sync",a.success)},setcursor:function(a){if(!a)return!1;this.cursor=a.cursors?a.cursors.after:!1},touch:function(a,
b){this.parentmodel=a;this.endpoint=this.modelstring+"ids";this.parameters=b;Store.get("touches",{id:this.url(),ping:Cloudwalkers.Session.getPing().cursor},this.touchlocal.bind(this))},touchlocal:function(a){a&&a.modelids.length?(this.seed(a.modelids),this.cursor=a.cursor):this.fetch({success:this.touchresponse.bind(this,this.url())})},touchresponse:function(a,b,c){b=c[this.parenttype][this.typestring];Store.set("touches",{id:a,modelids:b,cursor:this.cursor,ping:Cloudwalkers.Session.getPing().cursor});
this.seed(b)},seed:function(a){a||(a=[]);var b=[];a=_.compact(a.map(function(a){model=Cloudwalkers.Session.getReport(a);this.add(model?model:{id:a});model||(model=this.get(a));b.push(model.stamp());if(!model||!model.get("objectType")||model.outdated)return a},this));a.length&&(this.endpoint=this.parentmodel?this.typestring:null,this.parameters={ids:a.join(",")},this.fetch());this.trigger("seed",b);return b}});Cloudwalkers.Collections.Statistics=Backbone.Collection.extend({model:Cloudwalkers.Models.Statistic,typestring:"statistics",modelstring:"statistic",parenttype:"account",networkcolors:{facebook:"#3B5998",twitter:"#01a9da",linkedin:"#1783BC",tumblr:"#385775","google-plus":"#DD4C39",youtube:"#CC181E",web:"#f39501",blog:"#f39501","mobile-phone":"#E2EAE9",others:"#E5E5E5"},colors:"#D97041 #C7604C #21323D #9D9B7F #7D4F6D #584A5E".split(" "),processing:!1,parameters:{},paging:{},cursor:!1,initialize:function(a){a&&
$.extend(this,a);Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getReports().listenTo(this,"add",Cloudwalkers.Session.getReports().distantAdd)},touch:function(a,b){this.parentmodel=a;this.endpoint=this.modelstring+"ids";this.parameters=b;Store.get("touches",{id:this.url()},this.touchlocal.bind(this))},latest:function(){return this.at(this.length-1)},first:function(){return this.at(0)},place:function(a){return this.at(a)},parse:function(a){"string"==typeof a&&console.log("is string");this.parentmodel&&
(a=a[this.parenttype]);this.setcursor(a.paging);a.paging||this.ready();return a[this.typestring]},contacts:function(a){var b=this.latest(),c=[];if(!b.get("streams"))return c;a||$.each(b.get("streams"),function(a,b){var g=Cloudwalkers.Session.getStream(b.id);if(g){var g=g.get("network").token,h=b.contacts;h&&c.push({color:this.networkcolors[g],value:Number(h)})}}.bind(this));console.log("contacts list:",c);return c},age:function(a){return{counter:[]}},gender:function(a){return{counter:[]}},regional:function(a){return{counter:[]}},
countries:function(a){return{counter:[]}},cities:function(a){return{counter:[]}},besttime:function(a){return{counter:[]}},activity:function(a){return{counter:[]}},parsebesttime:function(){var a="Mon Tue Wed Thu Fri Sat Sun".split(" "),b,c=[],e=0,f=0,g,h=this.models;7<this.length&&(h=h.splice(7,h.length-1));$.each(a,function(m,l){var q=h[m],p=[];q&&q.get("streams")&&q.get("streams").forEach(function(a){a=new Cloudwalkers.Models.Stream(a);if(b=a.getbesttime())if(0==p.length)p=_.values(b);else for(i in b)p[i]+=
b[i],p[i]>e&&(e=p[i]),p[i]>f&&(f=p[i])});g=0<p.length?p.indexOf(Math.max.apply(Math,_.values(p))):-1;c.push({day:a.shift(),value:f,time:g});f=0});c.maxvalue=e;return c}});Cloudwalkers.Collections.Triggers=Backbone.Collection.extend({model:Cloudwalkers.Models.Trigger,typestring:"triggers",initialize:function(){},parse:function(a){return a.account.triggers},url:function(){var a=[Cloudwalkers.Session.api];this.parent?a.push(this.parent.typestring,this.parent.id,this.typestring):this.typestring&&a.push(this.typestring);return a.join("/")}});Backbone.View=Backbone.View.extend({loadListeners:function(a,b,c){var e=b.length,f="listenTo";c&&(f="listenToOnce");for(i in b)if(_.isArray(b[i]))for(n in b[i])this[f](a,b[i][n],this.loadRender.bind(this,Number(i)+1,e));else this[f](a,b[i],this.loadRender.bind(this,Number(i)+1,e));this.listenTo(a,"ready:empty",this.emptylist.bind(this));this.on("rendered",this.addLoader)},addLoader:function(){this.container=this.$loadercontainer?this.$loadercontainer:this.$container;this.loader=$(Templates.progressbar).appendTo(this.container)},
loadRender:function(a,b){if(this.loader){this.container.hasClass("empty-list")&&this.container.removeClass("empty-list");this.loader&&this.loader.hasClass("loaded")&&this.restart();this.loader&&(this.loader.hasClass("loading")&&1==a)&&this.restart();b==a&&this.finishLoading();var c=this;setTimeout(function(){var e=105*a/b;!c.loadingstate||c.loadingstate<=e?(c.loadingstate=e,c.loader&&c.loader.css("width",e+"%")):c.restart()},1)}},restart:function(){this.loadingstate=0;this.loader.remove();this.addLoader();
this.container.removeClass("loaded").addClass("toload")},finishLoading:function(){this.loader.css("width","100%");this.loader.addClass("loaded");this.container.removeClass("toload").addClass("loaded")},emptylist:function(){this.loadRender(99,99);this.container.addClass("empty-list")},counter:0,updateable:function(a,b){this.$countertarget=b?b:this.$container;this.listenTo(a?a:this.model,"outdated",this.showupdate)},showupdate:function(a){this.$counter||(this.$counter=$("<counter></counter>").appendTo(this.$countertarget).on("click",
function(){this.resetupdate();this.render()}.bind(this)));$(this.$loadercontainer?this.$loadercontainer:this.$container).addClass("outdated");this.$counter.html(++this.counter)},clearupdate:function(){this.$el.find(".outdated").removeClass("outdated");this.resetupdate()},resetupdate:function(){this.counter=0;this.$counter.remove()}});Cloudwalkers.Views.Root=Backbone.View.extend({view:null,header:null,footer:null,initialize:function(){this.navigation=new Cloudwalkers.Views.Navigation(this);this.navigation.fit();$(window).on("resize",this.resize.bind(this));this.resize()},render:function(){if(!this.view)return null;$("#inner-content").html(this.view.render().el);this.view.$el.trigger("rendered");this.view.finish&&this.view.finish();this.navigation.handleSidebarMenu()},setView:function(a){this.view&&this.view.remove();Cloudwalkers.Session.trigger("destroy:view");
this.view=a;this.render();Cloudwalkers.Session.manage()},viewshare:function(){this.share.show()},height:function(a){var b=$(window).height(),c=$(c).height();return a?c>b?c:b:b},resize:function(){var a=this.height(!0);this.trigger("resize",a);$("#inner-content").css("min-height",a-42+"px")},popup_new:function(a){var b=a.render().el,c=$(Mustache.render(Templates.popup,{title:a.title,actions:a.actions})).modal();c.find(".modal-body").html(b);if(a.actions)c.find(".modal-footer [data-action]").on("click",
function(a,b){this.trigger($(b.currentTarget).data("action"),a)}.bind(a,c));c.on("hide",function(){this.remove()}.bind(a))},popup:function(a){var b=this,c=$(Templates.uipopup).modal();c.find(".modalcontainer").html(a.render().el);a.on("popup:close",function(){c.modal("hide")});a.on("content:change",function(){b.trigger("content:change")})},compose:function(a){a?a.type="post":a={type:"post"};(new Cloudwalkers.Views.Compose(a)).render().$el.modal({backdrop:"static"})},viewContact:function(a){a||(a=
0);(new Cloudwalkers.Views.ViewContact({contact:a})).render().$el.modal()},writeNote:function(a){a=new Cloudwalkers.Views.ComposeNote({id:"compose",className:"modal hide note",thanks:!0,model:a});a.render().$el.modal();return a},writeMessage:function(a){a.preventDefault();if(b)b.type="post";else var b={type:"post"};b.redirect=!1;a=new Cloudwalkers.Views.Compose(b);this.setView(a)},editMessage:function(a){this.compose({model:a.clone(),redirect:!1})},writeDialog:function(a,b){var c=b.parameters;"edit"==
b.token?this.compose({model:a.clone(),clone:!1,redirect:!1}):this.compose({model:a.clone(),clone:!0,actionparameters:c,redirect:!1,type:"post"})},shareMessage:function(a){this.compose({model:a.clone(),clone:!0,redirect:!1})},confirm:function(a,b,c){var e={};e.message=a;e.options=[{token:"confirm",label:this.translateString("yes"),description:"Confirm your action"}];e.translate_close=this.translateString("close");a=Mustache.render(Templates.uiconfirm,e);a=$(a);var f=a.modal();a.find("[data-response=confirm]").click(function(){b();
f.modal("hide")});a.find("[data-dismiss=modal]").click(function(){c&&c()})},alert:function(a,b){var c={};c.message=a;c.translate_close=this.translateString("close");var c=Mustache.render(Templates.uiconfirm,c),c=$(c),e=c.modal();c.find("[data-response=confirm]").click(function(){b();e.modal("hide")})},growl:function(a,b){$.gritter.add({title:a,text:b,time:4E3})},information:function(a,b,c){c||(c="#inner-content .container-fluid");$(c).prepend("<div class='alert alert-info'><button type='button' class='close' data-dismiss='alert'>&times;</button><strong>"+
a+"</strong> "+b+"</div>")},closeInformation:function(a,b,c){$("div.alert.alert-info").remove()},dialog:function(a,b,c){var e={};e.message=a;e.options=b;e.translate_close=this.translateString("close");a=Mustache.render(Templates.uidialog,e);var f=$(a),g=f.modal();a=function(a){f.find("[data-response="+a.token+"]").click(function(){c(a);g.modal("hide")})};for(e=0;e<b.length;e++)a(b[e])},imagePopups:function(){$("a.image-popup-viewer").fancybox()},resync:function(a){setTimeout(function(){Cloudwalkers.Router.Instance.navigate("#resync");
var b=new Cloudwalkers.Views.Resync({returnto:a});this.setView(b)}.bind(this))},oops:function(){Cloudwalkers.Router.Instance.navigate("#dashboard",!0);Cloudwalkers.RootView.growl(this.translateString("oops"),this.translateString("something_went_sideways"))},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Navigation=Backbone.View.extend({views:[{name:"dashboard",title:"Dashboard",icon:"dashboard",authorized:0},{name:"inbox",title:"Inbox",icon:"inbox",authorized:0,children:[{name:"messages",title:"Messages",icon:"envelope",authorized:0},{name:"notifications",title:"Notifications",icon:"globe",authorized:0},{name:"post",title:"Post message",icon:"pencil",url:!1,authorized:0,attributes:{"data-header-action":"post"}},{name:"drafts",title:"Drafts",icon:"edit",url:"#drafts",authorized:0},
{name:"scheduled",title:"Scheduled",icon:"time",url:"#drafts",authorized:0}]},{name:"coworkers",title:"Co-workers wall",icon:"group",authorized:0},{name:"profiles",title:"Company accounts",build:"profiles",icon:"briefcase",authorized:0,childicons:["briefcase","thumbs-up"]},{name:"news",title:"Profiles We Follow",build:"news",icon:"globe",authorized:0,childicons:["globe","thumbs-up"]},{name:"monitoring",title:"Keyword Monitoring",build:"monitoring",icon:"tags",authorized:0,childicons:["tags","plus"]},
{name:"statistics",title:"Statistics",build:"reports",icon:"bar-chart",authorized:0},{name:"settings",title:"Settings",icon:"cogs",url:"#settings/users",authorized:0,children:[{name:"users",title:"Manage users",icon:"group",authorized:0},{name:"networks",title:"Social Connections",icon:"cloud",authorized:0},{name:"post",title:"Post message",icon:"pencil",url:!1,authorized:0,attributes:{"data-header-action":"post"}},{name:"settings",title:"Account Settings",icon:"briefcase",url:"#settings/account",
authorized:0},{name:"profile",title:"Profile settings",icon:"user",authorized:0}]}],events:{"click .notification-toggle":"toggleNotifications","click .btn-compose":"compose","click #writenote":"writenote"},initialize:function(){Cloudwalkers.Session.on("change:accounts",this.renderHeader,this);this.listenTo(Cloudwalkers.Session.getChannels(),"sync",this.render);this.listenTo(Cloudwalkers.Session.getChannels(),"remove",this.render)},headeraction:function(a){a=$(a.currentTarget).data("header-action");
"messages"==a&&Cloudwalkers.Router.Instance.navigate("#inbox/messages",!0);"contacts"==a&&Cloudwalkers.Router.Instance.navigate("#coworkers",!0);"post"==a&&Cloudwalkers.RootView.compose();"writenote"==a&&this.writenote()},fit:function(){$("#header").html(this.renderHeader().header);$("#sidebar").html(this.render().el);$("#header, #sidebar").on("click","*[data-header-action]",this.headeraction.bind(this))},version:function(a){if("TESTING"==a.platform.name||"DEVELOPMENT"==a.platform.name)this.development=
!0,$("#header").html(this.renderHeader().header)},renderHeader:function(){var a={dev:this.development};a.user=Cloudwalkers.Session.user.attributes;a.accounts=[];a.level=Cloudwalkers.Session.getUser().level;this.mustacheTranslateRenderHeader(a);Cloudwalkers.Session.user.accounts.each(function(b){a.accounts.push({name:b.get("name"),id:b.id,active:b.id==Cloudwalkers.Session.get("currentAccount")})});Cloudwalkers.Session.censuretemplate(a);this.header=Mustache.render(Templates.header,a);return this},
render:function(){var a=Cloudwalkers.Session.getAccount(),b={reports:[]};b.level=Cloudwalkers.Session.getUser().level;this.mustacheTranslateRender(b);Cloudwalkers.Session.isAuthorized("MESSAGE_READ_THIRDPARTY")&&(b.news=a.channels.findWhere({type:"news"}),b.news&&(b.news=a.channels.findWhere({type:"news"}).id));if(Cloudwalkers.Session.isAuthorized("MESSAGE_READ_MONITORING")){var c=a.channels.findWhere({type:"monitoring"});for(n in c.channels.models)if(c.channels.models[n].attributes.channels.length){this.first=
c.channels.models[n];break}c&&(b.monitoring={channelid:c.id,first:this.first,channels:c.channels.models,name:c.get("name")})}Cloudwalkers.Session.isAuthorized("MESSAGE_READ_SCHEDULE")&&(b.scheduled={channelid:Cloudwalkers.Session.getChannel("internal").id},b.scheduled.streams=a.streams.where({outgoing:1}));Cloudwalkers.Session.isAuthorized("_CW_INBOX_VIEW")&&(b.inbox=!0);Cloudwalkers.Session.isAuthorized("MESSAGE_READ_COMPANY")&&(c=a.channels.findWhere({type:"profiles"}),b.profiles={channelid:c.id,
streams:c.streams.models,name:c.get("name")});Cloudwalkers.Session.isAuthorized("STATISTICS_VIEW")&&(b.reports=a.streams.where({statistics:1}).map(function(a){return a.attributes}));Cloudwalkers.Session.censuretemplate(b);this.$el.html(Mustache.render(Templates.navigation,b));this.handleSidebarMenu();return this},handleSidebarMenu:function(){var a=Backbone.history.fragment;if(!a)return null;this.setActive(a)},compose:function(){Cloudwalkers.RootView.compose()},writenote:function(){var a=Cloudwalkers.Session.getAccount();
Cloudwalkers.RootView.writeNote(a)},setActive:function(a){$("#sidebar .active").removeClass("active");$('a[href="#'+a+'"]').parents("#sidebar .page-sidebar-menu *").addClass("active")},setNotifications:function(a){this.$el.find(".popup-frame ul").html("");for(var b=0;b<a.length;b++)this.addNotification(a[b])},addNotification:function(a){this.$el.find(".popup-frame ul").append('<li><div class="text account"><p>'+a.message+'</p><div class="row"><span class="time"></span></div></div></li>')},toggleNotifications:function(){this.$el.find(".notification-popup").toggle()},
mapViews:function(){var a={};for(n in this.views)if(a[this.views[n].name]={streams:[]},this.views[n].children)for(i in this.views[n].children)a[this.views[n].children[i].name]={streams:[]};return a},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRenderHeader:function(a){this.original=["write_note","clean","support","profile_settings","log_out"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+
this.original[k]]=this.translated[k]},mustacheTranslateRender:function(a){this.original="compose dashboard message_board compose_message drafts scheduled inbox messages notifications post_message calendar co-workers_wall company_accounts media trending_posts accounts_we_follow keyword_monitoring manage_accounts manage_keywords reports settings manage_users social_connections account_settings profile_settings manage_user_groups notes".split(" ");this.translated=[];for(k in this.original)this.translated[k]=
this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Compose=Backbone.View.extend({id:"compose",className:"modal hide",type:"post",network:"default",actionstreams:[],actionview:!1,minutestep:5,maxfilesize:3E6,besttimes:{},titles:{post:"Write Post",edit:"Edit Post",share:"Share message",comment:"Write Comment",reply:"Write Reply",dm:"Write Message",retweet:"Retweet",like:"Like",favourite:"Favourite",plusone:"Plus one","default":"Compose"},translated_titles:{},limitations:{},options:{"false":["editor","images","campaign","schedule",
"repeat"],twitter:["editor","images","campaign","schedule","repeat"],facebook:"editor fullbody images campaign schedule repeat".split(" "),linkedin:"editor fullbody images campaign schedule repeat".split(" "),tumblr:"subject editor fullbody images campaign schedule repeat".split(" "),"google-plus":"editor fullbody images campaign schedule repeat".split(" "),youtube:"subject editor fullbody video campaign schedule repeat".split(" "),blog:"subject editor fullbody images campaign schedule repeat".split(" "),
group:["editor","images","campaign","schedule","repeat"],"mobile-phone":["editor","schedule","repeat"],comment:["editor","canned"],reply:["editor","canned"],dm:["editor","canned"],retweet:["icon"],like:["icon"],favorite:["icon"],plusone:["icon"]},icons:{retweet:"retweet",like:"thumbs-up",favorite:"star",plusone:"plus-square"},events:{"click li[data-streams]":"togglestreams","click .stream-tabs div":"togglestream","click [data-toggle]":"toggleoption","keyup [data-option] input":"monitor","change [data-option] #compose-content":"monitor",
"keyup [data-option] #compose-content":"monitor","paste [data-option] #compose-content":"triggerpaste","blur [data-option] #compose-content":"triggerblur","click .add-file":"addfile","click .add-snapshot":"addsnapshot","change [data-collapsable=images] input":"listentofiles","click .photo-booth":"listentobooth","click li.images-thumb":"removefile","blur [data-collapsable=link] input":"listentolink","change select.campaign-list":"listentocampaign","change select.canned-list":"listentocanned","blur .campaign-name":"listentoaddcampaign",
"click .add-campaign":"toggleaddcampaign","click .schedule-entry":"monitorschedule","blur [data-collapsable=schedule] input, [data-collapsable=repeat] input":"monitorschedule","change .schedule-group select":"monitorschedule","click .schedule-group input":"monitorschedule","click [data-set=on] .btn-white":"togglebesttime","click .end-preview":"endpreview","click #previewbtn":"preview","click #save":"save","click #post":"post","click #action, [data-type=icon] > i":"postaction"},initialize:function(a){a&&
$.extend(this,a);this.streams=Cloudwalkers.Session.getChannel("outgoing").streams;this.action&&(this.type=this.action.get("token"));this.action&&"share"==this.type?(this.draft=this.reference.cloneSanitized(),this.draft.attributes.variations=[]):this.action&&this.reference?(this.action.parent=this.reference,this.actionstreams=[],this.actionview=!0,this.listenTo(this.action,"change",this.editstreams),this.action.fetch()):this.model&&(this.type="edit",this.state="loading",this.draft=this.model.clone(),
this.draft.get("streams").length&&(this.initstream=this.draft.get("streams")[0].id),this.draft.fetch({endpoint:"original",success:this.original.bind(this)}));this.draft||(this.draft=new Cloudwalkers.Models.Message({variations:[],attachments:[],streams:[],body:{},schedule:{}}),this.listenTo(this.draft,"invalid",this.invalid));this.loadmylisteners();"reply"==this.type&&"twitter"==this.reference.get("networktoken")&&this.draft.set("body",{html:Mustache.render(this.action.parameters[0].value,{from:this.reference.get("from")[0]})});
this.censurecompose();this.translateTitles()},loadmylisteners:function(){this.loadListeners(this.draft,["request","sync"],!0)},censurecompose:function(){var a=[];$.each({MESSAGE_OUT_ATTACHMENTS:["images"],MESSAGE_OUT_SCHEDULE:["schedule"],MESSAGE_OUT_REPEAT:["repeat"],CAMPAIGN_CREATE:["campaign"]},function(b,c){Cloudwalkers.Session.isAuthorized(b)||(a=_.union(a,c))});$.each(this.options,function(b,c){this.options[b]=_.difference(c,a)}.bind(this))},original:function(){var a,b=this.draft.get("schedule");
b&&b.date&&(b.date=moment(b.date).unix());b&&(b.repeat&&b.repeat.until)&&(b.repeat.until=moment(b.repeat.until).unix());(a=this.draft.get("variations"))&&$.each(a,function(a,b){b.schedule&&b.schedule.date&&(b.schedule.date=moment(b.schedule.date).unix());b.schedule&&!b.schedule.date&&(b.schedule.now=!0);b.schedule&&(b.schedule.repeat&&b.schedule.repeat.until)&&(b.schedule.repeat.until=moment(b.schedule.repeat.until).unix());b.attachments&&b.attachments.length&&(b.attachments=[b.attachments.pop()])});
this.state="loaded";this.render();this.$el.find("[data-stream="+this.initstream+"]").click()},render:function(){var a={streams:this.actionstreams.length?this.actionstreams:this.streams.models,title:this.translated_titles[this.type],campaigns:Cloudwalkers.Session.getAccount().get("campaigns"),actionview:this.actionview?this.type:!1};"edit"==this.type&&(a.type=this.type);this.mustacheTranslateRender(a);Cloudwalkers.Session.censuretemplate(a);a=Mustache.render(Templates.compose,a);this.$el.html(a);"loading"==
this.state&&this.disablefooter();this.editor||(this.editor=new Cloudwalkers.Views.Editor({draft:this.draft,parent:this}));this.$el.find("[data-type=post]").append(this.editor.render().el);this.listenTo(this.editor,"imageadded",this.listentourlfiles);this.listenTo(this.editor,"change:content",this.monitor);this.$el.find(".campaign-list").chosen({width:"50%"});this.$el.find(".canned-list").chosen({width:"100%"});this.$el.find("#delay-date, #repeat-until").datepicker({format:"dd-mm-yyyy",weekStart:1});
this.datepicker=this.$el.find("#delay-date, #repeat-until").datepicker({format:"dd-mm-yyyy",orientation:"auto"});this.timepicker=this.$el.find("#delay-time").timepicker({template:"dropdown",minuteStep:this.minutestep,showMeridian:!1});this.timepicker.on("show.timepicker",function(a){this.monitorschedule(a)}.bind(this));this.timepicker.on("hide.timepicker",function(a){this.monitorschedule(a)}.bind(this));this.$loadercontainer=this.$el.find(".modal-footer");"loaded"==this.state&&this.$el.find(".modal-body").addClass("loaded");
if(void 0!==this.draft.get("variations")||"share"==this.type)this.defaultstreams(),this.togglesubcontent(),this.trigger("rendered");return this},option:function(a){var b=this.options[this.type];return b?0<=b.indexOf(a):!1},restarttime:function(){var a=this.minutestep*Math.ceil(moment().minute()/this.minutestep),b=moment().hour();this.$el.find("#delay-time").timepicker("setTime",b+":"+a)},restartdate:function(){$(this.datepicker.get(0)).datepicker("update",moment.unix().format("DD/MM/YYYY"))},editstreams:function(a){var b=
a.get("actions").filter(function(b){if(b.token==a.token)return b.streams})[0];this.actionstreams=[];for(n in b.streams)Cloudwalkers.Session.getStream(b.streams[n])&&this.actionstreams.push(Cloudwalkers.Session.getStream(b.streams[n]));this.render();this.$el.find("aside li").eq(0).click()},monitor:function(a){var b=a?$(a.target):this.$el.find("#compose-content");this.editor.trigger("change:editor",a);a=this.activestream?this.activestream.id:!1;var c=b.html()||b.val(),e=b.text(),b=b.attr("data-option");
"body"==b&&(c={html:c,plaintext:e});a?this.draft.setvariation(a,b,c):this.draft.set(b,c)},updatelimitations:function(a,b){if(a){var c=Cloudwalkers.Session.getStream(a).getlimitations(),e=0;if(a&&this.draft.getvariation(a,"image")){var f=this.draft.getvariation(a,"image");$.each(f,function(b,c){e+=this.draft.getvariation(a,"image").length}.bind(this))}else this.draft.get("attachments")&&(f=this.draft.get("attachments").filter(function(a){if("image"==a.type)return a}),$.each(f,function(b,c){if(a&&this.draft.checkexclude(a,
b))return!0;e++}.bind(this)));e&&c["picture-url-length"]?this.editor.trigger("update:limit",c["picture-url-length"].limit,b):this.editor.trigger("update:limit",0,b)}else this.editor.trigger("update:limit",0)},toggleoption:function(a){a=$(a.currentTarget);var b=a.data("toggle");if(a.parent().toggleClass("collapsed").hasClass("collapsed")&&this["summarize"+b])this["summarize"+b]();this.$el.addClass("hidden");this.$el.removeClass("hidden")},closealloptions:function(){this.$el.find("[data-collapsable]").not(".collapsed").addClass("collapsed").each(function(a,
b){this["summarize"+$(b).data("collapsable")]()}.bind(this))},defaultstreams:function(){var a=this.draft.get("streams");a&&a.forEach(function(a){this.$el.find("li[data-streams="+(a.id?a.id:a)+"]").click()}.bind(this))},addstreamtab:function(a){this.$el.find(".tabs-container > section").append('<div class="stream-tab" data-stream="'+a.id+'"><i class="icon-'+a.get("network").icon+'"></i> '+a.get("defaultname")+"</div>")},togglestreams:function(a){var b=this.$el.find(".tabs-container > section");a=$(a.currentTarget);
var c=a.data("streams"),e=Cloudwalkers.Session.getStream(c),f=this.draft.get("streams")||[];a.hasClass("active")?(this.$el.find("[data-stream="+c+"]").remove(),b.find("div.active").size()||(b=this.$el.find(".stream-tabs div").eq(0),b.data("stream"),b.addClass("active"),this.trigger("update:streams",f)),f.splice(f.indexOf(c),1),this.draft.removevariation(c)):(this.addstreamtab(e),0>f.indexOf(c)&&f.push(c));a.toggleClass("inactive active");this.isscrolling()?this.$el.find(".stream-tabs").addClass("scrolling"):
this.$el.find(".stream-tabs").removeClass("scrolling")},togglestream:function(a){a=$(a.currentTarget);var b=a.data("stream"),b=b?Cloudwalkers.Session.getStream(b):!1;this.$el.find(".stream-tabs div.active").removeClass("active social-icon-colors");a.addClass("active social-icon-colors");this.toggleschedentry("[data-set=now], [data-set=in]").toggleschedentry("[data-set=on]",!0);this.togglesubcontent(b)},togglesubcontent:function(a){this.activestream=a;if(this.actionview)var b=this.options[this.type],
c=!1;else var c=a?a.get("network").token:!1,e=a?a.get("network").icon:"default",b=this.options[c],f=a?a.id:!1;this.network=c;this.$el.find("#previewbtn").attr("disabled",this.network?!1:!0);this.$el.find(".modal-body").hasClass("loading")||(this.$el.find(".modal-body").get(0).className="modal-body",this.$el.find(".modal-body").addClass(e+"-theme"));0<=b.indexOf("subject")?this.$el.find("[data-option=subject].hidden").removeClass("hidden"):this.$el.find("[data-option=subject]").addClass("hidden");
0<=b.indexOf("editor")?this.$el.find("#editor.hidden").removeClass("hidden"):this.$el.find("#editor").addClass("hidden");0<=b.indexOf("canned")?this.$el.find("[data-type=canned]").removeClass("hidden"):this.$el.find("[data-type=canned]").addClass("hidden");0<=b.indexOf("fullbody")?this.$el.find("[data-option=limit]").addClass("hidden"):this.$el.find("[data-option=limit].hidden").removeClass("hidden");0<=b.indexOf("icon")?this.$el.find("[data-type=icon]").removeClass("hidden").find("i").get(0).className=
"icon-"+this.icons[this.type]:this.$el.find("[data-type=icon]").addClass("hidden");this.updateschedule();this.closealloptions();this.toggleimages(0<=b.indexOf("images"),0<=b.indexOf("multiple"));this.togglecampaign(0<=b.indexOf("campaign"));this.toggleschedule(0<=b.indexOf("schedule"));this.togglerepeat(0<=b.indexOf("repeat"));this.updatesubject();this.updateimages();this.summarizeschedule();this.updatelimitations(a?a.id:null);this.trigger("update:stream",{id:f,data:this.draft.getvariation(f,"body")})},
updatesubject:function(){var a=this.activestream?this.activestream.id:!1,b=this.$el.find("[data-option=subject] > input").empty(),c;a&&this.draft.getvariation(a,"subject")?c=this.draft.getvariation(a,"subject"):this.draft.get("subject")&&(c=this.draft.get("subject")||"");b.val(c)},addfile:function(a){$("[data-collapsable=images] input").click()},listentofiles:function(a){for(var b=this.activestream?this.activestream.id:!1,c=a.target.files,e=this,f=0;a=c[f];f++)if(a.type.match(/^image\/(gif|jpg|jpeg|png)$/i))if(a.size>
this.maxfilesize)this.showerror("Upload failed: ","image size exceeds 3mb");else{c=new FileReader;c.onload=function(a){return function(c){e.addimage({type:"image",data:c.target.result,name:a.name});e.updatelimitations(b,!0);e.editor.trigger("change:charlength")}}(a);c.readAsDataURL(a);break}else this.showerror("Upload failed: ","only .jpg .jpeg .png and .gif extensions supported")},listentourlfiles:function(a){var b=this.activestream?this.activestream.id:!1,c=0;b&&this.draft.getvariation(b,"image")&&
(c+=this.draft.getvariation(b,"image").length);this.draft.get("attachments")&&(imgs=this.draft.get("attachments").filter(function(a){if("image"==a.type)return a}),c+=imgs.length);c||this.addimage(a)},addimage:function(a){var b=this.activestream?this.activestream.id:!1;b?this.draft.setvariation(b,"image",a):this.draft.attach(a);this.summarizeimages(a);this.listimage(a);this.disableimages()},summarizeimages:function(a){if(a){var b=a.data||a.url,c=this.$el.find("[data-collapsable=images] .summary");
$("<li></li>").prependTo(c).attr("data-filename",a.name).css("background-image","url("+b+")")}},listimage:function(a){var b=a.data||a.url,c=this.$el.find("ul.pictures-container");$("<li></li>").prependTo(c).attr("data-filename",a.name).addClass("images-thumb").css("background-image","url("+b+")")},updateimages:function(){var a=this.activestream?this.activestream.id:!1;this.$el.find("[data-collapsable=images] .summary").empty();var b=this.$el.find("ul.pictures-container").empty();this.$el.find("ul.snapshots-container").empty();
if(a&&this.draft.getvariation(a,"image")&&this.draft.getvariation(a,"image").length){var c=this.draft.getvariation(a,"image");$.each(c,function(a,b){this.summarizeimages(b);this.listimage(b)}.bind(this))}else this.draft.get("attachments")&&(c=this.draft.get("attachments").filter(function(a){if("image"==a.type)return a}),$.each(c,function(b,c){if(a&&this.draft.checkexclude(a,b))return!0;this.summarizeimages(c);this.listimage(c)}.bind(this)));0==b.find("li.images-thumb").length&&this.enableimages()},
toggleimages:function(a,b){this.$el.find("[data-collapsable=images]")[a?"removeClass":"addClass"]("hidden")},addsnapshot:function(a){this.$el.find(".photo-booth").removeClass("hidden");this.media||(this.media=new MediaClass({video:!0}));this.media.start()},listentobooth:function(){if(this.media){var a=this.media.snapshot();$("<li></li>").prependTo("ul.snapshots-container").attr("data-filename",moment().unix()).addClass("images-thumb").css("background-image","url("+a+")");this.disableimages();this.draft.attach({type:"image",
data:a,name:moment().unix()});this.$el.find(".photo-booth").addClass("hidden")}},removefile:function(a){var b=this.activestream?this.activestream.id:!1;a=$(a.currentTarget).remove();var c=this.draft.get("attachments")||[],e;for(n in c)if("image"==c[n].type&&c[n].name==a.data("filename")){e=parseInt(n);break}b?(this.draft.removevarimg(b,_.isNumber(e)?e:a.data("filename")),this.updatelimitations(b,!0),this.editor.trigger("change:charlength")):(c.splice(e,1),this.draft.get("variations")&&$.each(this.draft.get("variations"),
function(a,b){b.excludes&&(b.excludes.attachments=_.difference(b.excludes.attachments,[e]))}));this.$el.find('[data-collapsable=images] .summary [data-filename="'+a.data("filename")+'"]').remove();0==this.$el.find("ul.pictures-container li.images-thumb").length&&this.enableimages()},enableimages:function(){this.$el.find("ul.pictures-container").append('<li class="add-file">+</li>');this.$el.find("ul.snapshots-container").append('<li class="add-snapshot">+</li>')},disableimages:function(){this.$el.find("li.add-file").remove();
this.$el.find("li.add-snapshot").remove()},togglecampaign:function(a){this.$el.find("[data-collapsable=campaign]")[a?"removeClass":"addClass"]("hidden");return this},summarizecampaign:function(){var a=this.draft.get("campaign"),b=this.$el.find("[data-collapsable=campaign] .summary").empty();if(a){var c=Cloudwalkers.Session.getAccount().get("campaigns").filter(function(b){if(b.id==a)return b}).shift();b.html("<span>"+c.name+"</span>")}return this},listentocampaign:function(a){a=$(a.currentTarget).val();
var b=$(".chosen-single > span").get(0).textContent;0==a?this.removecampaign():(this.draft.set("campaign",Number(a)),this.trigger("update:campaign",b));this.summarizecampaign().$el.find("[data-collapsable=campaign]").addClass("collapsed")},toggleaddcampaign:function(){this.$el.find(".chosen-container, .campaign-name").toggleClass("hidden");return this},listentoaddcampaign:function(a){a=$(a.currentTarget).val();$(".chosen-single > span").get(0);Cloudwalkers.Session.getAccount().addcampaign(a,function(a){a=
a.get("campaigns");this.draft.set("campaign",a[a.length-1].id);this.trigger("update:campaign",a[a.length-1].name);this.reloadcampaigns(a);this.summarizecampaign().$el.find("[data-collapsable=campaign]").addClass("collapsed")}.bind(this))},reloadcampaigns:function(a){var b=this.$el.find(".campaign-list").empty();for(n in a)b.append($("<option value='"+a[n].id+"'>"+a[n].name+"</option>"));b.trigger("chosen:updated")},removecampaign:function(){this.draft.get("campaign")&&(delete this.draft.attributes.campaign,
this.trigger("update:campaign",null))},toggleschedule:function(a){this.$el.find("[data-collapsable=schedule]")[a?"removeClass":"addClass"]("hidden");return this},togglerepeat:function(a){this.$el.find("[data-collapsable=repeat]")[a?"removeClass":"addClass"]("hidden");return this},toggleschedentry:function(a,b){$(a)[b?"removeClass":"addClass"]("inactive").find("label")[b?"removeClass":"addClass"]("icon-circle-blank")[b?"addClass":"removeClass"]("icon-ok-circle");return this},parsemoment:function(a,
b){var c=moment(a.val(),"DD-MM-YYYY DD-MM-YY DD/MM/YYYY DD/MM/YY DDMMYYYY YYYYMMDD MM-DD-YYYY MM-DD-YY".split(" ")),e=b?b.val().split(":"):null,c=_.clone(c);e&&1<e.length&&c.add("minutes",60*Number(e[0])+Number(e[1]));return c.isValid()?c:void 0},parsescheduledate:function(a,b){var c=$(a),e=$(b);e.val()||this.restarttime();c.val()||this.restartdate();return c.val()&&e.val()?this.parsemoment(c,e):null},parserepeatdate:function(a){a=$(a);if(!a.val())return null;this.parsemoment(a)},updateschedule:function(){var a;
(a=this.draft.original(this.activestream,"schedule"))||(a=this.draft.original(null,"schedule"));this.toggleschedentry(".schedule-group [data-set]",!1).toggleschedentry("[data-set=now], [data-set=onlyonce]",!0);$("#delay-date, #delay-time, #repeat-interval, #repeat-amount, #repeat-until").val("").attr("disabled",!1);$("#repeat-interval, #repeat-amount").val(0);$("[data-set=in] .btn-white").addClass("inactive");$("#delay-select").val(600);$("#every-select").val(168);$("#every-select-weekday").val(0).attr("disabled",
!1);if(a&&a.date&&a.settings&&a.settings.delayselect)this.toggleschedentry("[data-set=now]").toggleschedentry("[data-set=in]",!0),$("#delay-select").val(a.settings.delayselect);else if(a&&a.date&&(this.toggleschedentry("[data-set=now]").toggleschedentry("[data-set=on]",!0),$(this.datepicker.get(0)).datepicker("update",moment.unix(a.date).format("DD/MM/YYYY")),this.timepicker.timepicker("setTime",moment.unix(a.date).format("HH:mm")),a.besttimetopost)){var b=this.$el.find("[data-set=on] .btn-white");
b.hasClass("inactive")&&b.toggleClass("inactive");$("#delay-time").attr("disabled",!0)}a&&a.repeat&&(a.repeat.interval&&(this.toggleschedentry("[data-set=onlyonce]").toggleschedentry("[data-set=every]",!0),[720,168,24,1].some(function(b){var e=a.repeat.interval/b/3600;if(Math.round(e)==e)return $("#repeat-interval").val(e),$("#every-select").val(b),!0})),a.repeat.weekdays&&a.repeat.weekdays.length&&$("#every-select-weekday").val(a.repeat.weekdays[0]),a.repeat.amount&&(this.toggleschedentry("[data-set=onlyonce]").toggleschedentry("[data-set=repeat]",
!0),$("#repeat-amount").val(a.repeat.amount)),a.repeat.until&&(this.toggleschedentry("[data-set=now]").toggleschedentry("[data-set=until]",!0),$(this.datepicker.get(1)).datepicker("update",moment.unix(a.repeat.until).format("DD/MM/YYYY"))))},monitorschedule:function(a,b){var c=b||$(a.currentTarget),c=(c.data("set")?c:c.parents("[data-set]").eq(0)).data("set"),e;(e=this.draft.original(this.activestream,"schedule"))||(e={repeat:{}});e.now&&delete e.now;"now"==c?(this.toggleschedentry("[data-set=in], [data-set=on]").toggleschedentry("[data-set=now]",
!0),$("[data-set=on] input").val("").attr("disabled",!1),$("[data-set=in] select").val(600),$("[data-set=in] .btn-white").addClass("inactive"),e={repeat:e.repeat,now:!0}):"in"==c?(this.toggleschedentry("[data-set=now], [data-set=on]").toggleschedentry("[data-set=in]",!0),$("[data-set=on] input").val("").attr("disabled",!1),$("[data-set=in] .btn-white").addClass("inactive")):"on"==c?(this.toggleschedentry("[data-set=now], [data-set=in]").toggleschedentry("[data-set=on]",!0),$("[data-set=in] select").val(600),
this.parsescheduledate("#delay-date","#delay-time"),e.settings&&e.settings.delayselect&&delete e.settings.delayselect):"onlyonce"==c?(this.toggleschedentry("[data-set=onlyonce]",!0).toggleschedentry("[data-set=repeat], [data-set=until], [data-set=every]",!1),$("#repeat-interval, #repeat-amount").val(0),$("#every-select").val(600),$("#every-select-weekday").val(0).attr("disabled",!1),$("#repeat-until").val(""),delete e.repeat):"every"==c?this.toggleschedentry("[data-set=every]",!0).toggleschedentry("[data-set=onlyonce]",
!1):"repeat"==c?(this.toggleschedentry("[data-set=every], [data-set=repeat]",!0).toggleschedentry("[data-set=onlyonce], [data-set=until]",!1),Number($("#repeat-interval").val())||$("#repeat-interval").val(1),Number($("#repeat-amount").val())||$("#repeat-amount").val(1),$("#repeat-until").val("")):"until"==c&&(this.toggleschedentry("[data-set=every], [data-set=until]",!0).toggleschedentry("[data-set=onlyonce], [data-set=repeat]",!1),Number($("#repeat-interval").val())||$("#repeat-interval").val(1),
$("#repeat-amount").val(0));this.draft.original(this.activestream,"schedule",e);this.parsescheduled();a.stopPropagation();return this},togglebesttime:function(a){var b;(b=this.draft.original(this.activestream,"schedule"))||(b={repeat:{}});$(a.currentTarget).toggleClass("inactive");$(a.currentTarget).hasClass("inactive")?$("#delay-time").attr("disabled",!1):$("#delay-time").attr("disabled",!0);b.besttimetopost=!$(a.currentTarget).hasClass("inactive");this.draft.original(this.activestream,"schedule",
b);return this},setbesttime:function(a){},hasbesttime:function(){var a=this.activestream?this.activestream.id:!1,b=a?this.streams.models.filter(function(b){return b.id==a}):!1;return b.length?b[0].get("bestTimeToPost"):!1},parsescheduled:function(){var a;(a=this.draft.original(this.activestream,"schedule"))||(a={repeat:{}});a.settings||(a.settings={});var b=this.$el.find("section[data-collapsable] .schedule-entry").not(".inactive").find("#delay-select, #delay-date, #delay-time, #repeat-interval, #every-select, #every-select-weekday, #repeat-amount, #repeat-until");
if(b.filter("#delay-select").val())a.settings.delayselect=$("#delay-select").val(),a.date=moment().add("seconds",a.settings.delayselect).unix();else if(b.filter("#delay-date").val()){var c=this.parsescheduledate("#delay-date","#delay-time");c&&(a.date=c.unix());b.filter("#delay-time").is("[disabled=disabled]")&&(a.besttimetopost=!0)}b.filter("#repeat-interval").val()&&(a.repeat||(a.repeat={interval:604800}),a.repeat.interval=$("#repeat-interval").val()?3600*$("#repeat-interval").val()*$("#every-select").val():
0,$("#every-select-weekday").val()&&(a.repeat.weekdays=[$("#every-select-weekday").val()]),$("#every-select-weekday").attr("disabled",168>$("#every-select").val()),a.repeat.amount=Number(b.filter("#repeat-amount").val())?Number($("#repeat-amount").val()):!1,a.repeat.until=b.filter("#repeat-until").val()?moment($("#repeat-until").val(),["DD-MM-YYYY","DD-MM-YY","DD/MM/YYYY"]).unix():!1);return a},summarizeschedule:function(){this.translate_best_time_to_post=this.translateString("best_time_to_post");
var a=this.parsescheduled(),b=this.$el.find("[data-collapsable=schedule] .summary").empty();if(a&&a.date){var c=a.besttimetopost?this.translate_best_time_to_post:moment.unix(a.date).format("HH:mm");b.html("<span><i class='icon-time'></i> "+moment.unix(a.date).format("dddd, D MMMM YYYY")+"<em class='negative'>"+c+"</em></span>")}this.summarizerepeat();return this},summarizerepeat:function(){this.mustacheTranslateSummarizeRepeat(this);var a=this.parsescheduled();a&&!a.repeat&&this.$el.find("[data-collapsable=repeat] .summary").empty();
if(!a||!a.repeat)return this;var b=this.$el.find("[data-collapsable=repeat] .summary").empty(),c=a.date?moment.unix(a.date):moment();if(a.repeat.until)var e=moment.unix(a.repeat.until),c=e.diff(c)/1E3,f=Math.round(c/a.repeat.interval);else a.repeat.interval&&(f=a.repeat.amount,e=c.clone().add("seconds",f*a.repeat.interval));if(f)b.html("<span>"+f+" "+this.translate_times+" "+(e?"<em class='negative'>"+this.translate_until+" "+e.format("dddd, D MMMM YYYY")+"</em>":"")+"</span>");else if(a.repeat.interval){var g,
h;[720,168,24,1].some(function(b){g=a.repeat.interval/b/3600;h=b;if(Math.round(g)==g)return!0});b.html("<span>"+this.translate_endless_repeat_every+" "+g+" "+{1:this.translate_hours,24:this.translate_days,168:this.translate_weeks,720:this.translate_months}[h])}return this},listentocanned:function(a){var b=$(a.currentTarget).val();$(".chosen-single > span").get(0);0!=b&&(a=Cloudwalkers.Session.getCannedResponses().models.filter(function(a){if(a.id==b)return a}),(a=a[0]?a[0].get("body").html:null)&&
this.trigger("replace:content",a))},preview:function(){this.$el.addClass("switch-mode");this.preview=new Cloudwalkers.Views.Preview({model:this.draft.clone(),previewtype:"default",streamid:this.activestream.id});this.$el.find(".switch-container").append(this.preview.render().el)},endpreview:function(){this.preview.remove();this.$el.removeClass("switch-mode")},save:function(a){var b;if(b=this.draft.validateCustom(["streams","schedule"]))return this.showerror("Not saved: ",b);this.disablefooter();a&&
_.isString(a)||(a="draft");this.draft.sanitizepost();this.draft.id?this.draft.save({body:this.draft.get("body"),attachments:this.draft.get("attachments"),variations:this.draft.get("variations"),streams:this.draft.get("streams"),schedule:this.draft.get("schedule"),update:!0},{patch:!0,endpoint:"original",success:this.thankyou.bind(this,"save"),error:this.oops.bind(this,"save",a)}):this.draft.save({status:a},{success:this.thankyou.bind(this,"save"),error:this.oops.bind(this,"save",a)})},post:function(){var a;
if(a=this.draft.validateCustom())return this.showerror(this.translateString("not_posted")+": ",a);this.disablefooter();this.draft.sanitizepost();this.draft.get("streams").length?this.draft.id?this.draft.save({body:this.draft.get("body"),attachments:this.draft.get("attachments"),variations:this.draft.get("variations"),streams:this.draft.get("streams"),status:"scheduled",schedule:this.draft.get("schedule"),update:!0},{patch:!0,endpoint:"original",success:this.thankyou.bind(this,"post"),error:this.oops.bind(this,
"post")}):this.draft.save({status:"scheduled"},{success:this.thankyou.bind(this,"post"),error:this.oops.bind(this,"post")}):this.save("scheduled")},postaction:function(){var a=[],b="content";this.$el.find(".action-tabs div").each(function(){a.push($(this).data("stream"))});0<=this.options[this.type].indexOf("editor")&&!this.draft.get("body").html&&(b=!1);if(b=this.draft.validateCustom([b]))return this.showerror(this.translateString("not_posted")+": ",b);this.disablefooter();this.$el.find("[data-type=canned] input").is(":checked")&&
Cloudwalkers.Session.getCannedResponses().create({body:{plaintext:this.draft.get("body").plaintext},status:"CANNED"});b=this.reference.actions.create({parameters:null,streams:a,message:this.draft.get("body").html,actiontype:this.type},{success:this.thankyou.bind(this,null),error:this.oops.bind(this,"saveaction")});this.loadListeners(b,["request:action","sync"]);b.trigger("request:action")},thankyou:function(a){var b=Mustache.render(Templates.thankyou);setTimeout(function(){this.$el.addClass("switch-mode").addClass("thanks");
this.$el.find(".switch-container").append(b);setTimeout(function(){this.$el.modal("hide")}.bind(this),1E3)}.bind(this),400);if("edit"==this.type){var c=this.draft.get("variations");c&&c.length?c.forEach(function(b){b.id&&(a&&"post"==a&&Cloudwalkers.RootView.trigger("added:message",this.draft),Cloudwalkers.Session.getMessage(b.id).fetch({success:function(a){a.trigger("change")}}))}.bind(this)):this.model.fetch()}"post"==this.type&&Cloudwalkers.RootView.trigger("added:message",this.draft);Cloudwalkers.RootView.trigger(this.type.concat(":success"),
this.type)},showerror:function(a,b){Cloudwalkers.RootView.information(a,b,this.$el.find(".modal-footer"))},oops:function(a,b){Cloudwalkers.RootView.confirm("An error ocurred while posting your message. Do you want to retry?",function(){this.loadmylisteners();"save"==a?this.save(b):this.post()}.bind(this),function(){this.$el.modal("hide")}.bind(this))},disablefooter:function(){this.$el.find(".modal-footer .btn").attr("disabled",!0)},invalid:function(a,b){Cloudwalkers.RootView.alert(a.get("title")+
" "+b)},isscrolling:function(){if(this.$el.find(".stream-tabs").length)return this.$el.find(".stream-tabs")[0].scrollWidth>this.$el.find(".stream-tabs").width();if(this.$el.find(".action-tabs").length)return this.$el.find(".action-tabs")[0].scrollWidth>this.$el.find(".action-tabs").width()},triggerpaste:function(a){this.editor.trigger("paste:content",a)},triggerblur:function(){this.editor.trigger("blur:content")},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},translateTitles:function(a){for(k in this.titles)this.translated_titles[k]=
this.translateString(this.titles[k])},mustacheTranslateRender:function(a){this.original="networks default subject images photo_booth pictures camera campaign no_campaign schedule now in mins hour hours day week on best_time repeat no_repeat every days weeks months select_a_day monday tuesday wednesday thursday friday saturday sunday doesnt_matter times until save preview post save_this_as_a_response_template".split(" ");this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),
a["translate_"+this.original[k]]=this.translated[k]},mustacheTranslateSummarizeRepeat:function(a){this.original="times until endless_repeat_every hours days weeks months".split(" ");this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.ComposeNote=Backbone.View.extend({template:"composenote",events:{"click #post":"post","click #cancel":"cancel"},initialize:function(a){a&&$.extend(this,a);this.note||(this.note=new Cloudwalkers.Models.Note);this.model&&(this.note.parent=this.model)},render:function(){var a={};this.note.get("text")&&(a.text=this.note.get("text"));this.mustacheTranslateRender(a);a=Mustache.render(Templates[this.template],a);this.$el.html(a);this.note.get("text")&&this.$el.find("h3").remove();this.$loadercontainer||
(this.$loadercontainer=this.$el.find(".modal-footer"));this.loadListeners(this.note,["request","sync"]);this.trigger("rendered");return this},post:function(){var a=this.$el.find("textarea").val();this.note.save({text:a},{patch:this.note.id?!0:!1,success:this.thanks?this.thankyou.bind(this):this.trigger.bind(this,"save:success")})},cancel:function(){this.trigger("edit:cancel");this.persistent||(this.$el.find("button.close").click(),this.remove())},thankyou:function(){var a=Mustache.render(Templates.thankyou);
setTimeout(function(){this.$el.addClass("thanks");this.$el.find("section").html(a);setTimeout(function(){this.$el.modal("hide")}.bind(this),1E3)}.bind(this),200);Cloudwalkers.RootView.trigger("added:note",this.note)},clean:function(){this.$el.find("textarea").val("")},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["write_note","save","cancel","private_note"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),
a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Preview=Backbone.View.extend({id:"preview",events:{},networkclasses:{facebook:"fb",twitter:"twt","google-plus":"gp",linkedin:"li"},events:{"click #viewsummary":"togglesummary"},initialize:function(a){a&&$.extend(this,a);$.extend(this.model.attributes,this.model.getvariation(this.streamid));this.model.attributes.profile=Cloudwalkers.Session.getStream(this.streamid).get("profile");this.network=Cloudwalkers.Session.getStream(this.streamid).get("network").token},render:function(){var a=
Mustache.render(Templates.preview,{networkclass:this.networkclasses[this.network]});this.$el.html(a);$.get("/assets/previews/template.html",this.fill.bind(this));return this},fill:function(a){this.previewdata={body:this.model.get("body")||"",profile:this.model.get("profile")};this.fakeload(1.2*Math.random()+0.4);this.model.hasAttachement("link")&&this.$el.find("#network").addClass("link");if(img=this.model.hasAttachement("image"))this.previewdata.image=img.data||img.url,this.$el.find("#network").addClass("img");
a=Mustache.render(a,this.previewdata);this.$el.find("#pv-main").append(a)},fakeload:function(a){$dis=this.$el;$dis.find("#pv-main").addClass("pv-load");$dis.find(".progress-bar").css("-webkit-transition","width "+a+"s ease-out");setTimeout(function(){$dis.find("#pv-main").removeClass("pv-load").addClass("pv-loaded")},1E3*a)},mergedata:function(a,b){if(0==b.length)return a;var c={};$.extend(c,a);$.extend(c,b);return c},togglesummary:function(){this.$el.find(".pv-url-content").toggle()}});Cloudwalkers.Views.Share=Backbone.View.extend({events:{"click .notification-toggle":"toggleNotifications"},initialize:function(){},fit:function(){$("#share").html(this.render().el)},render:function(){this.$el.html(Mustache.render(Templates.share,{streams:[{icon:"twitter",name:"bmgroup"},{icon:"facebook",name:"bmgroup"},{icon:"linkedin",name:"Cloudwalkers"}]}));return this},show:function(){$("#share").removeClass("collapsed");$("#sidebar, #inner-content").addClass("collapsed");this.spanheight()},hide:function(){$("#share").addClass("collapsed");
$("#sidebar, #inner-content").removeClass("collapsed")},toggle:function(){$("#share").hasClass("collapsed")?this.show():this.hide()},spanheight:function(){this.$el.height($(".page-container").height()+"px")}});Cloudwalkers.Views.Pageview=Backbone.View.extend({title:"Page",className:"container-fluid",span:0,widgets:[],widgetviews:[],events:{rendered:"bubblerender",remove:"destroy"},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);this.appendWidgets();return this},appendWidgets:function(){for(n in this.widgets){var a=this.widgets[n].view(this.widgets[n].data);this.appendWidget(a,this.widgets[n].size)}},appendWidget:function(a,
b,c){this.span&&0!=b||this.$container.append(Templates.row);this.span=12>b+this.span?b+this.span:0;a&&(this.$container.children().last().append(a.render().el),this.widgetviews.push(a),a.$el.addClass("span"+b),a.negotiateFunctionalities&&a.negotiateFunctionalities())},appendhtml:function(a){this.$container.children().last().append(a)},cleanviews:function(){this.widgetviews.length&&(this.destroy(),this.widgetviews=[])},bubblerender:function(){this.trigger("rendered");$.each(this.widgetviews,function(a,
b){b.trigger("rendered")})},destroy:function(){$.each(this.widgetviews,function(a,b){b.remove()})}});Cloudwalkers.Views.Message=Backbone.View.extend({events:{"click .message-action[data-action]":"messageAction","click .children-button.message-children":"showchildren"},className:"message-view",template:"message",tagName:"tr",commentsVisible:!1,commentsView:null,childrencontainer:"comment-container",initialize:function(){var a=this;this.model.on("change",function(){a.render()})},prepareData:function(){var a=jQuery.extend(!0,{},this.model.attributes);a.shortBody=this.model.shortBody();a.humandate=this.model.humandate();
a.dateonly=this.model.shortdate();a.time=this.model.time();a.sortedattachments={};var b=this.model.getProcessedAttachments();if(0<b.length)for(var c=0;c<b.length;c++)"undefined"==typeof a.sortedattachments[a.attachments[c].type]&&(a.sortedattachments[b[c].type]=[]),a.sortedattachments[b[c].type].push(b[c]);this.model.getStream()&&(a.stream=this.model.getStream().attributes);this.model.collection&&(a.channel=this.model.collection.id);if("undefined"!=typeof a.statistics)for(c=0;c<a.statistics.length;c++)"undefined"!=
typeof a.statistics[c].i18n&&(a.statistics[c].name=1!=a.statistics[c].value?a.statistics[c].i18n[1]:a.statistics[c].i18n[0]);return this.additionalData(a)},additionalData:function(a){"OUTGOING"==this.model.get("type")&&(a.scheduledate=this.model.scheduledate());return a},render:function(){console.log("here");var a=this.prepareData(),b=this;"undefined"!=typeof a.parentmodel&&"undefined"!=typeof this.options.childtemplate?$(this.el).html(Mustache.render(Templates[this.options.childtemplate],a)):"undefined"!=
typeof this.options.template?$(this.el).html(Mustache.render(Templates[this.options.template],a)):"undefined"!=typeof a.parentmodel?$(this.el).html(Mustache.render(Templates.messagecomment,a)):$(this.el).html(Mustache.render(Templates[this.template],a));a.parentmodel&&(a={model:a.parentmodel},"undefined"!=typeof this.options.originaltemplate&&(a.template=this.options.originaltemplate),a=new Cloudwalkers.Views.OriginalMessage(a),this.$el.find(".parent-message-view").html(a.render().el));this.$el.find(".actions.dropdown").on("click",
function(a){a.stopPropagation();b.$el.find(".dropdown-menu").dropdown("toggle");b.$el.find("[data-action]").unbind("click").click(function(a){b.messageAction(a)})});(this.commentsVisible||this.options.showcomments)&&this.showchildrenexec();this.afterRender();this.model.setRead();return this},messageAction:function(a){a=$(a.currentTarget).is("[data-action]")?$(a.currentTarget).attr("data-action"):$(a.target).is("[data-action]")?$(a.target).attr("data-action"):$(a.target).parent("[data-action]").attr("data-action");
action=this.model.getAction(a);null==action?console.log("Action not found: "+a):(a=this.model,"undefined"!=typeof action.target&&(a=action.target,"undefined"!=typeof action.originalaction&&(action=action.originalaction)),"undefined"!=typeof action.callback?action.callback(a):action&&("dialog"==action.type?(a=new Cloudwalkers.Views.ActionParameters({message:a,action:action}),Cloudwalkers.RootView.popup(a)):"simple"==action.type?a.act(action,{},function(){}):"write"==action.type&&Cloudwalkers.RootView.writeDialog(a,
action)))},afterRender:function(){this.time()},showchildren:function(a){a.stopPropagation();a.preventDefault();this.commentsVisible?(this.commentsVisible=!1,this.$el.find(".comment-label").html("Show comments"),this.$el.find("."+this.childrencontainer).hide()):this.showchildrenexec()},showchildrenexec:function(){console.log("!","Deprecation error")},time:function(){var a=new Date,b=new Date(this.$el.find("[data-date]").attr("data-date")),a=Math.round(0.001*(a.getTime()-b.getTime())),a=60>a?"now":
3600>a?Math.round(a/60)+"m":86400>a?Math.round(a/3600)+"h":2592E3>a?Math.round(a/86400)+"d":Math.round(a/2592E3)+"mo";this.$el.find("[data-date]").html(a)}});Cloudwalkers.Views.ContactView=Backbone.View.extend({tagName:"li",template:"contactentry",notifications:[],parameters:{},events:{"click .contact-delete":"unfollow"},initialize:function(a){this.parameters={};a&&$.extend(this,a);this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"destroy",this.remove)},render:function(){$.extend(this.parameters,this.model.attributes);this.$el.html(Mustache.render(Templates[this.template],this.parameters));this.model.get("objectType")&&this.$el.addClass(this.parameters.network.token);
return this},unfollow:function(){this.model.trigger("unfollow",this.model);this.model.parent=Cloudwalkers.Session.getAccount();this.model.save({following:!1},{patch:!0});this.remove()}});Cloudwalkers.Views.ViewContact=Backbone.View.extend({id:"compose",className:"modal hide viewcontact",entries:[],events:{"click .end-preview td i":"backtolist","click #contactfilter li":"loadmessages","click [data-action=write-note]":"togglecontactnote","click #post":"post","click aside *[data-action]":"action","keyup aside #tags":"entertag","click .load-more":"more"},initialize:function(a){a&&$.extend(this,a);if(this.contact=a.contact?a.contact.model:null)this.model=new Cloudwalkers.Models.Contact(this.contact);
!this.model&&this.contactid&&(this.model=new Cloudwalkers.Models.Contact({id:this.contactid}));this.loadmylisteners()},loadmylisteners:function(a){"note"==this.type?(this.collection=new Cloudwalkers.Collections.Notes,this.collection.parentmodel="contact",this.collection.parenttype="contact"):this.collection=new Cloudwalkers.Collections.Messages;a&&this.stopListening(this.collection);this.listenTo(this.collection,"seed",this.fill);this.listenTo(this.collection,"sync",this.paginate);this.listenTo(this.collection,
"ready",this.showmore);this.loadListeners(this.collection,["request","sync",["ready","loaded"]],!0)},render:function(){Cloudwalkers.Session.censuretemplate(this.contactinfo);var a=Mustache.render(Templates.viewcontact,this.contactinfo);this.$el.html(a);this.$container=this.$el.find("ul.list");this.$loadercontainer=this.$el.find("ul.list");this.trigger("rendered");this.updatecontactinfo();Cloudwalkers.Session.isAuthorized("ACCOUNT_NOTES_MANAGE")&&this.initializenote();(Cloudwalkers.Session.isAuthorized("ACCOUNT_TAGS_VIEW")||
Cloudwalkers.Session.isAuthorized("ACCOUNT_TAGS_MANAGE"))&&this.loadtagui();this.begintouch();return this},fill:function(a){this.refreshview&&($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);a.length?this.$el.find(".messagelist").removeClass("empty-content"):this.$el.find(".messagelist").addClass("empty-content");var b,c="note"==this.type?"inboxnote":"smallentry";for(n in a)b=a[n],b.attributes.arrow="arrow",b.parent=this.model,b=new Cloudwalkers.Views["note"==this.type?"NoteEntry":
"Entry"]({model:b,template:c,checkunread:!0,parameters:{parent:this,contactview:!0}}),this.entries.push(b),this.listenTo(b,"toggle",this.loadmessage),this.$container.append(b.render().el);this.refreshview=!1},seed:function(a,b){this.collection.models=b.contact.messages;this.collection.length=this.collection.models.length;this.collection.trigger("seed",this.collection.models)},begintouch:function(a){a||(a="messages");this.type=a;this.loadmylisteners(!0);this.refreshview=!0;"messages"==a?this.getmessages():
this.touch(a)},getmessages:function(a){this.model.urlparams=["messages"];this.model.parameters=a||!1;this.collection.url=this.model.url();this.collection.parenttype="contact";this.collection.contactinfo=this.contactinfo;this.collection.parse=this.parse;this.collection.fetch({success:this.seed.bind(this)})},parse:function(a){this.parenttype&&(a=a[this.parenttype]);if(a[this.typestring]){for(n in a[this.typestring])a[this.typestring][n]=new Cloudwalkers.Models.Message(a[this.typestring][n]),a[this.typestring][n].generateintro(),
a[this.typestring][n].set("read",1),a[this.typestring][n].set("fulldate",moment(a[this.typestring][n].get("date")).format("DD MMM YYYY HH:mm")),a[this.typestring][n].set("icon",this.contactinfo.network?this.contactinfo.network.icon:null),a[this.typestring][n].set("networkdescription",this.contactinfo.network?this.contactinfo.network.name:null),a[this.typestring][n].set("networktoken",this.contactinfo.network?this.contactinfo.network.token:null);this.setcursor(a.paging)}this.ready();return a[this.typestring]},
touch:function(a,b){this.collection.parentmodel=this.model;this.model.urlparams=[a+"ids"];this.model.parameters=b||!1;this.collection.url=this.model.url();this.collection.fetch({success:this.touchresponse.bind(this)})},touchresponse:function(a,b){var c=b.contact[this.collection.typestring];this.model.urlparams=[this.type+"s"];this.model.parameters={ids:c.join(",")};this.collection.url=this.model.url();this.collection.seed(c)},updatecontactinfo:function(){var a=this.model.attributes;a&&(Cloudwalkers.Session.censuretemplate(a),
this.mustacheTranslateRender(a),a.tags=!0,this.$el.find("aside").html(Mustache.render(Templates.viewcontactaside,a)),setTimeout(function(){this.$el.find("aside").removeClass("nodata")}.bind(this),1),this.hascontactinfo=!0,this.contactinfo=a)},initializenote:function(){var a=new Cloudwalkers.Views.ComposeNote({model:this.model,persistent:!0});this.composenote=a;this.$el.find("#notecontainer").append(a.render().el);this.listenTo(a.note,"sync",this.doneposting.bind(this,200));this.listenTo(a,"edit:cancel",
this.doneposting)},doneposting:function(a){a||(a=0);setTimeout(function(){this.togglecontactnote();this.composenote.remove();this.initializenote();"note"==this.type&&(this.refreshview=!0,this.touch("note"))}.bind(this),a)},loadmessages:function(a){this.backtolist();var b=$(a.currentTarget).attr("data-type");$(a.currentTarget).hasClass("inactive")&&(this.$el.find("#contactfilter .active").removeClass("active").addClass("inactive"),$(a.currentTarget).removeClass("inactive").addClass("active"),this.begintouch(b))},
loadmessage:function(a){var b={model:a.model,notes:a.model.id?!0:!1,parent:this};"note"!=this.type&&($(".viewcontact").addClass("onmessage"),this.$loadercontainer=this.$el.find(".inbox-container"),this.inboxmessage&&this.inboxmessage.remove(),this.inboxmessage=new Cloudwalkers.Views.Widgets["note"==this.type?"InboxNote":"InboxMessage"](b),this.type&&"messages"!=this.type&&this.loadListeners(this.inboxmessage,["request","sync",["ready","loaded"]],!0),this.$el.find(".inbox-container").html(this.inboxmessage.render().el),
this.type&&"conversation"==this.type?this.inboxmessage.showrelated():this.type&&"note"==this.type&&this.listenTo(this.inboxmessage.model,"destroy",this.backtolist),this.$el.find(".list .active").removeClass("active"),a.$el.addClass("active"))},backtolist:function(){$(".viewcontact").removeClass("onmessage");this.$loadercontainer=this.$el.find("ul.list")},togglecontactnote:function(){$(".viewcontact").hasClass("writenote")?($(".viewcontact").removeClass("writenote"),setTimeout(function(){this.$el.find(".contactbottom").slideDown("fast")}.bind(this),
100)):(this.$el.find(".contactbottom").slideUp("fast"),setTimeout(function(){$(".viewcontact").addClass("writenote")},100));this.backtolist()},filterparams:function(){return{records:20,contacts:this.contactid}},action:function(a){var b=$(a.currentTarget).data("action");if("tag-showedit"==b)this.showtagedit();else if("tag-add"==b){if(b=$(a.currentTarget).siblings("input").val())this.submittag(b),$(a.currentTarget).siblings("input").val("")}else this.model.trigger("action",b)},loadtagui:function(){this.fetchtags()},
showtagedit:function(){this.$el.find("aside .message-tags").toggleClass("enabled");this.$el.find("aside .message-tags .edit").toggleClass("inactive")},fetchtags:function(){var a=new Cloudwalkers.Collections.Tags;a.parentmodel=this.model;a.parenttype="contact";this.listenTo(a,"seed",this.rendertag);a.touch(this.model);this.loadedtags=!0},rendertag:function(a){a.length?this.$el.find(".tag-list").empty():this.$el.find(".tag-list").html("No tags found");this.$el.find(".tag-list").empty();for(n in a)this.addtag(a[n])},
submittag:function(a){this.tag=new Cloudwalkers.Models.Tag;this.model&&(this.tag.parent=this.model);this.tag.save({name:a},{success:this.addtag.bind(this)})},addtag:function(a){a=new Cloudwalkers.Views.Widgets.TagEntry({model:a,parent:this.model,template:"messagetag"});this.$el.find("aside .tag-list").append(a.render().el)},entertag:function(a){if(13===a.which){var b=$(a.target).val();b&&(this.submittag(b),$(a.target).val(""))}},paginate:function(a,b){this.hasmore=a.cursor&&b.contact[a.endpoint||
a.typestring].length?!0:!1},showmore:function(){setTimeout(function(){this.$container.css("max-height",999999);if(!this.hasmore)return this.$el.find("#loadmore").empty();var a=new Cloudwalkers.Views.Widgets.LoadMore({list:this.collection,parentcontainer:this.$container});this.$el.find("#loadmore").html(a.render().el)}.bind(this),200)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["latest_messages","latest_conversations","contact_notes",
"add_contact_note"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]},hideloading:function(){this.$el.find(".icon-cloud-download").hide();this.$container.removeClass("inner-loading");this.hasmore=this.model.messages.cursor?!0:!1},more:function(){this.incremental=!0;if(!this.collection.cursor)return!1;var a={after:this.collection.cursor};"messages"==this.type?this.getmessages(a):this.touch(this.type,
a);this.hasmore||this.$el.find(".load-more").hide()}});Cloudwalkers.Views.Editor=Backbone.View.extend({id:"editor",oldUrl:"",urldata:{},currenturl:!1,urlprocessing:!1,limit:null,content:"",charlength:0,contentlimitation:0,pos:0,urls:{},posmap:[],restrictedstreams:{twitter:140,linkedin:700},events:{"update:content":"render","update:limit":"renderlimit","append:content":"append","click #swaplink":"swaplink",'click [data-type="title"] .addcontent':"addoecontent",'click [data-type="content"] .addcontent':"addoecontent",'click [data-type="image"] i':"addoeimg",
"mouseup #compose-content":"savepos"},xtrimmable:/<[^>]*>|&nbsp;|\s/g,xurlbasic:/http|[w]{3}/g,xurlpattern:/(^|\s|\r|\n|\u00a0)((https?:\/\/|[w]{3})?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)(\s|\r|\n|\u00a0)/g,xurlendpattern:/(^|\s|\r|\n)((https?:\/\/|[w]{3})?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)/g,initialize:function(a){a&&$.extend(this,a);this.listenTo(Cloudwalkers.Session.UrlShortener,"sync",this.shortenurl);this.listenTo(this.parent,"update:stream",function(a){this.togglecontent(a,!0)}.bind(this));
this.listenTo(this.parent,"update:campaign",this.campaignupdated);this.listenTo(this.parent,"replace:content",this.replacecontent);this.on("change:charlength",this.monitorlimit);this.on("change:editor",this.listentochange);this.on("paste:content",this.listentopaste);this.on("blur:content",this.endchange);this.loadListeners(this,["request:og","ready:og"]);this.on("update:limit",this.updatelimit);navigator.userAgent.match(/(firefox(?=\/))\/?\s*(\d+)/i)?this.isfirefox=!0:navigator.userAgent.match(/(chrome(?=\/))\/?\s*(\d+)/i)||
(this.isexplorer=!0)},render:function(a){void 0!==a&&(this.content=a);a=Math.min.apply(Math,_.values(this.restrictedstreams));this.restrictedstreams["default"]=a;this.$el.html(Mustache.render(Templates.editor,{limit:a}));this.limit=a;this.$contenteditable=this.$el.find("#compose-content").eq(0);this.contenteditable=this.$contenteditable.get(0);this.document=this.contenteditable.ownerDocument||this.contenteditable.document;this.win=document.defaultView||document.parentWindow;this.$contenteditable.html(this.content);
this.content&&this.listentochange();this.$loadercontainer=this.$el.find("#out-loading");this.trigger("rendered");return this},listentopaste:function(a){a.preventDefault();if(a.originalEvent||a.originalEvent.clipboardData){var b=a.originalEvent.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,b)}this.listentochange(a)},applystyle:function(){this.win.getSelection();this.contenteditable.designMode="on";document.execCommand("backColor",!1,this.limit?"#fcc":"#fff");this.contenteditable.designMode=
"off"},applyselection:function(a){this.greyout(this.limit-this.$contenteditable.text().length,a)},listentochange:function(a,b){var c;if(this.content!==this.$contenteditable.text()||b)this.pos=this.cursorpos(),(c=this.listentourl(a,this.$contenteditable.text()))&&this.processurls(c);this.content=this.$contenteditable.text();this.isdefault&&!b&&(this.$contenteditable.removeClass("withdefault"),this.isdefault=!1);this.trigger("change:charlength");b&&this.clearselections()},endchange:function(a){if(this.$contenteditable.html().match(this.xurlendpattern)){var b;
(b=this.listentourl(null,this.$contenteditable.text(),!0))&&this.processurls(b)}},listentourl:function(a,b,c){var e=this.win.getSelection(),f=this.document.createRange(),g,h,m,l;if(!a||"keyup"!=a.type||32==a.keyCode)if(a&&"paste"==a.type&&(c=!0),f.selectNodeContents(this.$contenteditable.get(0)),g=this.parsenodes(f.startContainer.childNodes,c),g.length)return $.each(g,function(a,b){h=b.node.textContent.replace(/&nbsp;/gi,"");b.url=b.url.trim();m=h.indexOf(b.url);l=m+b.url.length;0>m&&(m=0);f.setStart(b.node,
m);f.setEnd(b.node,l);e.removeAllRanges();e.addRange(f);this.contenteditable.designMode="on";document.execCommand("createLink",!1,b.url);this.contenteditable.designMode="off";var c=document.createTextNode("\u200b");f.insertNode(c);this.$contenteditable.find("a").after(c);f.setStartAfter(c);e.removeAllRanges();e.addRange(f);g[a+1]&&(g[a+1].node=b.node.nextSibling)}.bind(this)),_.pluck(g,"url")},parsenodes:function(a,b){var c=[],e;$.each(a,function(a,g){var h=!1,m=g.textContent;if(b&&3!=g.nodeType)return!0;
m&&(h=m.match(b?this.xurlendpattern:this.xurlpattern));if(h&&h.length)return $.each(h,function(a,b){3==g.nodeType?c.push({node:g,url:b}):(e=this.getnode(g,null,b))&&b&&c.push({node:e,url:b})}.bind(this)),!0}.bind(this));return c},getnode:function(a,b,c){var e;$.each(a.childNodes,function(a,g){if(c){if(3==g.nodeType)if(g.childNodes.length)e=this.getnode(g,null,type);else if(-1<g.textContent.indexOf(c.trim()))return e=g,!1}else{var h=g.textContent.length;return h>=b?(g.childNodes.length?this.getnode(g,
b):this.currentnode={node:g,offset:b},!1):b-=h}}.bind(this));return e},processurls:function(a){this.$contenteditable.find("a").attr("contenteditable",!1);if(!this.campaign){var b=this.draft.get("campaign"),c=Cloudwalkers.Session.getAccount().get("campaigns").filter(function(a){if(a.id==b)return a});this.campaign=c.length?c[0].name:null}a&&!this.urlprocessing&&(this.urlprocessing=!0,this.parseurls(a,this.campaign))},parseurls:function(a,b,c){var e={error:this.releaseurlprocessing};a.forEach(function(a){!c&&
this.urls[a]?this.shortenurl(this.urls[a]):(e.q=a,e.campaign=b,Cloudwalkers.Session.UrlShortener.fetch(e))}.bind(this))},shortenurl:function(a){this.releaseurlprocessing();var b=["description","og:description","og:image","og:video","og:title"],c=this,e=a.get("url"),f=a.get("shortUrl");this.urls[e]||(this.urls[e]=a.clone());a=" <short contenteditable='false' data-long='"+e+"' data-short='"+f+"'>"+f+"<i class='icon-link' id='swaplink'></i></short>";this.$contenteditable.find("a[href='"+e+"']").replaceWith(a);
this.trigger("change:content");e='<div><a href="'+e+'" class="oembed"></a></div>';this.$el.find("#out").empty().html(e);this.$el.find(".oembed").oembed(null,null,this.embed).each(function(){c.$el.find("#out").removeClass("expanded");c.trigger("request:og");this.def.done(function(a){c.trigger("ready:og");a&&("youtube"==a?c.$el.find("#out").addClass("expanded"):_.isObject(a)&&$.each(a,function(a,e){0<=b.indexOf(a)&&c.$el.find("#out").addClass("expanded")}))})});this.trigger("change:charlength")},releaseurlprocessing:function(){this.urlprocessing=
!1},swaplink:function(a){var b=$(a.currentTarget).get(0).parentElement,c=this.$contenteditable.text().length;a=$(b).data("long");var e=$(b).data("short"),f=$(b).get(0).textContent.trim(),g="<short contenteditable='false' data-long='"+a+"' data-short='"+e+"'>"+(e==f?a:e)+"<i class='icon-link' id='swaplink'></i></short>";$(b).replaceWith(g);b=this.$contenteditable.text().length-c;a=e==f?this.$contenteditable.text().indexOf(a):this.$contenteditable.text().indexOf(e);this.pos>=a?this.cursorpos(this.pos+
b):this.cursorpos(this.pos);this.pos=this.cursorpos();this.trigger("change:content");this.trigger("change:charlength")},campaignupdated:function(a){var b=this.urls;b.length&&this.parseurls(b,a,!0)},addoetitle:function(a){},addoecontent:function(a){a=a.currentTarget.parentElement.textContent;var b=this.$contenteditable.html();this.$contenteditable.html(b+"<br/>"+a);this.trigger("change:content")},addoeimg:function(a){a=this.$el.find('[data-type="image"] img').get(0).src;this.trigger("imageadded",{type:"image",
url:a,name:a})},clearselections:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection():document.selection&&document.selection.empty()},monitorlimit:function(){this.charlength=this.$contenteditable.text().length;this.limit&&this.updatecounter(this.limit-this.charlength)},updatecounter:function(a){var b=this.$el.find(".limit-counter");20<=a&&b.removeClass().addClass("limit-counter");20>a&&b.removeClass().addClass("limit-counter").addClass("color-notice");
0>a&&b.removeClass().addClass("limit-counter").addClass("color-warning");b.empty().html(a)},updatelimit:function(a,b){this.contentlimitation=a;b&&(this.limit=this.restrictedstreams[this.network]?this.restrictedstreams[this.network]-this.contentlimitation:null)},greyout:function(a,b){var c=this.win.getSelection(),e=this.document.createRange(),f=this.cursorpos(),g,h,m=0,l=this.$contenteditable.find("short");this.content.length>=this.$contenteditable.text().length&&this.removegrey();e.selectNodeContents(this.$contenteditable.get(0));
g=this.cursorpos(this.$contenteditable.text().length,!0);h=this.cursorpos(this.limit,!0);if(h.node){if(b)return;l.removeClass("red");this.isurl(h.node)&&($(h.node.parentNode).addClass("red"),h.node=h.node.parentNode.nextSibling,h.offset=0,m++);e.setStart(h.node,h.offset);e.setEnd(g.node,g.offset);c.removeAllRanges();c.addRange(e);$.each(l,function(a,b){c.containsNode(b)&&m++})}this.contenteditable.designMode="on";document.execCommand("backColor",!1,this.limit?"#fcc":"#fff");this.contenteditable.designMode=
"off";if(m)for(;0<m;)$(l[l.length-m]).addClass("red"),m--;this.cursorpos(this.$contenteditable.text().length);this.mergechars();this.cursorpos(f)},isurl:function(a){result=!1;$.each(this.urls,function(b,c){if(c.get("shortUrl")==a.textContent||b==a.textContent)return result=!0,!1});return result},removegrey:function(a){a=this.win.getSelection();var b=this.document.createRange();this.$contenteditable.find("span").length&&(b.selectNodeContents(this.$contenteditable.get(0)),a.removeAllRanges(),a.addRange(b),
this.contenteditable.designMode="on",document.execCommand("removeFormat",!1,null),this.contenteditable.designMode="off")},mergechars:function(){$.each(this.$contenteditable.find("span"),function(a,b){$(b).html($(b).text())}.bind(this))},savepos:function(a){a=a.target.tagName;"I"!=a&&"SHORT"!=a&&(this.pos=this.cursorpos())},cursorpos:function(a,b){var c,e;if(void 0===a)a=0,this.win.getSelection()&&this.win.getSelection().rangeCount&&(e=this.win.getSelection().getRangeAt(0),c=e.cloneRange(),c.selectNodeContents(this.contenteditable),
c.setEnd(e.endContainer,e.endOffset),a=c.toString().length);else{this.getnode(this.$contenteditable[0],a);var f=this.currentnode;if(b)return{node:f.node,offset:f.offset};e=this.document.createRange();c=this.win.getSelection();e.setStart(f.node,f.offset);e.collapse(!0);c.removeAllRanges();c.addRange(e)}return a},replacecontent:function(a){this.$contenteditable.empty().html(a);this.trigger("change:content")},togglecontent:function(a,b){if(a)var c=_.isNumber(a.id)?a.id:null,e=_.isObject(a.data)?a.data.html:
null,f=c?Cloudwalkers.Session.getStream(c).get("network").token:null;this.network=f?f:"default";f&&!e?(this.$contenteditable.empty().html(this.draft.get("body").html),this.$contenteditable.addClass("withdefault"),this.isdefault=!0):(c?(e||(e=""),this.$contenteditable.empty().html(e)):this.$contenteditable.empty().html(this.draft.get("body").html),this.$contenteditable.removeClass("withdefault"));this.limit=this.restrictedstreams[this.network]?this.restrictedstreams[this.network]-this.contentlimitation:
null;$.each(this.$contenteditable.find("a"),function(a,b){b.innerText=b.innerText.trim();$(b).attr("contenteditable","false").after("&nbsp;")});this.removegrey(!0);this.listentochange(null,!0)}});Cloudwalkers.Views.Resync=Backbone.View.extend({className:"container-loading",initialize:function(a){$.extend(this,a);this.listenTo(Cloudwalkers.Session.user,"sync",this.activate);this.listenToOnce(Cloudwalkers.Session.user,"activated",this.refresh)},render:function(){this.$el.html(Mustache.render(Templates.loading));this.versioncheck();return this},updateme:function(){Store.remove("me");Cloudwalkers.Session.user.fetch()},activate:function(a){var b=Cloudwalkers.Session.version;Store.write("version",
[{version:b}]);Cloudwalkers.Session.localversion=b;Cloudwalkers.Session.user.activate(a)},refresh:function(){Cloudwalkers.RootView.navigation.renderHeader();Cloudwalkers.RootView.navigation.render();Cloudwalkers.Router.Instance.navigate(this.returnto,!0)},versioncheck:function(a){this.updateme()},parseversion:function(a){if("string"!=typeof a)return!1;a=a.split(".");return parseInt(a[0]+a[1]+a[2]+a[3])}});Cloudwalkers.Views.ContactCard=Backbone.View.extend({events:{click:"viewcontact"},initialize:function(a){$.extend(this,a)},render:function(){this.$el.html(Mustache.render(Templates.singlecontact,this.contact));return this},viewcontact:function(){this.contact&&Cloudwalkers.RootView.viewContact({model:this.contact})}});Cloudwalkers.Views.Actions=Backbone.View.extend({actionsright:[],actionsleft:[],compounds:[],initialize:function(a){$.extend(this,a);this.listenTo(this.message.notes,"ready",this.updateactions.bind(this,"notes"));this.listenTo(this.message.notes,"destroy",this.updateactions.bind(this,"notes"));this.listenTo(this.message.actions,"ready",this.updateactions);this.listenTo(this.message.actions,"destroy",this.updateactions)},render:function(a){this.selected=this.$el.find(".inactive").data("token");this.actionsleft=
[];this.actionsright=[];this.compounds=[];this.fillactions(a);this.$el.html(Mustache.render(Templates.actions));this.renderactions("left",this.actionsleft);this.renderactions("right",this.actionsright);return this},fillactions:function(a){var b,c;if(this.message)for(n in b=this.message.filterActions(a),b){if((a=b[n].compound?b.filter(function(a){return a.compound==b[n].compound}):null)&&a.length)if(0<=this.compounds.indexOf(a[0].compound))continue;else this.compounds.push(a[0].compound);this.selected&&
(a&&a[0].token==this.selected?c="inactive":a||b[n].token!=this.selected||(c="inactive"));a=new Cloudwalkers.Views.Action({action:a||b[n],inactive:c});this["actions"+a.position].push(a)}},updateactions:function(a){this.render(a);this.trigger("actions:update")},renderactions:function(a,b){var c=this.$el.find(".actions-"+a);for(n in b)c.append(b[n].render().el)},incrementaction:function(a){var b=this.actionsright.filter(function(b){return b.action.token==a});b||(b=this.actionsleft.filter(function(b){return b.action.token==
a}));b&&b[0].increment()}});Cloudwalkers.Views.Action=Backbone.View.extend({template:"action",position:"left",initialize:function(a){$.extend(this,a);_.isArray(this.action)&&(this.template="compoundaction",this.rendercompound());this.positionaction()},render:function(){this.action.inactive=this.inactive;this.action.noresults=0==this.action.value?"noresults":!1;this.$el.html(Mustache.render(Templates[this.template],this.action));return this},rendercompound:function(){2<=this.action.length?this.rendercomplexcompound():this.action=
this.action[0]},rendercomplexcompound:function(){var a=this.action[0].hasOwnProperty("value")?this.action[0]:this.action[1];this.action[0].hasOwnProperty("value");this.action=a},positionaction:function(){_.isArray(this.action)&&"note"==this.action[0].type?this.position="right":"note"==this.action.type&&(this.position="right")},increment:function(){var a=this.$el.find(".actionvalue span").html();a?this.$el.find(".actionvalue span").html(Number(a)+1):this.$el.find(".actionvalue span").html(Number(1))}});Cloudwalkers.Widget=Backbone.View.extend({title:"...",color:"blue",icon:"cloud",events:{"click .portlet-title.line":"collapse"},initialize:function(){this.bind("destroy",this.destroy)},innerRender:function(){this.$el.addClass("inner-empty")},render:function(){this.$el.html(Mustache.render(Templates.widget,{title:this.options.title|this.title,color:this.options.color|this.color,icon:this.options.icon|this.icon}));"auto"==this.options.height&&this.$el.find(".scroller").remove();"undefined"!=typeof this.options.counter&&
this.appendCounter();this.options.collapsible&&this.appendCollapsible();this.innerRender();this.addScroll();return this},appendCounter:function(a){this.$el.find(".tools").append($('<span class="count">'+a+"</span>"))},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",position:"right",height:$(this).attr("data-height"),alwaysVisible:"1"==$(this).attr("data-always-visible")?!0:!1,railVisible:"1"==$(this).attr("data-rail-visible")?!0:!1,disableFadeOut:!0})},appendCollapsible:function(a){this.$el.find(".tools .count").length?
this.$el.find(".tools .count").addClass("collapse"):this.$el.find(".tools").append($('<span class="collapse pull-right"></span>'));this.$el.addClass(a?"collapse-open":"collapse-closed")},collapse:function(){this.$el.toggleClass("collapse-closed collapse-open")},destroy:function(){this.$el.find(".scroller").slimScroll({destroy:1})}});Cloudwalkers.Views.Widgets.WidgetContainer=Backbone.View.extend({widgets:[],title:"Widget Container",isLoaded:!1,currentLine:null,sizecounter:0,newline:!0,templatename:"widgetcontainer",events:{remove:"destroy"},initialize:function(){this.widgets=[];this.initializeWidgets();this.isLoaded=!1;this.newline=!0;this.sizecounter=0;this.title=this.options.title?this.options.title:this.title},initializeWidgets:function(){},add:function(a,b){"undefined"==typeof b&&(b=a.size);b="full"==b?12:"half"==b?6:b?parseInt(b):
12;this.sizecounter+=b;12<this.sizecounter&&(this.sizecounter=b,this.newline=!0);this.addWidgetSize(a,this.newline,b);this.newline=!1},addHalfWidget:function(a,b){"undefined"==typeof b&&(b=!1);var c=this;a.on("content:change",function(){c.trigger("content:change")});this.widgets.push({widget:a,size:"half",newline:b});this.isLoaded&&this.addWidgetsDOM([{widget:a,size:"half",newline:b}])},addWidget:function(a,b){"undefined"==typeof b&&(b=!1);var c=this;a.on("content:change",function(){c.trigger("content:change")});
this.widgets.push({widget:a,size:"full",newline:b});this.isLoaded&&this.addWidgetsDOM([{widget:a,size:"full",newline:b}])},addWidgetSize:function(a,b,c){"undefined"==typeof b&&(b=!1);var e=this;a.on("content:change",function(){e.trigger("content:change")});this.widgets.push({widget:a,size:c,newline:b});this.isLoaded&&this.addWidgetsDOM([{widget:a,size:c,newline:b}])},render:function(){this.isLoaded=!0;this.$el.addClass("container-fluid");this.$el.html(Mustache.render(Templates[this.templatename],
{title:this.title}));this.currentline=$(document.createElement("div"));this.currentline.addClass("row-fluid");this.$el.find("#widgetcontainer").append(this.currentline);this.addWidgetsDOM(this.widgets);return this},addWidgetsDOM:function(a){for(var b=this,c=0;c<a.length;c++)a[c].newline&&(this.currentline=$(document.createElement("div")),this.currentline.addClass("row-fluid"),this.$el.find("#widgetcontainer").append(this.currentline)),container=$(document.createElement("div")),"half"==a[c].size?container.addClass("span6"):
"full"==a[c].size?container.addClass("span12"):container.addClass("span"+a[c].size),container.append(a[c].widget.render().el),this.currentline.append(container),a[c].widget.negotiateFunctionalities();setTimeout(function(){b.trigger("content:change")},1)},destroy:function(){for(n in this.widgets)this.widgets[n].widget.trigger("destroy")}});Cloudwalkers.Views.Dashboard=Cloudwalkers.Views.Pageview.extend({title:"Dashboard",widgets:[{widget:"messagescounters",type:"inbox",source:"streams",size:4,title:"Inbox",icon:"inbox",open:!0,counter:!0,typelink:"#inbox",countString:"incomingUnread",scrollable:"scrollable",translation:{title:"inbox"}},{widget:"messagescounters",type:"monitoring",source:"channels",size:4,title:"Keywords",icon:"tags",open:!0,counter:!0,countString:"incoming",scrollable:"scrollable",translation:{title:"keywords"}},{widget:"schedulecounter",
type:"schedule",source:"outgoing",size:4,title:"Schedule",icon:"time",open:!0,counter:!0,countString:"scheduled",link:"#scheduled",scrollable:"scrollable",translation:{title:"schedule"}},{widget:"coworkers",type:"drafts",size:4,title:"Co-workers wall",color:"yellow",icon:"edit",open:!0,link:"#coworkers",scrollable:"scrollable",translation:{title:"co-workers_wall"}},{widget:"trending",type:"profiles",size:4,title:"Trending Company Posts",color:"grey",icon:"thumbs-up",open:!0,since:7,sublink:"#trending/",
scrollable:"scrollable",translation:{title:"trending_company_posts"}},{widget:"trending",type:"news",size:4,title:"Trending Accounts we follow",color:"red",icon:"thumbs-up",open:!0,since:1,sublink:"#trending/",scrollable:"scrollable",translation:{title:"trending_accounts_we_follow"}}],initialize:function(){Cloudwalkers.Session.ping();this.translateTitle("dashboard")},addDynamicReports:function(){var a=Cloudwalkers.Session.getStreams().where({statistics:1}),b=[];for(n in a)switch(a[n].get("network").token){case "facebook":b.push({widget:"report",
size:3,stream:a[n],type:"numbercomparison/likes",dashboard:!0});b.push({widget:"report",size:3,stream:a[n],type:"besttimetoposttext",dashboard:!0});break;case "twitter":b.push({widget:"report",size:3,stream:a[n],type:"numbercomparison/followers_count",dashboard:!0}),b.push({widget:"report",size:3,stream:a[n],type:"besttimetoposttext",dashboard:!0})}return b},render:function(){var a=this.widgets;this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);
Cloudwalkers.Session.isAuthorized("STATISTICS_VIEW")&&(a=a.concat(this.addDynamicReports()));for(i in a){this.translateWidgets(a[i]);switch(a[i].widget){case "messagescounters":var b=this.addMessagesCounters(a[i]);break;case "schedulecounter":b=this.addScheduleCounters(a[i]);break;case "coworkers":b=this.addDashboardDrafts(a[i]);break;case "trending":b=this.addDashboardTrending(a[i]);break;case "report":b=new Cloudwalkers.Views.Widgets.Report(a[i])}b&&this.appendWidget(b,Number(a[i].size))}return this},
addMessagesCounters:function(a){var b=Cloudwalkers.Session.getChannel(a.type);if(b)return $.extend(a,{name:b.get("name"),open:1,channel:b}),new Cloudwalkers.Views.Widgets.MessagesCounters(a)},addScheduleCounters:function(a){var b=Cloudwalkers.Session.getChannel("internal");b.outgoing=new Cloudwalkers.Collections.Streams(b.get("additional").outgoing);$.extend(a,{name:b.get("name"),open:1,channel:b});return new Cloudwalkers.Views.Widgets.MessagesCounters(a)},addDashboardDrafts:function(a){a.model=Cloudwalkers.Session.getStream("coworkers");
if(a.model)return a.link="#coworkers",new Cloudwalkers.Views.Widgets.DashboardMessageList(a)},addDashboardTrending:function(a){a.trending=!0;a.model=Cloudwalkers.Session.getChannel(a.type);a.filters={sort:"engagement",since:3600*Math.round(Date.now()/36E5)-86400*a.since};if(a.model)return new Cloudwalkers.Views.Widgets.DashboardMessageList(a)},translateWidgets:function(a){if(a.translation)for(k in a.translation)a[k]=Cloudwalkers.Session.polyglot.t(a.translation[k])},translateTitle:function(a){this.title=
Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.MessageBoard=Cloudwalkers.Views.Widgets.WidgetContainer.extend({title:"Message Board",widgets:{}});Cloudwalkers.Views.IB=Cloudwalkers.Views.Pageview.extend({id:"inbox",title:"Inbox",className:"container-fluid inbox",initialize:function(){options&&$.extend(this,options);this.model=Cloudwalkers.Session.getStream("draft");if(!this.model)return Cloudwalkers.Router.Instance.exception();Cloudwalkers.Session.viewsettings("ib-"+this.channeltype);this.listenTo(Cloudwalkers.RootView,"resize",this.resize)},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=
this.$el.find("#widgetcontainer").eq(0);this.options.channel.childtype=this.options.type.slice(0,-1);var a=new Cloudwalkers.Views.Widgets.InboxList({model:this.model});this.appendWidget(a,4);this.appendhtml(Templates.inboxcontainer);this.listenTo(Cloudwalkers.RootView,"resize",this.resize);return this},resize:function(a){this.$el.find("section, main").height(a-120)},finish:function(){this.resize(Cloudwalkers.RootView.height());$message=this.$el.find(".inbox-container").wrap("<div class='scroller'>");
$message.parent().slimScroll({height:"inherit"})}});
Cloudwalkers.Views.Inbox=Cloudwalkers.Views.Pageview.extend({title:"Inbox",className:"container-fluid inbox",initialize:function(){var a=Cloudwalkers.Session.viewsettings(this.options.type);a.streams&&(this.options.filters={contacts:{string:"",list:[]},streams:a.streams})},render:function(){this.translate_title=this.translateString(this.options.type);this.$el.html(Mustache.render(Templates.pageview,{title:this.translate_title}));this.$container=this.$el.find("#widgetcontainer").eq(0);this.options.channel.childtype=
this.options.type.slice(0,-1);var a="messages"==this.options.type?new Cloudwalkers.Views.Widgets.InboxMessageList(this.options):new Cloudwalkers.Views.Widgets.InboxNotificationList(this.options);this.appendWidget(a,4);this.appendhtml(Templates.inboxcontainer);this.listenTo(Cloudwalkers.RootView,"resize",this.resize);return this},resize:function(a){this.$el.find("#widgetcontainer").height(a-140)},finish:function(){this.resize(Cloudwalkers.RootView.height());$message=this.$el.find(".inbox-container").wrap("<div class='scroller'>");
$message.parent().slimScroll({height:"inherit"})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Demo=Cloudwalkers.Views.Pageview.extend({title:"Demo",events:{"click #viewcontact":"viewcontact","click #createnote":"createnote"},initialize:function(a){a&&$.extend(this,a);this.translateTitle("demo")},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);var a=$("<button>",{id:"viewcontact","class":"btn",text:"View contact"});this.$container.append(a);this.$container.append("<br><br>");a=
$("<button>",{id:"createnote","class":"btn",text:"Create Note"});this.$container.append(a);a=Mustache.render(Templates.demos.demomessagetags);this.$container.append(a);return this},viewcontact:function(){Cloudwalkers.RootView.viewContact()},createnote:function(){var a=Cloudwalkers.Session.getAccount();Cloudwalkers.RootView.writeNote(a)},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Drafts=Cloudwalkers.Views.Pageview.extend({title:"Drafts",className:"container-fluid drafts",initialize:function(){this.model=Cloudwalkers.Session.getStream("draft");if(!this.model)return Cloudwalkers.Session.home();this.listenTo(this.model,"sync",this.render);this.translateTitle("drafts")},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);var a=new Cloudwalkers.Views.Widgets.DraftsFilters({model:this.model});
this.appendWidget(a,4);var b=new Cloudwalkers.Views.Widgets.DraftsList({model:this.model});this.appendWidget(b,8);a.list=b;return this},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Notes=Cloudwalkers.Views.Pageview.extend({title:"Notes",className:"container-fluid inbox inbox-notes",initialize:function(a){this.model=Cloudwalkers.Session.getAccount();this.events["click [data-action=viewcontact]"]="viewcontact"},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);var a=new Cloudwalkers.Views.Widgets.InboxNotesList({check:"hasnotes",collectionstring:"notes",listtype:"notes",
model:this.model});this.list=a;this.appendWidget(a,4);this.appendhtml(Templates.inboxcontainer);return this},viewcontact:function(){this.list.trigger("contact:clicked")},resize:function(a){this.$el.find("#widgetcontainer").height(a-140)},finish:function(){this.resize(Cloudwalkers.RootView.height());$message=this.$el.find(".inbox-container").wrap("<div class='scroller'>");$message.parent().slimScroll({height:"inherit"})}});Cloudwalkers.Views.Scheduled=Cloudwalkers.Views.Pageview.extend({title:"Schedule",className:"container-fluid scheduled",initialize:function(){this.model=Cloudwalkers.Session.getStream("scheduled");if(!this.model)return Cloudwalkers.Session.home();this.listenTo(this.model,"sync",this.render);this.translateTitle("scheduled")},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);var a=new Cloudwalkers.Views.Widgets.ScheduledFilters({model:this.model});
this.appendWidget(a,4);var b=new Cloudwalkers.Views.Widgets.ScheduledList({model:this.model});this.appendWidget(b,8);a.list=b;return this},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Calendar=Cloudwalkers.Views.Pageview.extend({title:"Calendar",className:"container-fluid calendar",viewtype:"month",views:[],parameters:{records:999},events:{remove:"destroy","change select":"toggleView","click #subtract":"prev","click #add":"next","click #now":"now"},initialize:function(){this.model=Cloudwalkers.Session.getChannel("profiles");if(!this.model)return Cloudwalkers.Session.home();this.translateTitle("calendar");this.listenTo(this.model,"sync",this.render)},render:function(){var a=
{monthActive:!0};this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.calendar,a));this.$container=this.$el.find("#widgetcontainer").eq(0);a=new Cloudwalkers.Views.Widgets.CalendarFilters({model:this.model,calview:this});this.appendWidget(a,3);a=new Cloudwalkers.Views.Widgets.CalSummary({calview:this});this.views.push(a);this.appendWidget(a,9);this.$el.find("select").chosen({width:"200px",disable_search_threshold:10,inherit_select_classes:!0});setTimeout(this.initCalendar.bind(this),
10);return this},populate:function(a,b,c,e){a=a.startOf("month").add(1,"month");b=b.endOf("month").subtract(1,"month");this.datedisplay(a,b);this.listenToOnce(this.model.messages,"ready",this.fill.bind(this,e));this.listenToOnce(this.model.messages,"cached",this.fill.bind(this,e));$.extend(this.parameters,{since:a.unix(),until:b.unix()});this.model.messages.touch(this.model,this.parameters)},datedisplay:function(a,b){var c=moment();a.isAfter(c)||b.isBefore(c)?this.$el.find("#now").removeClass("hidden"):
this.$el.find("#now").addClass("hidden");var e="agendaWeek"==this.viewtype?"week":"month",c=(c=a.diff(c,e+"s"))?-2<c&&0>c?"last ":2>c&&0<c?"next ":"":"this ",f=24<a.date()?11==a.month()?"DD MMM YYYY":"DD MMM":"DD",f=a.format(f)+" - "+b.format("DD MMM YYYY");this.$el.find("h3.stats-header-timeview").html("<strong>"+c+e+": </strong>"+f)},fill:function(a,b){var c=[];for(n in b.models)c.push(b.models[n].filterCalReadable().calNode);a(c)},updatenode:function(a,b){$("#calendar").fullCalendar("updateEvent",
a.filterCalReadable().calNode)},filldrafts:function(a){$("#drafts-list").html("");for(n in a)this.addDraft("Draft message ("+a[n].id+")")},toggleView:function(a){this.viewtype=$(a.currentTarget).val();"list"==this.viewtype?this.initList():$("#calendar").removeClass("hidden");$("#calendar").fullCalendar("changeView",this.viewtype)},prev:function(){$("#calendar").fullCalendar("prev")},next:function(){$("#calendar").fullCalendar("next")},now:function(){$("#calendar").fullCalendar("today")},initCalendar:function(){$("#calendar").fullCalendar({header:!1,
slotMinutes:30,editable:!1,droppable:!1,allDayDefault:!1,allDaySlot:!1,firstDay:1,axisFormat:"H:mm",defaultTimedEventDuration:"00:30:00",slotEventOverlap:!1,events:this.populate.bind(this),eventRender:function(a,b){if(!a.icon)return!1;$(b).find(".fc-event-time").html("<i class='icon-"+a.icon+"'></i>");a.media&&$(b).find(".fc-event-inner").prepend("<i class='fc-event-media pull-right icon-"+a.media+"'></i>");$(b).data("title",a.intro).tooltip({html:!0,delay:500,placement:"top"});a.rendered=!0}})},
addDraft:function(a){a=0==a.length?"Untitled Event":a;a=$('<div class="external-event label">'+a+"</div>");$("#drafts-list").append(a);this.initDrag(a)},initDrag:function(a){var b={title:$.trim(a.text())};a.data("eventObject",b);a.draggable({zIndex:999,revert:!0,revertDuration:0})},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["week","month","list_view",
"now"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Coworkers=Cloudwalkers.Views.Pageview.extend({title:"Co-workers wall",className:"container-fluid coworkers",initialize:function(){this.model=Cloudwalkers.Session.getStream("coworkers");if(!this.model)return Cloudwalkers.Session.home();this.listenTo(this.model,"outdated",this.model.fetch);this.listenTo(this.model,"sync",this.render);this.translateTitle("co-workers_wall")},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);
var a=new Cloudwalkers.Views.Widgets.CoworkersFilters({model:this.model});this.appendWidget(a,4);var b=new Cloudwalkers.Views.Widgets.CoworkersList({model:this.model});this.appendWidget(b,8);a.list=b;return this},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Timeline=Cloudwalkers.Views.Pageview.extend({id:"timeline",parameters:{records:20,markasread:!0},entries:[],events:{"click *[data-action]":"action","click .load-more":"more"},initialize:function(a){a&&$.extend(this,a);this.collection=this.model.messages;this.$el.addClass("loading");this.listenTo(this.collection,"seed",this.fill)},hideloading:function(){this.$el.removeClass("loading")},render:function(){var a={};this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.timeline,
a));this.$container=this.$el.find("ul.timeline").eq(0);this.$loadmore=this.$el.find(".load-more").remove();this.$nocontent=this.$el.find(".no-content").remove();this.collection.touch(this.model,this.filterparameters());return this},filterparameters:function(){return this.parameters},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){a[n].attributes.showcontact=this.showcontact;var b=new Cloudwalkers.Views.Entry({model:a[n],
template:"messagetimeline",type:"full",parameters:{trendview:this.trending}});this.entries.push(b);this.$container.append(b.render().el)}this.collection.cursor?this.$container.append(this.$loadmore):a.length||this.$container.append(this.$nocontent);this.hideloading()},more:function(){this.incremental=!0;this.collection.more(this.model,this.filterparameters())||this.$el.find(".load-more").hide()},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=
["loading","view_more","no_messages","comments"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Trending=Cloudwalkers.Views.Pageview.extend({initialize:function(a){a&&$.extend(this,a);this.listenTo(this.model.streams,"seed",this.fill);this.listenTo(this.model.streams,"request",this.showloading);this.listenTo(this.model.streams,"sync",this.hideloading)},render:function(){var a={streams:[],networks:this.model.streams.filterNetworks(null,!0)};this.model.streams.each(function(b){a.streams.push({id:b.id,icon:b.get("network").icon,name:b.get("defaultname")})});this.$el.html(Mustache.render(Templates.trending,
a));this.collection.touch(this.model,{records:40,sort:"engagement",since:3600*Math.round(Date.now()/36E5)-86400*this.span});return this}});Cloudwalkers.Views.ManageAccounts=Cloudwalkers.Views.Pageview.extend({id:"manageaccounts",className:"container-fluid",title:"Manage Accounts",entries:[],events:{rendered:"bubblerender",remove:"destroy","search .input-large":"posturl","blur .input-large":"posturl","click *[data-network]":"filter","click .toggleall.active":"toggleall"},initialize:function(a){a&&$.extend(this,a);this.collection=new Cloudwalkers.Collections.Contacts([],{});this.listenTo(this.collection,"seed",this.limited);this.listenTo(this.collection,
"remove",this.limited);this.listenTo(this.collection,"add",this.addcontact);this.translateTitle("manage_accounts")},render:function(){var a={networks:this.channel.streams.filterNetworks(null,!0)};a.title=this.title;this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.manageaccounts,a));this.$container=this.$el.find(".contacts-list");this.collection.touch(null,{records:200});return this},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),
this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.ContactView({model:a[n],parameters:{inboxview:!0}});this.entries.push(b);this.$container.append(b.render().el)}},addcontact:function(a){view=new Cloudwalkers.Views.ContactView({model:a,parameters:{}});this.entries.push(view);this.$container.prepend(view.render().el);this.$el.find(".icon-cloud-upload").toggleClass("icon-search icon-cloud-upload");this.listenTo(a,"unfollow",function(a){this.collection.remove(a)})},posturl:function(a){a=$(a.currentTarget);
if(!a.val())return null;this.collection.create({url:a.val(),following:!0},{wait:!0,error:this.postfailure.bind(this,a.val())});this.$el.find(".url-post span").toggleClass("icon-search icon-cloud-upload");this.listenToOnce(this.collection,"add",this.limited);a.val("")},postfailure:function(a){this.$el.find(".icon-cloud-upload").toggleClass("icon-search icon-cloud-upload");Cloudwalkers.RootView.information("Non-supported profile","This link is not recognized: "+a,this.$el.find(".info-container"))},
limited:function(a){Cloudwalkers.Session.getAccount().monitorlimit("following",this.collection.models.length,$(".url-post, .url-post .input-large"))},filter:function(a,b){b||(b=this.button&&this.button.data("network")==$(a.currentTarget).data("network"));this.togglefilters(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:this.button.data("network");b&&(this.button=!1);b||this.$el.find(".contacts-list li").not("."+c).addClass("hidden");this.$el.find(".contacts-list li."+
(c?c:"hidden")).removeClass("hidden");return this},togglefilters:function(a){this.$el.find("div[data-network]").addClass(a?"active":"inactive").removeClass(a?"inactive":"active");this.$el.find(".toggleall").addClass(a?"inactive":"active").removeClass(a?"active":"inactive")},toggleall:function(){this.filter(!0);this.togglefilters(!0)},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=
["networks","show_all","enter_profile_link"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.KeywordMonitoring=Cloudwalkers.Views.Pageview.extend({title:"Keyword Monitoring",className:"container-fluid monitoring",initialize:function(){if(!this.options.category)return Cloudwalkers.Session.home();this.category=this.options.category;this.translateTitle("keyword_monitoring")},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);var a=new Cloudwalkers.Views.Widgets.MonitorFilters({category:this.category});
this.appendWidget(a,4);var b=new Cloudwalkers.Views.Widgets.MonitorList({category:this.category,reset:!0});this.appendWidget(b,8);a.list=b;return this},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.ManageKeywords=Cloudwalkers.Views.Pageview.extend({title:"Manage Keywords",className:"container-fluid managekeywords",render:function(){var a=12;setTimeout(this.limitlistener,50);this.listenTo(Cloudwalkers.Session.getChannels(),"sync remove",this.limitlistener);this.translateTitle("manage_keywords");this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);if(Cloudwalkers.Session.isAuthorized("CHANNEL_MANAGE_ADD_MONITORING")){var b=
new Cloudwalkers.Views.Widgets.KeywordsEditor;this.appendWidget(b,4);a=8}var c=new Cloudwalkers.Views.Widgets.KeywordsOverview({editor:b});this.appendWidget(c,a);this.widgets=[b,c];return this},limitlistener:function(){var a=Cloudwalkers.Session.getChannel("monitoring").channels.reduce(function(a,c){return("number"==typeof a?a:a.get("channels").length)+c.get("channels").length});Cloudwalkers.Session.getAccount().monitorlimit("keywords",a,".add-keyword")},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Reports=Cloudwalkers.Views.Widgets.WidgetContainer.extend({navclass:"reports",title:"Report",datepicker:null,initializeWidgets:function(){this.title=this.title+" "+this.options.stream.get("customname");this.datepicker=new Cloudwalkers.Views.Widgets.Datepicker;if("undefined"!=typeof this.options.stream&&this.options.stream)this.addStreamWidgets(this.options.stream);else for(var a=Cloudwalkers.Session.getStreams(),b=0;b<a.length;b++)a[b].get("statistics")&&this.addStreamWidgets(a[b])},
addStreamWidgets:function(a){var b=this;$.ajax(Cloudwalkers.Session.api+"/streams/"+a.get("id")+"/statistics",{success:function(c){if(0<c.statistics.length){for(var e=[],f=[],g=0;g<c.statistics.length;g++)"time"==c.statistics[g].type?e.push(c.statistics[g]):f.push(c.statistics[g]);b.addCombinedWidget(a.attributes,e);for(c=0;c<f.length;c++)b.addReportWidget(a.attributes,f[c])}},beforeSend:function(a){a.setRequestHeader("Accept","application/json");a.setRequestHeader("Authorization","Bearer "+Cloudwalkers.Session.authenticationtoken)}})},
addCombinedWidget:function(a,b){for(var c=[],e=0;e<b.length;e++){var f=b[e],g=void 0;b[e].stream=a;g=new Cloudwalkers.Models.Report(f);c.push(g)}c=new Cloudwalkers.Views.Widgets.CombinedStatistics({reports:c,stream:a});c.color=a.network.icon+"-color";c.network=a.network;this.add(c)},addReportWidget:function(a,b){b.stream=a;var c=new Cloudwalkers.Models.Report(b),e=c.getWidget(),f=this.datepicker.getDateRange();c.setDateRange(f[0],f[1]);e.color=a.network.icon+"-color";e.network=a.network;e.showLink=
!1;e.showStreamName=!1;this.datepicker.on("date:change",function(a,b){e.getDataset().setDateRange(a,b)});this.add(e)}});Cloudwalkers.Views.Statistics=Cloudwalkers.Views.Pageview.extend({id:"statistics",start:0,end:0,timespan:"week",period:0,custom:!1,views:[],events:{remove:"destroy","click #add":"addperiod","click #subtract":"subtractperiod","click #now":"now","click #show":"changecustom","change .stats-header select.networks":"changestream","change .stats-header select.time":"changespan","click .dashboard-stat":"updatenetwork"},widgets:[{widget:"StatSummary",data:{columnviews:["contacts","score-trending","outgoing",
"coworkers"]},span:12},{widget:"TitleSeparator",data:{translation:{title:"contacts_info"}}},{widget:"Chart",data:{filterfunc:"contacts",chart:"PieChart",translation:{title:"contacts"},display:"divided"},span:6},{widget:"CompoundChart",span:6,data:{template:"2col1row",chartdata:[{widget:"Chart",data:{filterfunc:"age",chart:"PieChart",translation:{title:"by_age"}}},{widget:"Chart",data:{filterfunc:"gender",chart:"PieChart",translation:{title:"by_gender"}}},{widget:"Chart",data:{filterfunc:"contact-evolution",
chart:"LineChart",translation:{title:"contacts_evolution"}}}]}},{widget:"TitleSeparator",data:{translation:{title:"new_this"}}},{widget:"Info",data:{translation:{title:"contact_evolution"},filterfunc:"contact-evolution"},span:3},{widget:"Info",data:{translation:{title:"post_activity"},filterfunc:"post-activity"},span:3},{widget:"Info",data:{title:"Activity?",filterfunc:"activity"},span:3},{widget:"Info",data:{title:"Page Views?",filterfunc:"page-views"},span:3},{widget:"TitleSeparator",data:{translation:{title:"messages_info"}}},
{widget:"TrendingMessage",data:{translation:{title:"top_rated_comment"}},span:12},{widget:"BestTimeToPost",data:{filterfunc:"besttime",chart:"LineChart",translation:{title:"best_time_to_post"}},span:4},{widget:"Chart",data:{filterfunc:"message-evolution",chart:"LineChart",translation:{title:"messages_evolution"}},span:4},{widget:"HeatCalendar",data:{filterfunc:"activity",translation:{title:"activity_calendar"}},span:4},{widget:"TitleSeparator",data:{translation:{title:"geo_graphics"}}},{widget:"Chart",
data:{filterfunc:"geo",type:"dots",chart:"GeoChart",translation:{title:"countries"},connect:!0},span:8},{widget:"CompoundChart",span:4,data:{template:"2row",chartdata:[{widget:"Chart",data:{filterfunc:"regional",chart:"PieChart",translation:{title:"countries"}},connect:"regional"},{widget:"Chart",data:{filterfunc:"cities",chart:"PieChart",translation:{title:"cities"}}}]}}],initialize:function(a){a&&$.extend(this,a);this.model.statistics||(this.model.statistics=new Cloudwalkers.Collections.Statistics);
this.collection=this.model.statistics;this.listenTo(this.collection,"request",this.showloading);this.cleancollection();google.load("visualization","1",{callback:function(){this.render()}.bind(this),packages:["corechart"]})},render:function(){var a=this.timemanager();a.streams=[];a.streams=this.model.streams.where({statistics:1}).map(function(a){a.attributes.selected=a.id==this.streamid;return a.attributes}.bind(this));this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.statsview,
a));this.$container=this.$el.find("#widgetcontainer").eq(0);this.$el.find("select").chosen({width:"200px",disable_search_threshold:10,inherit_select_classes:!0});"custom"==this.timespan&&this.$el.find("#start, #end").datepicker({format:"dd-mm-yyyy"});0==this.period&&this.$el.find("#add").attr("disabled",!0);this.collection.touch(this.model,this.filterparameters());return this},fillcharts:function(){this.collection.latest()&&this.collection.latest().get("streams")?this.hideloading():this.listenToOnce(this.collection,
"sync",this.hideloading);this.cleanviews();for(n in this.widgets){if(this.widgets[n].data.translation)this.translateWidgets(this.widgets[n].data);else if(this.widgets[n].data.chartdata)for(i in this.widgets[n].data.chartdata)this.translateWidgets(this.widgets[n].data.chartdata[i].data);var a=this.streamid||!1;if(a){var b=Cloudwalkers.Session.getStream(a).get("network").token;if(this.widgets[n].networks&&this.widgets[n].networks!=b)continue}_.isString(this.widgets[n].data)&&(this.widgets[n].data=this.networkspecific[this.widgets[n].data][b]);
this.widgets[n].data.network=a;this.widgets[n].data.model=this.model;this.widgets[n].data.parent=this;this.widgets[n].data.visualization=google.visualization;this.widgets[n].data.timespan={since:this.start.unix(),to:this.end.unix()};this.widgets[n].data.span=this.timespan;translate={};translate.new_this=this.translateString("new_this");translate.top_rated_comment=this.translateString("top_rated_comment");translate.messages_evolution=this.translateString("messages_evolution");translate.activity_calendar=
this.translateString("activity_calendar");translate.new_this_n="week"==this.timespan?this.translateString("new_this"):this.translateString("new_this_m");this.widgets[n].data.title==translate.new_this&&(this.widgets[n].data.title=translate.new_this_n+" "+this.translateString(this.timespan));this.widgets[n].data.title==translate.top_rated_comment&&(this.widgets[n].span="quarter"==this.timespan?8:"year"==this.timespan?8:12);this.widgets[n].data.title==translate.messages_evolution&&(this.widgets[n].span=
"quarter"==this.timespan?6:"year"==this.timespan?12:4);this.widgets[n].data.title==translate.activity_calendar&&(this.timespan==translate.this?quarter.widgets[n].span=6:"year"==this.timespan?(this.widgets[n].span=12,this.widgets[n].data.bigdata=!0):(this.widgets[n].span=4,this.widgets[n].data.bigdata=!1));a=new Cloudwalkers.Views.Widgets[this.widgets[n].widget](this.widgets[n].data);this.views.push(a);this.appendWidget(a,this.widgets[n].span)}},timemanager:function(){var a=this.filterparameters(),
b=moment.unix(a.since),c=24<b.date()||"quarter"==a.span?11==b.month()?"DD MMM YYYY":"DD MMM":"DD";a.periodstring=this.period||"custom"==a.span?-1==this.period?"last ":"":"this ";a.timeview=b.format(c)+" - "+moment.unix(a.until).format("DD MMM YYYY");a[a.span+"Active"]=!0;a.startstring=moment.unix(a.since).format("DD-MM-YYYY");a.endstring=moment.unix(a.until).format("DD-MM-YYYY");a.fullperiod="pt_PT"==Cloudwalkers.Session.user.attributes.locale?this.translateString(a.span)+" "+this.translateString(a.periodstring):
this.translateString(a.periodstring)+" "+this.translateString(a.span);return a},resize:function(){},showloading:function(){this.$el.addClass("loading")},hideloading:function(a,b){this.$el.removeClass("loading");this.$el.find(".period-buttons .btn").attr("disabled",!1);this.$el.find("select").prop("disabled",!1).trigger("chosen:updated");this.listenToOnce(this,"change:period",this.render)},now:function(){this.cleancollection();this.period=0;this.trigger("change:period")},addperiod:function(a){a=$(a.target).attr("disabled");
0<=this.period||"disabled"==a||(this.cleancollection(),this.period+=1,this.trigger("change:period"))},subtractperiod:function(a){"disabled"!=$(a.target).attr("disabled")&&(this.cleancollection(),this.period-=1,this.trigger("change:period"))},changestream:function(){var a=Number(this.$el.find("select.networks").val());Cloudwalkers.Router.Instance.navigate(a?"#statistics/"+a:"#statistics",{trigger:!0})},changespan:function(){this.cleancollection();this.timespan=this.$el.find("select.time").val();this.trigger("change:period")},
changecustom:function(){this.cleancollection();this.start=moment(this.$el.find("#start").val(),"DD-MM-YYYY");this.end=moment(this.$el.find("#end").val(),"DD-MM-YYYY");this.trigger("change:period")},filterparameters:function(){"now"==this.timespan&&(this.period=0);"week"==this.timespan&&(this.start=moment().zone(0).startOf("isoweek"),this.end=moment().zone(0).endOf("isoweek"));"month"==this.timespan&&(this.start=moment().zone(0).startOf("month"),this.end=moment().zone(0).endOf("month"));"year"==this.timespan&&
(this.start=moment().zone(0).startOf("year"),this.end=moment().zone(0).endOf("year"));if("quarter"==this.timespan){var a=3*(this.period+moment().quarter());this.start=moment().startOf("year").add("months",a-3);this.end=moment().startOf("year").add("months",a-1).endOf("month")}else"custom"!=this.timespan&&(0<this.period&&(this.start.add(this.timespan+"s",this.period),this.end.add(this.timespan+"s",this.period)),0>this.period&&(this.start.subtract(this.timespan+"s",Math.abs(this.period)),this.end.subtract(this.timespan+
"s",Math.abs(this.period))));return{since:this.start.unix(),until:this.end.unix(),span:this.timespan,period:this.period}},finish:function(){},updatenetwork:function(a){},cleancollection:function(){this.listenToOnce(this.collection,"sync",this.fillcharts);this.collection.reset()},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},translateWidgets:function(a){if(a.translation)for(k in a.translation)a[k]=Cloudwalkers.Session.polyglot.t(a.translation[k])},mustacheTranslateRender:function(a){this.original=
"week month quarter year custom time_spans all_networks now show".split(" ");this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.StatStream=Cloudwalkers.Views.Statistics.extend({networkspecific:{typeA:{facebook:{filterfunc:"age",chart:"PieChart",title:"By Age"},twitter:{filterfunc:"follow",chart:"PieChart",title:"By Type"},linkedin:{filterfunc:"follow",chart:"PieChart",title:"By Type"},youtube:{filterfunc:"follow",chart:"PieChart",title:"By Type"}},typeB:{facebook:{filterfunc:"gender",chart:"PieChart",title:"By gender"},twitter:{filterfunc:"nodata",chart:"PieChart",title:"No data"},youtube:{filterfunc:"nodata",
chart:"PieChart",title:"No data"},linkedin:{filterfunc:"nodata",chart:"PieChart",title:"No data"}}},widgets:[{widget:"StatSummary",data:{columnviews:["contacts-network","score-trending-network","outgoing-network","besttime"]},span:12},{widget:"TitleSeparator",data:{title:"Contacts info"}},{widget:"Chart",data:{filterfunc:"contact-evolution-network",chart:"LineChart",title:"Contacts Evolution"},span:6},{widget:"Chart",data:"typeA",span:3},{widget:"Chart",data:"typeB",span:3},{widget:"TitleSeparator",
data:{title:"Network info"}},{widget:"Info",data:{title:"New impressions",filterfunc:"page-views-network"},span:3},{widget:"Info",data:{title:"New shares",filterfunc:"shares"},span:3},{widget:"Info",data:{title:"New posts",filterfunc:"posts"},span:3},{widget:"Info",data:{title:"New direct messages",filterfunc:"dms"},span:3},{widget:"TitleSeparator",data:{title:"Messages info"}},{widget:"TrendingMessage",data:{title:"Top rated comment"},span:12},{widget:"BestTimeToPost",data:{filterfunc:"besttime",
chart:"LineChart",title:"Best Time to Post"},span:4},{widget:"Chart",data:{filterfunc:"message-evolution-network",chart:"LineChart",title:"Messages Evolution"},span:4},{widget:"HeatCalendar",data:{filterfunc:"activity",title:"Activity Calendar"},span:4},{widget:"Chart",data:{filterfunc:"geo",type:"dots",chart:"GeoChart",title:"Countries",connect:!0},networks:["facebook"],span:8},{widget:"CompoundChart",span:4,data:{template:"2row",chartdata:[{widget:"Chart",data:{filterfunc:"regional",chart:"PieChart",
title:"Countries"},connect:"regional"},{widget:"Chart",data:{filterfunc:"cities",chart:"PieChart",title:"Cities"}}]},networks:["facebook"]}],initialize:function(a){a&&$.extend(this,a);this.streamid=Number(this.streamid);this.model.statistics||(this.model.statistics=new Cloudwalkers.Collections.Statistics);this.collection=this.model.statistics;this.listenTo(this.collection,"request",this.showloading);this.cleancollection();google.load("visualization","1",{callback:function(){this.gloaded=!0}.bind(this),
packages:["corechart"]})}});Cloudwalkers.Views.Settings=Cloudwalkers.Views.Pageview.extend({title:"Settings",tabs:[],initialize:function(){this.endpoint=this.options.endpoint;this.level=Cloudwalkers.Session.user.level},setAction:function(a){this.action=a},render:function(){var a={};this.tabs=[];this.mustacheTranslateRender(a);Cloudwalkers.Session.isAuthorized("USER_INVITE")&&this.tabs.push({url:"#settings/users",name:a.translate_manage_users});Cloudwalkers.Session.isAuthorized("SERVICE_CONNECT")&&this.tabs.push({url:"#settings/services",
name:a.translate_social_connections});Cloudwalkers.Session.isAuthorized("CAMPAIGN_DELETE")&&this.tabs.push({url:"#settings/account",name:a.translate_account_settings});this.tabs.push({url:"#settings/profile",name:a.translate_profile_settings});this.translateTitle("settings");this.$el.html(Mustache.render(Templates.tabview,{title:this.title,tabs:this.tabs}));this.$container=this.$el.find("#widgetcontainer").eq(0);this.$el.find('.nav-tabs a[href="#settings/'+this.endpoint+'"]').parent().addClass("active");
switch(this.endpoint){case "users":a=new Cloudwalkers.Views.Settings.Users;break;case "services":a=new Cloudwalkers.Views.Settings.Services({serviceid:this.options.serviceid});break;case "account":a=new Cloudwalkers.Views.Settings.Account;break;default:a=new Cloudwalkers.Views.Settings.Profile}this.appendWidget(a,12);return this},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=
["manage_users","social_connections","account_settings","manage_user_groups","profile_settings"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Firsttime=Cloudwalkers.Views.Pageview.extend({title:"First Time",events:{remove:"destroy","click [data-add-service]":"addService"},initialize:function(){this.services=new Cloudwalkers.Collections.Services;this.listenTo(this.services,"available:ready",this.appendOptions);this.services.fetchAvailable()},render:function(){Backbone.history.fragment="settings/services";$("#sidebar").addClass("collapsed");$("#inner-content").addClass("expanded");params={displayname:Cloudwalkers.Session.user.get("displayname")};
this.$el.html(Mustache.render(Templates.firsttime,params));return this},appendOptions:function(a,b){var c=this.$el.find(".networks-list");for(n in b)c.append(Mustache.render(Templates.settings.service_option,b[n]))},processLink:function(a){return a=0<a.indexOf("?")?a+"&return="+encodeURIComponent(window.location.origin+"/#settings/services"):a+"?return="+encodeURIComponent(window.location.origin+"/#settings/services")},addService:function(a){a=$(a.target).data("add-service");this.listenToOnce(this.services,
"sync",function(a){a=a.get("authenticateUrl");if(!a)return null;window.location=this.processLink(a)});this.services.create({},{wait:!0,endpoint:a})},destroy:function(){$("#sidebar, #inner-content").removeClass("collapsed expanded")}});Cloudwalkers.Views.Coworkdashboard=Cloudwalkers.Views.Pageview.extend({title:"First Time",events:{remove:"destroy","click [data-add-service]":"addServiceCall"},initialize:function(){Cloudwalkers.Session.getAccount()},render:function(){Backbone.history.fragment="settings/services";$("#sidebar").addClass("collapsed");$("#inner-content").addClass("expanded");params={displayname:Cloudwalkers.Session.user.get("displayname")};this.mustacheTranslateRender(params);this.$el.html(Mustache.render(Templates.coworkerdashboard,
params));return this},processLink:function(a){return a=0<a.indexOf("?")?a+"&return="+encodeURIComponent(window.location):a+"?return="+encodeURIComponent(window.location)},addServiceCall:function(a){a.preventDefault();var b=this;a=$(a.target).attr("data-add-service");this.addService(a,function(a){"undefined"!=typeof a.error?Cloudwalkers.RootView.alert(a.error.message):($.each(a.service.settings,function(a,c){if("link"==c.type){var g=b.processLink(c.url);window.location=g}}),b.render())})},destroy:function(){$("#sidebar, #inner-content").removeClass("collapsed expanded")},
translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["welcome","lets_get_started","update_your_profile"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.Widget=Backbone.View.extend({title:"Untitled widget",icon:"inbox",color:"blue",network:null,entries:[],events:{},tools:[],initialize:function(){this.options.color||(this.options.color=this.color);this.initializeWidget()},initializeWidget:function(){this.bind("destroy",this.onDestroy);this.bind("add",function(){console.log("View add triggrered")})},innerRender:function(a){a.html("No inner content set.")},render:function(){"undefined"!=typeof this.options.title&&(this.title=
this.options.title);"undefined"!=typeof this.options.icon&&this.options.icon&&(this.icon=this.options.icon);this.$el.html(Mustache.render(Templates.widget,{title:this.title,color:this.color,icon:this.icon,tools:this.tools,network:this.network}));for(var a=0;a<this.tools.length;a++)this.attachToolEvents(this.tools[a]);this.$innerEl=$(this.$el.find(".portlet-body"));this.innerRender(this.$innerEl);return this},attachToolEvents:function(a){var b=this;this.$el.find("."+a["class"]).click(function(c){b[a.event](c)})},
negotiateFunctionalities:function(){this.$el.find(".scroller").length&&this.addScroll();this.options.counter&&this.appendCounter();"undefined"!=typeof this.options.open&&this.appendCollapseble(this.options.open)},appendCollapseble:function(a){this.$el.addClass(a?"collapse-open":"collapse-closed");this.$el.find(".tools .count").length?this.$el.find(".tools .count").addClass("collapse"):this.$el.find(".tools").append($('<span class="collapse pull-right"></span>'));this.$el.find(".portlet-title.line").on("click",
this.collapse.bind(this))},appendCounter:function(a){var b=0;this.$el.find("li .number, li .count").each(function(){b+=Number($(this).text())});999<b&&(b="+999");0>b&&(b=0);this.$el.find(".tools").append($('<span class="count">'+b+"</span>"))},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",position:"right",height:$(this).attr("data-height"),alwaysVisible:"1"==$(this).attr("data-always-visible")?!0:!1,railVisible:"1"==$(this).attr("data-rail-visible")?!0:!1,
disableFadeOut:!0})},onDestroy:function(){$.each(this.entries,function(a,b){b.trigger("destroy")});this.$el.find(".scroller").slimScroll({destroy:1});this.remove()},collapse:function(){this.$el.toggleClass("collapse-closed collapse-open")}});Cloudwalkers.Views.Entry=Backbone.View.extend({tagName:"li",template:"messageentry",notifications:[],parameters:{},loadedlists:[],events:{remove:"destroy","click [data-notifications]":"loadNotifications","click [data-youtube]":"loadYoutube","click *[data-action]":"action",click:"toggle"},initialize:function(a){this.parameters={};a&&$.extend(this,a);this.loadmylisteners()},loadmylisteners:function(){this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"action:toggle",this.toggleaction);
this.listenTo(this.model,"destroy",this.remove)},render:function(){$.extend(this.parameters,this.model.attributes);"full"==this.type&&this.model.get("objectType")&&(this.parameters.actions=this.model.filterActions());Cloudwalkers.Session.censuretemplate(this.parameters);for(n in this.parameters.actions)this.parameters.actions[n].name_translated=this.translateString(this.parameters.actions[n].name);this.parameters.hasactions=this.parameters.actions&&!this.parameters.actions.length?!1:!0;for(n in this.parameters.statistics)this.parameters.statistics[n].name_translated=
this.translateString(this.parameters.statistics[n].name);this.mustacheTranslateRender(this.parameters);this.parameters.hasnotes=this.model.hasnotes();this.$el.html(Mustache.render(Templates[this.template],this.parameters));this.$el.find("[data-date]")&&this.time();this.checkunread&&this.model.get("objectType")&&this.checkUnread();Cloudwalkers.Session.isAuthorized("ACCOUNT_NOTES_VIEW")&&(this.$el.find(".note-list").html("<li>"+Mustache.render(Templates.messagenote)+"</li>"),this.loadnoteui());this.parameters.hasactions&&
this.renderactions();return this},renderactions:function(){this.actions=new Cloudwalkers.Views.Actions({message:this.model});this.$el.find(".message-actions").html(this.actions.render().el);this.loadedlists=[];if("messagetimeline"==this.template)this.actions.on("actions:update",this.updatetimelineactions.bind(this))},updatetimelineactions:function(){var a=this.actions.message.notes.length;a&&this.$el.find(".interaction > .notescount").html(a)},action:function(a){var b=$(a.currentTarget).data("action");
if("note"==b||"action-list"==b){if("messagetimeline"==this.template){var c=Cloudwalkers.RootView.writeNote(this.model);this.listenTo(c.note,"sync",this.noteadded)}c=$(a.currentTarget).data("token");this.toggleactions(b,c,a)}else if("note-edit"==b)this.editnote();else if("tag-showedit"==b)this.showtagedit();else if("tag-add"==b){if(b=$(a.currentTarget).siblings("input").val())this.submittag(b),$(a.currentTarget).siblings("input").val("")}else"viewcontact"==b?this.parent||(a=this.model.attributes.from?
this.model.attributes.from[0]:null)&&Cloudwalkers.RootView.viewContact({model:a}):this.model.trigger("action",b)},editnote:function(){var a=new Cloudwalkers.Views.ComposeNote({note:this.model});this.stopListening(this.model);this.listenTo(a,"edit:cancel",this.canceledit);this.listenTo(a,"save:success",this.saved);this.$el.find(".message-body").addClass("note-content").html(a.render().el);this.$el.find(".message-actions").addClass("hidden");this.$el.find(".toggle-note-actions").toggle()},showtagedit:function(){this.$el.find(".message-tags").toggleClass("enabled");
this.$el.find(".message-tags .edit").toggleClass("inactive")},canceledit:function(a){this.loadmylisteners();this.$el.find(".message-actions").removeClass("hidden");a?this.toggleaction("note"):(this.$el.find(".message-body").removeClass("note-content").html(this.model.get("text")),this.$el.find(".toggle-note-actions").toggle())},saved:function(){setTimeout(function(){this.canceledit();this.loadmylisteners()}.bind(this),200)},toggleactions:function(a,b,c){c&&$(c.currentTarget).hasClass("noresults")||
(c=this.$el.find("[data-action="+a+"][data-token="+b+"]"),c.hasClass("inactive")?c.hasClass("inactive")&&this.processaction("close"):this.processaction("open",a,b))},processaction:function(a,b,c){var e=this.$el.find("[data-action="+b+"][data-token="+c+"]"),f=this.$el.find(".actionvalue.inactive"),g=this.$el.find(".actionname.inactive"),h=this.$el.find(".action-list"),m=this.$el.find(".note-content"),l=!1;if(h.is(":visible")||m.is(":visible"))l=!0;f.removeClass("inactive");g.removeClass("inactive");
this.$el.find(".action-list").slideUp("fast");this.$el.find(".note-content").slideUp("fast");"close"!=a&&setTimeout(function(){e.addClass("inactive");"action-list"==b?this.expandlist(c):"note"==b&&m.slideDown()}.bind(this),l?200:1)},expandlist:function(a){if(0>this.loadedlists.indexOf(a+"list"))return this.fetchactions(a);this.$el.find(".action-list."+a+"-list").slideDown()},fetchactions:function(a){var b="note"==a?this.model.notes:this.model.notifications;b.parentmodel=this.model;b.parenttype="message";
this.listenTo(b,"seed",this.fillactions.bind(this,a));b.touch(this.model,{records:999});this.loadedlists.push(a+"list")},fillactions:function(a,b,c){c=a+"-list";if(!b.length)return this.$el.find(".action-list li").html("No actions found");this.$el.find("."+c).remove();this.$el.find(".action-lists").append('<ul class="action-list '+c+'"></ul>');for(n in b)this.addaction(b[n],a)},addaction:function(a,b){var c={model:a,template:"note"==b?"messagenote":"timelinecomment"},e=b+"-list";this.newaction&&(c.isnew=
!0);a="note"==b?new Cloudwalkers.Views.Widgets.NoteEntry(c):new Cloudwalkers.Views.Notification(c);this.$el.find("."+e).append(a.render().el);this.newaction=!1},toggleaction:function(a,b){var c=this.$el.find('[data-action="'+a+'"]'),e=c.clone().attr("data-action",b.token);c.is("a")?e.html("<i class='icon-"+b.icon+"'></i> "+b.name):e.find("i").attr("class","").addClass("icon-"+b.icon);c.before(e).remove()},toggle:function(){this.trigger("toggle",this)},checkUnread:function(){this.model.get("read")?
this.$el.removeClass("unread"):this.$el.addClass("unread")},loadNotifications:function(){if(this.$el.find(".timeline-comments li").size())return this.$el.find(".timeline-comments li").remove();this.listenTo(this.model.notifications,"seed",this.fillNotifications);this.model.notifications.touch(this.model,{records:50,markasread:!0})},fillNotifications:function(a){$.each(this.notifications,function(a,b){b.remove()});this.notifications=[];a.models&&(a=a.models);var b=this.$el.find(".timeline-comments").eq(0).html("");
for(n in a){var c=new Cloudwalkers.Views.Notification({model:a[n],template:"timelinecomment"});this.notifications.push(c);b.append(c.render().el)}},loadYoutube:function(){var a=this.$el.find(".timeline-video").eq(0),b=a.data("youtube");a.attr("data-youtube","").removeClass("inactive");a.html(Mustache.render(Templates.youtube,{url:b}))},loadnoteui:function(){var a=new Cloudwalkers.Views.ComposeNote({model:this.model,persistent:!0});this.composenote=a;this.listenTo(a.note,"sync",this.noteadded);this.listenTo(a,
"edit:cancel",this.canceledit.bind(this,!0));this.$el.find(".note-content").append(a.render().el)},addnote:function(a){a={model:a,template:"messagenote"};this.newnote&&(a.isnew=!0);a=new Cloudwalkers.Views.Widgets.NoteEntry(a);this.$el.find(".note-list").append(a.render().el);this.newnote=!1},noteadded:function(a){this.toggleactions("action-list","note");this.newnote=!0;this.fetchactions("note");this.trigger("note:added");this.composenote.remove();this.loadnoteui()},loadtagui:function(){this.fetchtags()},
fetchtags:function(){var a=new Cloudwalkers.Collections.Tags;a.parentmodel=this.model;a.parenttype="message";this.listenTo(a,"seed",this.rendertag);a.touch(this.model);this.loadedtags=!0},rendertag:function(a){a.length?this.$el.find(".tag-list").empty():this.$el.find(".tag-list").html(this.translateString("no_tags_found"));this.$el.find(".tag-list").empty();for(n in a)this.addtag(a[n])},submittag:function(a){this.tag=new Cloudwalkers.Models.Tag;this.model&&(this.tag.parent=this.model);this.tag.save({name:a},
{success:this.addtag.bind(this)})},addtag:function(a){a=new Cloudwalkers.Views.Widgets.TagEntry({model:a,parent:this.model,template:"messagetag"});this.$el.find(".tag-list").append(a.render().el)},entertag:function(a){if(13===a.which){var b=$(a.target).val();b&&(this.submittag(b),$(a.target).val(""))}},time:function(){var a=new Date,b=new Date(this.$el.find("[data-date]").attr("data-date")),a=Math.round(0.001*(a.getTime()-b.getTime())),a=60>a?"now":3600>a?Math.round(a/60)+"m":86400>a?Math.round(a/
3600)+"h":2592E3>a?Math.round(a/86400)+"d":Math.round(a/2592E3)+"mo";this.$el.find("[data-date]").html(a);this.tm=setTimeout(this.time.bind(this),6E4)},destroy:function(){window.clearTimeout(this.tm)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["comments","notes"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.NoteEntry=Cloudwalkers.Views.Entry.extend({className:"note",events:{remove:"destroy","click [data-notifications]":"loadNotifications","click [data-youtube]":"loadYoutube","click *[data-action]":"action",click:"toggle"},initialize:function(a){this.parameters={};a&&$.extend(this,a);this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"action:toggle",this.toggleaction);this.listenTo(this.model,"destroy",this.remove)},render:function(){$.extend(this.parameters,this.model.attributes);
this.model.loaded()&&(this.model.loaded("model")&&(this.model.parent?(this.parameters.parent=this.model.parent.attributes,Cloudwalkers.RootView.trigger("ready:notecontext")):(this.model.parent=this.model.attachParent(this.model.get("model").objectType,this.model.get("model").id),this.model.parent.loaded()?(this.parameters.parent=this.model.parent.attributes,Cloudwalkers.RootView.trigger("ready:notecontext")):this.listenTo(this.model.parent,"sync",this.render))),"full"==this.type&&(this.parameters.actions=
this.model.filterActions()));Cloudwalkers.Session.censuretemplate(this.parameters);for(n in this.parameters.actions)this.parameters.actions[n].name_translated=this.translateString(this.parameters.actions[n].name);this.$el.html(Mustache.render(Templates[this.template],this.parameters));this.$el.find("[data-date]")&&this.time();return this}});Cloudwalkers.Views.User=Backbone.View.extend({tagName:"li",template:"user",events:{click:"select"},initialize:function(a){a&&$.extend(this,a);this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html(Mustache.render(Templates[this.template],this.model.filterData(this.type)));return this},select:function(){this.trigger("select",this)}});Cloudwalkers.Views.Write=Backbone.View.extend({files:[],draft:!1,sendnow:!1,className:"write",navclass:"write",title:"Compose message",events:{"submit form":"submit","keyup textarea[name=message]":"updateCounter","keyup input[name=title]":"updateCounter","click #schedule-btn-toggle":"toggleSchedule","click button[value=draft]":"setDraft","click [name=delay]":"setWithinDate","change select[name=schedule_day],select[name=schedule_month],select[name=schedule_year],select[name=schedule_time]":"resetWithin",
"click #button-response[value=send]":"sendNow","click .btnShortenURL":"shortenUrl","change select[name=campaign]":"selectCampaign","click [name=add-campaign]":"addCampaign"},initialize:function(){},setDraft:function(){this.draft=!0},sendNow:function(a){a.preventDefault();a.stopPropagation();this.sendnow=!0;this.$el.find(".message-schedule").is(":visible")?this.model&&confirm("Are you sure you want to sent this scheduled message now?")?(this.clearScheduleDate(),this.form.trigger("submit")):confirm("Are you sure you want to send your message right now? Your schedule details will be lost.")&&
(this.clearScheduleDate(),this.form.trigger("submit")):(this.clearScheduleDate(),this.form.trigger("submit"))},selectCampaign:function(a){Number(this.$el.find("select[name=campaign]").val())||this.$el.find(".new-campaign, select[name=campaign]").toggleClass("inactive")},addCampaign:function(a){},getAvailableStreams:function(){var a=Cloudwalkers.Session.getChannel("internal"),a=new Cloudwalkers.Collections.Streams(a.get("additional").outgoing);if("undefined"!=typeof this.options.actionparameters&&
"undefined"!=typeof this.model){var b=Cloudwalkers.Session.getStream(this.model.get("stream"));if(b){for(var c=new Backbone.Collection,e=0;e<a.models.length;e++)a.models[e].get("network").name==b.get("network").name&&c.add(a.models[e]);return c}}return a},render:function(){this.files=[];this.sendnow=this.draft=!1;var a=Cloudwalkers.Session.getAccount();this.actionparameters={};if("undefined"!=typeof this.options.actionparameters)for(var b=0;b<this.options.actionparameters.length;b++)this.actionparameters[this.options.actionparameters[b].token]=
this.options.actionparameters[b];var c=this,e={},f=this.getAvailableStreams(),g={};if(this.model&&this.model.get("streams"))for(b=0;b<this.model.get("streams").length;b++)g[this.model.get("streams")[b].id]=!0;e.channels=[];$.each(f.where({outgoing:1}),function(a,b){b.attributes.checked="undefined"!=typeof g[b.id];e.channels.push(b.attributes)});e.BASE_URL=CONFIG_BASE_URL;var f=this.model?this.model.scheduledate(!1):!1,h=this.model?this.model.repeat():!1;e.days=[];e.months=[];e.years=[];e.times=[];
e.endrepeat={days:[],months:[],years:[]};for(b=1;31>=b;b++)e.days.push({day:b,checked:f?f.getDate()==b:!1}),e.endrepeat.days.push({day:b,checked:h&&h.end&&h.end.getDate()==b});for(b=1;12>=b;b++)e.months.push({month:b,display:Cloudwalkers.Utils.month(b),checked:f?f.getMonth()==b-1:!1}),e.endrepeat.months.push({month:b,display:Cloudwalkers.Utils.month(b),checked:h&&h.end&&h.end.getMonth()==b-1});for(var m=null,b=0;10>b;b++)m=(new Date).getFullYear()+b,e.years.push({year:m,checked:f?f.getFullYear()==
m:!1}),e.endrepeat.years.push({year:m,checked:h&&h.end&&h.end.getFullYear()==m});e.weekdays=[];m="monday tuesday wednesday thursday friday saturday sunday".split(" ");for(b=0;b<m.length;b++){var l=m[b],l=l.charAt(0).toUpperCase()+l.substr(1);e.weekdays.push({name:l,weekday:m[b],checked:h&&h.weekdays&&h.weekdays[m[b].toUpperCase()]})}e.repeatinterval={amount:[],unit:[]};for(b=0;72>b;b++)e.repeatinterval.amount.push({value:b,name:b,selected:h&&h.interval==b});e.repeatinterval.unit.push({value:"minutes",
name:"Minute(s)",selected:h&&"minutes"==h.unit});e.repeatinterval.unit.push({value:"hours",name:"Hour(s)",selected:h&&"hours"==h.unit});e.repeatinterval.unit.push({value:"days",name:"Day(s)",selected:h&&"days"==h.unit});e.repeatinterval.unit.push({value:"weeks",name:"Week(s)",selected:h&&"weeks"==h.unit});e.repeatinterval.unit.push({value:"months",name:"Month(s)",selected:h&&"months"==h.unit});for(b=0;24>b;b+=0.25)h=Math.floor(b),m=60*(b-Math.floor(b)),10>h&&(h="0"+h),10>m&&(m="0"+m),f&&f.setMinutes(15*
Math.floor(f.getMinutes()/15)),e.times.push({time:h+":"+m,checked:f&&f.getHours()==h&&f.getMinutes()==m});e.canSchedule=!0;e.canSave=!0;e.canSendNow=!0;if(this.model){e.canSave="SCHEDULED"!=this.model.get("status");e.message=jQuery.extend(!0,{},this.model.attributes);"undefined"!=typeof this.actionparameters.message&&""!=this.actionparameters.message.value&&(e.message.body.plaintext=Cloudwalkers.Utilities.Parser.parseFromMessage(this.actionparameters.message.value,this.model),e.message.body.html=
Cloudwalkers.Utilities.Parser.parseFromMessage(this.actionparameters.message.value,this.model));e.sortedattachments={};console.log(this.model);if(this.model.get("attachments"))for(b=0;b<this.model.get("attachments").length;b++)e.sortedattachments[this.model.get("attachments")[b].type]=[this.model.get("attachments")[b]];e.showschedule=!1;if(this.model.scheduledate(!1)||"undefined"!=typeof this.model.repeat().interval)e.showschedule=!0}e.campaigns=a.get("campaigns");a=Mustache.render(Templates.write,
e);c.$el.html(a);this.form=this.$el.find("form").eq(0);c.$el.find("[name=url]").change(function(){c.updateCounter()});c.afterRender();this.model&&setTimeout(function(){var a=c.model.get("attachments");if("undefined"!=typeof a)for(var b=0;b<a.length;b++)"image"==a[b].type&&c.addUploadedFileToList({name:a[b].name,url:a[b].url,delete_url:"bla"})},100);c.updateCounter();c.$el.find("[name=schedule_random]").click(function(){c.randomTime()});c.$el.find("[data-toggle-id].inactive").hide();c.$el.find("[data-toggle-target]").click(function(){var a=
$(this).attr("data-toggle-target"),b;c.$el.find("[data-toggle-id="+a+"]").is(":visible")?(c.$el.find("[data-toggle-id="+a+"]").hide(),b=!1):(b=!0,c.$el.find("[data-toggle-id="+a+"]").show());$(this).toggleClass("black",b);$(this).toggleClass("blue",!b)}).each(function(){var a=$(this);setTimeout(function(){var b=a.attr("data-toggle-target"),b=c.$el.find("[data-toggle-id="+b+"]").is(":visible");a.toggleClass("black",b);a.toggleClass("blue",!b)},200)});c.$el.find(".inactive[data-toggle-id]").hide();
setTimeout(function(){c.trigger("content:change");c.$el.find("#schedule-btn-toggle").toggleClass("black",c.$el.find(".message-schedule").is(":visible"));c.$el.find("#schedule-btn-toggle").toggleClass("blue",!c.$el.find(".message-schedule").is(":visible"))},200);return this},addUploadedFileToList:function(a){var b=this,c=$(document.createElement("div"));c.addClass("uploaded-file");var e=$(document.createElement("img")),f=$(document.createElement("a"));e.attr("src",a.url);c.append(e);f.html("Delete");
f.attr("href","javascript:void(0);");b.files.push(a.url);f.click(function(){for(var e=0;e<b.files.length;e++)if(b.files[e]==a.url){b.files.splice(e,1);break}0==b.files.length&&$(".fileupload").show();c.remove();b.updateCounter();jQuery.ajax({async:!0,cache:!1,data:"",dataType:"json",type:"get",url:a.delete_url})});c.append(f);b.$el.find(".fileupload-feedback").append(c);b.updateCounter()},getValidationRules:function(){var a=this,b=Cloudwalkers.Session.getStreams(),c=[];$.each(b.where({outgoing:1}),
function(b,e){a.$el.find("#channel_"+e.id).is(":checked")&&c.push(e.attributes)});for(var b={},e=0;e<c.length;e++)for(var f in c[e].network.limitations)if("undefined"==typeof b[f])b[f]=c[e].network.limitations[f].limit;else{var g=b[f];"MAXIMUM"==c[e].network.limitations[f].type?g>c[e].network.limitations[f].limit&&(b[f]=c[e].network.limitations[f].limit):"MINIMUM"==c[e].network.limitations[f].type?g<c[e].network.limitations[f].limit&&(b[f]=c[e].network.limitations[f].limit):alert("Unexpected limitation type: "+
c[e].network.limitations[f].type)}return b},afterRender:function(){var a=this;a.$el.find("form").find(".channels label").click(function(){var b=$(this);setTimeout(function(){a.$el.find("form").find("input[type=checkbox]#"+b.attr("for")).is(":checked")?(b.parent().addClass("active"),b.parent().removeClass("inactive")):(b.parent().addClass("inactive"),b.parent().removeClass("active"));a.updateCounter()},100)}).each(function(){var b=$(this);setTimeout(function(){a.$el.find("form").find("input[type=checkbox]#"+
b.attr("for")).each(function(){$(this).is(":checked")?(b.parent().addClass("active"),b.parent().removeClass("inactive")):(b.parent().addClass("inactive"),b.parent().removeClass("active"))})},100)});a.$el.find("form").find(".social-icon-colors input[type=checkbox]").hide();a.$el.find("form").find(".channels label").addClass("inactive");a.$el.find("form").find("h2.schedule-message-title").click(function(){a.$el.find("form").find("div.schedule-message-container").toggle()});a.$el.find("form").find("div.schedule-message-container").hide();
a.$el.find("form .fileupload").fileupload({dataType:"json",done:function(b,c){$.each(c.result.files,function(b,c){a.addUploadedFileToList(c)})}})},isClone:function(){return"undefined"!=typeof this.options.clone&&this.options.clone},submit:function(a){a.preventDefault();var b=this;setTimeout(function(){var c=b.$el.find(a.currentTarget);"Add a title to post"==c.find("input[name=title]").val()&&c.find("input[name=title]").val("");"URL"==c.find("input[name=url]").val()&&c.find("input[name=url]").val("");
for(var c=c.serialize(),e=0;e<b.files.length;e++)c+="&files[]="+escape(b.files[e]);e=CONFIG_BASE_URL+"post/?account="+Cloudwalkers.Session.getAccount().get("id");b.model&&!b.isClone()?e+="&id="+b.model.get("id"):b.isClone()&&(c+="&original_message="+b.model.get("id"));b.draft&&(c+="&draft=true");b.validate(!0)&&(b.trigger("popup:close"),b.$el.html("<p>Please wait, storing message.</p>"),jQuery.ajax({async:!0,cache:!1,data:c,dataType:"json",type:"post",url:e,success:function(a){if(a.success){b.$el.html("<p>Your message has been scheduled.</p>");
if("undefined"!=typeof b.options.redirect&&b.options.redirect)window.location.reload();else if(b.draft)if(Cloudwalkers.RootView.alert("Your message was saved."),b.render(),b.model){var c=Cloudwalkers.Session.getStream(a.result.message.stream),c=c.messages.get(b.model.id);c.set(c.filterData(a.result.message))}else window.location.reload();else"#scheduled"!=window.location.hash?window.location="#scheduled":b.model?(c=Cloudwalkers.Session.getStream(a.result.message.stream),c=c.messages.get(b.model.id),
c.set(c.filterData(a.result.message))):window.location.reload();Cloudwalkers.Session.trigger("message:add");return!0}Cloudwalkers.RootView.alert(a.error.message)}}))},1)},validate:function(a){"undefined"==typeof a&&(a=!1);var b=this.$el.find("textarea[name=message]").val().length;this.$el.find(".total-text-counter").html(b);var c=this.getValidationRules(),e=""!=this.$el.find("[name=url]").val()?1:0,f=this.files.length,g=0;"undefined"!=typeof c["picture-url-length"]&&(g+=c["picture-url-length"]*f);
"undefined"!=typeof c["picture-url-length"]&&(g+=c["url-length"]*e);"undefined"!=typeof c["include-title-in-max-length"]&&(e=this.$el.find("input[name=title]").val(),0<e.length&&(g+=e.length,"undefined"!=typeof c["title-spacing-length"]&&(g+=c["title-spacing-length"])));"undefined"==typeof c["max-length"]&&"undefined"!=typeof c["max-length-hardlimit"]&&(c["max-length"]=c["max-length-hardlimit"]);"undefined"!=typeof c["max-length"]?(c["max-length"]-=g,this.$el.find(".total-max-counter").html(c["max-length"]),
b>c["max-length"]&&this.$el.find(".error").html("You can only use "+c["max-length"]+" characters")):this.$el.find(".total-max-counter").html("\u221e");if("undefined"!=typeof c["max-length-hardlimit"]&&b+g>c["max-length-hardlimit"])return a&&this.throwError("You message cannot be longer than "+c["max-length-hardlimit"]+" characters."),!1;this.$el.find(".error").html("");if((b=this.getScheduleDate())&&!this.model&&b<new Date)return a&&this.throwError("Even CloudWalkers is unable to send messages to the past \u00af\\_(\u30c4)_/\u00af"),
!1;if(a){if("minutes"==this.$el.find("[name=repeat_delay_unit]").val()&&0<this.$el.find("[name=repeat_delay_amount]").val()&&20>this.$el.find("[name=repeat_delay_amount]").val())return confirm("Are you sure you want to repeat this message within such a short time?");if(!this.draft&&0==this.$el.find(".channels input[type=checkbox]:checked").length)return this.throwError("Please select at least one stream to send too."),!1}return!0},throwError:function(a){alert(a)},updateCounter:function(){return this.validate()},
clearScheduleDate:function(){this.$el.find("select[name=schedule_day]").val("Day");this.$el.find("select[name=schedule_month]").val("Month");this.$el.find("select[name=schedule_year]").val("Year")},setScheduleDate:function(a){this.$el.find("select[name=schedule_day]").val(a.getDate());this.$el.find("select[name=schedule_month]").val(a.getMonth()+1);this.$el.find("select[name=schedule_year]").val(a.getFullYear());var b=String(15*Math.floor(a.getMinutes()/15));a=String(a.getHours());1==b.length&&(b=
"0"+b);1==a.length&&(a="0"+a);b=a+":"+b;this.$el.find("select[name=schedule_time]").val(b)},setWithinDate:function(){var a=this.$el.find("[name=delay]:checked").val(),b=new Date;b.setSeconds(a);this.setScheduleDate(b);this.$el.find("[name=schedule_random]").prop("checked",!1).trigger("change");this.trigger("content:change")},getScheduleDate:function(){var a=new Date;if("Day"!=this.$el.find("select[name=schedule_day]").val())a.setDate(this.$el.find("select[name=schedule_day]").val());else return!1;
if("Month"!=this.$el.find("select[name=schedule_month]").val())a.setMonth(this.$el.find("select[name=schedule_month]").val()-1);else return!1;if("Year"!=this.$el.find("select[name=schedule_year]").val())a.setFullYear(this.$el.find("select[name=schedule_year]").val());else return!1;if("Time"!=this.$el.find("select[name=schedule_time]").val()){var b=this.$el.find("select[name=schedule_time]").val().split(":");2==b.length&&(a.setHours(b[0]),a.setMinutes(b[1]))}else return!1;return a},getSelectedDate:function(){var a=
new Date,b=new Date;b.setFullYear(a.getFullYear(),a.getMonth(),a.getDate());b.setHours(0,0,0,0);"Day"!=this.$el.find("select[name=schedule_day]").val()&&b.setDate(this.$el.find("select[name=schedule_day]").val());"Month"!=this.$el.find("select[name=schedule_month]").val()&&b.setMonth(this.$el.find("select[name=schedule_month]").val()-1);"Year"!=this.$el.find("select[name=schedule_year]").val()&&b.setFullYear(this.$el.find("select[name=schedule_year]").val());return b},randomTime:function(){var a=
this.getSelectedDate(),b=[{start:480,end:540},{start:735,end:840},{start:1140,end:1439}][Math.floor(3*Math.random())],c=new Date,b=b.start+Math.random()*(b.end-b.start);a.setMinutes(b);a<c&&(a=new Date,a.setHours(c.getHours()+1));this.setScheduleDate(a);this.resetWithin(!1);this.trigger("content:change")},resetWithin:function(a){"undefined"==typeof a&&(a=!0);this.$el.find("[name=delay]").prop("checked",!1).trigger("change");a&&this.$el.find("[name=schedule_random]").prop("checked",!1).trigger("change");
var b=this;setTimeout(function(){b.trigger("content:change")},1);"Year"==this.$el.find("select[name=schedule_year]").val()&&this.$el.find("select[name=schedule_year]").val((new Date).getFullYear())},toggleSchedule:function(){if(!this.getScheduleDate()){var a=new Date;a.setMinutes(a.getMinutes()+15);this.setScheduleDate(a)}this.$el.find(".message-schedule").toggleClass("hidden");this.$el.find("#schedule-btn-toggle").toggleClass("black",this.$el.find(".message-schedule").is(":visible"));this.$el.find("#schedule-btn-toggle").toggleClass("blue",
!this.$el.find(".message-schedule").is(":visible"));this.trigger("content:change")},shortenUrl:function(a){a.preventDefault();var b=this.$el.find("[name=url]"),c=this.$el.find("[name=message]");$.getJSON("http://wlk.rs/api/shorten?callback=?",{url:b.val(),output:"jsonp",format:"json"}).done(function(a){a.shortUrl?(c.val(c.val()+" "+a.shortUrl),b.val("")):Cloudwalkers.RootView.alert(a.error.message)})}});Cloudwalkers.Views.Comments=Backbone.View.extend({events:{"click .load-more-comments a":"loadMore"},render:function(){var a=this,b={},c=a.options.parent.getStream();b.textfields=c.get("textfields");$(this.el).html(Mustache.render(Templates.comments,b));a.$el.find(".loading-comments").show();a.$el.find(".load-more-comments").hide();a.$el.find(".comments-inner-container").hide();a.$el.find(".no-comments").hide();this.collection=b=new Cloudwalkers.Collections.Comments({id:this.options.parent.get("id")});
this.options.parent.on("change",function(){a.collection.fetch()});b.fetch({success:function(){a.$el.find(".comments-inner-container").show();a.$el.find(".loading-comments").hide();0==a.collection.length%10&&a.$el.find(".load-more-comments").show();0==a.collection.length&&(a.$el.find(".load-more-comments").hide(),a.$el.find(".no-comments").show(),a.$el.find(".comments-inner-container").hide())}});b.bind("add",this.addOne,this);b.bind("refresh",this.refresh,this);b.bind("reset",this.refresh,this);b.bind("remove",
this.removeMessage,this);return this},addOne:function(a){var b=a.collection.indexOf(a),c=!1;this.options.selectedchild&&(c=this.options.selectedchild.get("id")==a.get("id"));c=(new Cloudwalkers.Views.Comment({model:a,selected:c})).render().el;$(c).attr("data-message-id",a.get("id"));0===b?this.$el.find(".comments-inner-container").prepend(c):0<this.$el.find(".comments-inner-container .comments-row").eq(b-1).length?this.$el.find(".comments-inner-container .comments-row").eq(b-1).after(c):this.$el.find(".comments-inner-container").append(c)},
refresh:function(){this.$el.find(".messages-container").html("");this.options.channel.each(this.addOne,this);if(0==this.options.channel.length){var a=this.options.parent.getStream();this.$el.find(".comments-inner-container").html("<p>"+a.get("textfields").nochildren+"</p>")}},removeMessage:function(a){this.$el.find(".comments-inner-container [data-message-id="+a.get("id")+"]").remove()},loadMore:function(){var a=this;this.collection.loadMore({success:function(){a.$el.find(".loading-comments").hide();
0==a.collection.length%10&&0<a.collection.length&&a.$el.find(".load-more-comments").show()}});this.$el.find(".loading-comments").show();this.$el.find(".load-more-comments").hide()}});Cloudwalkers.Views.Comment=Cloudwalkers.Views.Message.extend({events:{"click .button-post.action.comment-message-action":"messageAction"},initialize:function(){var a=this;this.options.template="comment";this.model.on("change",function(){a.render()})},className:"comments-row",tagName:"li",additionalData:function(a){a.parent=!1;return a},afterRender:function(){this.options.selected&&this.$el.addClass("selected");this.delegateEvents(this.events)}});Cloudwalkers.Views.Notification=Cloudwalkers.Views.Entry.extend({template:"message",events:{mouseover:"toggleactions",mouseout:"toggleactions","click *[data-notification-action]":"action","click .viewcommentcontact":"togglecommentcontact"},render:function(){$.extend(this.parameters,this.model.attributes);this.model.get("objectType")&&(this.parameters.actions=this.model.filterActions());this.$el.html(Mustache.render(Templates[this.template],this.parameters));return this},action:function(a){a=$(a.currentTarget).data("notification-action");
this.model.trigger("action",a)},toggleaction:function(a,b){var c=this.$el.find('div[data-notification-action="'+a+'"]'),e=c.clone();e.attr("data-notification-action",b.token).find("i").attr("class","").addClass("icon-"+b.icon);c.before(e).remove()},toggleactions:function(a){a="mouseout"==a.originalEvent.type;this.$el.find(".message-actions")[a?"addClass":"removeClass"]("hidden");this.$el.find(".comment-info")[a?"removeClass":"addClass"]("hidden")},markasread:function(){this.model.save({read:1},{patch:!0,
wait:!0});this.model.get("stream")&&Cloudwalkers.Session.getStreams().outdated(this.model.get("stream"))},togglecommentcontact:function(){var a=this.model.attributes.from?this.model.attributes.from[0]:null;a&&Cloudwalkers.RootView.viewContact({model:a})}});Cloudwalkers.Views.Widgets.Chart=Backbone.View.extend({title:"Chart",events:{},columns:{contacts:"parsecontacts",age:"parseage",gender:"parsegender",regional:"parseregional",besttime:"parsebesttime",cities:"parsecities",networks:"parsenetworks",activity:"parsecalendar","contact-evolution":"parsecontactevolution","message-evolution":"parsemessageevolution",messages:"parsemessages",activities:"parseactivities",impressions:"parseimpressions",notifications:"parsenotifications",followers:"parsefollowers",
following:"parsefollowing",follow:"parsefollow","contact-evolution-network":"parsecontactevolutionnetwork","message-evolution-network":"parsemessageevolutionnetwork",geo:"parsegeo",allreports:"parseallreports",nodata:"emptychartdata"},colors:"#E27927 #B14B22 #9E1818 #850232 #68114F #70285B #783E68 #815574 #896C80 #91828D".split(" "),countrycolors:"#E27927 #E5822E #E88B35 #EC953C #EF9E43 #F2A74A #F5B051 #F9BA58 #FCC35F #FFCC66".split(" "),networkcolors:{facebook:"#3B5998",twitter:"#01a9da",linkedin:"#1783BC",
tumblr:"#385775","google-plus":"#DD4C39",youtube:"#CC181E",web:"#f39501",blog:"#f39501","mobile-phone":"#E2EAE9",others:"#E5E5E5"},networktokens:{Facebook:"#3B5998",Twitter:"#01a9da",LinkedIn:"#1783BC",GooglePlus:"#DD4C39",YouTube:"#CC181E",Internal:"#E2EAE9",Others:"#E5E5E5",CoworkerWall:"#CCCCCC"},initialize:function(a){a&&$.extend(this,a);view=this;this.collection=this.model.statistics;this.listenTo(this.collection,"ready",this.fill)},render:function(){this.settings={};this.settings.title=this.title;
this.$el.html(Mustache.render(Templates.chart,this.settings));return this},fill:function(){if(this.collection.latest()&&this.collection.latest().get("streams")){var a,b;b=this[this.columns[this.filterfunc]](this.collection);if("besttime"==this.filterfunc)this.renderbesttime(b);else{var c=this.$el.find(".chart-container").get(0).clientWidth,c={pieHole:0.4,chartArea:{width:"95%",height:"90%"},width:c,height:0.7*c,legend:{textStyle:{fontSize:"13"}},tooltip:{textStyle:{fontSize:"13"}}};a={displayMode:"markers",
colorAxis:{colors:["#E27927","#91828D"]}};"geo"==this.filterfunc&&"dots"==this.type&&$.extend(c,a);$.extend(c,b.options);_.map(b.data,function(a){"Female"==a[0]&&(a[0]=this.translateString("female"));"Male"==a[0]&&(a[0]=this.translateString("male"))}.bind(this));b.data=google.visualization.arrayToDataTable(b.data);a=new google.visualization[this.chart](this.$el.find(".chart-container").get(0));a.draw(b.data,c)}}},removeloading:function(){this.$el.find(".loading").removeClass("loading")},renderbesttime:function(a){this.$el.html(Mustache.render(Templates.besttimewrap,
this.settings));$.each(a,function(b,c){c.fill=100*c.value/a.maxvalue;this.$el.find(".chart-wrapper").append(Mustache.render(Templates.besttime,c))}.bind(this))},parsecontacts:function(a,b,c){var e={},f={data:[],colors:[],options:{}};a=b?b:this.collection.latest().get("streams");$.each(a,function(a,b){b=new Cloudwalkers.Models.Stream(b);var f=new Cloudwalkers.Models.Network(Cloudwalkers.Session.getStream(b.id).get("network")),l=b.getcontacts();if(c&&f.gettoken()!=c)return!0;_.isNumber(l)&&_.has(e,
f.gettoken())?e[f.gettoken()].addcontacts(l):e[f.gettoken()]=f.addcontacts(l)});e=_.sortBy(e,function(a){return a.get("contacts")});$.each(e,function(a,b){f.data.push([b.gettitle(),b.getcontacts()]);f.colors.push(b.getcolor())});if(0==f.data.length)return this.emptychartdata();f.options.colors=f.colors;c||b||f.data.unshift(["Network",this.translateString("number_of_contacts")]);return f},parsemessages:function(a,b,c){var e={},f={data:[],colors:[]};a=b?b:a.latest().get("streams");$.each(a,function(a,
b){b=new Cloudwalkers.Models.Stream(b);var f=new Cloudwalkers.Models.Network(Cloudwalkers.Session.getStream(b.id).get("network")),l=b.getmessages();if(c&&f.gettoken()!=c)return!0;_.isNumber(l)&&_.has(e,f.gettoken())?e[f.gettoken()].messages+=l:(e[f.gettoken()]=f,e[f.gettoken()].messages=l)});e=_.sortBy(e,function(a){return a.get("messages")});$.each(e,function(a,b){f.data.push([b.gettitle(),b.messages]);f.colors.push(b.getcolor())});c||b||f.data.unshift(["Network",this.translateString("number_of_contacts")]);
return f},parsecontactevolution:function(a){return this.parseevolution(a,"contacts")},parsecontactevolutionnetwork:function(a){a=a.models;var b=this.network,c=this.$el.find(".chart-container").get(0).clientWidth,e={data:[],options:{colors:["#333333"],chartArea:{width:"70%",height:"70%",left:"40"},width:c,height:0.3*c,curveType:"function"}};$.each(a,function(a,c){var h=moment(c.get("date")).format("D MMM"),m=c.pluck("contacts",b);e.data.push([h,m])}.bind(this));e.data.unshift(["Day",this.translateString("number_of_contacts")]);
return e},parsemessageevolution:function(a){a=a.models;var b=this.$el.find(".chart-container").get(0).clientWidth,c={data:[],options:{colors:["#333333"],chartArea:{width:"90%",height:"70%",left:"40"},width:b,height:350<b?350:0.92*b,legend:{position:"bottom",textStyle:{fontSize:"13"}},curveType:"function",hAxis:{textStyle:{fontSize:"10"}}}};$.each(a,function(a,b){var g=moment(b.get("date")).format("D MMM"),h=b.pluck("messages");c.data.push([g,h])}.bind(this));c.data.unshift(["Day",this.translateString("number_of_messages")]);
return c},parsemessageevolutionnetwork:function(a){a=a.models;var b=this.network,c=this.$el.find(".chart-container").get(0).clientWidth,e={data:[],options:{colors:["#333333"],chartArea:{width:"70%",height:"70%",left:"40"},width:c,height:0.65*c,legend:{position:"bottom"},curveType:"function"}};$.each(a,function(a,c){var h=moment(c.get("date")).format("D MMM"),m=c.pluck("messages",b);e.data.push([h,m])}.bind(this));e.data.unshift(["Day",this.translateString("number_of_messages")]);return e},parseactivities:function(a,
b,c){var e={},f={data:[],colors:[]};a=b?b:a.latest().get("streams");$.each(a,function(a,b){b=new Cloudwalkers.Models.Stream(b);var f=new Cloudwalkers.Models.Network(Cloudwalkers.Session.getStream(b.id).get("network")),l=b.getactivities();if(c&&f.gettoken()!=c)return!0;_.isNumber(l)&&_.has(e,f.gettoken())?e[f.gettoken()].activities+=l:(e[f.gettoken()]=f,e[f.gettoken()].activities=l)});e=_.sortBy(e,function(a){return a.get("activities")});$.each(e,function(a,b){f.data.push([b.gettitle(),b.activities]);
f.colors.push(b.getcolor())});c||b||f.data.unshift(["Network",this.translateString("number_of_contacts")]);return f},parseimpressions:function(a,b,c){var e={},f={data:[],colors:[]};a=b?b:a.latest().get("streams");$.each(a,function(a,b){b=new Cloudwalkers.Models.Stream(b);var f=new Cloudwalkers.Models.Network(Cloudwalkers.Session.getStream(b.id).get("network")),l=b.getimpressions();if(c&&f.gettoken()!=c)return!0;_.isNumber(l)&&_.has(e,f.gettoken())?e[f.gettoken()].impressions+=l:(e[f.gettoken()]=f,
e[f.gettoken()].impressions=l)});e=_.sortBy(e,function(a){return a.get("impressions")});$.each(e,function(a,b){f.data.push([b.gettitle(),b.impressions]);f.colors.push(b.getcolor())});c||b||f.data.unshift(["Network",this.translateString("number_of_contacts")]);return f},parsenotifications:function(a,b,c){var e={},f={data:[],colors:[]};a=b?b:a.latest().get("streams");$.each(a,function(a,b){b=new Cloudwalkers.Models.Stream(b);var f=new Cloudwalkers.Models.Network(Cloudwalkers.Session.getStream(b.id).get("network")),
l=b.getnotifications();if(c&&f.gettoken()!=c)return!0;_.isNumber(l)&&_.has(e,f.gettoken())?e[f.gettoken()].notifications+=l:(e[f.gettoken()]=f,e[f.gettoken()].notifications=l)});e=_.sortBy(e,function(a){return a.get("notifications")});$.each(e,function(a,b){f.data.push([b.gettitle(),b.notifications]);f.colors.push(b.getcolor())});c||b||f.data.unshift(["Network",this.translateString("number_of_contacts")]);return f},parsefollowers:function(a,b,c){var e={},f={data:[],colors:[]};a=b?b:a.latest().get("streams");
$.each(a,function(a,b){b=new Cloudwalkers.Models.Stream(b);var f=new Cloudwalkers.Models.Network(Cloudwalkers.Session.getStream(b.id).get("network")),l=b.getfollowers();if(c&&f.gettoken()!=c)return!0;_.isNumber(l)&&_.has(e,f.gettoken())?e[f.gettoken()].followers+=l:(e[f.gettoken()]=f,e[f.gettoken()].followers=l)});e=_.sortBy(e,function(a){return a.get("followers")});$.each(e,function(a,b){f.data.push([b.gettitle(),b.followers]);f.colors.push(b.getcolor())});c||b||f.data.unshift(["Network",this.translateString("number_of_contacts")]);
return f},parsefollowing:function(a,b,c){var e={},f={data:[],colors:[]};a=b?b:a.latest().get("streams");$.each(a,function(a,b){b=new Cloudwalkers.Models.Stream(b);var f=new Cloudwalkers.Models.Network(Cloudwalkers.Session.getStream(b.id).get("network")),l=b.getfollowing();if(c&&f.gettoken()!=c)return!0;_.isNumber(l)&&_.has(e,f.gettoken())?e[f.gettoken()].following+=l:(e[f.gettoken()]=f,e[f.gettoken()].following=l)});e=_.sortBy(e,function(a){return a.get("following")});$.each(e,function(a,b){f.data.push([b.gettitle(),
b.following]);f.colors.push(b.getcolor())});c||b||f.data.unshift(["Network",this.translateString("number_of_contacts")]);return f},parsefollow:function(a){var b=a.latest();a=b.pluck(["contacts","types","followers"],this.network,3);var b=b.pluck(["contacts","types","following"],this.network,3),c={data:[["Followers",a],["Following",b]],options:{colors:["#2bbedc","#324A4F"]}};if(0>=b+a)return this.emptychartdata();c.data.unshift(["Follow state",this.translateString("number_of_contacts")]);return c},
parseage:function(a){a=a.latest().get("streams");a=this.groupkey(a,"contacts","age");var b=0,c=[],e={data:[],options:{colors:"#2bbedc #2CA7C0 #2E90A4 #2F7988 #30616B #324A4F #333333".split(" ")}};$.each(a,function(a,e){c.push([a,e]);b+=e});c=_.sortBy(c,function(a){return a.title});if(0==c.length||0==b)return this.emptychartdata();e.data=c;e.data.unshift(["Age interval",this.translateString("number_of_contacts")]);return e},groupkey:function(a,b,c){var e={};$.each(a,function(a,g){if(this.network&&
g.id==this.network||!this.network){var h=g[b][c];_.isObject(h)&&(_.isEmpty(e)?e=h:$.each(h,function(a,b){e[a]+=b}))}}.bind(this));return e},parsegender:function(a){var b=a.latest().get("streams"),b=this.groupkey(b,"contacts","gender"),c=0,e=[];a={data:[],options:{colors:["#2bbedc","#F14B68",a.networkcolors.others]}};$.each(b,function(a,b){e.push([this.capitalize(a),b]);c+=b}.bind(this));if(0==e.length||0==c)return this.emptychartdata();a.data=e;a.data.unshift(["Gender",this.translateString("number_of_contacts")]);
return a},capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},filtercountry:function(a,b){var c={},e=a.latest().get("streams");$.each(e,function(a,e){if(b&&e.id==b||!b){var h=Cloudwalkers.Session.getStream(e.id).get("network").name,m=Cloudwalkers.Session.getStream(e.id).get("network").token;if(_.isObject(e.contacts.geo)){var l=e.contacts.geo.countries;0==_.size(c)?$.each(l,function(a,b){c[b.name]=b;c[b.name].networks=[];c[b.name].networks[h]={total:b.total,token:m}}):$.each(l,function(a,
b){c[b.name]?(c[b.name].total+=b.total,c[b.name].networks[h]?c[b.name].networks[h].total+=b.total:c[b.name].networks[h]={total:b.total,token:m}):(c[b.name]=b,c[b.name].networks=[],c[b.name].networks[h]={total:b.total,token:m})})}}});return c=_(c).sortBy(function(a){return a.total})},parseregional:function(a,b){var c=8,e=0,f=this.filtercountry(a,b||this.network),g={data:[],options:{colors:this.colors}};this.regional=[];if(!c||c>f.length)c=f.length;if(0==c)return this.emptychartdata();for(;e<c;){var h=
f.pop();g.data.push([h.name,h.total]);this.regional.push(h);e++}c=_.reduce(f,function(a,b){return a+b.total},0);g.data.push(["Others",c]);g.data.unshift(["Countries",this.translateString("number_of_contacts")]);return g},parsecities:function(a){var b;a=this.filtercountry(a,this.network);b={};var c;if(0==a.length)return this.emptychartdata();c=a[a.length-1];countrycities=c.cities;$.each(countrycities,function(a,c){b[c.name]={name:c.name,value:c.total}});b=_(b).sortBy(function(a){return a.value});a=
this.getbiggestdata(b,6);a.data.unshift(["Cities",this.translateString("number_of_contacts")]);this.$el.find("h4").text(c.name+", "+this.translateString("cities"));return a},parsenetworks:function(a){var b=this.connect.regional?this.connect.regional:this.parseregional(a),c={data:[],colors:[]};if(0==b.length)return this.emptychartdata();this.$el.find("h3").html(b[0].name);b=b[0].networks;for(i in b)c.data.push([i,b[i].total]),c.colors.push(a.networkcolors[b[i].token]);c.data.unshift(["Network",this.translateString("number_of_contacts")]);
return c},getbiggestdata:function(a,b){for(var c=0,e={data:[],options:{colors:[]}};c<b;){var f=a.pop();e.data.push([f.name,f.value]);e.options.colors.push(this.countrycolors[c]);c++}if(0==a.length)return e;c=_.reduce(a,function(a,b){return a+b.value},0);e.data.push(["Others",c]);e.options.colors.push(this.collection.networkcolors.others);return e},parsebesttime:function(a){var b="Mon Tue Wed Thu Fri Sat Sun".split(" "),c,e=[],f=0,g=0,h;a.forEach(function(a){var l=[];a.get("streams").forEach(function(a){a=
new Cloudwalkers.Models.Stream(a);if(c=a.getbesttime())if(0==l.length)l=_.values(c);else for(i in c)l[i]+=c[i],l[i]>f&&(f=l[i]),l[i]>g&&(g=l[i])});h=l.indexOf(Math.max.apply(Math,_.values(l)));e.push({day:b.shift(),value:g,time:h});g=0});e.maxvalue=f;return e},parseevolution:function(a,b){for(var c=b?this.columns[b]:this.columns[this.type],e=this.collection.length,f=this.network?this.network:null,g,h=["Day of the week"],m={},l=this.$el.find(".chart-container").get(0).clientWidth,l={data:[],options:{chartArea:{width:"70%",
height:"60%",left:"40",top:"50"},width:l,height:0.4*l,legend:{textStyle:{fontSize:"11"},position:"top"},curveType:"function",colors:[]}},q=0;q<e;q++)g=a.place(q).get("streams"),dailyresult=this[c](null,g,f),_.map(dailyresult.data,function(a){m[a[0]]||(m[a[0]]=[]);m[a[0]][q]=a[1]});for(q=0;q<e;q++){c=[moment(a.place(q).get("date")).format("D MMM")];for(d in m)c.push(m[d].shift());l.data.push(c)}for(d in m)h.push(d),l.options.colors.push(this.networktokens[d]);l.data.unshift(h);return l},parseallreports:function(a){var b=
this.parseevolution(a,"contacts").data,c=this.parseevolution(a,"messages").data,e=this.parseevolution(a,"notifications").data;a=this.$el.find(".chart-container").get(0).clientWidth;a={data:[],colors:["#E27927","#9E1818","#68114F","#783E68","#896C80"],options:{chartArea:{width:"90%",height:"90%"},width:a,height:0.7*a,legend:{textStyle:{fontSize:"13"}},tooltip:{textStyle:{fontSize:"13"}},curveType:"function",legend:{position:"bottom"}}};b.shift();c.shift();e.shift();$.each(b,function(a,g){b[a].push(c[a][1]);
b[a].push(e[a][1])});a.data=b;a.data.unshift(["Day of the week","Contacts","Messages","Notifications"]);return a},parsegeo:function(a){return this.parseregional(a,this.network)},emptychartdata:function(){var a={data:[["No results",1]],options:{colors:["#e5e5e5"]}};a.data.unshift(["Results","Number"]);return a},negotiateFunctionalities:function(){},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Widgets.Info=Backbone.View.extend({title:"Info",columns:{"contact-evolution":"parseevolution","post-activity":"parsepostactivity",activity:"parseactivity","page-views":"parseviews",notifications:"parsenotifications","contact-evolution-network":"parseevolutionnetwork","post-activity-network":"parsepostactivitynetwork","activity-network":"parseactivitynetwork","page-views-network":"parseviewsnetwork",followers:"parsefollowers",following:"parsefollowing",mentions:"parsementions",retweets:"parseretweets",
shares:"parseshares",posts:"parseposts",dms:"parsedms"},descriptions:{contacts:{facebook:"New fans",twitter:"New followers",youtube:"New subscriptions",linkedin:"New followers"},messages:{facebook:"New mesages",twitter:"New tweets",youtube:"New uploads",linkedin:"New messages"},notifications:{facebook:"New notifications",twitter:"New notifications",youtube:"New notifications",linkedin:"New notifications"}},initialize:function(a){a&&$.extend(this,a);this.settings={title:this.title,network:this.icon?
{icon:this.icon}:{icon:"cloud"}};this.settings.filterfunc=this.filterfunc;this.settings.footer=this.footer;this.collection=this.model.statistics;this.listenTo(this.collection,"ready",this.fill);this.listenTo(this.collection,"change",this.render);this.network&&(this.settings.network.icon=Cloudwalkers.Session.getStream(this.network).get("network").token)},render:function(){this.$el.html(Mustache.render(Templates.dashboardstat,this.settings));return this},fill:function(){this.settings.details=this[this.columns[this.filterfunc]]();
this.render()},parseevolution:function(){var a=this.collection.latest().pluck("contacts"),b=this.collection.first().pluck("contacts"),a=a-b,b=this.translateString("new_contacts");this.settings.network={icon:"group"};return[{content:a,descr:b}]},parsepostactivity:function(){var a=this.collection.latest().pluck("messages"),b=this.collection.first().pluck("messages"),a=a-b,b=this.translateString("new_messages");this.settings.network={icon:"cloud-upload"};return[{content:a,descr:b}]},parseactivity:function(){var a=
this.collection.latest().pluck("activities"),b=this.collection.first().pluck("activities"),a=a-b,b=this.translateString("new_activities");this.settings.network={icon:"cloud-download"};return[{content:a,descr:b}]},parseviews:function(){var a=this.collection.latest().pluck(["messages","impressions"],!1,!0),b=this.collection.first().pluck(["messages","impressions"],!1,!0),a=a-b,b=this.translateString("new_impressions");return[{content:a,descr:b}]},parsenotifications:function(){var a=this.collection.latest().pluck("notifications"),
b=this.collection.first().pluck("notifications"),a=a-b,b=this.translateString("new_notifications");return[{content:a,descr:b}]},parseevolutionnetwork:function(){var a=this.collection.latest().pluck("contacts",this.network),b=this.collection.first().pluck("contacts",this.network);return[{content:a-b,descr:this.descriptions.contacts[this.icon]}]},parsepostactivitynetwork:function(){var a=this.collection.latest().pluck("messages",this.network),b=this.collection.first().pluck("messages",this.network);
return[{content:a-b,descr:this.descriptions.messages[this.icon]}]},parseactivitynetwork:function(){var a=this.collection.latest().pluck("activities",this.network),b=this.collection.first().pluck("activities",this.network),a=a-b,b=this.translateString("new_activities");return[{content:a,descr:b}]},parseviewsnetwork:function(){var a=this.collection.latest().pluck(["messages","impressions"],this.network,!0),b=this.collection.first().pluck(["messages","impressions"],this.network,!0),a=a-b,b=this.translateString("post_views");
return[{content:a,descr:b}]},parsenotificationnetwork:function(){var a=this.collection.latest().pluck("contacts",this.network),b=this.collection.first().pluck("contacts",this.network);return[{content:a-b,descr:this.descriptions.notifications[this.icon]}]},parsefollowers:function(){var a=this.collection.latest().pluck(["contacts","types","followers"],this.network,3),b=this.collection.first().pluck(["contacts","types","followers"],this.network,3);return[{content:a-b,descr:this.title}]},parsefollowers:function(){var a=
this.collection.latest().pluck(["contacts","types","followers"],this.network,3),b=this.collection.first().pluck(["contacts","types","followers"],this.network,3);return[{content:a-b,descr:this.title}]},parsementions:function(){var a=this.collection.latest().pluck(["notifications","types","comments"],this.network,3),b=this.collection.first().pluck(["notifications","types","comments"],this.network,3);return[{content:a-b,descr:this.title}]},parseretweets:function(){var a=this.collection.latest().pluck(["notifications",
"types","shares"],this.network,3),b=this.collection.first().pluck(["notifications","types","shares"],this.network,3);return[{content:a-b,descr:this.title}]},parsefollowing:function(){var a=this.collection.latest().pluck(["contacts","types","following"],this.network,3),b=this.collection.first().pluck(["contacts","types","following"],this.network,3);return[{content:a-b,descr:this.title}]},parseplusones:function(){var a=this.collection.latest().pluck(["notifications","types","favourites"],this.network,
3),b=this.collection.first().pluck(["notifications","types","favourites"],this.network,3);return[{content:a-b,descr:this.title}]},parseseniorities:function(){var a=this.collection.latest().pluck(["contacts","professional","seniority"],this.network,3),b=this.collection.first().pluck(["contacts","professional","seniority"],this.network,3);return[{content:a-b,descr:this.title}]},parseshares:function(){var a=this.collection.latest().pluck(["messages","types","shares"],this.network,3),b=this.collection.first().pluck(["messages",
"types","shares"],this.network,3);return[{content:a-b,descr:this.title}]},parseposts:function(){var a=this.collection.latest().pluck(["messages","types","posts"],this.network,3),b=this.collection.first().pluck(["messages","types","posts"],this.network,3);return[{content:a-b,descr:this.title}]},parsedms:function(){var a=this.collection.latest().pluck(["messages","types","dms"],this.network,3),b=this.collection.first().pluck(["messages","types","dms"],this.network,3);return[{content:a-b,descr:this.title}]},
negotiateFunctionalities:function(){},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Widgets.Combo=Backbone.View.extend({render:function(){this.$el.html("<div>Combo</div>");return this},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Widgets.Legenda=Backbone.View.extend({title:"Info",initialize:function(a){a&&$.extend(this,a);this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html("<div></div>");return this},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Widgets.HeatCalendar=Backbone.View.extend({title:"Info",filled:!1,nummonths:{quarter:3,year:12},initialize:function(a){a&&$.extend(this,a);this.collection=this.model.statistics;this.listenTo(this.model,"change",this.render);this.listenTo(this.collection,"ready",this.fill)},render:function(){this.$el.html(Mustache.render(Templates.activitycalendar,this.options));return this},fill:function(){if(this.filled)return!1;var a,b=new CalHeatMap;a=this.calculatedata();var c={itemSelector:this.$el.find("#cal-heatmap").get(0),
domain:"month",subDomain:"x_day",data:a.data,start:Date.parse(a.date),cellSize:36,cellPadding:8,range:1,legend:a.legend,label:{height:30},subDomainTextFormat:"%d"};if("quarter"==this.span||"year"==this.span)a=this.calculatesizes(this.nummonths[this.span]),12==this.nummonths[this.span]&&delete c.subDomainTextFormat,$.extend(c,a);b.init(c);this.filled=!0},calculatesizes:function(a){var b=(this.$el.find("#cal-heatmap").get(0).clientWidth-40)/a;return{subDomain:"day",cellSize:0.15*b,cellPadding:0.15*
b/3,range:a}},calculatedata:function(){for(var a=$.extend(!0,{},this.collection),b={},c,e=0,f=0;0<a.size();){var g=a.shift(),h=g.pluck("messages");c=(new Date(g.get("date"))).getTime()/1E3;b[c]=h>=f?h-f:0;f=h;0==e&&(e=g.get("date"))}return{data:b,legend:this.generaterange(b,4),date:e}},generaterange:function(a,b){for(var c=_.max(a,function(a){return a}),e=_.min(a,function(a){return a}),c=(c-e)/b,e=[],f=1;f<=b;f++)e.push(c*f);return e},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Widgets.MessageContainer=Cloudwalkers.Views.Widgets.Widget.extend({template:"messagecontainer",messageelement:"tr",canLoadMore:!0,events:{"click .load-more a":"loadMore"},initialize:function(){this.title=this.options.channel.name;this.canLoadMore="undefined"==typeof this.options.channel.canLoadMore?!0:this.options.channel.canLoadMore;this.initializeWidget()},refreshWidget:function(a){a.preventDefault();this.options.channel.update()},innerRender:function(a){var b=this,c={};jQuery.extend(!0,
c,this.options);c.showMoreButton="undefined"!=typeof this.options.channel.showMoreButton?this.options.channel.showMoreButton:!1;a.html(Mustache.render(Templates[this.template],c));a.find(".load-more").hide();a.find(".timeline-loading").show();this.options.channel.bind("sort",this.resort,this);this.options.channel.bind("remove",this.removeMessage,this);Cloudwalkers.Session.bind("message:add",function(){b.options.channel.reset();b.options.channel.fetch()},this);this.options.channel.fetch({success:function(c){b.canLoadMore&&
"undefined"!=typeof b.options.channel.loadMore&&(0<b.options.channel.length&&a.find(".load-more").show(),a.find(".timeline-loading").hide());a.find(".inner-loading").toggleClass(b.options.channel.length?"inner-loading":"inner-empty inner-loading");b.afterInit()}});this.interval=setInterval(function(){b.options.channel.update()},15E3);return this},loadMore:function(){var a=this;this.options.channel.loadMore({success:function(){a.$el.find(".timeline-loading").hide();a.$el.find(".load-more").show()}});
this.$el.find(".timeline-loading").show();this.$el.find(".load-more").hide()},onDestroy:function(){clearInterval(this.interval);this.$el.find(".scroller").slimScroll({destroy:1})},processMessageView:function(a){},getMessageView:function(a){var b;b=new Cloudwalkers.Views.Message({model:a,template:this.messagetemplate,tagName:this.messageelement});this.processMessageView(a,b);return b},onFirstAddEvent:function(a,b){var c=this;setTimeout(function(){c.onFirstAdd(a,b)},1)},onFirstAdd:function(a,b){},afterInit:function(){},
resort:function(){var a=this;a.$el.find("p.no-current-messages").remove();this.options.channel.each(function(b){var c=a.$el.find(".messages-container .message-view[data-message-id="+b.get("id")+"]"),e=b.collection.indexOf(b);if(!(0<c.length)){var f=a.getMessageView(b),c=f.render().el;$(c).attr("data-message-id",b.get("id"));if(0==e)a.onFirstAdd(b,f)}0==e?a.$el.find(".messages-container").prepend(c):(b=b.collection.at(e-1),b=a.$el.find(".messages-container .message-view[data-message-id="+b.get("id")+
"]"),0<b.length?b.after(c):console.log("PREVIOUS MESSAGE NOT FOUND"))});setTimeout(function(){a.trigger("content:change")},1)},removeMessage:function(a){this.$el.find(".messages-container .message-view[data-message-id="+a.get("id")+"]").remove()},refresh:function(){}});Cloudwalkers.Views.Widgets.MessageList=Cloudwalkers.Views.Widgets.MessageContainer.extend({messagetemplate:"messagelist"});Cloudwalkers.Views.Widgets.DashboardMessageList=Cloudwalkers.Views.Widgets.MessageContainer.extend({template:"dashboardmessagecontainer",messagetemplate:"dashboardmessage",entries:[],initialize:function(a){a&&$.extend(this,a);this.model.messages||(this.model.messages=new Cloudwalkers.Collections.Messages);this.listenTo(this.model.messages,"seed",this.fill);this.loadListeners(this.model.messages,["request","sync","ready"],!0);this.initializeWidget()},render:function(){this.$el.html(Mustache.render(Templates.dashboardmessagecontainer,
this.options));this.$container=this.$el.find(".messages-container");this.$loadercontainer=this.$el.find(".portlet-body");this.model.messages.touch(this.model,this.filters);return this},fill:function(a){this.$el.find(".inner-loading").toggleClass(a.length?"inner-loading":"inner-empty inner-loading");$.each(this.entries,function(a,b){b.remove()});this.entries=[];for(n in a){this.link&&(a[n].link=this.link);var b=new Cloudwalkers.Views.Entry({model:a[n],template:"smallentry",parameters:{trendview:this.trending,
mediaview:!this.trending}});this.entries.push(b);this.$container.append(b.render().el);this.listenTo(b,"toggle",this.toggle)}},toggle:function(a){Cloudwalkers.Router.Instance.navigate(this.sublink?this.sublink+this.model.id:this.link,!0)},fail:function(){Cloudwalkers.RootView.growl("Oops","Something went sideways, please reload the page.")}});Cloudwalkers.Views.Widgets.DetailedList=Cloudwalkers.Views.Widgets.MessageContainer.extend({template:"detailedlist",messagetemplate:"messagedetailedlist",messageelement:"tr",id:"inbox",currentSelected:null,render:function(){var a=this;this.$innerEl=this.$el;this.innerRender(this.$innerEl);this.$el.attr("id","list");this.on("content:change",function(){a.maximizeView();a.currentSelected&&a.currentSelected.$el.find("td").addClass("active")});return this},processMessageView:function(a,b){var c=this;b.$el.click(function(){c.$el.find("td").removeClass("active");
c.currentSelected=b;c.currentSelected.$el.find("td").addClass("active");c.trigger("select:message",a)})},onFirstAdd:function(a,b){this.options.selectmessage||setTimeout(function(){b.$el.click()},100)},afterInit:function(){this.options.selectmessage&&this.$el.find(".messages-container").find("[data-message-id="+this.options.selectmessage+"]").click()},maximizeView:function(){var a=$("#inner-content").height()-90;$("#inboxcontainer, #list .portlet-body").css({height:a+"px","max-height":a+"px"});this.addScroll()},
addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",position:"right",height:"auto",alwaysVisible:!1,railVisible:!1,disableFadeOut:!0})}});Cloudwalkers.Views.Widgets.DraftsList=Cloudwalkers.Views.Widgets.Widget.extend({id:"draftsparent",title:"Draft messages",parameters:{records:20},entries:[],events:{remove:"destroy","click .load-more":"more"},initialize:function(a){a&&$.extend(this,a);this.model.messages||(this.model.messages=new Cloudwalkers.Collections.Messages);this.listenTo(this.model.messages,"seed",this.fill);this.listenTo(this.model.messages,"request",this.showloading);this.listenTo(this.model.messages,"ready",this.showmore);
this.listenTo(this.model.messages,"destroy",this.showmore);this.listenTo(Cloudwalkers.RootView,"added:message",function(){this.model.messages.touch(this.model,this.parameters)}.bind(this));this.listenTo(this.model.messages,"update:content",this.loadmylisteners);this.translateTitle("draft_messages")},render:function(a){this.loadmylisteners();var b={reports:[]};b.title=this.title;this.mustacheTranslateRender(b);this.$el.html(Mustache.render(Templates.coworkerslist,b));this.$container=this.$el.find(".messages-container");
this.$loadercontainer=this.$el.find(".portlet-body");this.model.messages.touch(this.model,a?a:this.parameters);this.addScroll();return this},loadmylisteners:function(){this.loadListeners(this.model.messages,["request","sync",["ready","loaded","destroy"]],!0)},showloading:function(){this.$el.find(".load-more").hide()},hideloading:function(){this.$el.find(".icon-cloud-download").hide();this.$container.removeClass("inner-loading");this.hasmore=this.model.messages.cursor?!0:!1},showmore:function(){setTimeout(function(){this.$container.css("max-height",
999999);if(!this.hasmore)return this.$el.find("#loadmore").empty();var a=new Cloudwalkers.Views.Widgets.LoadMore({list:this.model.messages,parentcontainer:this.$container});this.$el.find("#loadmore").html(a.render().el)}.bind(this),200)},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],type:"full",template:"coworkersmessage"});this.entries.push(b);a[n].get("from")?this.model.seedusers(a[n]):
this.listenTo(a[n],"change:from",this.model.seedusers.bind(this.model));this.$container.append(b.render().el)}this.hideloading()},more:function(){this.incremental=!0;this.model.messages.more(this.model,this.parameters)||this.$el.find(".load-more").hide()},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove)},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",height:$("#inner-content").height()-165+"px",alwaysVisible:!1,
railVisible:!1})},destroy:function(){$.each(this.entries,function(a,b){b.remove()})},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["load_more"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.DraftsFilters=Cloudwalkers.Views.Widgets.Widget.extend({filters:{users:{string:"",list:[]}},events:{remove:"destroy","input .input-rounded":"comparesuggestions","click .load-more":"more","click .toggleall.active":"toggleall"},initialize:function(a){a&&$.extend(this,a);this.model.childtype="message";this.model.users?this.model.users.reset():this.model.users=new Cloudwalkers.Collections.Users;this.listenTo(this.model.users,"add",this.comparesuggestions)},render:function(){var a=
{reports:[]};this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.draftsfilters,a));this.$container=this.$el.find("#users-list").eq(0);return this},toggleall:function(){this.showsuggestions(this.model.users.models);this.model.messages.trigger("update:content");this.model.messages.touch(this.model,{records:20})},comparesuggestions:function(a){this.$el.find(".toggleall").addClass("active").removeClass("inactive");var b=$("#filter_contacts input").val();if(b)b=b.toLowerCase();else return this.hidesuggestions();
var c=this.model.users.filter(this.comparenamefilter.bind(this,b));5>c.length&&(!a.cid&&2<b.length)&&this.requestusers(b);if(c.length)this.showsuggestions(c.slice(0,10));else return this.hidesuggestions()},comparenamefilter:function(a,b){return 0<=b.get("displayname").toLowerCase().indexOf(a)||b.get("name")&&0<=b.get("name").toLowerCase().indexOf(a)},hidesuggestions:function(){this.fill(this.model.users.models)},showsuggestions:function(a){this.fill(a)},requestusers:function(a){a!=this.filters.users.string&&
(this.model.users.processing?this.filters.users.buffered=a:(this.$el.find(".loading-contacts").removeClass("hidden"),this.filters.users.string=a,this.model.users.fetch({remove:!1,parameters:{q:a},success:this.loadedusers.bind(this)})))},loadedusers:function(){this.$el.find(".loading-contacts").addClass("hidden");this.filters.users.buffered&&(this.requestusers(this.filters.users.buffered),this.filters.users.buffered=!1)},filter:function(a){$(a.currentTarget).toggleClass("inactive active");a=this.$el.find(".filter.keyword-list .active");
var b=[];if(!a.size())return this.list.$container.empty();a.each(function(){b.push($(this).attr("data-keyword-id"))});a=this.$el.find(".filter.network-list .active");var c=[];if(!a.size())return this.list.$container.empty();a.each(function(){c=c.concat($(this).attr("data-network-streams").split(" "))});this.category.messages.touch(this.category,{records:40,channels:b.join(","),streams:c.join(",")});return this},fill:function(a){$.each(this.entries,function(a,b){b.remove()});this.entries=[];for(n in a){var b=
new Cloudwalkers.Views.User({model:a[n],template:"smalluser",type:"listitem"});this.entries.push(b);this.listenTo(b,"select",this.select);this.$container.append(b.render().el)}this.$el.find(".inner-loading").removeClass("inner-loading")},select:function(a){this.list.render({users:a.model.id,records:20})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["editors","search_co-workers","suggestions","show_all","manage_users"];this.translated=
[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.ScheduledList=Cloudwalkers.Views.Widgets.Widget.extend({id:"scheduledlist",title:"Scheduled messages",parameters:{records:200,sort:"asc"},entries:[],events:{remove:"destroy","click .load-more":"more"},initialize:function(a){a&&$.extend(this,a);this.model.messages||(this.model.messages=new Cloudwalkers.Collections.Messages);this.listenTo(this.model.messages,"seed",this.fill);this.listenTo(this.model.messages,"request",this.showloading);this.listenTo(this.model.messages,"ready",
this.showmore);this.listenTo(Cloudwalkers.RootView,"added:message",function(){this.model.messages.touch(this.model,this.parameters)}.bind(this));this.translateTitle("scheduled_messages")},render:function(a){this.loadmylisteners();var b={};b.title=this.title;this.mustacheTranslateRender(b);this.$el.html(Mustache.render(Templates.scheduledlist,b));this.$container=this.$el.find(".messages-container");this.$loadercontainer=this.$el.find(".portlet-body");this.$el.find(".load-more").hide();this.model.messages.touch(this.model,
a?a:this.parameters);this.addScroll();return this},loadmylisteners:function(){this.loadListeners(this.model.messages,["request","sync",["ready","loaded","destroy"]],!0)},showloading:function(){this.$el.find(".load-more").hide()},hideloading:function(){this.$container.removeClass("inner-loading");this.hasmore=this.model.messages.cursor?!0:!1},showmore:function(){setTimeout(function(){this.$container.css("max-height",999999);if(!this.hasmore)return this.$el.find("#loadmore").empty();var a=new Cloudwalkers.Views.Widgets.LoadMore({list:this.model.messages,
parentcontainer:this.$container});this.$el.find("#loadmore").html(a.render().el)}.bind(this),200)},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);this.count=a.length;for(n in a){var b=new Cloudwalkers.Views.Entry({tagName:"tr",model:a[n],type:"full",template:"scheduledentry"});this.entries.push(b);this.$container.append(b.render().el)}this.hideloading()},more:function(){this.incremental=!0;this.model.messages.more(this.model,
this.parameters)||this.$el.find(".load-more").hide()},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove)},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",height:$("#inner-content").height()-165+"px",alwaysVisible:!1,railVisible:!1})},destroy:function(){$.each(this.entries,function(a,b){b.remove()})},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},
mustacheTranslateRender:function(a){this.original=["start_date","networks","message","actions"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.ScheduledFilters=Cloudwalkers.Views.Widgets.Widget.extend({id:"scheduledfilters",filters:{users:{string:"",list:[]}},events:{remove:"destroy","click *[data-streams]":"filter","click .toggleall.active":"toggleall"},initialize:function(a){a&&$.extend(this,a);this.model.childtype="message";this.streams=Cloudwalkers.Session.getChannel("internal").get("additional").outgoing},render:function(){var a={streams:[]};for(n in this.streams)a.streams.push({id:this.streams[n].id,icon:this.streams[n].network.icon,
name:this.streams[n].name,network:this.streams[n].network});this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.scheduledfilters,a));return this},toggleall:function(){this.filter(!0);this.togglefilters(!0)},togglefilters:function(a){this.$el.find("li").addClass(a?"active":"inactive").removeClass(a?"inactive":"active");this.$el.find(".toggleall").addClass(a?"inactive":"active").removeClass(a?"active":"inactive")},filter:function(a,b){b||(b=this.button&&this.button.data("streams")==
$(a.currentTarget).data("streams"));this.togglefilters(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:this.button.data("streams");b&&(this.button=!1);this.list.render(c?{records:200,target:c,sort:"asc"}:{records:200,sort:"asc"});return this},fill:function(a){$.each(this.entries,function(a,b){b.remove()});this.entries=[];for(n in a){var b=new Cloudwalkers.Views.User({model:a[n],template:"smalluser",type:"listitem"});this.entries.push(b);this.listenTo(b,
"select",this.select);this.$container.append(b.render().el)}this.$el.find(".inner-loading").removeClass("inner-loading")},select:function(a){this.list.render({users:a.model.id,records:20})},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",height:$("#inner-content").height()-165+"px",alwaysVisible:!1,railVisible:!1})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["company_accounts","select_all"];
this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.CoworkersFilters=Cloudwalkers.Views.Widgets.Widget.extend({filters:{users:{string:"",list:[]}},events:{remove:"destroy","input .input-rounded":"comparesuggestions","click .load-more":"more","click .toggleall.active":"toggleall"},initialize:function(a){a&&$.extend(this,a);this.model.childtype="message";this.model.users?this.model.users.reset():this.model.users=new Cloudwalkers.Collections.Users;this.listenTo(this.model.users,"add",this.comparesuggestions)},render:function(){var a=
{};this.mustacheTranslateRender(a);Cloudwalkers.Session.censuretemplate(a);this.$el.html(Mustache.render(Templates.coworkersfilters,a));this.$container=this.$el.find("#users-list").eq(0);return this},toggleall:function(){this.showsuggestions(this.model.users.models);this.model.messages.trigger("update:content");this.model.messages.touch(this.model,{records:20})},comparesuggestions:function(a){this.$el.find(".toggleall").addClass("active").removeClass("inactive");var b=$("#filter_contacts input").val();
if(b)b=b.toLowerCase();else return this.hidesuggestions();var c=this.model.users.filter(this.comparenamefilter.bind(this,b));5>c.length&&(!a.cid&&2<b.length)&&this.requestusers(b);if(c.length)this.showsuggestions(c.slice(0,10));else return this.hidesuggestions()},comparenamefilter:function(a,b){return 0<=b.get("displayname").toLowerCase().indexOf(a)||b.get("name")&&0<=b.get("name").toLowerCase().indexOf(a)},hidesuggestions:function(){this.fill(this.model.users.models)},showsuggestions:function(a){this.fill(a)},
requestusers:function(a){a!=this.filters.users.string&&(this.model.users.processing?this.filters.users.buffered=a:(this.$el.find(".loading-contacts").removeClass("hidden"),this.filters.users.string=a,this.model.users.fetch({remove:!1,parameters:{q:a},success:this.loadedusers.bind(this)})))},loadedusers:function(){this.$el.find(".loading-contacts").addClass("hidden");this.filters.users.buffered&&(this.requestusers(this.filters.users.buffered),this.filters.users.buffered=!1)},filter:function(a){$(a.currentTarget).toggleClass("inactive active");
a=this.$el.find(".filter.keyword-list .active");var b=[];if(!a.size())return this.list.$container.empty();a.each(function(){b.push($(this).attr("data-keyword-id"))});a=this.$el.find(".filter.network-list .active");var c=[];if(!a.size())return this.list.$container.empty();a.each(function(){c=c.concat($(this).attr("data-network-streams").split(" "))});this.category.messages.touch(this.category,{records:40,channels:b.join(","),streams:c.join(",")});return this},fill:function(a){$.each(this.entries,function(a,
b){b.remove()});this.entries=[];for(n in a){var b=new Cloudwalkers.Views.User({model:a[n],template:"smalluser",type:"listitem"});this.entries.push(b);this.listenTo(b,"select",this.select);this.$container.append(b.render().el)}this.$el.find(".inner-loading").removeClass("inner-loading")},select:function(a){this.list.render({users:a.model.id,records:20})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["co-workers","search_co-workers",
"suggestions","show_all","manage_users"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.CoworkersList=Cloudwalkers.Views.Widgets.Widget.extend({id:"coworkersparent",title:"Co-workers messages",parameters:{records:20},entries:[],events:{remove:"destroy","click .load-more":"more"},initialize:function(a){a&&$.extend(this,a);this.model.messages||(this.model.messages=new Cloudwalkers.Collections.Messages);this.listenTo(this.model.messages,"seed",this.fill);this.listenTo(this.model.messages,"request",this.showloading);this.listenTo(this.model.messages,"ready",this.showmore);
this.listenTo(this.model.messages,"update:content",this.loadmylisteners);this.listenTo(Cloudwalkers.RootView,"added:message",this.messageadded);this.updateable(this.model,"h3.page-title");this.translateTitle("co-workers_messages")},render:function(a){this.loadmylisteners();var b={};b.title=this.title;this.mustacheTranslateRender(b);this.$el.html(Mustache.render(Templates.coworkerslist,b));this.$container=this.$el.find(".messages-container");this.$loadercontainer=this.$el.find(".portlet-body");this.loadListeners(this.model.messages,
["request","sync","ready"],!0);this.model.messages.touch(this.model,a?a:this.parameters);this.addScroll();return this},loadmylisteners:function(){this.loadListeners(this.model.messages,["request","sync",["ready","loaded","destroy"]],!0)},showloading:function(){this.$el.find(".icon-cloud-download").show()},hideloading:function(){this.$el.find(".icon-cloud-download").hide();this.$container.removeClass("inner-loading");this.hasmore=this.model.messages.cursor?!0:!1},showmore:function(){setTimeout(function(){this.$container.css("max-height",
999999);if(!this.hasmore)return this.$el.find("#loadmore").empty();var a=new Cloudwalkers.Views.Widgets.LoadMore({list:this.model.messages,parentcontainer:this.$container});this.$el.find("#loadmore").html(a.render().el)}.bind(this),200)},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],type:"full",template:"coworkersmessage"});this.entries.push(b);a[n].get("from")?this.model.seedusers(a[n]):
this.listenTo(a[n],"change:from",this.model.seedusers.bind(this.model));this.$container.append(b.render().el)}this.hideloading()},more:function(){this.incremental=!0;this.model.messages.more(this.model,this.parameters)||this.$el.find(".load-more").hide()},messageadded:function(a){var b=Cloudwalkers.Session.getStream("coworkers").id;(a=a.get("streams"))&&0<=a.indexOf(b)&&this.model.messages.touch(this.model)},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove)},
addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",height:$("#inner-content").height()-165+"px",alwaysVisible:!1,railVisible:!1})},destroy:function(){$.each(this.entries,function(a,b){b.remove()})},translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["load_more","co-workers","search_co-workers"];this.translated=[];for(k in this.original)this.translated[k]=
this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.MonitorFilters=Cloudwalkers.Views.Widgets.Widget.extend({events:{"click [data-network-streams]":"filternetworks","click [data-keyword-id]":"filterkeywords","click .toggleall.networks.active":"toggleallnetworks","click .toggleall.keywords.active":"toggleallkeywords"},initialize:function(){this.category=this.options.category;this.category.childtype="message";this.streams=[];this.category.channels.each(function(a){this.streams=this.streams.concat(a.streams.models)},this);this.initializeWidget()},
toggleallnetworks:function(a){this.filternetworks(null,!0);this.togglefilters(a,".network-list")},toggleallkeywords:function(a){this.filterkeywords(null,!0);this.togglefilters(a,".keyword-list")},togglefilters:function(a,b){this.$el.find(b+" .filter").addClass(a?"active":"inactive").removeClass(a?"inactive":"active");$(b+" .toggleall").addClass(a?"inactive":"active").removeClass(a?"active":"inactive")},render:function(){var a={keywords:this.category.channels.models};a.name=this.category.get("name");
a.networks=Cloudwalkers.Session.getStreams().filterNetworks(this.streams,!0);a.translate_filters=this.translateString("filters");a.translate_select_all=this.translateString("select_all");a.translate_building_your_data=this.translateString("building_your_data");a.translate_this_will_take_a_minute_or_so=this.translateString("this_will_take_a_minute_or_so");a.translate_keywords=this.translateString("keywords");a.translate_manage_keywords=this.translateString("manage_keywords");Cloudwalkers.Session.censuretemplate(a);
this.$el.html(Mustache.render(Templates.channelfilters,a));a.networks.length||this.$el.find(".building-notice").toggleClass("inactive");this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove);return this},filternetworks:function(a,b){b||(b=this.button&&this.button.data("network-streams")==$(a.currentTarget).data("network-streams"));this.togglefilters(b,".network-list");b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:String(this.button.data("network-streams")).split(" ");
b&&(this.button=!1);c?this.list.parameters.streams=c.join(","):delete this.list.parameters.streams;this.category.messages.trigger("change:filter");this.category.messages.touch(this.category,this.list.parameters);return this},filterkeywords:function(a,b){b||(b=this.button&&this.button.data("keyword-id")==$(a.currentTarget).data("keyword-id"));this.togglefilters(b,".keyword-list");b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:Number(this.button.data("keyword-id"));
b&&(this.button=!1);c?this.list.parameters.channels=c:delete this.list.parameters.channels;this.category.messages.trigger("change:filter");this.category.messages.touch(this.category,this.list.parameters);return this},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Widgets.MonitorList=Cloudwalkers.Views.Widgets.Widget.extend({id:"monitorparent",parameters:{records:40,markasread:!0},entries:[],events:{remove:"destroy","click .load-more":"more"},initialize:function(){this.category=this.options.category;this.category.set({messages:[]});this.listenTo(this.category.messages,"change:filter",this.loadmylisteners.bind(this,!0));this.loadmylisteners();this.options.reset&&(delete this.parameters.streams,delete this.parameters.channels);this.updateable(this.category,
"h3.page-title")},render:function(){var a={};a.name=this.category.get("name");a.translate_load_more=this.translateString("load_more");this.$el.html(Mustache.render(Templates.monitorlist,a));this.$container=this.$el.find(".messages-container");this.$loadercontainer=this.$el.find(".portlet-body");this.$el.find(".load-more").hide();this.category.messages.touch(this.category,this.parameters);this.addScroll();return this},loadmylisteners:function(a){a&&(this.stopListening(this.category.messages),this.listenTo(this.category.messages,
"change:filter",this.loadmylisteners.bind(this,!0)));this.$el.find("#loadmore").empty();this.listenTo(this.category.messages,"seed",this.fill);this.listenTo(this.category.messages,"request",this.showloading);this.listenTo(this.category.messages,"sync",this.hideloading);this.listenTo(this.category.messages,"ready",this.showmore);this.loadListeners(this.category.messages,["request","sync","ready"],!0)},showloading:function(){this.$el.find(".icon-cloud-download").show();this.$el.find(".load-more").hide()},
hideloading:function(){this.$el.find(".icon-cloud-download").hide();this.hasmore=this.category.messages.cursor?!0:!1;this.$container.removeClass("inner-loading")},showmore:function(){setTimeout(function(){this.$container.css("max-height",999999);if(!this.hasmore)return this.$el.find("#loadmore").empty();var a=new Cloudwalkers.Views.Widgets.LoadMore({list:this.category.messages,parentcontainer:this.$container});this.$el.find("#loadmore").html(a.render().el)}.bind(this),200)},fill:function(a){this.incremental?
this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],type:"full",template:"messagefullentry"});this.entries.push(b);this.$container.append(b.render().el)}},more:function(){this.incremental=!0;this.category.messages.more(this.category,this.parameters)||this.$el.find(".load-more").hide()},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove)},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",
color:"#a1b2bd",height:$("#inner-content").height()-165+"px",alwaysVisible:!1,railVisible:!1})},destroy:function(){$.each(this.entries,function(a,b){b.remove()})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Widgets.KeywordsEditor=Cloudwalkers.Views.Widgets.Widget.extend({events:{"submit form[data-add-category]":"addCategory","click button.add-keyword":"addKeyword","click button.update-keyword":"updateKeyword","click .cancel-edit-keyword":"render","click button[data-keyword-filter]":"toggleFilter"},initialize:function(){this.channel=Cloudwalkers.Session.getChannel("monitoring");this.listenTo(Cloudwalkers.Session.getChannels(),"sync",this.render);this.listenTo(Cloudwalkers.Session.getChannels(),
"remove",this.render)},render:function(a){a&&a.preventDefault&&a.preventDefault();a=Cloudwalkers.Session.getAccount();var b=a.get("filteroptions");b||a.fetch({endpoint:"filteroptions",success:this.render.bind(this)});a={filteroptions:b,categories:this.channel.channels.models};a.title=this.title;this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.keywordseditor,a));this.$el.find("select").chosen({width:"100%"});return this},addCategory:function(a){a.preventDefault();a={name:$("#category_create_name").val(),
remember:$("#category_create_remember").val()};this.channel.channels.create(a,{parent:this.channel.id,wait:!0});this.$el.find(".addcategory .icon-cloud-upload").show()},addKeyword:function(a){a.preventDefault();a=Number($("#keyword_manage_category").val());if(!a)return Cloudwalkers.RootView.alert("Don't forget to select a category.");Cloudwalkers.Session.getChannel(a).channels.create(this.keywordParameters(),{parent:a,wait:!0,error:function(){Cloudwalkers.RootView.information("Not saved","Your formula is a bit fuzzy",
this.$el.find(".manage-keyword"));this.$el.find(".managekeyword .icon-cloud-upload").hide()}.bind(this)});this.$el.find(".managekeyword .icon-cloud-upload").show()},fillKeyword:function(a,b){b.preventDefault();this.render();this.$el.find(".add-keyword, .edit-keyword").toggleClass("inactive");var c=this.editing=Cloudwalkers.Session.getChannel(a),e=c.get("settings");$('#keyword_manage_category option[value="'+c.get("parent")+'"]').attr("selected","selected");$("#keyword_manage_name").val(c.get("name"));
$("#filter_formula").val(e.formula?e.formula:"");$("#filter_include").val(e.include?e.include.join(", "):"");$("#filter_exclude").val(e.exclude?e.exclude.join(", "):"");for(n in e.languages)$('#filter_languages option[value="'+e.languages[n]+'"]').attr("selected","selected");for(n in e.countries)$('#filter_countries option[value="'+e.countries[n]+'"]').attr("selected","selected");this.$el.find("select").trigger("chosen:updated")},updateKeyword:function(a){a.preventDefault();this.editing.save(this.keywordParameters());
this.$el.find(".managekeyword .icon-cloud-upload").show()},keywordParameters:function(){var a={name:$("#keyword_manage_name").val(),settings:{}};$("#filter_formula").val()&&(a.settings.formula=$("#filter_formula").val());$("#filter_include").val()&&(a.settings.include=$("#filter_include").val().split(","));$("#filter_exclude").val()&&(a.settings.exclude=$("#filter_exclude").val().split(","));if(a.settings.include&&a.settings.include.length)for(n in a.settings.include)a.settings.include[n]=a.settings.include[n].trim();
if(a.settings.exclude&&a.settings.exclude.length)for(n in a.settings.exclude)a.settings.exclude[n]=a.settings.exclude[n].trim();a.settings.languages=$("#filter_languages").val();a.settings.countries=$("#filter_countries").val();return a},toggleFilter:function(a){a.preventDefault();a=$(a.target).attr("data-keyword-filter");this.$el.find("div[data-keyword-filter="+a+"]").toggleClass("inactive")},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=
"add_category name create add_keyword category select_category fine-tune filters include exclude languages countries use_comma_separated_words language country select_from_list all_languages global update cancel manage_keyword remember_for days".split(" ");this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.KeywordsOverview=Cloudwalkers.Views.Widgets.Widget.extend({id:"monitorparent",entries:[],events:{"submit form":"editCategory","click .edit-toggler":"toggleEditCategory","click .delete-category":"deleteCategory","click .delete-keyword":"deleteKeyword","click [data-keyword]":"toggleEditKeyword"},initialize:function(){this.channel=Cloudwalkers.Session.getChannel("monitoring");this.editor=this.options.editor;this.listenTo(Cloudwalkers.Session.getChannels(),"sync",this.render)},
render:function(){categories=this.channel.channels.map(function(a){return{id:a.id,name:a.get("name"),settings:a.get("settings"),keywords:a.channels.models}});var a={categories:categories};this.mustacheTranslateRender(a);Cloudwalkers.Session.censuretemplate(a);this.$el.html(Mustache.render(Templates.keywordsoverview,a));return this},toggleEditCategory:function(a){a.stopPropagation();$(a.target).closest("[data-category]").find(".category-name, .category-edit").toggle()},editCategory:function(a){a.stopPropagation();
a=$(a.target).closest("[data-category]");var b=a.find('[name="name"]').val(),c=a.find('[name="remember"]').val(),e={remember:c},f=Cloudwalkers.Session.getChannel(Number(a.attr("data-category")));f.endpoint="";f.save({name:b,settings:e});a.find(".name_val").html(b);a.find(".remember_val").html(c);return!1},deleteCategory:function(a){a.stopPropagation();var b=$(a.target).closest("[data-category]");Cloudwalkers.RootView.confirm(this.translateString("are_you_sure_you_want_to_remove_this_category"),function(){Cloudwalkers.Session.getChannel(Number(b.attr("data-category"))).destroy();
Cloudwalkers.RootView.navigation.render();b.next().remove();b.remove()})},toggleEditKeyword:function(a){a.stopPropagation();var b=Number($(a.target).closest("[data-keyword]").data("keyword"));this.editor.fillKeyword(b,a)},deleteKeyword:function(a){a.stopPropagation();var b=Number($(a.target).closest("[data-keyword]").attr("data-keyword"));Cloudwalkers.RootView.confirm(this.translateString("are_you_sure_you_want_to_remove_this_filter"),function(){Cloudwalkers.Session.getChannel(b).destroy();$(a.target).parent().remove()})},
translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["categories_overview","change_name","remember_for","days","save_changes"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.DetailedView=Cloudwalkers.Views.Widgets.Widget.extend({id:"inbox",initialize:function(){var a=this;this.options.list.on("select:message",function(b){a.selectMessage(b)})},selectMessage:function(a){var b=a.get("parentmodel"),c=null;b&&(c=a,a=b);a=new Cloudwalkers.Views.Message({model:a,selectedchild:c,template:"messagedetailview",childtemplate:"messagedetailviewchild",originaltemplate:"messagedetailoriginal",tagName:"div",showcomments:!0});this.$el.html(a.render().el);this.setHeight(a.$el)},
render:function(){this.$el.html("");return this},setHeight:function(a){a.css("height",$("#inboxcontainer").height()-16+"px")}});Cloudwalkers.Views.Widgets.InboxFilter=Cloudwalkers.Views.Widgets.Widget.extend({id:"inboxlist",entries:[],check:"hasMessages",collectionstring:"messages",filters:{contacts:{string:"",list:[]},streams:[]},events:{remove:"destroy","click [data-toggle]":"togglefilter","input .input-rounded":"comparesuggestions","click [data-contact]":"filtercontacts","click [data-close-contact]":"filtercontacts","click [data-networks]":"filternetworks","click [data-streams]":"filterstreams","click .toggleall.active":"toggleall",
"click .load-more":"more"},initialize:function(a){a&&$.extend(this,a)},toggleall:function(){this.filternetworks(null,!0);this.togglestreams(!0)},togglestreams:function(a){this.$el.find("[data-networks], [data-streams]").addClass(a?"active":"inactive").removeClass(a?"inactive":"active");this.$el.find(".toggleall").addClass(a?"inactive":"active").removeClass(a?"active":"inactive")},render:function(){return this}});Cloudwalkers.Views.Widgets.InboxList=Cloudwalkers.Views.Widgets.Widget.extend({id:"inboxlist",entries:[],check:"hasMessages",collectionstring:"messages",filters:{contacts:{string:"",list:[]},streams:[]},events:{remove:"destroy","click [data-toggle]":"togglefilter","input .input-rounded":"comparesuggestions","click [data-contact]":"filtercontacts","click [data-close-contact]":"filtercontacts","click [data-networks]":"filternetworks","click [data-streams]":"filterstreams","click .toggleall.active":"toggleall",
"click .load-more":"more"},initialize:function(a){a&&$.extend(this,a);this.collection=this.model[this.collectionstring];this.listenTo(this.collection,"seed",this.fill)},toggleall:function(){this.filternetworks(null,!0);this.togglestreams(!0)},render:function(){this.$el.html(Mustache.render(Templates.list,{streams:[],networks:[]}));this.$container=this.$el.find("ul.list");this.collection.touch(this.model,this.filterparameters());return this},showloading:function(){$(".inbox").addClass("loading");this.$el.find(".load-more").hide()},
hideloading:function(a,b){this.hasmore=a.cursor&&b.channel[this.collectionstring].length?!0:!1;$(".inbox").removeClass("loading");this.$container.removeClass("inner-loading")},showmore:function(){this.hasmore&&this.$el.find(".load-more").show()},hidemore:function(){this.$el.find(".load-more").hide()},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],template:"smallentry",
checkunread:!0,parameters:{inboxview:!0}});this.entries.push(b);this.listenTo(b,"toggle",this.toggle);this.$container.append(b.render().el)}this.entries.length?setTimeout(this.toggle.bind(this,this.entries[0]),1):this.hidemore()},toggle:function(a){this.inboxmessage&&this.inboxmessage.remove();this.inboxmessage=new Cloudwalkers.Views.Widgets.InboxMessage({model:a.model});$("main").html(this.inboxmessage.render().el);this.inboxmessage.showrelated();this.$el.find(".list .active").removeClass("active");
a.$el.addClass("active")},togglefilter:function(a){a=$(a.currentTarget);var b=a.data("toggle"),c=a.hasClass("selected");$("[data-toggle].selected").removeClass("selected");$("[id^=filter_]").addClass("hidden");c||(a.addClass("selected"),$("#filter_"+b).removeClass("hidden"))},comparesuggestions:function(a){var b=$("#filter_contacts input").val();if(b)b=b.toLowerCase();else return this.hidesuggestions();var c=this.model.contacts.filter(this.comparenamefilter.bind(this,b));5>c.length&&(!a.cid&&2<b.length)&&
this.requestcontacts(b);if(c.length)this.showsuggestions(c.slice(0,10));else return this.hidesuggestions()},comparenamefilter:function(a,b){return 0<=b.get("displayname").toLowerCase().indexOf(a)||b.get("name")&&0<=b.get("name").toLowerCase().indexOf(a)},showsuggestions:function(a){this.$el.find("#filter_contacts label").removeClass("hidden");this.$el.find("ul.contacts-suggestions").empty();for(n in a)this.$el.find("ul.contacts-suggestions").append(Mustache.render(Templates.contactsuggestionentry,
a[n].attributes))},hidesuggestions:function(){this.$el.find("#filter_contacts label").addClass("hidden");this.$el.find("ul.contacts-suggestions").empty()},requestcontacts:function(a){a!=this.filters.contacts.string&&(this.model.contacts.processing?this.filters.contacts.buffered=a:(this.$el.find(".loading-contacts").removeClass("hidden"),this.filters.contacts.string=a,this.model.contacts.fetch({remove:!1,parameters:{q:a,channels:this.model.id},success:this.loadedcontacts.bind(this)})))},loadedcontacts:function(){this.$el.find(".loading-contacts").addClass("hidden");
this.filters.contacts.buffered&&(this.requestcontacts(this.filters.contacts.buffered),this.filters.contacts.buffered=!1)},filtercontacts:function(a){a=$(a.currentTarget);if(a.data("contact"))a=Cloudwalkers.Session.getContact(a.data("contact")),0>this.filters.contacts.list.indexOf(a.id)&&(this.filters.contacts.list.push(a.id),this.$el.find("ul.contacts-placeholder").append(Mustache.render(Templates.contactselectedentry,a.attributes)));else{var b=a.data("close-contact");this.filters.contacts.list=this.filters.contacts.list.filter(function(a){return a!=
b});this.$el.find("[data-close-contact="+b+"]").parent().remove()}this.collection.touch(this.model,this.filterparameters());return this},filternetworks:function(a,b){this.loadmylisteners(!0);b||(b=this.button&&this.button.data("networks")==$(a.currentTarget).data("networks"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:String(this.button.data("networks")).split(" ");b&&(this.button=!1);c?($(c.map(function(a){return'[data-streams="'+
a+'"]'}).join(",")).removeClass("inactive").addClass("active"),this.filters.streams=c):this.filters.streams=[];this.collection.touch(this.model,this.filterparameters());return this},filterstreams:function(a,b){this.loadmylisteners(!0);b||(b=this.button&&this.button.data("streams")==$(a.currentTarget).data("streams"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:Number(this.button.data("streams"));b&&(this.button=!1);c?($('[data-networks~="'+
c+'"]').removeClass("inactive").addClass("active"),this.filters.streams=[c]):this.filters.streams=[];this.collection.touch(this.model,this.filterparameters());return this},filterparameters:function(){var a={records:20,group:1};this.filters.contacts.list.length&&(a.contacts=this.filters.contacts.list.join(","));this.filters.streams.length&&(a.streams=this.filters.streams.join(","));this.storeview();return a},storeview:function(){var a=Cloudwalkers.Session.viewsettings(this.collectionstring);a.streams||
(a.streams=[]);JSON.stringify(a.streams)!=JSON.stringify(this.filters.streams)&&(a.streams=this.filters.streams,Cloudwalkers.Session.viewsettings(this.collectionstring,a))},more:function(){this.incremental=!0;this.collection.more(this.model,this.filterparameters())||this.$el.find(".load-more").hide()},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove);this.addScroll()},addScroll:function(){this.$el.find(".scroller").slimScroll({height:"inherit"})},destroy:function(){$.each(this.entries,
function(a,b){b.remove()})},isempty:function(){$(".inbox-container").empty().addClass("empty-content")},unsetempty:function(){$(".inbox-container").removeClass("empty-content")}});Cloudwalkers.Views.Widgets.InboxMessageList=Cloudwalkers.Views.Widgets.Widget.extend({id:"inboxlist",entries:[],check:"hasMessages",collectionstring:"messages",filters:{contacts:{string:"",list:[]},streams:[]},templates:{messages:"smallentry",notes:"smallentrynote",notifications:"smallentry"},events:{remove:"destroy","click [data-toggle]":"togglefilter","input .input-rounded":"comparesuggestions","click [data-contact]":"filtercontacts","click [data-close-contact]":"filtercontacts","click [data-networks]":"filternetworks",
"click [data-streams]":"filterstreams","click .toggleall.active":"toggleall","click .load-more":"more"},initialize:function(a,b){a&&$.extend(this,a);this.model||(this.model=this.options.channel);this.collection=this.model[this.collectionstring];this.loadmylisteners();this.updateable(this.model,"h3.page-title")},loadmylisteners:function(a){a&&this.stopListening(this.collection);this.$el.find("#loadmore").empty();this.listenTo(this.collection,"seed",this.fill);this.listenTo(this.collection,"request",
this.showloading);this.listenTo(this.collection,"sync",this.hideloading);this.listenTo(this.collection,"ready",this.showmore);this.listenTo(this.model.contacts,"add",this.comparesuggestions);this.listenTo(this.collection,"ready:empty",this.isempty);this.listenTo(this.collection,"request",this.unsetempty);this.listenTo(Cloudwalkers.RootView,"added:note",function(){this.collection.touch(this.model,this.filterparameters())}.bind(this));this.loadListeners(this.collection,["request","sync",["ready","loaded"]],
!0)},toggleall:function(){this.filternetworks(null,!0);this.togglestreams(!0)},togglestreams:function(a){this.$el.find("[data-networks], [data-streams]").addClass(a?"active":"inactive").removeClass(a?"inactive":"active");this.$el.find(".toggleall").addClass(a?"inactive":"active").removeClass(a?"active":"inactive")},render:function(){var a={streams:[],networks:[]};this.model.streams.each(function(b){b.get(this.check)&&a.streams.push({id:b.id,icon:b.get("network").icon,name:b.get("defaultname"),network:b.get("network")})}.bind(this));
a.networks=this.model.streams.filterNetworks(a.streams,!0);a.note=this.listtype?!0:!1;this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.inboxlist,a));this.filters.streams.length&&(this.$el.find("[data-streams], [data-networks], .toggleall").toggleClass("inactive active"),this.$el.find(this.filters.streams.map(function(a){return'[data-networks~="'+a+'"],[data-streams="'+a+'"]'}).join(",")).toggleClass("inactive active"));this.$container=this.$el.find("ul.list");this.collection.touch(this.model,
this.filterparameters());return this},showloading:function(){this.$el.find(".inbox").addClass("loading");this.$el.find(".load-more").hide()},hideloading:function(a,b){this.hasmore=a.cursor&&b[a.parenttype][this.collectionstring].length?!0:!1;this.$el.find(".inbox").removeClass("loading");this.$container.removeClass("inner-loading")},showmore:function(){setTimeout(function(){this.$container.css("max-height",999999);if(!this.hasmore)return this.$el.find("#loadmore").empty();var a=new Cloudwalkers.Views.Widgets.LoadMore({list:this.collection,
parentcontainer:this.$container});this.$el.find("#loadmore").html(a.render().el)}.bind(this),200)},hidemore:function(){this.$el.find(".load-more").hide()},fill:function(a){var b=this.templates[this.collectionstring];this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){var c=new Cloudwalkers.Views.Entry({model:a[n],template:b,checkunread:!0,parameters:{inboxview:!0}});this.entries.push(c);this.listenTo(c,"toggle",this.toggle);this.$container.append(c.render().el);
this.model.seedcontacts&&this.model.seedcontacts(a[n])}this.entries.length?setTimeout(this.toggle.bind(this,this.entries[0]),1):this.hidemore()},toggle:function(a){var b={model:a.model};this.inboxmessage&&this.inboxmessage.remove();"notes"==this.collectionstring&&(b.template="note");this.inboxmessage=new Cloudwalkers.Views.Widgets.InboxMessage(b);$(".inbox-container").html(this.inboxmessage.render().el);this.inboxmessage.showrelated();this.$el.find(".list .active").removeClass("active");a.$el.addClass("active")},
togglefilter:function(a){a=$(a.currentTarget);var b=a.data("toggle"),c=a.hasClass("selected");this.$el.find("[data-toggle].selected").removeClass("selected");this.$el.find("[id^=filter_]").addClass("hidden");c||(a.addClass("selected"),this.$el.find("#filter_"+b).removeClass("hidden"))},comparesuggestions:function(a){var b=this.$el.find("#filter_contacts input").val();if(b)b=b.toLowerCase();else return this.hidesuggestions();var c=this.model.contacts.filter(this.comparenamefilter.bind(this,b));5>c.length&&
(!a.cid&&2<b.length)&&this.requestcontacts(b);if(c.length)this.showsuggestions(c.slice(0,10));else return this.hidesuggestions()},comparenamefilter:function(a,b){return 0<=b.get("displayname").toLowerCase().indexOf(a)||b.get("name")&&0<=b.get("name").toLowerCase().indexOf(a)},showsuggestions:function(a){this.$el.find("#filter_contacts label").removeClass("hidden");this.$el.find("ul.contacts-suggestions").empty();for(n in a)this.$el.find("ul.contacts-suggestions").append(Mustache.render(Templates.contactsuggestionentry,
a[n].attributes))},hidesuggestions:function(){this.$el.find("#filter_contacts label").addClass("hidden");this.$el.find("ul.contacts-suggestions").empty()},requestcontacts:function(a){a!=this.filters.contacts.string&&(this.model.contacts.processing?this.filters.contacts.buffered=a:(this.$el.find(".loading-contacts").removeClass("hidden"),this.filters.contacts.string=a,this.model.contacts.fetch({remove:!1,parameters:{q:a,channels:this.model.id},success:this.loadedcontacts.bind(this)})))},loadedcontacts:function(){this.$el.find(".loading-contacts").addClass("hidden");
this.filters.contacts.buffered&&(this.requestcontacts(this.filters.contacts.buffered),this.filters.contacts.buffered=!1)},filtercontacts:function(a){a=$(a.currentTarget);if(a.data("contact"))a=Cloudwalkers.Session.getContact(a.data("contact")),0>this.filters.contacts.list.indexOf(a.id)&&(this.filters.contacts.list.push(a.id),this.$el.find("ul.contacts-placeholder").append(Mustache.render(Templates.contactselectedentry,a.attributes)));else{var b=a.data("close-contact");this.filters.contacts.list=this.filters.contacts.list.filter(function(a){return a!=
b});this.$el.find("[data-close-contact="+b+"]").parent().remove()}this.collection.touch(this.model,this.filterparameters());return this},filternetworks:function(a,b){this.loadmylisteners(!0);b||(b=this.button&&this.button.data("networks")==$(a.currentTarget).data("networks"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:String(this.button.data("networks")).split(" ");b&&(this.button=!1);c?($(c.map(function(a){return'[data-streams="'+
a+'"]'}).join(",")).removeClass("inactive").addClass("active"),this.filters.streams=c):this.filters.streams=[];this.collection.touch(this.model,this.filterparameters());return this},filterstreams:function(a,b){this.loadmylisteners(!0);b||(b=this.button&&this.button.data("streams")==$(a.currentTarget).data("streams"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:Number(this.button.data("streams"));b&&(this.button=!1);c?($('[data-networks~="'+
c+'"]').removeClass("inactive").addClass("active"),this.filters.streams=[c]):this.filters.streams=[];this.collection.touch(this.model,this.filterparameters());return this},filterparameters:function(){var a="notes"==this.listtype?{all:1}:{records:20,group:1};this.filters.contacts.list.length&&(a.contacts=this.filters.contacts.list.join(","));this.filters.streams.length&&(a.streams=this.filters.streams.join(","));this.storeview();return a},storeview:function(){var a=Cloudwalkers.Session.viewsettings(this.collectionstring);
a&&(a.streams||(a.streams=[]),JSON.stringify(a.streams)!=JSON.stringify(this.filters.streams)&&(a.streams=this.filters.streams,Cloudwalkers.Session.viewsettings(this.collectionstring,a)))},more:function(){this.incremental=!0;this.collection.more(this.model,this.filterparameters())||this.$el.find(".load-more").hide()},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove);this.addScroll()},addScroll:function(){this.$el.find(".scroller").slimScroll({height:"inherit"})},
destroy:function(){$.each(this.entries,function(a,b){b.remove()})},isempty:function(){$(".inbox-container").empty().addClass("empty-content")},unsetempty:function(){$(".inbox-container").removeClass("empty-content")},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original="networks more contacts filters search_contacts suggestions select_all load_more on".split(" ");this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),
a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.InboxNotificationList=Cloudwalkers.Views.Widgets.InboxMessageList.extend({collectionstring:"notifications",check:"hasNotifications",toggle:function(a){this.inboxmessage&&this.inboxmessage.remove();a.model.get("parent")?this.showmessage(a.model):this.listenToOnce(a.model,"change",this.showmessage);this.$el.find(".list .active").removeClass("active");a.$el.addClass("active").removeClass("unread")},showmessage:function(a){var b=Cloudwalkers.Session.getMessage(a.get("parent").id);
b||(b=new Cloudwalkers.Models.Message({id:a.get("parent").id}));this.model.messages.add(b);b.get("objectType")||b.fetch();this.inboxmessage=new Cloudwalkers.Views.Widgets.InboxMessage({model:b,notification:a});$(".inbox-container").html(this.inboxmessage.render().el)}});Cloudwalkers.Views.Widgets.InboxNotesList=Cloudwalkers.Views.Widgets.InboxMessageList.extend({entrytemplate:"smallentrynote",render:function(){this.on("contact:clicked",this.contactview);var a={streams:[],networks:[]};this.model.streams.each(function(b){b.get(this.check)&&a.streams.push({id:b.id,icon:b.get("network").icon,name:b.get("defaultname"),network:b.get("network")})}.bind(this));a.networks=this.model.streams.filterNetworks(a.streams,!0);a.note=this.listtype?!0:!1;this.mustacheTranslateRender(a);
this.$el.html(Mustache.render(Templates.inboxlist,a));this.filters.streams.length&&(this.$el.find("[data-streams], [data-networks], .toggleall").toggleClass("inactive active"),this.$el.find(this.filters.streams.map(function(a){return'[data-networks~="'+a+'"],[data-streams="'+a+'"]'}).join(",")).toggleClass("inactive active"));this.$container=this.$el.find("ul.list");this.collection.touch(this.model,this.filterparameters());this.listenTo(this.collection,"ready",this.afterrender);this.listenTo(Cloudwalkers.RootView,
"ready:notecontext",this.rendercontext);return this},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.NoteEntry({model:a[n],template:this.entrytemplate,parameters:{inboxview:!0}});this.entries.push(b);this.listenTo(b,"toggle",this.toggle);this.$container.append(b.render().el)}},afterrender:function(){this.entries.length?setTimeout(this.toggle.bind(this,this.entries[0]),1):this.hidemore()},
toggle:function(a){var b={model:a.model},c=a.model.parent?a.model.parent.get("objectType"):null;this.inboxnote&&this.inboxnote.remove();this.inboxnote=new Cloudwalkers.Views.Widgets.InboxNote(b);$(".inbox-container").html(this.inboxnote.render().el);this.rendercontext();"account"!=c&&this.inboxnote.showrelated();this.$el.find(".list .active").removeClass("active");a.$el.addClass("active")},togglefilter:function(a){a=$(a.currentTarget);var b=a.data("toggle"),c=a.hasClass("selected");this.$el.find("[data-toggle].selected").removeClass("selected");
this.$el.find("[id^=filter_]").addClass("hidden");c||(a.addClass("selected"),this.$el.find("#filter_"+b).removeClass("hidden"))},rendercontext:function(){if(this.inboxnote){var a=this.inboxnote.getcontext(),b;if("message"==a.objectType){var c=$('<div class="message social-box-colors"></div>');a.display=!0;b=Mustache.render(Templates.inboxmessage,a);b=c.append(b)}else"contact"==a.objectType&&(b=(new Cloudwalkers.Views.ContactCard({contact:a})).render().el);$(".inbox-container").find(".message").remove();
$(".inbox-container").find(".single-contact").remove();$(".inbox-container").prepend(b)}},comparesuggestions:function(a){var b=this.$el.find("#filter_contacts input").val();if(b)b=b.toLowerCase();else return this.hidesuggestions();var c=this.model.contacts.filter(this.comparenamefilter.bind(this,b));5>c.length&&(!a.cid&&2<b.length)&&this.requestcontacts(b);if(c.length)this.showsuggestions(c.slice(0,10));else return this.hidesuggestions()},comparenamefilter:function(a,b){return 0<=b.get("displayname").toLowerCase().indexOf(a)||
b.get("name")&&0<=b.get("name").toLowerCase().indexOf(a)},showsuggestions:function(a){this.$el.find("#filter_contacts label").removeClass("hidden");this.$el.find("ul.contacts-suggestions").empty();for(n in a)this.$el.find("ul.contacts-suggestions").append(Mustache.render(Templates.contactsuggestionentry,a[n].attributes))},hidesuggestions:function(){this.$el.find("#filter_contacts label").addClass("hidden");this.$el.find("ul.contacts-suggestions").empty()},requestcontacts:function(a){a!=this.filters.contacts.string&&
(this.model.contacts.processing?this.filters.contacts.buffered=a:(this.$el.find(".loading-contacts").removeClass("hidden"),this.filters.contacts.string=a,this.model.contacts.fetch({remove:!1,parameters:{q:a,channels:this.model.id},success:this.loadedcontacts.bind(this)})))},loadedcontacts:function(){this.$el.find(".loading-contacts").addClass("hidden");this.filters.contacts.buffered&&(this.requestcontacts(this.filters.contacts.buffered),this.filters.contacts.buffered=!1)},contactview:function(){var a=
this.inboxnote.getcontext();(a=a.from?a.from[0]:null)&&Cloudwalkers.RootView.viewContact({model:a})},filtercontacts:function(a){a=$(a.currentTarget);if(a.data("contact"))a=Cloudwalkers.Session.getContact(a.data("contact")),0>this.filters.contacts.list.indexOf(a.id)&&(this.filters.contacts.list.push(a.id),this.$el.find("ul.contacts-placeholder").append(Mustache.render(Templates.contactselectedentry,a.attributes)));else{var b=a.data("close-contact");this.filters.contacts.list=this.filters.contacts.list.filter(function(a){return a!=
b});this.$el.find("[data-close-contact="+b+"]").parent().remove()}this.collection.touch(this.model,this.filterparameters());return this},filternetworks:function(a,b){this.loadmylisteners(!0);b||(b=this.button&&this.button.data("networks")==$(a.currentTarget).data("networks"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:String(this.button.data("networks")).split(" ");b&&(this.button=!1);c?($(c.map(function(a){return'[data-streams="'+
a+'"]'}).join(",")).removeClass("inactive").addClass("active"),this.filters.streams=c):this.filters.streams=[];this.collection.touch(this.model,this.filterparameters());return this},filterstreams:function(a,b){this.loadmylisteners(!0);b||(b=this.button&&this.button.data("streams")==$(a.currentTarget).data("streams"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:Number(this.button.data("streams"));b&&(this.button=!1);c?($('[data-networks~="'+
c+'"]').removeClass("inactive").addClass("active"),this.filters.streams=[c]):this.filters.streams=[];this.collection.touch(this.model,this.filterparameters());return this},filterparameters:function(){var a={all:1,records:20,group:1};this.filters.contacts.list.length&&(a.contacts=this.filters.contacts.list.join(","));this.filters.streams.length&&(a.streams=this.filters.streams.join(","));this.storeview();return a},storeview:function(){var a=Cloudwalkers.Session.viewsettings(this.collectionstring);
a&&(a.streams||(a.streams=[]),JSON.stringify(a.streams)!=JSON.stringify(this.filters.streams)&&(a.streams=this.filters.streams,Cloudwalkers.Session.viewsettings(this.collectionstring,a)))},more:function(){this.incremental=!0;this.collection.more(this.model,this.filterparameters())||this.$el.find(".load-more").hide()},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove);this.addScroll()},addScroll:function(){this.$el.find(".scroller").slimScroll({height:"inherit"})}});Cloudwalkers.Views.Widgets.InboxMessage=Cloudwalkers.Views.Entry.extend({tagName:"div",className:"message social-box-colors",template:"inboxmessage",related:[],messageview:[],notifications:[],events:{remove:"destroy","click *[data-youtube]":"loadYoutube","click *[data-action]":"action","keyup #tags":"entertag"},render:function(){this.loading(!this.model.get("objectType"));if(this.options.notification)var a={from:this.options.notification.get("from")[0],timeago:moment(this.options.notification.get("date")).fromNow()};
a={commented:a};$.extend(a,this.model.attributes);this.options.notification?a.notification=!0:a.tags=!0;this.mustacheTranslateRender(a);Cloudwalkers.Session.censuretemplate(a);this.$el.html(Mustache.render(Templates[this.template],a));this.renderactions();this.model.get("objectType")&&(Cloudwalkers.Session.isAuthorized("ACCOUNT_NOTES_VIEW")&&(this.$el.find(".note-list").html("<li>"+Mustache.render(Templates.messagenote)+"</li>"),this.loadnoteui()),(Cloudwalkers.Session.isAuthorized("ACCOUNT_TAGS_VIEW")||
Cloudwalkers.Session.isAuthorized("ACCOUNT_TAGS_MANAGE"))&&this.loadtagui());this.time();this.options.notification&&this.model.get("objectType")&&this.addNotifications();this.model.get("objectType")&&!this.model.get("read")&&this.markasread();return this},incrementaction:function(a){this.actions.incrementaction(a)},loading:function(a){a?$(".inbox").addClass("loading"):$(".inbox").removeClass("loading")},showrelated:function(){this.loading(!0);this.$related=$("<ul></ul>");this.$prelated=$("<ul></ul>");
this.$el.before(this.$prelated.addClass("related-messages social-box-colors"));this.$el.after(this.$related.addClass("related-messages social-box-colors"));this.model.related||(this.model.related=new Cloudwalkers.Collections.Related);this.listenTo(this.model.related,"seed",this.updateCounters);this.listenTo(this.model.related,"seed",this.fillrelated);this.listenTo(this.model.related,"all",this.sendtriggers);var a=!1;"1"!=this.model.get("read")&&(a=!0);this.model.related.touch(this.model,{records:20,
markasread:a})},updateCounters:function(a){},fillrelated:function(a){this.incremental?this.incremental=!1:($.each(this.related,function(a,b){b.remove()}),this.related=[]);var b=!1;a=a.filter(function(a){a.id==this.model.id&&(b=!0);a.append=b;return a.id!=this.model.id}.bind(this));for(n in a){var c=new Cloudwalkers.Views.Entry({model:a[n],template:"inboxrelatedmessage",type:"full",parameters:{notes:this.notes}});this.related.push(c);this[a[n].append?"$related":"$prelated"].append(c.render().el)}this.loading(!1)},
sendtriggers:function(a){this.trigger(a)},addNotifications:function(){this.loading(!0);this.model.notifications||(this.model.notifications=new Cloudwalkers.Collections.Notifications);this.listenTo(this.model.notifications,"seed",this.fillNotifications);this.model.notifications.touch(this.model,{records:50,markasread:!0})},fillNotifications:function(a){this.notifications.length&&($.each(this.notifications,function(a,b){b.remove()}),this.notifications=[]);a.models&&(a=a.models);var b=this.$el.find(".message-comments ul").eq(0).html("");
for(n in a){var c=new Cloudwalkers.Views.Notification({model:a[n],template:"inboxcomment",active:a[n].id==this.options.notification.id});this.notifications.push(c);b.append(c.render().el)}this.loading(!1)},markasread:function(){this.model.save({read:1},{patch:!0,wait:!0});Cloudwalkers.Session.getStreams().outdated(this.model.get("stream"))},destroy:function(){$.each(this.modelview,function(a,b){b.remove()});$.each(this.notifications,function(a,b){b.remove()});$.each(this.related,function(a,b){b.remove()})},
translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["add","on","commented"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.InboxNote=Cloudwalkers.Views.Widgets.InboxMessage.extend({tagName:"div",className:"note",template:"inboxnote",related:[],messageview:[],notifications:[],events:{remove:"destroy","click *[data-youtube]":"loadYoutube","click *[data-action]":"action","keyup #tags":"entertag"},render:function(){this.loading(!this.model.loaded());var a={};$.extend(a,this.model.attributes);this.model.loaded("model")&&this.model.parent.loaded()&&(a[this.model.parent.get("objectType")]=this.model.parent.attributes);
this.model.filterActions&&$.extend(a,{actions:this.model.filterActions()});this.notes&&(a.notes=!0);this.options.notification||(a.tags=!0);this.mustacheTranslateRender(a);Cloudwalkers.Session.censuretemplate(a);this.$el.html(Mustache.render(Templates[this.template],a));this.model.get("objectType")&&(Cloudwalkers.Session.isAuthorized("ACCOUNT_NOTES_VIEW")&&(this.$el.find(".note-list").html("<li>"+Mustache.render(Templates.messagenote)+"</li>"),this.loadnoteui()),(Cloudwalkers.Session.isAuthorized("ACCOUNT_TAGS_VIEW")||
Cloudwalkers.Session.isAuthorized("ACCOUNT_TAGS_MANAGE"))&&this.loadtagui());this.time();this.options.notification&&this.model.get("objectType")&&this.addNotifications();this.model.attributes.ACCOUNT&&this.$el.addClass("nocontext");return this},loading:function(a){a?$(".inbox").addClass("loading"):$(".inbox").removeClass("loading")},getcontext:function(){return this.model.parent.attributes},showrelated:function(){this.loading(!0);this.$related=$("<ul></ul>");this.$prelated=$("<ul></ul>");this.$el.before(this.$prelated.addClass("related-messages social-box-colors"));
this.$el.after(this.$related.addClass("related-messages social-box-colors"));this.model.related||(this.model.related=new Cloudwalkers.Collections.RelatedNotes);this.listenTo(this.model.related,"seed",this.fillrelated);this.listenTo(this.model.related,"all",this.sendtriggers);this.model.related.touch(this.model,{records:20,markasread:!0})},fillrelated:function(a){this.incremental?this.incremental=!1:($.each(this.related,function(a,b){b.remove()}),this.related=[]);var b=!1;a=a.filter(function(a){a.id==
this.model.id&&(b=!0);a.append=b;return a.id!=this.model.id}.bind(this));for(n in a){var c=new Cloudwalkers.Views.NoteEntry({model:a[n],template:"inboxnote",parameters:{notes:this.notes}});this.related.push(c);this[a[n].append?"$related":"$prelated"].append(c.render().el)}this.loading(!1)},sendtriggers:function(a){this.trigger(a)},addNotifications:function(){this.loading(!0);this.model.notifications||(this.model.notifications=new Cloudwalkers.Collections.Notifications);this.listenTo(this.model.notifications,
"seed",this.fillNotifications);this.model.notifications.touch(this.model,{records:50,markasread:!0})},fillNotifications:function(a){this.notifications.length&&($.each(this.notifications,function(a,b){b.remove()}),this.notifications=[]);a.models&&(a=a.models);var b=this.$el.find(".message-comments ul").eq(0).html("");for(n in a){var c=new Cloudwalkers.Views.Notification({model:a[n],template:"inboxcomment",active:a[n].id==this.options.notification.id});this.notifications.push(c);b.append(c.render().el)}this.loading(!1)},
markasread:function(){this.model.save({read:1},{patch:!0,wait:!0});Cloudwalkers.Session.getStreams().outdated(this.model.get("stream"))},destroy:function(){$.each(this.modelview,function(a,b){b.remove()});$.each(this.notifications,function(a,b){b.remove()});$.each(this.related,function(a,b){b.remove()})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["add","on","commented"];this.translated=[];for(k in this.original)this.translated[k]=
this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.NoteEntry=Cloudwalkers.Views.Entry.extend({tagName:"li",template:"messagenote",events:{mouseover:"toggleactions",mouseout:"toggleactions","click *[data-notification-action]":"action","click .note-header":"togglenote"},initialize:function(a){this.parameters={};a&&$.extend(this,a);this.listenToOnce(this.model,"change",this.render);this.listenTo(this.model,"destroy",this.remove)},render:function(){Cloudwalkers.Session.censuretemplate(this.model.attributes);this.model.attributes.date=
moment(this.model.attributes.date).format("DD MMM YYYY");this.$el.html(Mustache.render(Templates[this.template],this.model.attributes));this.isnew&&this.makenew();return this},makenew:function(){this.$el.addClass("new");setTimeout(function(){this.$el.removeClass("new")}.bind(this),2E3)},togglenote:function(){this.$el.find(".note-body").slideToggle("fast")},toggleactions:function(a){a="mouseout"==a.originalEvent.type;this.$el.find(".message-actions")[a?"addClass":"removeClass"]("hidden");this.$el.find(".comment-info")[a?
"removeClass":"addClass"]("hidden")},action:function(a){a.stopPropagation();a=$(a.currentTarget).data("notification-action");this.model.trigger("action",a);"edit"==a&&(this.$el.find(".note-body").is(":visible")||this.togglenote(),this.isediting?this.canceledit():this.editnote())},editnote:function(){var a=new Cloudwalkers.Views.ComposeNote({note:this.model});this.listenTo(a,"edit:cancel",this.canceledit);this.listenTo(a,"save:success",this.saved);this.$el.find(".note-body").html(a.render().el);this.isediting=
!0},canceledit:function(){this.$el.find(".note-body").html(this.model.get("text"));this.isediting=!1},saved:function(){setTimeout(function(){this.canceledit()}.bind(this),200)},remove:function(){this.$el.slideUp(300);setTimeout(function(){this.remove()}.bind(this),300)}});Cloudwalkers.Views.Widgets.TagEntry=Cloudwalkers.Views.Entry.extend({tagName:"span",template:"messagetag",events:{mouseover:"toggleactions",mouseout:"toggleactions","click *[data-tag-action]":"action","click *[data-action]":"action"},initialize:function(a){this.parameters={};a&&$.extend(this,a);this.parent&&this.model&&(this.model.parent=this.parent);this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"destroytag",this.remove)},render:function(){Cloudwalkers.Session.censuretemplate(this.model.attributes);
this.model.attributes.name&&this.$el.html(Mustache.render(Templates[this.template],this.model.attributes));return this},remove:function(){this.$el.remove()},action:function(a){this.$el.closest(".message-tags").hasClass("enabled")&&this.model.deletetag()}});Cloudwalkers.Views.Widgets.Timeline=Cloudwalkers.Views.Widgets.MessageContainer.extend({template:"timeline",messagetemplate:"messagetimeline",messageelement:"li",render:function(){if("undefined"!=typeof this.options.title)this.title=this.options.title;else{var a=this.options.channel.getFilters();"undefined"!=typeof a.streams&&0<a.streams.length&&(a=Cloudwalkers.Session.getStream(a.streams[0]))&&(this.title=a.customname)}"undefined"!=typeof this.options.color&&(this.color=this.options.color);this.$el.html(Mustache.render(Templates.widgetnoborder,
{color:this.color}));this.$innerEl=$(this.$el.find(".portlet-body"));this.innerRender(this.$innerEl);return this}});Cloudwalkers.Views.Widgets.ScheduledTable=Cloudwalkers.Views.Widgets.MessageContainer.extend({messagetemplate:"messageschedule",template:"messageschedulecontainer"});Cloudwalkers.Views.Widgets.Datepicker=Cloudwalkers.Views.Widgets.Widget.extend({title:"Date range",icon:"calendar",color:"grey",start:Date.today().add({days:-6}),end:Date.today().add({days:1}),events:{"submit form":"submit"},getDateRange:function(){return[this.start,this.end]},render:function(){var a=this.$el,b=this;a.html(Mustache.render(Templates.datepicker,{}));a.find(".dashboard-report-range").daterangepicker({ranges:{"Last 2 Days":[Date.today().add({days:-1}),"today"],"Last 5 Days":[Date.today().add({days:-4}),
"today"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 10 Days":[Date.today().add({days:-9}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})]},opens:App.isRTL()?"right":"left",format:"MM/dd/yyyy",separator:" to ",startDate:this.start,endDate:this.end,locale:{applyLabel:"Submit",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom Range",
daysOfWeek:"Su Mo Tu We Th Fr Sa".split(" "),monthNames:"January February March April May June July August September October November December".split(" "),firstDay:1},showWeekNumbers:!0,buttonClasses:["btn-danger"]},function(c,e){a.find(".dashboard-report-range span").html(c.toString("MMMM d, yyyy")+" - "+e.toString("MMMM d, yyyy"));b.trigger("date:change",c,(new Date(e.getTime())).add({days:1}))});a.find(".dashboard-report-range").show();a.find(".dashboard-report-range span").html(this.start.toString("MMMM d, yyyy")+
" - "+(new Date(this.end)).add({days:-1}).toString("MMMM d, yyyy"));return this}});Cloudwalkers.Views.Widgets.MessagesCounters=Cloudwalkers.Views.Widgets.Widget.extend({entries:[],events:{"click a[href]":"updatesettings"},initialize:function(a){a.color||(this.options.color=this.color);if(this.list=a.channel[a.source])for(n in this.list.models){this.list.models[n].count=0;this.listenTo(this.list.models[n],"change",this.render);this.listenTo(this.list.models[n],"change",this.negotiateFunctionalities);if(this.list.models[n].get("counters"))for(k in this.counters=this.list.models[n].get("counters").MESSAGE,
this.counters)"UNREAD"==this.counters[k].type&&"TOTAL"==this.counters[k].interval&&(this.list.models[n].count=this.counters[k].amount);else if(this.list.models[n].channels)for(k in this.keywordchannels=this.list.models[n].channels.models,this.keywordchannels)for(j in this.keywordstreams=this.keywordchannels[k].streams.models,this.keywordstreams)if(this.keywordstreams[j].get("counters"))for(i in this.counters=this.keywordstreams[j].get("counters").MESSAGE,this.counters)"UNREAD"==this.counters[i].type&&
"TOTAL"==this.counters[i].interval&&(this.list.models[n].count+=parseInt(this.counters[i].amount));this.list.models[n].count||(this.list.models[n].count=this.list.models[n].get("count")[a.countString])}},render:function(){var a={list:[]};$.extend(a,this.options);this.list&&(this.list.comparator=function(a,c){return c.count-a.count},this.list.sort(),this.list.each(function(b){var c=b.attributes,e=a.typelink?a.typelink+"/"+(b.get("hasMessages")?"messages":"notifications"):a.link?a.link:"#"+a.type+"/"+
a.channel.id+"/"+b.id;a.list.push({id:c.id,name:c.name,url:e,count:b.count,icon:c.network?c.network.icon:a.icon})}));this.$el.html(Mustache.render(Templates.messagescounters,a));return this},updatesettings:function(a){if("streams"!=this.options.source)return null;a=this.list.get($(a.currentTarget).data("stream"));var b=a.get("childtypes")[0]+"s",c=Cloudwalkers.Session.viewsettings(b);c.streams=[a.id];Cloudwalkers.Session.viewsettings(b,c)},negotiateFunctionalities:function(){this.$el.find(".scroller").length&&
this.addScroll();this.options.counter&&this.appendCounter();"undefined"!=typeof this.options.open&&this.appendCollapseble(this.options.open)}});Cloudwalkers.Views.Widgets.CombinedStatistics=Cloudwalkers.Views.Widgets.Widget.extend({size:"full",currentReport:null,element:null,render:function(){function a(a){f.find('[data-report-id="'+a.get("uniqueid")+'"]').click(function(){c.setReport(a)})}function b(a){f.find('[data-interval-id="'+a.token+'"]').click(function(){f.find(".interval-value").html(a.name);var b=1;"day"==a.token?b=11:"7days"==a.token?b=77:"28days"==a.token&&(b=308);for(var e=new Date,e=new Date(e.getFullYear(),e.getMonth(),e.getDate()+
1),b=new Date(e.getTime()-864E5*b),g=0;g<c.options.reports.length;g++)c.options.reports[g].intervalinput=a.token,c.options.reports[g].daterange=[b,e],c.options.reports[g].refresh();c.currentReport&&c.currentReport.getDataset().refresh()})}var c=this,e={},f=this.$el;this.element=f;e.reports=[];e.stream=this.options.stream;for(var g=0;g<this.options.reports.length;g++)e.reports.push(this.options.reports[g].attributes);e.intervals=[{name:"Days",token:"day"},{name:"7 days",token:"7days"},{name:"28 days",
token:"28days"}];f.html(Mustache.render(Templates.combinedstatistics,e));for(g=0;g<this.options.reports.length;g++)a(this.options.reports[g]);for(g=0;g<e.intervals.length;g++)b(e.intervals[g]);f.find('[data-interval-id="'+e.intervals[0].token+'"]').click();0<this.options.reports.length?this.setReport(this.options.reports[0]):(this.$el.find(".statistic-container").html("<p>There is currently no information available.</p>"),this.$el.find(".statistic-title").html("Combined statistics"),this.$el.find(".statistic-description").html(""));
return this},setReport:function(a){this.element.find(".report-value").html(a.get("name"));this.currentReport=a;var b=$("<div></div>");this.$el.find(".statistic-container").html(b);this.$el.find(".statistic-title").html(a.get("name"));this.$el.find(".statistic-description").html(a.get("description"));a.getWidget().innerRender(b)}});Cloudwalkers.Views.Widgets.NewCombinedStatistics=Backbone.View.extend({streamid:216,reports:{facebook:["fans","posts","activity","impressions","notifications"],twitter:["followers","following","posts","mentions","retweets"],youtube:["fans","posts"]},funcs:{fans:{data:{title:"Fans Evolution",filterfunc:"contact-evolution-network"},span:3},posts:{data:{title:"Posts Evolution",filterfunc:"post-activity-network"},span:3},activity:{data:{title:"Activity Evolution",filterfunc:"activity-network"},span:3},
impressions:{data:{title:"Impressions evolution",filterfunc:"page-views-network"},span:3},notifications:{data:{title:"Notifications evolution",filterfunc:"notifications"},span:3},followers:{data:{title:"Followers evolution",filterfunc:"followers"},span:3},following:{data:{title:"Following evolution",filterfunc:"following"},span:3},mentions:{data:{title:"mentions evolution",filterfunc:"mentions"},span:3},retweets:{data:{title:"Retweet evolution",filterfunc:"retweets"},span:3}},charts:[{data:{chart:"LineChart",
filterfunc:"evolution",network:!0},span:6},{data:{chart:"LineChart",filterfunc:"evolution"},span:6}],titles:{contacts:"Contact evolution",messages:"Message evolution",activities:"Activity evolution",impressions:"Impression evolution",notifications:"Notification evolution"},initialize:function(a){a&&$.extend(this,a);view=this;this.collection=this.model.statistics;this.listenTo(this.collection,"ready",this.fill)},render:function(){this.settings={};this.settings.title=this.title;$.extend(this.settings,
this.getstreamcontext(this.network));this.$el.html(Mustache.render(Templates.newcombinedstatistics,this.settings));return this},fill:function(){if(this.filled)return!0;this.fillcharts();this.renderinfos&&this.fillinfo(this.settings.reports);this.filled=!0},fillcharts:function(){var a=this.charts;for(n in a)a[n].data.model=this.model,a[n].data.network&&(a[n].data.network=this.network),a[n].data.type=this.type,a[n].data.title=this.titles[this.type],view=new Cloudwalkers.Views.Widgets.Chart(this.charts[n].data),
this.parent.appendWidget(view,6)},fillinfo:function(a){var b;for(n in a)this.funcs[a[n]].data.model=this.model,this.funcs[a[n]].data.network=this.network,this.funcs[a[n]].data.icon=this.icon,this.funcs[a[n]].data.footer="+ 0 (+ 0%) SINCE LAST 7 DAYS",b=new Cloudwalkers.Views.Widgets.Info(this.funcs[a[n]].data),this.parent.appendWidget(b,3);this.parent.appendWidget(null,0)},getstreamcontext:function(a){var b={};b.reports=this.reports[a];return b},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Widgets.CompoundChart=Backbone.View.extend({templatemap:{"2col1row":["#col1","#col2","#row1"],"2row":["#row1","#row2"]},initialize:function(a){a&&$.extend(this,a);view=this;this.collection=this.model.statistics;this.charttemplate="compoundchart"+this.options.template;this.template=this.options.template;this.charts=this.options.chartdata},render:function(){this.settings={};this.settings.title=this.title;this.$el.html(Mustache.render(Templates[this.charttemplate],this.settings));
this.fill();return this},fill:function(){if(this.filled)return!0;$.each(this.charts,function(a,b){b.data.model=this.model;b.data.network=this.network;var c=(new Cloudwalkers.Views.Widgets[b.widget](b.data)).render().el;this.$el.find(this.templatemap[this.template][a]).append(c)}.bind(this));this.filled=!0},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Widgets.TrendingMessage=Backbone.View.extend({initialize:function(a){a&&$.extend(this,a);this.settings={};this.settings.title=this.title;this.model=this.network?Cloudwalkers.Session.getStream(this.network):Cloudwalkers.Session.getChannel("profiles");this.listenTo(this.model,"sync",this.fill);this.timespan.sort||(this.timespan.sort="engagement");this.gettoptrending()},render:function(){this.$el.html(Mustache.render(Templates.trendingmsg,this.settings));this.hideloading();return this},
fill:function(){if((this.message=this.model.get("messages")?this.model.get("messages")[0]:!1)&&0!=this.message.length){var a=this.message,b=a.attachments?a.attachments.filter(function(a){if("link"==a.type)return a}):null,c=a.attachments?a.attachments.filter(function(a){if("image"==a.type)return a}):null;this.settings.statistics=a.statistics;this.settings.from=a.from[0].displayname||"";this.settings.body=a.body.plaintext||"";this.settings.icon=a.from[0].network.icon||"";this.settings.date=a.dateonly||
"";c.length&&(this.settings.image=c[0].url||"");this.settings.links=b||[];this.render()}else this.$el.find(".commentballoon h4").html("No data"),this.hideloading()},gettoptrending:function(){return this.network?this.toptrendingstream(this.network):this.toptrendingall()},toptrendingstream:function(a){this.model.fetch({endpoint:"messages",parameters:{sort:this.timespan.sort,records:1}})},toptrendingall:function(){this.model=Cloudwalkers.Session.getChannel("profiles");this.model.fetch({endpoint:"messages",
parameters:{sort:this.timespan.sort,records:1,since:this.timespan.since}})},showloading:function(){this.$el.find(".icon-cloud-download").show()},hideloading:function(){$(".inner-loading").removeClass("inner-loading")},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Widgets.BestTimeToPost=Backbone.View.extend({initialize:function(a){a&&$.extend(this,a);this.settings={};this.settings.title=this.title;this.collection=this.model.statistics;this.listenTo(this.collection,"ready",this.fill)},render:function(){this.$el.html(Mustache.render(Templates.besttimewrap,this.settings));return this},fill:function(){if(!this.filled){var a=this.collection.clone().parsebesttime();$.each(a,function(b,c){c.fill=100*c.value/a.maxvalue;c.time=0<=c.time?c.time+"h":
"";this.$el.find(".chart-wrapper").append(Mustache.render(Templates.besttime,c))}.bind(this));this.filled=!0}},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Widgets.TitleSeparator=Backbone.View.extend({className:"titleseparator",initialize:function(a){a&&$.extend(this,a);this.settings={};this.settings.title=this.title},render:function(){this.$el.html(Mustache.render(Templates.titleseparator,this.settings));return this},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Widgets.NetworkStatistics=Backbone.View.extend({initialize:function(a){a&&$.extend(this,a);this.collection=this.model.statistics;this.listenTo(this.collection,"ready",this.fill)},render:function(){this.settings={};this.settings.title=this.title;this.$el.html('<div id="netstat"></div>');return this},fill:function(){if(this.filled)return!0;title="Network evolution chart ("+this.network+")";data={chart:"LineChart",filterfunc:"allreports",network:this.network,title:title};data.model=
this.model;view=(new Cloudwalkers.Views.Widgets.Chart(data)).render().el;this.$el.find("#netstat").append(view);this.filled=!0},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Widgets.Report=Cloudwalkers.Views.Widgets.Widget.extend({template:"report",initialize:function(){this.stream=this.options.stream},render:function(){this.$el.html(Mustache.render(Templates[this.template],{network:this.stream.get("network")}));this.$el.find(".dashboard-stat").addClass("portlet-loading");this.stream.reports.hook({success:this.fill.bind(this),error:this.fail.bind(this)});return this},fill:function(){var a=this.stream.reports.findWhere({token:this.options.type});if(!a)return null;
a={dashboard:this.options.dashboard,streamid:this.stream.id,network:this.stream.get("network"),details:a.getDetails()};this.$el.html(Mustache.render(Templates[this.template],a));this.trigger("content:change")},fail:function(){Cloudwalkers.RootView.growl(this.translateString("oops"),this.translateString("something_went_sideways_please_reload_the_page"))},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Widgets.StatSummary=Cloudwalkers.Views.Widgets.Widget.extend({className:"stats-summary",columns:{contacts:{translate_title:"total_contacts",func:"parsecontacts"},"score-trending":{translate_title:"popularity_score",func:"parsescore"},outgoing:{translate_title:"messages_sent",func:"parsesent"},coworkers:{translate_title:"co-workers_activity",func:"parseactivity"},"contacts-network":{translate_title:"total_contacts",func:"parsecontactsnetwork"},"score-trending-network":{translate_title:"popularity_score",
func:"parsescorenetwork"},"outgoing-network":{translate_title:"messages_sent",func:"parsesentnetwork"},coworkers:{translate_title:"co-workers_activity",func:"parseactivity"},besttime:{translate_title:"best_time_to_post",func:"parsebesttime"}},initialize:function(a){a&&$.extend(this,a);this.collection=this.model.statistics;this.listenTo(this.collection,"ready",this.fill)},render:function(){var a={columns:[]};for(n in this.columnviews)a.columns.push(this.columns[this.columnviews[n]]);for(n in a.columns)!a.columns[n].title&&
a.columns[n].translate_title&&(a.columns[n].title=this.translateString(a.columns[n].translate_title));this.$el.html(Mustache.render(Templates.statsummary,a));return this},fill:function(){this.$el.find("[data-type]").each(function(a,b){var c=$(b).data("type");$(b).find(".stats-summary-counter").html(this[c]().counter)}.bind(this))},parsecontacts:function(){return{counter:this.collection.latest().pluck("contacts")}},parsescore:function(){stat=this.collection.latest();return{counter:stat.pluck("notifications")+
stat.pluck("activities")}},parsesent:function(){var a=this.collection.latest(),b=this.collection.first();return{counter:a.pluck("messages")-b.pluck("messages")}},parseactivity:function(){var a=Cloudwalkers.Session.getStream("coworkers").id,a=this.activitymsgs(this.collection.latest(),a)-this.activitymsgs(this.collection.first(),a);return{counter:0<=a?a:0}},activitymsgs:function(a,b){var c=a.get("streams"),c=$.grep(c,function(a){return a.id==b});return c.length?(_.isNumber(c[0].messages),c[0].messages):
0},parsecontactsnetwork:function(){return{counter:this.collection.latest().pluck("contacts",this.network)}},parsescorenetwork:function(){stat=this.collection.latest();return{counter:stat.pluck("notifications",this.network)+stat.pluck("activities",this.network)}},parsesentnetwork:function(){var a=this.collection.latest(),b=this.collection.first();return{counter:a.pluck("messages",this.network)-b.pluck("messages",this.network)}},parsebesttime:function(){var a=this.collection.clone().parsebesttime();
if(0==a.length)return null;for(var b={},c=a[0].time,e=1,f=0;f<a.length;f++){var g=a[f].time;0>g||(null==b[g]?b[g]=1:b[g]++,b[g]>e?(c=g,e=b[g]):b[g]==e&&(c=g,e=b[g]))}return{counter:c+"h"}},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Widgets.CalSummary=Cloudwalkers.Views.Widgets.Widget.extend({className:"stats-summary cal-summary",columns:[{title:"Total messages",func:"parsetotal",translation:{title:"total_messages"}},{title:"Average",func:"parseavg",translation:{title:"average"}},{title:"Media",func:"parsemedia",translation:{title:"media"}}],initialize:function(a){a&&$.extend(this,a);this.listenTo(this.calview.model.messages,"ready",this.fill)},render:function(){var a={columns:this.columns};for(k in this.columns)this.translateColumns(this.columns[k]);
this.$el.html(Mustache.render(Templates.statsummary,a));return this},fill:function(a){this.$el.find("[data-type]").each(function(b,c){var e=this[$(c).data("type")](a);$(c).find(".stats-summary-counter").html(e.counter);e.title&&$(c).find(".stats-summary-title").html(e.title)}.bind(this))},parsetotal:function(a){return{counter:a.length}},parseavg:function(a){if(!a.length)return{counter:0};var b="agendaWeek"==this.calview.viewtype?{title:this.translateString("daily_average"),divide:7}:{title:this.translateString("weekly_average"),
divide:4};a=Math.round(a.length/b.divide);b.counter=a+" <small>message"+(1!=a?"s":"")+"</small>";return b},parsemedia:function(a){if(!a.length)return{counter:0};var b=[],c=a.length,e={image:0,video:0,link:0,text:0};a.each(function(a){if(a=a.get("attachments"))for(n in a)e[a[n].type]++;else e.text++});e.image&&b.push("<div class='media-entry'><i class='icon-picture'></i> <strong>"+Math.round(100*(e.image/c))+"</strong>% "+this.translateString("images")+"</div>");e.video&&b.push("<div class='media-entry'><i class='icon-facetime-video'></i> <strong>"+
Math.round(100*(e.video/c))+"</strong>% "+this.translateString("video")+"</div>");e.link&&b.push("<div class='media-entry'><i class='icon-link'></i> <strong>"+Math.round(100*(e.link/c))+"</strong>% "+this.translateString("links")+"</div>");e.text&&b.push("<div class='media-entry'><i class='icon-reorder'></i> <strong>"+Math.round(100*(e.text/c))+"</strong>% "+this.translateString("text-only")+"</div>");return{counter:b.join("<br>")}},parsetrending:function(a){a=a.max(function(a){return a.get("engagement")});
var b={intro:a.get("body").plaintext.substr(0,140)};140==b.intro.length&&(b.intro+="...");$.extend(b,a.attributes);return{counter:Mustache.render(Templates.caltrendingentry,b)}},translateColumns:function(a){if(a.translation)for(k in a.translation)a[k]=Cloudwalkers.Session.polyglot.t(a.translation[k])},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Widgets.CalendarFilters=Cloudwalkers.Views.Widgets.Widget.extend({id:"calendarfilters",filters:{},events:{remove:"destroy","click [data-toggle]":"togglefilter","click [data-networks]":"filternetworks","click [data-streams]":"filterstreams","click .toggleall.active":"toggleall"},initialize:function(a){a&&$.extend(this,a);this.collection=this.model.messages;this.streams=Cloudwalkers.Session.getChannel("internal").get("additional").outgoing},render:function(){if(this.model.streams){var a=
{streams:[]};for(n in this.streams)a.streams.push({id:this.streams[n].id,icon:this.streams[n].network.icon,name:this.streams[n].name,network:this.streams[n].network});a.networks=this.model.streams.filterNetworks(a.streams,!0);this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.calendarfilters,a))}return this},toggleall:function(){this.filternetworks(null,!0);this.togglestreams(!0)},togglefilter:function(a){a=$(a.currentTarget);var b=a.data("toggle"),c=a.hasClass("selected");$("[data-toggle].selected").removeClass("selected");
$("[id^=filter_]").addClass("hidden");c||(a.addClass("selected"),$("#filter_"+b).removeClass("hidden"))},togglefilters:function(a){this.$el.find("li").addClass(a?"active":"inactive").removeClass(a?"inactive":"active");this.$el.find(".toggleall").addClass(a?"inactive":"active").removeClass(a?"active":"inactive")},togglestreams:function(a){this.$el.find("[data-networks], [data-streams]").addClass(a?"active":"inactive").removeClass(a?"inactive":"active");this.$el.find(".toggleall").addClass(a?"inactive":
"active").removeClass(a?"active":"inactive")},filternetworks:function(a,b){b||(b=this.button&&this.button.data("networks")==$(a.currentTarget).data("networks"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:String(this.button.data("networks")).split(" ");b&&(this.button=!1);c?($(c.map(function(a){return'[data-streams="'+a+'"]'}).join(",")).removeClass("inactive").addClass("active"),this.filters.streams=c):this.filters.streams=[];
this.filterparameters();return this},filterstreams:function(a,b){b||(b=this.button&&this.button.data("streams")==$(a.currentTarget).data("streams"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:Number(this.button.data("streams"));b&&(this.button=!1);c?($('[data-networks~="'+c+'"]').removeClass("inactive").addClass("active"),this.filters.streams=[c]):this.filters.streams=[];this.filterparameters();return this},filterparameters:function(){this.filters.streams.length?
this.calview.parameters.streams=this.filters.streams.join(","):this.calview.parameters.streams&&delete this.calview.parameters.streams;$("#calendar").fullCalendar("refetchEvents")},fill:function(a){$.each(this.entries,function(a,b){b.remove()});this.entries=[];for(n in a){var b=new Cloudwalkers.Views.User({model:a[n],template:"smalluser",type:"listitem"});this.entries.push(b);this.listenTo(b,"select",this.select);this.$container.append(b.render().el)}this.$el.find(".inner-loading").removeClass("inner-loading")},
select:function(a){this.list.render({users:a.model.id,records:20})},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",height:$("#inner-content").height()-165+"px",alwaysVisible:!1,railVisible:!1})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["networks","more","select_all"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+
this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Widgets.Charts.Linechart=Cloudwalkers.Views.Widgets.Widget.extend({title:"Line chart",placeholder:null,icon:"reorder",size:6,element:null,getDataset:function(){return this.options.model},initialize:function(){var a=this;this.options.model.on("dataset:change",function(b){a.plot(b[0].values)})},innerRender:function(a){this.element=a;var b=this;this.placeholder=$('<div class="chart" style="position: relative;"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)})},
showTooltip:function(a,b,c){$('<div id="tooltip">'+c+"</div>").css({position:"absolute",display:"none",top:b+5,left:a+15,border:"1px solid #333",padding:"4px",color:"#fff","border-radius":"3px","background-color":"#333",opacity:0.8}).appendTo(this.element).fadeIn(200)},plot:function(a){var b=this;$.plot(this.placeholder,[a],{xaxis:{mode:"time"},yaxis:{tickDecimals:0},series:{lines:{show:!0,lineWidth:2,fill:!0,fillColor:{colors:[{opacity:0.05},{opacity:0.01}]}},points:{show:!0},shadowSize:2},grid:{hoverable:!0,
clickable:!0,tickColor:"#eee",borderWidth:0},colors:["#d12610","#37b7f3","#52e136"]});var c=null;this.placeholder.bind("plothover",function(a,f,g){$("#x").text(f.x.toFixed(2));$("#y").text(f.y.toFixed(2));g?c!=g.dataIndex&&(c=g.dataIndex,$("#tooltip").remove(),a=g.datapoint[0],f=g.datapoint[1],a=(new Date(a)).toLocaleDateString(),b.showTooltip(g.pageX,g.pageY,a+": "+f)):($("#tooltip").remove(),c=null)})}});Cloudwalkers.Views.Widgets.Charts.Intervalchart=Cloudwalkers.Views.Widgets.Widget.extend({title:"Bar chart",placeholder:null,icon:"reorder",size:6,getDataset:function(){return this.options.model},innerRender:function(a){var b=this;this.placeholder=$('<div class="chart" style="position: relative;"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)});this.options.model.on("dataset:change",function(a){b.plot(a[0].values)})},numberOutput:function(a){return 0<=
a?"+ "+a:"- "+Math.abs(a)},plot:function(a){if(a){var b=[],c=[],e=[],f,g=0;for(10<a.length&&(g=1);10>a.length;)a.unshift([null,0]);for(;g<a.length;g++)null!=a[g][0]?(f=new Date(a[g][0]),f=f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()):f="",b.push([g,f]),a[g][0]=g,0==g?(c.push([g,a[g][1]]),e.push([g,0])):a[g-1][1]<=a[g][1]?(c.push([g,a[g-1][1]]),e.push([g,a[g][1]-a[g-1][1]])):(c.push([g,a[g][1]]),e.push([g,0]));b=$.plot(this.placeholder,[c,e],{xaxis:{ticks:b},yaxis:{tickDecimals:0,min:0},series:{stack:!0,
shadowSize:2,bars:{show:!0,align:"center",barWidth:0.8,fill:0.78,lineWidth:1}},grid:{borderWidth:0},colors:["#2bbedc","#ffb848","#852b99","#e02222","#ffe399"]});for(g=0;g<a.length;g++)0<g&&(a[g][1]=parseInt(a[g][1]),0<a[g][1]&&0<a[g-1][1]&&(e=(a[g][1]-a[g-1][1])/Math.max(1,a[g-1][1]),e*=100,e=Math.floor(e),e=this.numberOutput(e)+"%",c=b.pointOffset({x:a[g][0],y:a[g][1]}),this.placeholder.append('<div style="background: white; position: absolute; left: '+(c.left-30)+"px; top: "+(c.top-25)+'px; width: 60px; text-align: center;">'+
e+"</div>")))}}});Cloudwalkers.Views.Widgets.Charts.Numberstat=Cloudwalkers.Views.Widgets.Widget.extend({title:"Number stat",icon:"reorder",color:null,network:null,template:"dashboardstat",size:3,showLink:!0,showStreamName:!0,getDataset:function(){return this.options.model},render:function(){var a=this.$el,b=this;this.color&&(this.options.color=this.color);this.network&&(this.options.network=this.network);this.dashboard&&(this.options.dashboard=this.dashboard);this.showLink&&(this.options.showLink=this.showLink);this.showStreamName&&
(this.options.showStreamName=this.showStreamName);a.html(Mustache.render(Templates[this.template],this.options));this.options.model.getValues(function(a){b.setValue(a)});this.options.model.on("dataset:change",function(a){b.setValue(a[0].values)});return this},numberOutput:function(a,b){"undefined"==typeof b&&(b=!1);return 0>a?"- "+Math.abs(a):b?"+ "+Math.abs(a):a},setValue:function(a){var b=this.$el,c=this.options.model.getDisplay(),e={};$.extend(!0,e,this.options);var f=this.options.model.getInterval();
e.details=[];e.footer="&nbsp;";e.report=this.options.report.attributes;a&&0<a.length?"comparison"==c?(c=this.numberOutput(a[0][1]),1<a.length?(e.footer="<strong>"+this.numberOutput(a[0][1]-a[1][1],!0)+"</strong> (",e.footer+=this.numberOutput(Math.round(100*this.options.model.getEvolution()),!0)+"%) Since last "+f):e.footer="Last "+f,a=this.options.showStreamName?"Foo "+e.title:e.title,e.details.push({content:c,descr:a})):this.$el.find(".number").html(this.numberOutput(a[a.length-1][1])):e.details.push({content:"\u2639",
descr:"No info"});this.trigger("content:change");b.html(Mustache.render(Templates[this.template],e));b.find(".portlet-loading").toggleClass("portlet-loading")}});Cloudwalkers.Views.Widgets.Charts.Textstat=Cloudwalkers.Views.Widgets.Widget.extend({title:"Line chart",icon:"reorder",color:null,network:null,template:"dashboardstat",size:3,getDataset:function(){return this.options.model},render:function(){var a=this.$el,b=this;this.color&&(this.options.color=this.color);this.network&&(this.options.network=this.network);this.options.footer="&nbsp;";a.html(Mustache.render(Templates[this.template],this.options));this.options.model.getValues(function(a){b.setValue(a)});
this.options.model.on("dataset:change",function(a){b.setValue(a[0].values)});return this},setValue:function(a){var b=this.$el,c={};$.extend(!0,c,this.options);c.footer="<strong>"+this.options.stream.customname+"</strong> "+this.options.title;c.details=[];a&&0<a.length?c.details.push({content:a[0][1],descr:a[0][0]}):c.details.push({content:"\u2639",descr:"No info"});b.html(Mustache.render(Templates[this.template],c));b.find(".portlet-loading").toggleClass("portlet-loading")}});Cloudwalkers.Views.Widgets.Charts.Comparison=Cloudwalkers.Views.Widgets.Charts.Numberstat.extend({template:"dashboardstat"});Cloudwalkers.Views.Widgets.Charts.Barchart=Cloudwalkers.Views.Widgets.Widget.extend({title:"Bar chart",placeholder:null,icon:"reorder",size:6,getDataset:function(){return this.options.model},innerRender:function(a){var b=this;this.placeholder=$('<div class="chart" style="position: relative;"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)});this.options.model.on("dataset:change",function(a){b.plot(a[0].values)})},plot:function(a){if(a){for(var b=[],
c=0;c<a.length;c++)b.push([c,a[c][0]]),a[c][0]=c;$.plot(this.placeholder,[a],{xaxis:{ticks:b},yaxis:{tickDecimals:0},bars:{show:!0,align:"center",fill:0.78,lineWidth:1},colors:["#2bbedc","#ffb848","#852b99","#e02222","#ffe399"]})}}});Cloudwalkers.Views.Widgets.Charts.Piechart=Cloudwalkers.Views.Widgets.Widget.extend({title:"Pie chart",placeholder:null,icon:"reorder",size:6,maxSlices:10,getDataset:function(){return this.options.model},innerRender:function(a){var b=this;this.placeholder=$('<div class="chart" style="position: relative;"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)});this.options.model.on("dataset:change",function(a){b.plot(a[0].values)})},plot:function(a){if(0==
a.length)this.placeholder.html("<p>At this time there is no information available.</p>");else{a.sort(function(a,b){return b[1]-a[1]});var b=0;if(a.length>this.maxSlices){for(;a.length>this.maxSlices-1;)b+=a.pop()[1];a.push(["Other",b])}for(var b=[],c=0;c<a.length;c++)b.push({label:a[c][0],data:a[c][1]});$.plot(this.placeholder,b,{series:{pie:{show:!0}},colors:"#2bbedc #ffb848 #852b99 #e02222 #ffe399 #AFD8F8 #A23C3C #4DA74D #BD9B33 #8CACC6".split(" ")})}}});Cloudwalkers.Views.Widgets.Charts.Table=Cloudwalkers.Views.Widgets.Widget.extend({title:"Line chart",placeholder:null,size:"full",icon:"reorder",getDataset:function(){return this.options.model},innerRender:function(a){var b=this;this.placeholder=$('<div class="table-container"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)});this.options.model.on("dataset:change",function(a){b.plot(a[0].values)})},plot:function(a){for(var b={header:[]},c=[],e=0;e<
a.header.length;e++)b.header.push({name:a.header[e],"class":"undefined"!=typeof a.classes[e]?a.classes[e]:null}),c.push({sSortDataType:"dom-text"});b.rows=[];for(e=0;e<a.rows.length;e++){for(var c=[],f=0;f<a.rows[e].length;f++)c.push({value:a.rows[e][f],"class":"undefined"!=typeof a.classes[f]?a.classes[f]:null});b.rows.push({columns:c})}this.placeholder.html(Mustache.render(Templates.charttable,b))}});Cloudwalkers.Views.Widgets.LoadMore=Backbone.View.extend({events:{click:"more"},initialize:function(a){$.extend(this,a)},loadmylisteners:function(){this.loadListeners(this.list,["request","sync","ready"],!0)},render:function(){this.$el.html(Mustache.render(Templates.loadmore));this.$container=this.$el.find(".load-more-wrap");this.$loadercontainer=this.$el.find(".load-more-wrap");this.loadmylisteners();this.trigger("rendered");return this},more:function(){this.$el.find(".btn.load-more").addClass("hidden");
this.$el.find(".load-more-wrap").addClass("inner-loading");var a=this.parentcontainer.outerHeight();this.parentcontainer.css("max-height",a)}});Cloudwalkers.Views.Widgets.InboxDemoList=Cloudwalkers.Views.Widgets.Widget.extend({id:"inboxlist",entries:[],check:"hasMessages",collectionstring:"messages",filters:{contacts:{string:"",list:[]},streams:[]},events:{remove:"destroy","click [data-toggle]":"togglefilter","input .input-rounded":"comparesuggestions","click [data-contact]":"filtercontacts","click [data-close-contact]":"filtercontacts","click [data-networks]":"filternetworks","click [data-streams]":"filterstreams","click .toggleall.active":"toggleall",
"click .load-more":"more"},initialize:function(a,b){a&&$.extend(this,a);this.model=this.options.channel;this.collection=this.model[this.collectionstring];this.listenTo(this.collection,"seed",this.fill);this.listenTo(this.collection,"request",this.showloading);this.listenTo(this.collection,"sync",this.hideloading);this.listenTo(this.model.contacts,"add",this.comparesuggestions)},toggleall:function(){this.filternetworks(null,!0);this.togglestreams(!0)},togglestreams:function(a){this.$el.find("[data-networks], [data-streams]").addClass(a?
"active":"inactive").removeClass(a?"inactive":"active");this.$el.find(".toggleall").addClass(a?"inactive":"active").removeClass(a?"active":"inactive")},render:function(){var a={streams:[],networks:[]};this.model.streams.each(function(b){b.get(this.check)&&a.streams.push({id:b.id,icon:b.get("network").icon,name:b.get("defaultname"),network:b.get("network")})}.bind(this));a.networks=this.model.streams.filterNetworks(a.streams,!0);this.$el.html(Mustache.render(Templates.demolist,a));this.filters.streams.length&&
(this.$el.find("[data-streams], [data-networks], .toggleall").toggleClass("inactive active"),this.$el.find(this.filters.streams.map(function(a){return'[data-networks~="'+a+'"],[data-streams="'+a+'"]'}).join(",")).toggleClass("inactive active"));this.$container=this.$el.find("ul.list");var b=this.demo;this.$el.find(".scroller").scrollrefresh({callback:function(){b();running(!0);setTimeout(function(){this.restart();this.running(!1)},1E3)},effectheight:40,scrolltime:400});"empty"==this.demotype?this.emptydemo():
this.demo();return this},demo:function(){function a(b,e){setTimeout(function(){b.eq(e).addClass("loaded");e<b.length&&a(b,e+1)},50)}function b(){$(".progress-bar").addClass("loading");$(".list-loading").removeClass("done");setTimeout(function(){elements=$(".unloaded");a(elements,0);$(".progress-bar").addClass("loaded");$(".list-loading").addClass("done");$(".progress-bar").removeClass("loaded").removeClass("loading")},3E3)}setTimeout(function(){b()},1E3)},emptydemo:function(){function a(){$(".progress-bar").addClass("loading");
setTimeout(function(){$(".progress-bar").addClass("loaded");$(".list-loading").addClass("empty-list");$(".inbox-container").addClass("empty-content")},3E3)}setTimeout(function(){a()},0)},showloading:function(){this.$container.addClass("inner-loading");$(".inbox").addClass("loading");this.$el.find(".load-more").hide()},hideloading:function(a,b){a.cursor&&b.channel[this.collectionstring].length&&this.$el.find(".load-more").show();$(".inbox").removeClass("loading");this.$container.removeClass("inner-loading")},
hidemore:function(){this.$el.find(".load-more").hide()},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],template:"smallentry",checkunread:!0,parameters:{inboxview:!0}});this.entries.push(b);this.listenTo(b,"toggle",this.toggle);this.$container.append(b.render().el);this.model.seedcontacts(a[n])}this.entries.length?setTimeout(this.toggle.bind(this,this.entries[0]),1):this.hidemore()},
toggle:function(a){this.inboxmessage&&this.inboxmessage.remove();this.inboxmessage=new Cloudwalkers.Views.Widgets.DemoMessage({model:a.model});$(".inbox-container").html(this.inboxmessage.render().el);this.inboxmessage.showrelated();this.$el.find(".list .active").removeClass("active");a.$el.addClass("active")},togglefilter:function(a){a=$(a.currentTarget);var b=a.data("toggle"),c=a.hasClass("selected");$("[data-toggle].selected").removeClass("selected");$("[id^=filter_]").addClass("hidden");c||(a.addClass("selected"),
$("#filter_"+b).removeClass("hidden"))},comparesuggestions:function(a){var b=$("#filter_contacts input").val();if(b)b=b.toLowerCase();else return this.hidesuggestions();var c=this.model.contacts.filter(this.comparenamefilter.bind(this,b));5>c.length&&(!a.cid&&2<b.length)&&this.requestcontacts(b);if(c.length)this.showsuggestions(c.slice(0,10));else return this.hidesuggestions()},comparenamefilter:function(a,b){return 0<=b.get("displayname").toLowerCase().indexOf(a)||b.get("name")&&0<=b.get("name").toLowerCase().indexOf(a)},
showsuggestions:function(a){this.$el.find("#filter_contacts label").removeClass("hidden");this.$el.find("ul.contacts-suggestions").empty();for(n in a)this.$el.find("ul.contacts-suggestions").append(Mustache.render(Templates.contactsuggestionentry,a[n].attributes))},hidesuggestions:function(){this.$el.find("#filter_contacts label").addClass("hidden");this.$el.find("ul.contacts-suggestions").empty()},requestcontacts:function(a){a!=this.filters.contacts.string&&(this.model.contacts.processing?this.filters.contacts.buffered=
a:(this.$el.find(".loading-contacts").removeClass("hidden"),this.filters.contacts.string=a,this.model.contacts.fetch({remove:!1,parameters:{q:a,channels:this.model.id},success:this.loadedcontacts.bind(this)})))},loadedcontacts:function(){this.$el.find(".loading-contacts").addClass("hidden");this.filters.contacts.buffered&&(this.requestcontacts(this.filters.contacts.buffered),this.filters.contacts.buffered=!1)},filtercontacts:function(a){a=$(a.currentTarget);if(a.data("contact"))a=Cloudwalkers.Session.getContact(a.data("contact")),
0>this.filters.contacts.list.indexOf(a.id)&&(this.filters.contacts.list.push(a.id),this.$el.find("ul.contacts-placeholder").append(Mustache.render(Templates.contactselectedentry,a.attributes)));else{var b=a.data("close-contact");this.filters.contacts.list=this.filters.contacts.list.filter(function(a){return a!=b});this.$el.find("[data-close-contact="+b+"]").parent().remove()}this.collection.touch(this.model,this.filterparameters());return this},filternetworks:function(a,b){b||(b=this.button&&this.button.data("networks")==
$(a.currentTarget).data("networks"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:String(this.button.data("networks")).split(" ");b&&(this.button=!1);c?($(c.map(function(a){return'[data-streams="'+a+'"]'}).join(",")).removeClass("inactive").addClass("active"),this.filters.streams=c):this.filters.streams=[];this.collection.touch(this.model,this.filterparameters());return this},filterstreams:function(a,b){b||(b=this.button&&this.button.data("streams")==
$(a.currentTarget).data("streams"));this.togglestreams(b);b||(this.button=$(a.currentTarget).addClass("active").removeClass("inactive"));var c=b?null:Number(this.button.data("streams"));b&&(this.button=!1);c?($('[data-networks~="'+c+'"]').removeClass("inactive").addClass("active"),this.filters.streams=[c]):this.filters.streams=[];this.collection.touch(this.model,this.filterparameters());return this},filterparameters:function(){var a={records:20,group:1};this.filters.contacts.list.length&&(a.contacts=
this.filters.contacts.list.join(","));this.filters.streams.length&&(a.streams=this.filters.streams.join(","));this.storeview();return a},storeview:function(){var a=Cloudwalkers.Session.viewsettings(this.collectionstring);a.streams||(a.streams=[]);JSON.stringify(a.streams)!=JSON.stringify(this.filters.streams)&&(a.streams=this.filters.streams,Cloudwalkers.Session.viewsettings(this.collectionstring,a))},more:function(){this.incremental=!0;this.collection.more(this.model,this.filterparameters())||this.$el.find(".load-more").hide()},
negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove);this.addScroll()},addScroll:function(){this.$el.find(".scroller").slimScroll({height:"inherit"})},destroy:function(){$.each(this.entries,function(a,b){b.remove()})}});Cloudwalkers.Views.Widgets.DemoMessage=Cloudwalkers.Views.Entry.extend({tagName:"div",className:"message social-box-colors",related:[],messageview:[],notifications:[],events:{remove:"destroy","click *[data-youtube]":"loadYoutube","click *[data-action]":"action"},render:function(){this.loading(!this.model.get("objectType"));if(this.options.notification)var a={from:this.options.notification.get("from")[0],timeago:moment(this.options.notification.get("date")).fromNow()};a={commented:a};$.extend(a,this.model.attributes,
{actions:this.model.filterActions()});void 0!==a.body&&(a.isdone="done");this.$el.html(Mustache.render(Templates.demoinboxmessage,a));this.time();this.options.notification&&this.model.get("objectType")&&this.addNotifications();this.model.get("objectType")&&!this.model.get("read")&&this.markasread();return this},loading:function(a){a?$(".inbox").addClass("loading"):$(".inbox").removeClass("loading")},showrelated:function(){this.loading(!0);this.$related=$("<ul></ul>");this.$prelated=$("<ul></ul>");
this.$el.before(this.$prelated.addClass("related-messages social-box-colors"));this.$el.after(this.$related.addClass("related-messages social-box-colors"));this.model.related||(this.model.related=new Cloudwalkers.Collections.Related);this.listenTo(this.model.related,"seed",this.fillrelated);this.model.related.touch(this.model,{records:20,markasread:!0})},fillrelated:function(a){this.incremental?this.incremental=!1:($.each(this.related,function(a,b){b.remove()}),this.related=[]);var b=!1;a=a.filter(function(a){a.id==
this.model.id&&(b=!0);a.append=b;return a.id!=this.model.id}.bind(this));for(n in a){var c=new Cloudwalkers.Views.Entry({model:a[n],template:"inboxrelatedmessage",type:"full"});this.related.push(c);this[a[n].append?"$related":"$prelated"].append(c.render().el)}this.loading(!1)},addNotifications:function(){this.loading(!0);this.model.notifications||(this.model.notifications=new Cloudwalkers.Collections.Notifications);this.listenTo(this.model.notifications,"seed",this.fillNotifications);this.model.notifications.touch(this.model,
{records:50,markasread:!0})},fillNotifications:function(a){this.notifications.length&&($.each(this.notifications,function(a,b){b.remove()}),this.notifications=[]);a.models&&(a=a.models);var b=this.$el.find(".message-comments ul").eq(0).html("");for(n in a){var c=new Cloudwalkers.Views.Notification({model:a[n],template:"inboxcomment",active:a[n].id==this.options.notification.id});this.notifications.push(c);b.append(c.render().el)}this.loading(!1)},markasread:function(){this.model.save({read:1},{patch:!0,
wait:!0});Cloudwalkers.Session.getStreams().outdated(this.model.get("stream"))},destroy:function(){$.each(this.modelview,function(a,b){b.remove()});$.each(this.notifications,function(a,b){b.remove()});$.each(this.related,function(a,b){b.remove()})}});Cloudwalkers.Views.Error=Backbone.View.extend({render:function(){var a={};a.error=this.options.error;$(this.el).html(Mustache.render(Templates.error,a));return this}});Cloudwalkers.Views.OriginalMessage=Cloudwalkers.Views.Message.extend({template:"originalmessage",className:"originalmessage-view",tagName:"div",childrencontainer:"original-comment-container",events:{"click .original-message-action.action":"messageAction","click .original-message-children":"showchildren"}});Cloudwalkers.Views.ActionParameters=Backbone.View.extend({events:{"submit form":"submit"},render:function(){this.$el.html(Templates["action-parameters"]);var a=this.options.action,b=this.options.message,c={};c.action=a;c.title=a.name;c.input={};jQuery.each(a.parameters,function(a,f){"undefined"==typeof c.input[f.type]&&(c.input[f.type]=[]);"undefined"!=typeof f.value&&""!=f.value&&(f.value=Cloudwalkers.Utilities.Parser.parseFromMessage(f.value,b));c.input[f.type]=f});this.$el.html(Mustache.render(Templates["action-parameters"],
c));return this},submit:function(a){a.preventDefault();var b={};a=$(a.currentTarget).serializeArray();for(var c=0;c<a.length;c++)b[a[c].name]=a[c].value;this.options.message.act(this.options.action,b);this.trigger("popup:close")}});Cloudwalkers.Views.Widgets.Title=Backbone.View.extend({size:"full",render:function(){this.$el.html('<h3 style="margin-bottom: 25px;">'+this.options.title+"</h3>");return this},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Settings.Services=Backbone.View.extend({events:{"click [data-add-service]":"addService","click [data-service]":"servicedetail"},initialize:function(){this.services=new Cloudwalkers.Collections.Services;if(this.options.serviceid)return this.appendservice(this.options.serviceid);this.listenTo(this.services,"available:ready",this.appendOptions);this.services.fetchAvailable();this.listenTo(this.services,"add",this.appendService);this.listenToOnce(this.services,"add",this.endload);this.listenTo(this.services,
"ready",this.limited);this.services.fetch();this.loadListeners(this.services,["available:ready","sync","ready"],!0)},endload:function(){this.$el.find(".inner-loading").removeClass("inner-loading")},appendservice:function(a){(new Cloudwalkers.Models.Service({id:a})).addservice()},render:function(){Cloudwalkers.Session.getAccount();var a={};a.translate_active_social_connections=this.translateString("active_social_connections");this.$el.html(Mustache.render(Templates.settings.services,a));this.$container=
this.$el.find(".portlet-body");return this},appendOptions:function(a,b){var c=this.$el.find(".networks-list");for(n in b)b[n].translate_add=this.translateString("add"),c.append(Mustache.render(Templates.settings.service_option,b[n]))},appendService:function(a){this.$el.find("ul.services").append(Mustache.render(Templates.settings.service_connected,a.attributes))},addService:function(a){if(this.$el.find(".networks-list.limited").size())return null;a=$(a.target).data("add-service");this.listenToOnce(this.services,
"sync",function(a){var c=a.get("authenticateUrl");if(!c)return null;window.location=this.processLink(c,a.id)});this.services.create({},{wait:!0,endpoint:a})},limited:function(a){Cloudwalkers.Session.getAccount().monitorlimit("services",a.models.length,$(".networks-list"))},servicedetail:function(a){this.$el.find("#service-connected").addClass("open-detail");this.detail=new Cloudwalkers.Views.Settings.Service({id:$(a.currentTarget).data("service"),parent:this});this.$el.find(".service-detail").html(this.detail.render().el)},
closedetail:function(){this.$el.find("#service-connected").removeClass("open-detail");this.detail.remove()},processLink:function(a,b){return a=0<a.indexOf("?")?a+"&return="+encodeURIComponent(window.location.origin+"/#settings/services/"+b):a+"?return="+encodeURIComponent(window.location.origin+"/#settings/services/"+b)},addServiceCall:function(a){a.preventDefault();var b=this;a=$(a.target).attr("data-add-service");this.addService(a,function(a){"undefined"!=typeof a.error?Cloudwalkers.RootView.alert(a.error.message):
($.each(a.service.settings,function(a,c){if("link"==c.type){var g=b.processLink(c.url);window.location=g}}),b.render())})},negotiateFunctionalities:function(a){},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Settings.Service=Backbone.View.extend({events:{"click li[data-id]":"toggleprofile","click .delete-detail":"delete","click .close-detail":"closedetail"},listnames:{facebook:"Pages",twitter:!1,linkedin:"Companies","google-plus":"Pages",youtube:!1},service:null,initialize:function(a){a&&$.extend(this,a);this.service=this.parent.services.get(this.id)},render:function(){var a=_.clone(this.service.attributes);a.listname=this.listnames[a.network.token];a.authurl=a.authenticateUrl+"&return="+
encodeURIComponent(window.location.href);this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.settings.service,a));return this},toggleprofile:function(a){a=$(a.currentTarget).toggleClass("active inactive");var b=new Cloudwalkers.Models.User({id:a.data("id")});b.parent=this.service;b.typestring="profiles";b.save({activated:a.hasClass("active")},{patch:!0,success:function(a){Cloudwalkers.RootView.growl(this.translateString("social_connections"),this.translateString("a_successful_update_here"));
a.parent.updateStreams(a.get("activated"),a)}.bind(this)})},parseprofile:function(a){var b=a.parent,c;b&&b.get("streams")&&(c=b.get("streams").filter(function(b){if(b.profile)return b.profile.id==a.id}),console.log(c));if(c&&c.length)for(n in c)this.parent.parsestream(c[n],a.get("activated")?"add":"remove");Cloudwalkers.RootView.navigation.renderHeader();Cloudwalkers.RootView.navigation.render()},"delete":function(){Cloudwalkers.RootView.confirm(this.translateString("you_are_about_to_delete_a_service_all_your_statistics_information_will_be_lost"),
function(){this.parent.$el.find("[data-service="+this.service.id+"]").remove();this.service.destroy({success:this.closedetail.bind(this)})}.bind(this))},closedetail:function(){this.parent.closedetail()},processSettings:function(a){var b=this;$.each(a,function(c,e){"link"==e.type&&(a[c].url=b.processLink(e.url))})},processLink:function(a){return a=0<a.indexOf("?")?a+"&return="+encodeURIComponent(window.location):a+"?return="+encodeURIComponent(window.location)},getServiceData:function(a,b){var c=this;
Cloudwalkers.Net.get("wizard/service/"+a,{account:Cloudwalkers.Session.getAccount().get("id")},function(a){c.processSettings(a.service.settings);b(a)})},storeServiceData:function(a,b,c){Cloudwalkers.Net.put("wizard/service/"+a,{account:Cloudwalkers.Session.getAccount().get("id")},b,c)},deleteService:function(a,b){Cloudwalkers.Net.remove("wizard/service/"+a,{account:Cloudwalkers.Session.getAccount().get("id")},b)},setStreamChannels:function(a){function b(a,b){var c=[];b.each(function(b){if(!b.get("parent")&&
b.get("name")){for(var e=!1,f=0;f<a.channels.length;f++)if(a.channels[f]==b.get("id")){e=!0;break}e={channel:b.attributes,selected:e,channels:[]};b.attributes&&b.get("channels");c.push(e)}});return c}function c(a){for(var b={string:[],"boolean":[]},c=0;c<a.settings.length;c++)"undefined"==typeof b[a.settings[c].type]&&(b[a.settings[c].type]=[]),b[a.settings[c].type].push(a.settings[c]);a.groupedsettings=b}function e(g){var h=[];$.each(a.streams,function(a,l){"undefined"!=typeof l.parent&&l.parent.id==
g.id&&(c(l),h.push({parsedchannels:b(l,f),stream:l,substreams:e(l)}))});return h}var f=Cloudwalkers.Session.getChannels();a.parsedstreams=function(){for(var g=[],h=0;h<a.streams.length;h++)a.streams[h].canSetChannels&&"undefined"==typeof a.streams[h].parent&&(c(a.streams[h]),g.push({parsedchannels:b(a.streams[h],f),stream:a.streams[h],substreams:e(a.streams[h])}));return g}()},submit:function(a){var b=this;a.preventDefault();var c=$(a.target),e={streams:{}};c.find("[data-channel-setting]").each(function(a,
b){"checkbox"==$(b).attr("type")?e[$(b).attr("name")]=$(b).is(":checked"):e[$(b).attr("name")]=$(b).val()});$.each(this.service.streams,function(a,b){var h=[];c.find("[data-stream-id="+b.id+"][data-channel-id]:checked").each(function(a,b){h.push($(b).attr("data-channel-id"))});e.streams[b.id]={channels:h};c.find("[data-stream-setting="+b.id+"]").each(function(a,c){"checkbox"==$(c).attr("type")?e.streams[b.id][$(c).attr("name")]=$(c).is(":checked"):e.streams[b.id][$(c).attr("name")]=$(c).val()})});
this.storeServiceData(this.service.id,e,function(){b.render()})},deleteServiceClick:function(a){a.preventDefault();var b=this;Cloudwalkers.RootView.confirm(this.translateString("are_you_sure_you_want_to_remove_this_service_all_statistics_will_be_lost"),function(){b.deleteService(b.service.id,function(){b.trigger("service:delete")})})},streamDetailView:function(a){a.preventDefault();a=$(a.target).attr("data-stream-details-id");a=new Cloudwalkers.Views.Settings.StreamSettings({streamid:a});Cloudwalkers.RootView.popup(a)},
translateTitle:function(a){this.title=Cloudwalkers.Session.polyglot.t(a)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original="done delete connected_to reauthenticate_user to_add is_not_connected authenticate_user save to_your_cloudwalkers_account_select_them_below".split(" ");this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Settings.Users=Backbone.View.extend({events:{"submit .users-invite":"addUser"},"class":"section",collections:[],initialize:function(){this.collection=new Cloudwalkers.Collections.Users;this.listenToOnce(this.collection,"sync",this.fill);this.listenToOnce(this.collection,"request",this.showloading);this.listenToOnce(this.collection,"sync",this.hideloading);this.loadListeners(this.collection,["request","sync"],!0)},render:function(){var a=Cloudwalkers.Session.getAccount(),b={};this.mustacheTranslateRender(b);
Cloudwalkers.Session.censuretemplate(b);this.$el.html(Mustache.render(Templates.settings.users,b));this.$el.find(".collapse-closed, .collapse-open").each(this.negotiateFunctionalities);this.collection.parameters={records:100};this.collection.parentmodel=a;this.collection.fetch();this.$container=this.$el.find(".toload");return this},fill:function(a){models=a.models;Cloudwalkers.Session.getAccount().monitorlimit("users",models.length,$(".invite-user"));a=this.$el.find(".user-container").eq(-1);for(n in models){var b=
new Cloudwalkers.Views.Settings.User({model:models[n],view:this});a.append(b.render().el)}},addUserContainer:function(a,b){var c=Cloudwalkers.Session.getUser(),e=this,f={};f.title=a;f.user=c.attributes;var g=$(Mustache.render(Templates.settings.users,f));b.on("reset",function(){g.find(".user-container").html("")});b.on("reset:all",function(){for(var a=0;a<e.collections.length;a++)e.collections[a].reset(),e.collections[a].fetch()});b.on("add",function(a){a=new Cloudwalkers.Views.Settings.User({model:a});
g.find(".user-container").append(a.render().el)});g.find(".loading").show();b.fetch({success:function(){g.find(".loading").hide()}});this.$el.append(g)},addUser:function(){var a={email:$("input[name=invite-email]").val()};Cloudwalkers.Session.getAccount().get("id");(new Cloudwalkers.Models.User(a)).once("sync",function(a){Cloudwalkers.RootView.growl(this.translateString("user_management"),this.translateString("invitation_on_its_way"))}.bind(this)).save()},negotiateFunctionalities:function(a){$(this).find(".portlet-title").on("click",
function(){$(this).parents(".collapse-closed, .collapse-open").toggleClass("collapse-closed collapse-open")})},fail:function(){Cloudwalkers.RootView.growl(this.translateString("oops"),this.translateString("something_went_sideways_please_reload_the_page"))},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original="edit_user select_user invite_new_user email invite_user userlist name type manage_user_groups".split(" ");this.translated=
[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Settings.User=Backbone.View.extend({tagName:"tr",events:{"click [data-edit-user-id]":"openDetails","click [data-delete-user-id]":"deleteUser"},initialize:function(a){a&&$.extend(this,a);this.parameters={};this.listenTo(this.model,"change:clearance",this.render);translate_you_are_about_to_remove=this.translateString("you_are_about_to_remove");translate_sure=this.translateString("sure");translate_manage_users=this.translateString("manage_users");translate_thats_an_ex_user=this.translateString("thats_an_ex_user")},
render:function(){var a={};a.user=this.model.attributes;a.user.role=this.model.getRole().name;Cloudwalkers.Session.censuretemplate(a);this.$el.html(Mustache.render(Templates.settings.user,a));return this},openDetails:function(){var a=new Cloudwalkers.Views.Settings.UserDetails({model:this.model,view:this.view});$(".manage-users-edit-widget .portlet-body").html(a.render().el)},deleteUser:function(a){var b=$(a.currentTarget).parents("tr");Cloudwalkers.Session.getUser(b.data("delete-user-id"));Cloudwalkers.RootView.confirm(translate_you_are_about_to_remove+
this.model.get("firstname")+translate_sure,function(){this.model.destroy({success:function(){b.remove();Cloudwalkers.RootView.growl(translate_manage_users,translate_thats_an_ex_user)}})}.bind(this))},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)}});Cloudwalkers.Views.Settings.UserDetails=Backbone.View.extend({events:{"submit form.edit-managed-user":"submit"},initialize:function(a){a&&$.extend(this,a);this.listenTo(this.model,"request",this.disablesave);this.listenTo(this.model,"sync",this.enablesave);this.role=this.model.get("rolegroup");this.roles=Cloudwalkers.Session.getAccount().get("roles");if(!this.roles||_.isUndefined(this.role))return Cloudwalkers.RootView.resync("#"+Backbone.history.fragment)},render:function(){var a={},b=this.roles;
a.user=this.model.attributes;a.title=a.user.name;a.roles=[];for(var c=0;c<b.length;c++){var e=b[c];e.checked=this.model.get("rolegroup")==b[c].id;a.roles.push(e)}this.mustacheTranslateRender(a);this.$el.html(Mustache.render(Templates.settings.userdetails,a));return this},submit:function(a){a={rolegroup:$("#level").val()};this.model.parent=Cloudwalkers.Session.getAccount();this.model.save(a,{patch:!0,success:this.success.bind(this)})},success:function(){Cloudwalkers.RootView.growl(this.translateString("manage_users"),
this.translateString("the_user_clearance_is_updated"));this.model.trigger("change:clearance")},disablesave:function(){this.$el.find(".edit-managed-user .btn").attr("disabled",!0)},enablesave:function(){this.$el.find(".edit-managed-user .btn").attr("disabled",!1)},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=["clearance_level","save"];this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),
a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Settings.Profile=Backbone.View.extend({events:{"click .add-user":"addUser","submit .edit-user-profile":"editUserProfile","submit .edit-user-password":"editUserPassword","click #add-file":"addfile","change input[type=file]":"listentofile","click #upload-file":"uploadfile"},"class":"section",collections:[],render:function(){var a=Cloudwalkers.Session.getUser(),b=this,c={user:{firstname:a.get("firstname"),name:a.get("name"),avatar:a.get("avatar"),role:a.getRole()},langs:Cloudwalkers.Session.langs};
this.mustacheTranslateRender(c);Cloudwalkers.Session.censuretemplate(c);this.$el.html(Mustache.render(Templates.settings.profile,c));this.$el.find(".collapse-closed, .collapse-open").each(function(){b.negotiateFunctionalities(this)});this.$el.find("option[value="+a.get("locale")+"]").attr("selected",!0);return this},editUserProfile:function(a){a=Cloudwalkers.Session.getUser();var b=this.$el.find("[name=firstname]").val(),c=this.$el.find("[name=name]").val(),e=this.$el.find("[name=mobile]").val(),
f=this.$el.find("[name=locale]").val();this.$el.find(".edit-user-profile .btn").attr("disabled",!0);this.$el.find(".edit-user-profile").addClass("loading");a.save({firstname:b,name:c,mobile:e,locale:f},{patch:!0,success:function(){Cloudwalkers.RootView.growl(this.translateString("user_profile"),this.translateString("your_profile_settings_are_updated"));window.location.reload()}.bind(this),error:function(){Cloudwalkers.RootView.growl(this.translateString("user_profile"),this.translateString("there_was_an_error_updating_your_settings"));
window.location.reload()}.bind(this)})},addfile:function(a){$(".settings-profile input[type=file]").click()},listentofile:function(a){var b=this;a=a.target.files;for(var c=0,e;e=a[c];c++){if(!e.type.match("image.*"))return Cloudwalkers.RootView.information(this.translateString("wrong_file"),this.translateString("you_need_a_valid_image"),this.$el.find(".settings-profile .portlet-body"));var f=new FileReader;f.onload=function(a){return function(a){b.addimage(a.target.result)}}(e);f.readAsDataURL(e)}},
addimage:function(a){this.base64data=a;this.$el.find("div.avatar-big").css("background-image","url("+a+")")},uploadfile:function(){this.$el.find(".edit-user-avatar").addClass("loading");this.base64data?Cloudwalkers.Session.getUser().save({avatar:this.base64data},{patch:!0,success:function(){Cloudwalkers.RootView.growl(this.translateString("user_profile"),this.translateString("you_have_a_new_profile_picture"));this.$el.find(".edit-user-avatar").removeClass("loading");setTimeout(function(){window.location.reload()},
1E3)}.bind(this)}):(Cloudwalkers.RootView.growl(this.translateString("no_image"),this.translateString("select_an_image_file_first")),this.$el.find(".edit-user-avatar").removeClass("loading"))},editUserPassword:function(){var a=this.$el.find("[name=pass0]").val(),b=this.$el.find("[name=pass1]").val();this.$el.find(".edit-user-password").addClass("loading");if(b!=this.$el.find("[name=pass2]").val())return Cloudwalkers.RootView.growl("Oops",this.translateString("please_retype_your_new_password")),null;
Cloudwalkers.Session.getUser().save({oldpassword:a,newpassword:b},{patch:!0,endpoint:"password",success:function(){Cloudwalkers.RootView.growl(this.translateString("user_profile"),this.translateString("you_have_a_new_password_now"));this.$el.find(".edit-user-password").removeClass("loading");this.$el.find("[name=pass0]").val("");this.$el.find("[name=pass1]").val("");this.$el.find("[name=pass2]").val("");this.$el.find("[name=pass2]").blur()}.bind(this),error:function(a,b,f){Cloudwalkers.RootView.growl(this.translateString("user_profile"),
error);window.location.reload()}.bind(this)})},negotiateFunctionalities:function(a){$(a).find(".portlet-title").on("click",function(){$(this).parents(".collapse-closed, .collapse-open").toggleClass("collapse-closed collapse-open")})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original="profile_type profile_picture select upload upload_profile_picture change_password current_password new_password retype_new_password cancel your_profile first_name last_name mobile_phone language save_changes cancel no_image".split(" ");
this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Settings.Account=Backbone.View.extend({events:{"click i[data-delete-campaign-id]":"deletecampaign","click #menu a":"scroll"},initialize:function(){this.streams=Cloudwalkers.Session.getStreams();this.streams=this.streams.filterNetworks();this.account=Cloudwalkers.Session.getAccount();this.triggers=new Cloudwalkers.Collections.Triggers;this.listenTo(this.triggers,"sync",this.filltriggers);this.triggermodel={}},render:function(){var a=Cloudwalkers.Session.getAccount().attributes;this.mustacheTranslateRender(a);
Cloudwalkers.Session.censuretemplate(a);this.$el.html(Mustache.render(Templates.settings.account,a));this.$el.find("#menu").affix();return this},filltriggers:function(a){var b=a.filter(function(a){if("CONTACT-NEW"==a.get("event"))return a});a=a.filter(function(a){if("MESSAGE-RECEIVED"==a.get("event"))return a});b=new Cloudwalkers.Models.Trigger(b[0].attributes);this.twitterview.updatetrigger(b);a=new Cloudwalkers.Models.Trigger(a[0].attributes);this.dmview.updatetrigger(a)},action:function(a){this[$(a.currentTarget).data("action")](a)},
editaccount:function(a){a=this.$el.find("[data-attribute=account-name]").val();this.account.save({name:a},{patch:!0,success:function(){Cloudwalkers.RootView.growl(this.translateString("account_settings"),this.translateString("your_account_settings_are_updated"))}}.bind(this))},deletecampaign:function(a){var b=$(a.target).data("delete-campaign-id");Cloudwalkers.RootView.confirm(this.translateString("are_you_sure_you_want_to_remove_this_campaign"),function(){Cloudwalkers.Session.getAccount().removecampaign(b,
a.target)})},scroll:function(a){a=$(a.currentTarget).data("hash");var b=this.$el.find("h3[name="+a+"]").offset().top,b=b-this.$el.find("h3[name="+a+"]").outerHeight();$("html, body").animate({scrollTop:b},"fast");return!1},negotiateFunctionalities:function(a){this.$el.find(".portlet-title").on("click",function(){$(this).parents(".collapse-closed, .collapse-open").toggleClass("collapse-closed collapse-open")})},translateString:function(a){return Cloudwalkers.Session.polyglot.t(a)},mustacheTranslateRender:function(a){this.original=
"campaigns account_plan account name save_changes cancel company_name menu campaigns basic manage_campaigns manage_auto_responders message_templates triggers".split(" ");this.translated=[];for(k in this.original)this.translated[k]=this.translateString(this.original[k]),a["translate_"+this.original[k]]=this.translated[k]}});Cloudwalkers.Views.Settings.Trigger=Backbone.View.extend({events:{"click [data-action=save]":"save","click [data-action=reset]":"reset"},initialize:function(a){$.extend(this,a);this.model||(this.model=new Cloudwalkers.Models.Trigger)},render:function(){this.model.parent=Cloudwalkers.Session.getAccount();var a={message:this.model.getmessage("REPLY"),description:this.description};this.$el.html(Mustache.render(Templates.settings.trigger,a));return this},updatetrigger:function(a){this.model=a;this.render();
this.$el.find(".inner-loading").removeClass("inner-loading");this.$el.find(".loading").removeClass("loading");this.$el.find("textarea").attr("disable",!1)},save:function(){this.model.setaction("REPLY",{message:this.$el.find("textarea").val()});this.model.save({event:this.model.get("event"),actions:this.model.get("actions")},{patch:this.model.id?!0:!1,success:function(){console.log("Success")}})},reset:function(){this.$el.find("textarea").val("")}});Cloudwalkers.Views.Settings.CannedList=Backbone.View.extend({events:{"click i[data-delete-canned-id]":"deletecanned"},initialize:function(){this.cannedresponses=Cloudwalkers.Session.getCannedResponses();this.listenTo(this.cannedresponses,"sync",this.render)},render:function(){this.$el.html(Mustache.render(Templates.settings.cannedlist,{canned:this.cannedresponses.models}));return this},deletecanned:function(a){var b=$(a.target).data("delete-canned-id"),b=this.cannedresponses.removecanned(b);b.length&&
(this.listenTo(b[0],"destroyed",function(){this.destroyli(a)}.bind(this)),b[0].deletecanned())},destroyli:function(a){$(a.target).closest("li").remove()}});Cloudwalkers.Views.Settings.StreamSettings=Backbone.View.extend({events:{"submit form":"submit"},streamid:null,render:function(){var a=this;this.streamid=this.options.streamid;a.$el.html("<p>Please wait, loading data.</p>");a.getStreamSettings(function(b){var c={};c.events=JSON.stringify(b.events);a.$el.html(Mustache.render(Templates.settings.streamsettings,c))});return this},getStreamSettings:function(a){Cloudwalkers.Net.get("stream/"+this.streamid+"/events",null,a)},setStreamSettings:function(a,
b){Cloudwalkers.Net.put("stream/"+this.streamid+"/events",null,a,b)},submit:function(a){var b=this;a.preventDefault();a=JSON.parse(this.$el.find('[name="events"]').val());this.setStreamSettings({events:a},function(a){"undefined"!=typeof a.error?Cloudwalkers.RootView.alert(a.error.message):b.trigger("popup:close")})}});
