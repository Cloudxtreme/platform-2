var Cloudwalkers={Views:{Settings:{},Widgets:{Charts:{}}},Router:{},Models:{},Collections:{},Utilities:{},init:function(){Cloudwalkers.Session.loadEssentialData(function(){Cloudwalkers.RootView=new Cloudwalkers.Views.Root;Cloudwalkers.Router.Instance=new Cloudwalkers.Router;Backbone.history.start()})}};Cloudwalkers.Session={user:null,isLoaded:function(){return null!=this.user},loadEssentialData:function(a){this.user=new Cloudwalkers.Models.Me;this.user.once("activated",a);this.user.fetch()},refresh:function(){console.log("Session.refresh triggered")},reset:function(){window.localStorage.clear()},home:function(){Cloudwalkers.Router.Instance.home()},updateSetting:function(a,b,c){Cloudwalkers.Session.user.attributes.settings[a]!=b&&(Cloudwalkers.Session.user.attributes.settings[a]=b,Cloudwalkers.Session.user.save({settings:Cloudwalkers.Session.user.attributes.settings},
c))},get:function(a){return Cloudwalkers.Session.user.attributes.settings[a]},manage:function(){400<Store.count("messages")&&Store.filter("messages",null,function(a){a.sort(function(a,c){return a.stamp>c.stamp?1:a.stamp<c.stamp?-1:0});a=a.slice(0,300);Store.write("messages",a);Store.filter("touches",null,function(a){var c=Cloudwalkers.Session.getPing().cursor;a=a.filter(function(a){return a.ping==c});Store.write("touches",a)})})},getPing:function(){return this.user.account.ping},ping:function(){this.user.account.ping.request()},
getAccount:function(a){return a?this.user.accounts.get(a):this.user.account},getAccounts:function(a){return this.user.accounts},getChannel:function(a){return"number"==typeof a?this.user.account.channels.get(a):this.user.account.channels.findWhere({type:a})},getChannels:function(a){return this.user.account.channels},storeChannel:function(a){a.channels&&a.channels.length&&(a.channels=a.channels.map(function(a){Cloudwalkers.Session.storeChannel(a);return a.id}));a.streams&&a.streams.length&&(a.streams=
a.streams.map(function(a){Store.post("streams",a);return a.id}));Store.post("channels",a)},getStream:function(a){return this.user.account.streams.get(a)},getStreams:function(){return this.user.account.streams},getUser:function(a){return a?this.user.account.users.get(a):this.user},getUsers:function(){return this.user.account.users},getContact:function(a){return this.user.account.contacts.get(a)},getContacts:function(){return this.user.account.contacts},getMessage:function(a){return this.user.account.messages.get(a)},
getMessages:function(){return this.user.account.messages},getNotification:function(a){return this.user.account.notifications.get(a)},getNotifications:function(){return this.user.account.notifications},getReport:function(a){return this.user.account.reports.get(a)},getReports:function(){return this.user.account.reports},getComment:function(a){return this.user.account.comments.get(a)},getComments:function(){return this.user.account.comments}};_.extend(Cloudwalkers.Session,Backbone.Events);Cloudwalkers.Router=Backbone.Router.extend({routes:{write:"write",share:"share","schedule(/:channel)(/:stream)":"schedule",drafts:"drafts","inbox(/:channel)(/:type)(/:streamid)":"inbox",coworkers:"coworkers","channel/:channel(/:subchannel)(/:stream)(/:messageid)":"channel","timeline/:channel(/:stream)":"timeline","trending/:channel(/:subchannel)(/:stream)(/:messageid)":"trending","monitoring/:channel(/:subchannel)(/:messageid)":"monitoring",keywords:"managekeywords","reports/:streamid":"reports",
reports:"stats","settings(/:sub)":"settings",firsttime:"firsttime","dashboard/:accountid":"changeaccount",home:"home","*path":"dashboard"},initialize:function(){},dashboard:function(){if(Cloudwalkers.Session.getAccount().get("firstTime"))return this.navigate("#firsttime",!0);Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Dashboard)},changeaccount:function(a){a!=Cloudwalkers.Session.get("currentAccount")&&Cloudwalkers.Session.updateSetting("currentAccount",a,{success:this.home})},write:function(){var a=
new Cloudwalkers.Views.Write;Cloudwalkers.RootView.setView(a)},share:function(){Cloudwalkers.RootView.viewshare("general")},schedule:function(a,b){var c={};"undefined"!=typeof b&&b&&(c.streams=[b]);var d=new Cloudwalkers.Collections.Scheduled([],{name:"Scheduled messages"});d.setFilters(c);c=new Cloudwalkers.Views.Widgets.WidgetContainer;d=new Cloudwalkers.Views.Widgets.ScheduledTable({channel:d,color:"blue"});c.addWidget(d);c.navclass="schedule";c.title="Schedule";b&&(c.subnavclass="schedule_"+b);
Cloudwalkers.RootView.setView(c)},drafts:function(){var a=new Cloudwalkers.Collections.Drafts([],{name:"Draft messages",filter:"mine"}),b=new Cloudwalkers.Views.Widgets.WidgetContainer,a=new Cloudwalkers.Views.Widgets.DraftList({channel:a,color:"blue"});b.addWidget(a);b.title="Drafts";b.navclass="drafts";Cloudwalkers.RootView.setView(b)},coworkers:function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Coworkers)},inbox:function(a,b,c){var d=Cloudwalkers.Session.getChannel(a?Number(a):"inbox");
if(!d)return this.home();b||(b="messages");a||Cloudwalkers.Router.Instance.navigate("#inbox/"+d.id+"/"+b);Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Inbox({channel:d,type:b,streamid:c}))},timeline:function(a,b){var c=b?Cloudwalkers.Session.getStream(Number(b)):Cloudwalkers.Session.getChannel(Number(a));Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Timeline({model:c,parameters:{records:40}}))},trending:function(a,b){var c=Cloudwalkers.Session.getChannel(Number(a)),d=b?Cloudwalkers.Session.getStream(Number(b)):
c,c="news"==c.get("type")?1:7,c={since:3600*Math.round(Date.now()/36E5)-86400*c,sort:"engagement",records:40};Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Timeline({model:d,trending:!0,parameters:c}))},monitoring:function(a,b,c){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.KeywordMonitoring({category:Cloudwalkers.Session.getChannel(Number(b))}))},managekeywords:function(){var a=new Cloudwalkers.Views.ManageKeywords;Cloudwalkers.RootView.setView(a)},reports:function(a){var b=new Cloudwalkers.Views.Reports({stream:Cloudwalkers.Session.getStream(a)});
a&&(b.subnavclass="reports_"+a);Cloudwalkers.RootView.setView(b)},stats:function(a){a=a?Cloudwalkers.Session.getStream(Number(a)):Cloudwalkers.Session.getAccount();Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Statistics({model:a}))},settings:function(a){a=new Cloudwalkers.Views.Settings({endpoint:a});Cloudwalkers.RootView.setView(a)},firsttime:function(){Cloudwalkers.RootView.setView(new Cloudwalkers.Views.Firsttime)},home:function(){Cloudwalkers.Session.reset();window.location="/";return!1},
exception:function(a){var b="/";switch(a){case 401:case 503:b="/503.html";default:window.location=b}}});Cloudwalkers.Session.Ping=Backbone.Model.extend({interval:3E4,min:1E4,max:9E4,timeout:0,cursor:!1,parameters:{},initialize:function(){Store.exists("ping",{id:this.id})||Store.post("ping",{id:this.id});this.setCursor(!1);this.fetch({success:this.schedule.bind(this),error:this.toing});this.on("change:paging",this.setCursor,this);this.on("change:updates",this.updateModels,this);this.on("change:add",this.addModels,this)},setCursor:function(a,b){a?(this.interval+=Math.round(0.2*(this.min-this.interval)),
this.cursor=b.cursors.after,Store.set("ping",{id:this.id,cursor:this.cursor})):Store.get("ping",{id:this.id},function(a){a&&(this.cursor=a.cursor)}.bind(this))},url:function(){this.cursor&&(this.parameters.after=this.cursor);return CONFIG_BASE_URL+"json/account/"+this.id+"/ping?"+$.param(this.parameters)},parse:function(a){return a.pong},updateModels:function(a,b){b.accounts&&Cloudwalkers.Session.getAccounts().updates(b.accounts);b.streams&&Cloudwalkers.Session.getStreams().updates(b.streams);b.messages&&
Cloudwalkers.Session.getMessages().updates(b.messages);b.notifications&&Cloudwalkers.Session.getNotifications().updates(b.notifications);b.users&&Cloudwalkers.Session.getUsers().updates(b.users);b.contacts&&Cloudwalkers.Session.getContacts().updates(b.contacts)},addModels:function(a,b){if(!b.length)return null;console.log("ping add callback: ",b)},request:function(){window.clearTimeout(this.timeout);this.fetch({success:this.schedule.bind(this),error:this.toing.bind(this)})},schedule:function(){this.timeout=
setTimeout(function(){this.fetch({success:this.schedule.bind(this),error:this.toing.bind(this)})}.bind(this),this.timer())},timer:function(){return this.interval+=Math.round(0.05*(this.max-this.interval))},toing:function(){Cloudwalkers.RootView.growl("Ping","There is no pong.");this.interval=this.max;this.schedule()}});var StorageClassLocal=function(a,b){this.get=function(a,b,e){if(a=JSON.parse(window.localStorage.getItem(a)))if(b){for(key in b)a=a.filter(function(a){return a[key]==b[key]});e(a.length?a.shift():null)}else e(a.shift());else e(null);return this};this.filter=function(a,b,e){if(a=JSON.parse(window.localStorage.getItem(a)))if(b){for(key in b)a=a.filter(function(a){return a[key]==b[key]});e(a.length?a:[])}else e(a);else e([]);return this};this.exists=function(a,b,e){if((a=JSON.parse(window.localStorage.getItem(a)))&&
b)for(key in b)a=a.filter(function(a){return a[key]==b[key]});a=a&&a.length;return e?(e(a),this):a};this.post=function(a,b,e){var f=JSON.parse(window.localStorage.getItem(a));f||(f=[]);f.push(b);window.localStorage.setItem(a,JSON.stringify(f));e&&e(b,f.length-1);return this};this.postCollection=function(a,b,e){var f=JSON.parse(window.localStorage.getItem(a));f||(f=[]);b.each(function(a){f.push(a.attributes)});window.localStorage.setItem(a,JSON.stringify(f));e&&e(content,f.length);return this};this.write=
function(a,b,e){window.localStorage.setItem(a,JSON.stringify(b));e&&e(b);return this};this.set=function(a,b,e){var f=!1,g=JSON.parse(window.localStorage.getItem(a));g||(g=[]);for(n in g)g[n].id==b.id&&($.extend(g[n],b),f=!0);f||g.push(b);window.localStorage.setItem(a,JSON.stringify(g));e&&e(b);return this};this.update=function(a,b,e,f){var g=JSON.parse(window.localStorage.getItem(a)),h=g;if(b&&h){for(key in b)h=h.filter(function(a,c){return a[key]==b[key]});for(n in h)for(i in g)g[i].id==h[i].id&&
(g[i]=$.extend(h[n],e));window.localStorage.setItem(a,JSON.stringify(g));f&&(h.length?f(h):f(null,e))}else f(null,e);return this};this.updateById=function(a,b,e){var f=JSON.parse(window.localStorage.getItem(a)),g=!1;if(f&&b.id){for(n in f)f[n].id==b.id&&(f[n]=g=$.extend(f[n],b));window.localStorage.setItem(a,JSON.stringify(f));e&&(g?e(g):e(null,b))}else e(null,b);return this};this.remove=function(a,b,e,f){e=JSON.parse(window.localStorage.getItem(a));if(!b)return window.localStorage.removeItem(a),
e;var g=[];for(key in b)for(n in e)e[n][key]==b[key]&&g.push(e.splice(n,1));window.localStorage.setItem(a,JSON.stringify(e));f&&f(g);return this};this.count=function(a){return(a=JSON.parse(window.localStorage.getItem(a)))?a.length:0};this.calc=function(){var a=0,b;for(b in localStorage){var e=2*localStorage[b].length/1024/1024,a=a+e;console.log(b,e.toFixed(4)+" MB")}console.log("Total localStorage",a.toFixed(2)+" MB");return a.toFixed(2)}};var StorageClassIDB=function(a,b){var c,d=indexedDB.open(a,b),e=function(a){console.log("IndexedDB error.",a)};d.onerror=function(a){console.log("IndexedDB locked.");Store=new StorageClassLocal};d.onsuccess=function(a){c=d.result;c.onerror=e};d.onupgradeneeded=IDBstores;this.get=function(a,b,c){if(a=JSON.parse(window.localStorage.getItem(a)))if(b){for(key in b)a=a.filter(function(a){return a[key]==b[key]});c(a.length?a.shift():null)}else c(a.shift());else c(null);return this};this.filter=function(a,
b,c){if(a=JSON.parse(window.localStorage.getItem(a)))if(b){for(key in b)a=a.filter(function(a){return a[key]==b[key]});c(a.length?a:[])}else c(a);else c([]);return this};this.exists=function(a,b,c){if((a=JSON.parse(window.localStorage.getItem(a)))&&b)for(key in b)a=a.filter(function(a){return a[key]==b[key]});a=a&&a.length;return c?(c(a),this):a};this.post=function(a,b,c){var d=JSON.parse(window.localStorage.getItem(a));d||(d=[]);d.push(b);window.localStorage.setItem(a,JSON.stringify(d));c&&c(b,d.length-
1);return this};this.postCollection=function(a,b,c){var d=JSON.parse(window.localStorage.getItem(a));d||(d=[]);b.each(function(a){d.push(a.attributes)});window.localStorage.setItem(a,JSON.stringify(d));c&&c(content,d.length);return this};this.write=function(a,b,c){window.localStorage.setItem(a,JSON.stringify(b));c&&c(b);return this};this.set=function(a,b,c){var d=!1,e=JSON.parse(window.localStorage.getItem(a));e||(e=[]);for(n in e)e[n].id==b.id&&($.extend(e[n],b),d=!0);d||e.push(b);window.localStorage.setItem(a,
JSON.stringify(e));c&&c(b);return this};this.update=function(a,b,c,d){var e=JSON.parse(window.localStorage.getItem(a)),l=e;if(b&&l){for(key in b)l=l.filter(function(a,c){return a[key]==b[key]});for(n in l)for(i in e)e[i].id==l[i].id&&(e[i]=$.extend(l[n],c));window.localStorage.setItem(a,JSON.stringify(e));d&&(l.length?d(l):d(null,c))}else d(null,c);return this};this.updateById=function(a,b,c){var d=JSON.parse(window.localStorage.getItem(a)),e=!1;if(d&&b.id){for(n in d)d[n].id==b.id&&(d[n]=e=$.extend(d[n],
b));window.localStorage.setItem(a,JSON.stringify(d));c&&(e?c(e):c(null,b))}else c(null,b);return this};this.remove=function(a,b,c,d){c=JSON.parse(window.localStorage.getItem(a));if(!b)return window.localStorage.removeItem(a),c;var e=[];for(key in b)for(n in c)c[n][key]==b[key]&&e.push(c.splice(n,1));window.localStorage.setItem(a,JSON.stringify(c));d&&d(e);return this};this.count=function(a){return(a=JSON.parse(window.localStorage.getItem(a)))?a.length:0};this.calc=function(){var a=0,b;for(b in localStorage){var c=
2*localStorage[b].length/1024/1024,a=a+c;console.log(b,c.toFixed(4)+" MB")}console.log("Total localStorage",a.toFixed(2)+" MB");return a.toFixed(2)}};var IDBstores=function(a){console.log("Upgrading IDB.");a=a.target.result;var b;a.createObjectStore("me",{keyPath:"id"});a.createObjectStore("accounts",{keyPath:"id"});b=a.createObjectStore("channels",{keyPath:"id"});b.createIndex("type","type",{unique:!1});b=a.createObjectStore("streams",{keyPath:"id"});b.createIndex("type","token",{unique:!1});b=a.createObjectStore("messages",{keyPath:"id"});b.createIndex("stream","stream",{unique:!1});b=a.createObjectStore("notifications",{keyPath:"id"});b.createIndex("stream",
"stream",{unique:!1});b=a.createObjectStore("users",{keyPath:"id"});b.createIndex("name","displayname",{unique:!1});b=a.createObjectStore("contacts",{keyPath:"id"});b.createIndex("name","displayname",{unique:!1});a.createObjectStore("campaigns",{keyPath:"id"});a.createObjectStore("ping",{keyPath:"id"});a.createObjectStore("touches",{keyPath:"id"})};Cloudwalkers.Utils={months:"Jan Feb Mar Apr May Jun Jul Aug Sept Oct Nov Dec".split(" "),longdate:function(a){return a.getDate()+" "+this.month(a.getMonth()+1)+" "+a.getFullYear()+" "+this.zeroIt(a.getHours(),2)+":"+this.zeroIt(a.getMinutes(),2)},shortdate:function(a){return a.getDate()+" "+this.month(a.getMonth()+1)+" "+a.getFullYear()},time:function(a){return this.zeroIt(a.getHours(),2)+":"+this.zeroIt(a.getMinutes(),2)},zeroIt:function(a,b){for(a=String(a);a.length<b;)a="0"+a;return a},month:function(a){return"undefined"!=
typeof this.months[a-1]?this.months[a-1]:"Month out of range"}};Cloudwalkers.Net={get:function(a,b,c){a=CONFIG_BASE_URL+"json/"+a+(b?"?"+jQuery.param(b):"");$.ajax({type:"get",url:a,cache:!1,success:function(a){c(a)}})},put:function(a,b,c,d){a=CONFIG_BASE_URL+"json/"+a;"undefined"!=typeof b&&b&&(a+="?"+jQuery.param(b));jQuery.ajax({data:JSON.stringify(c),dataType:"json",type:"put",url:a,processData:!1,cache:!1,success:function(a){d(a)}})},post:function(a,b,c,d){a=CONFIG_BASE_URL+"json/"+a;"undefined"!=typeof b&&b&&(a+="?"+jQuery.param(b));jQuery.ajax({data:JSON.stringify(c),
dataType:"json",type:"post",url:a,processData:!1,cache:!1,success:function(a){d(a)}})},remove:function(a,b,c){a=CONFIG_BASE_URL+"json/"+a;"undefined"!=typeof b&&b&&(a+="?"+jQuery.param(b));jQuery.ajax({dataType:"json",type:"delete",url:a,cache:!1,success:function(a){c(a)}})}};Cloudwalkers.Utilities.StreamLibrary={streams:[],reset:function(){this.streams=[]},parse:function(a){for(var b=0;b<a.length;b++)this.touch(a[b]),"undefined"!=typeof a[b].streams&&this.parse(a[b].streams)},parseFromChannel:function(a){for(var b=0;b<a.length;b++)this.touch(a[b])&&(console.log("Stream NOT preloaded!"),console.log(a[b]))},touch:function(a){return null==this.getFromId(a.id)?(this.streams.push(new Cloudwalkers.Models.Stream(a)),!0):!1},getFromId:function(a){for(var b=0;b<this.streams.length;b++)if(this.streams[b].get("id")==
a)return this.streams[b];return null},getStreams:function(){return this.streams}};Cloudwalkers.Utilities.Parser={parseFromMessage:function(a,b){a=a.replace("{{from.name}}",b.get("from")?b.get("from")[0].name:null);return a=a.replace("{{body.plaintext}}",b.get("body")?b.get("body").plaintext:null)}};Cloudwalkers.Models.Account=Backbone.Model.extend({endpoint:"",limits:{users:50,networks:15,keywords:10},initialize:function(){this.channels=new Cloudwalkers.Collections.Channels;this.streams=new Cloudwalkers.Collections.Streams;this.campaigns=new Cloudwalkers.Collections.Campaigns;this.users=new Cloudwalkers.Collections.Users;this.contacts=new Cloudwalkers.Collections.Contacts;this.messages=new Cloudwalkers.Collections.Messages;this.notifications=new Cloudwalkers.Collections.Notifications;this.reports=
new Cloudwalkers.Collections.Reports;this.comments=new Cloudwalkers.Collections.Comments},parse:function(a){this.endpoint="";Store.set("accounts",a.account);return a.account},url:function(){return CONFIG_BASE_URL+"json/account/"+this.id+this.endpoint},sync:function(a,b,c){this.endpoint=c.endpoint?"/"+c.endpoint:"";return Backbone.sync(a,b,c)},firstload:function(){$.each(this.get("channels"),function(a,b){Cloudwalkers.Session.storeChannel(b)})},activate:function(){Store.exists("channels")||this.firstload();
Store.filter("streams",null,function(a){this.streams.add(a)}.bind(this));Store.filter("channels",null,function(a){this.channels.add(a)}.bind(this));Store.filter("campaigns",null,function(a){this.campaigns.add(a)}.bind(this));Store.filter("messages",null,function(a){this.messages.add(a)}.bind(this));this.get("plan")&&(this.limits=this.get("plan").limits);this.ping=new Cloudwalkers.Session.Ping({id:this.id})},monitorlimit:function(a,b,c){return b>=this.limits[a]?($(".alert-info").remove(),Cloudwalkers.RootView.information("Upgrade?",
"You're fresh out of "+a.slice(0,-1)+" slots, maybe you should upgrade."),c&&("string"==typeof c&&(c=$(c)),c.addClass("limited").attr("disabled",!0)),!0):!1}});Cloudwalkers.Models.Service=Backbone.Model.extend({initialize:function(){}});Cloudwalkers.Models.Channel=Backbone.Model.extend({endpoint:"",parameters:"",initialize:function(a){this.channels=new Cloudwalkers.Collections.Channels;this.channels.seed(this.get("channels"));this.streams=new Cloudwalkers.Collections.Streams;this.streams.seed(this.get("streams"));this.messages=new Cloudwalkers.Collections.Messages;this.notifications=new Cloudwalkers.Collections.Notifications;this.contacts=new Cloudwalkers.Collections.Contacts;this.on("change",function(a){Store.set("channels",a.attributes)});
this.listenTo(this.messages,"change:from",this.seedcontacts);this.listenTo(this.notifications,"change:from",this.seedcontacts)},url:function(){return CONFIG_BASE_URL+"json/channel/"+(this.id?this.id:"")+this.endpoint+this.parameters},parse:function(a){if(a.error)return[];Store.set("channels",a.channel);return a.channel},sync:function(a,b,c){"read"==a?(this.endpoint=c.endpoint?"/"+c.endpoint:"",this.parameters=c.parameters?"?"+$.param(c.parameters):""):"create"==a?this.endpoint=c.parent?c.parent+"/channels":
"":"delete"==a&&(this.endpoint="");return Backbone.sync(a,b,c)},getStream:function(a){var b={};b["string"==typeof a?"token":"id"]=a;return this.streams.findWhere(b)},seedcontacts:function(a){(a=a.get("from"))&&a.length&&this.contacts.add(a)}});Cloudwalkers.Models.Campaign=Backbone.Model.extend({initialize:function(){}});Cloudwalkers.Models.User=Backbone.Model.extend({initialize:function(){},url:function(){return CONFIG_BASE_URL+"json/user/"+this.id},sync:function(a,b,c){"read"==a&&Store.get(this.url(),null,function(a){a&&this.set(a)}.bind(this));return Backbone.sync(a,b,c)},filterData:function(a){var b=this.attributes;"listitem"==a?b.arrow=!0:b.role=this.getRole();return b},getRole:function(){return 10==this.get("level")?"Administrator":"Co-worker"},saveProfile:function(a){var b={firstname:this.get("firstname"),
name:this.get("name"),avatar:this.get("avatarBase64")};Cloudwalkers.Net.put("user/me",{},b,a)}});Cloudwalkers.Models.Contact=Cloudwalkers.Models.User.extend({initialize:function(){}});Cloudwalkers.Models.Me=Cloudwalkers.Models.User.extend({unreadMessages:null,initialize:function(a){this.once("change",this.activate);this.on("change:id",function(a){this.previous("id")&&Cloudwalkers.Session.home()})},url:function(){var a=Store.exists("me")?"?include_accounts=ids":"";return CONFIG_BASE_URL+"json/user/me"+a},parse:function(a){Store.exists("me")||(a.user=this.firstload(a.user));Store.write("me",[a.user]);Store.set("users",a.user);return a.user},sync:function(a,b,c){"read"==a&&Store.get("me",
null,function(a){a&&this.set(a)}.bind(this));return Backbone.sync(a,b,c)},firstload:function(a){$.each(a.accounts,function(a,c){Store.set("accounts",c)}.bind(this));a.settings.currentAccount||(a.settings={currentAccount:a.accounts[0].id});return a},activate:function(a){if(!this.get("accounts").length)return Cloudwalkers.RootView.exception(401);Store.filter("accounts",null,function(a){this.accounts=new Cloudwalkers.Collections.Accounts(a);this.account=this.getCurrentAccount();this.account.activate();
this.level=Number(this.account.get("currentuser").level);this.trigger("activated")}.bind(this))},getCurrentAccount:function(){var a=Cloudwalkers.Session.get("currentAccount");a||(a=this.accounts.at(0).id,this.save({settings:{currentAccount:a}}));return(a=this.accounts.get(Number(a)))&&a.id?a:Cloudwalkers.Session.home()},savePassword:function(a,b,c){Cloudwalkers.Net.put("user/me/password",{},{oldpassword:a,newpassword:b},c)}});Cloudwalkers.Models.Stream=Backbone.Model.extend({parameters:{},initialize:function(a){this.messages=new Cloudwalkers.Collections.Messages;this.contacts=new Cloudwalkers.Collections.Contacts;this.get("statistics")&&(this.reports=new Cloudwalkers.Collections.Reports,this.reports.streamid=this.id);this.on("outdated",this.fetch)},url:function(){return CONFIG_BASE_URL+"json/streams/"+(this.id?this.id:"")+this.endpoint+this.parameters},parse:function(a){a.stream&&(a=a.stream);Store.set("streams",a);return a},
sync:function(a,b,c){"read"==a?(this.endpoint=c.endpoint?"/"+c.endpoint:"",this.parameters=c.parameters?"?"+$.param(c.parameters):""):"create"==a&&(this.endpoint=c.parent?c.parent+"/streams":"");return Backbone.sync(a,b,c)},seedusers:function(a){(a=a.get("from"))&&a.length&&this.users.add(a)}});Cloudwalkers.Models.Message=Backbone.Model.extend({url:function(a){return this.endpoint?CONFIG_BASE_URL+"json/message/"+this.id+this.endpoint:CONFIG_BASE_URL+"json/message/"+this.id},initialize:function(){this.on("change",this.afterChange);"undefined"!=typeof this.attributes.parent?(this.set("parentmodel",new Cloudwalkers.Models.Message(this.attributes.parent)),this.get("parentmodel").trigger("change")):this.trigger("change")},parse:function(a){if("number"==typeof a)return{id:a};a.message&&(a=a.message);
this.stamp(a);return a},sync:function(a,b,c){this.endpoint=c.endpoint?"/"+c.endpoint:!1;return Backbone.sync(a,b,c)},stamp:function(a){a||(a={id:this.id});a.stamp=Math.round(0.0010*(new Date).getTime());Store.set("messages",a);return this},filterData:function(a){if(!this.get("date"))return this.attributes;var b=this.attributes,c=Cloudwalkers.Session.getStream(b.stream);b.attachments?(b.media=b.attachments[b.attachments.length-1],b.media.icon="image"==b.media.type?"picture":b.media.type):b.media={icon:"reorder"};
c?(b.icon=c.get("network").icon,b.networktoken=c.get("network").token,b.url=this.link?this.link:"#"+a+"/"+c.get("channels")[0]):b.url=this.link;if("trending"==a)b.trending=1E3>this.get("engagement")?this.get("engagement"):"+999",b.date=null,b.iconview=!0;else if("inbox"==a)b.url=null,b.media={icon:b.icon},b.body.plaintext=b.body.plaintext?b.body.plaintext.substr(0,72):"...";else if("full"==a||"fulltrending"==a)b.url=null,b.share=this.filterShareData(c),b.iconview=!0,b.date&&(b.dateonly=moment(b.date).format("DD MMM YYYY"),
b.time=moment(b.date).format("HH:mm")),b.attachments&&(b.attached={},$.each(b.attachments,function(a,c){b.attached[c.type]=c})),"fulltrending"==a&&(b.time=this.get("engagement"));return b},filterShareData:function(a){var b=[];a.get("network");"facebook"==a.get("network").token&&(b.push({action:"like",icon:"thumbs-up",name:"Like"}),b.push({action:"comment",icon:"comment-alt",name:"Comment"}));a.get("outgoing")&&(b.push({action:"delete",icon:"remove",name:"Delete"}),b.push({action:"reply",icon:"comment",
name:"Reply"}));b.push({action:"internal-share",icon:"share-alt",name:"Share"});return b},location:function(){return"#"},afterChange:function(){this.addInternalActions();this.get("parent")&&this.get("parentmodel").set(this.get("parent"))},getActionIcon:function(a){return"internal-share"==a.token?"share-alt":"internal-edit"==a.token?"edit":"internal-delete"==a.token||"delete"==a.token?"remove":"like"==a.token?"thumbs-up":"unlike"==a.token?"thumbs-down":"comment"==a.token?"comment-alt":"reply"==a.token?
"comment":"retweet"==a.token?"retweet":"dm"==a.token?"envelope":"internal-reply"==a.token?"comment":"favorite"==a.token?"star":"unfavorite"==a.token?"star-empty":a.token},addInternalActions:function(){var a=this;if("undefined"!=typeof this.attributes.actions)for(var b=0;b<this.attributes.actions.length;b++){if("internal-"==this.attributes.actions[b].token.substr(0,9))return}else this.attributes.actions=[];"INCOMING"==this.attributes.type?this.attributes.actions.push({name:"Share",parameters:[],token:"internal-share",
callback:function(a){Cloudwalkers.RootView.shareMessage(a)}}):"OUTGOING"==this.attributes.type&&(this.attributes.actions.push({name:"Edit",parameters:[],token:"internal-edit",callback:function(b){Cloudwalkers.RootView.editMessage(a)}}),this.attributes.actions.push({name:"Delete",parameters:[],token:"internal-delete",callback:function(b){a.deleteMessage()}}));var c=this.get("parentmodel");if("undefined"!=typeof c&&c){var d=c.get("actions");if(d)for(b=0;b<d.length;b++)"comment"==d[b].token&&this.attributes.actions.push({name:"Reply",
token:"internal-reply",target:c,originalaction:d[b]})}if("undefined"!=typeof this.attributes.actions)for(b=0;b<this.attributes.actions.length;b++)this.attributes.actions[b].icon=this.getActionIcon(this.attributes.actions[b])},deleteMessage:function(){var a=this;this.repeat().repeat?Cloudwalkers.RootView.dialog("Are you sure you want to remove this message?",[{label:"Skip once",description:"Message will be skipped once",token:"skip"},{label:"Delete forever",description:"Message will never be repeated",
token:"remove"}],function(b){b="post/?"+b.token+"="+a.get("id");jQuery.ajax({dataType:"json",type:"get",url:b,success:function(b){a.trigger("destroy",a,a.collection)}})}):Cloudwalkers.RootView.confirm("Are you sure you want to remove this message?",function(){a.destroy()})},humandate:function(a){a=new Date(a?a:this.get("date"));return Cloudwalkers.Utils.longdate(a)},shortdate:function(){var a=this.date();return Cloudwalkers.Utils.shortdate(a)},time:function(){var a=this.date();return Cloudwalkers.Utils.time(a)},
date:function(){return new Date(this.get("date"))},getAction:function(a){for(var b=this.get("actions"),c=0;c<b.length;c++)if(b[c].token==a)return b[c];return null},act:function(a,b,c){Cloudwalkers.RootView.growl(a.name,"The "+a.token+" is planned with success.");var d=this;"undefined"==typeof b&&(b={});a={actions:[{token:a.token,parameters:b}]};b=CONFIG_BASE_URL+"json/message/"+this.get("id")+"?account="+Cloudwalkers.Session.getAccount().get("id");jQuery.ajax({data:JSON.stringify(a),dataType:"json",
type:"put",url:b,processData:!1,cache:!1,success:function(a){a.removed?d.trigger("destroy",d,d.collection):d.set(a.message);c()}})},scheduledate:function(a){"undefined"==typeof a&&(a=!0);var b=this.get("schedule");return b?a?"ASAP"==b.date?b.date:this.humandate(b.date):"ASAP"==b.date?!1:new Date(b.date):!1},calculateIntervalFromSeconds:function(a){for(var b={},c=[{unit:"minutes",value:60},{unit:"hours",value:3600},{unit:"days",value:86400},{unit:"weeks",value:604800},{unit:"months",value:2678400}],
d=c.length-1;0<=d;d--)if(0==a%c[d].value)return b.interval=Math.round(a/c[d].value),b.unit=c[d].unit,b;for(d=0;d<c.length;d++)if(72>a/c[d].value)return b.interval=Math.round(a/c[d].value),b.unit=c[d].unit,b;return!1},repeat:function(){var a=this.get("schedule"),b={repeat:!1,weekdays:{}};if("undefined"!=typeof a&&"undefined"!=typeof a.repeat){b.repeat=!0;var c=this.calculateIntervalFromSeconds(a.repeat.interval);c&&(b.interval=c.interval,b.unit=c.unit);b.end=null;a.repeat.end&&(b.end=new Date(a.repeat.end));
if(a.repeat.weekdays)for(c=0;c<a.repeat.weekdays.length;c++)b.weekdays[a.repeat.weekdays[c]]=!0}return b},getStream:function(){return this.get("stream")?Cloudwalkers.Session.getAccount().streams.get(this.get("stream")):null},getProcessedAttachments:function(){var a=[],b;if("undefined"!=typeof this.attributes.attachments)for(var c=0;c<this.attributes.attachments.length;c++)b=this.attributes.attachments[c],"link"==b.type?null!=this.attributes.body.plaintext&&-1!==this.attributes.body.plaintext.indexOf(b.url)||
a.push(b):a.push(b);return a},setRead:function(){if(!this.get("read")){var a=CONFIG_BASE_URL+"json/message/"+this.get("id")+"/read/";jQuery.ajax({type:"get",url:a,success:function(a){}})}},shortBody:function(){var a=this.get("body");return a.plaintext?{html:a.plaintext.substring(0,100),plaintext:a.plaintext.substring(0,100)}:{html:"",plaintext:""}}});Cloudwalkers.Models.Comment=Cloudwalkers.Models.Message.extend({});Cloudwalkers.Models.Report=Backbone.Model.extend({initialize:function(a){this.entity="undefined"!=typeof a.entity?a.entity:"report";this.type="undefined"!=typeof a.type?a.type:"time";this.isFetched=!1;this.evolution=this.intervalinput=this.interval=this.display=this.daterange=null},getDetails:function(){return this[this.attributes.type+"Details"](this.attributes.series[0])},textDetails:function(a){var b=Cloudwalkers.Session.getStream(this.get("streamid"));return{content:a.values[0].value,title:a.name,
description:b.get("customname")}},comparisonDetails:function(a){var b=a.values[0].value-a.values[1].value;0<b&&(b="+ "+b);var c=a.values[1].value?" ("+(Math.round(100*(a.values[0].value/a.values[1].value))-100)+"%)":"";return{content:a.values[0].value,title:"<strong>"+b+"</strong>"+c+" in last "+a.interval,description:a.name}},refresh:function(){var a=this;$.ajax(this.getDataURL(),{success:function(b){if("undefined"!=typeof b[a.entity]){a.setInternalParameters(b[a.entity].series[0]);for(var c=[],
d=0;d<b[a.entity].series.length;d++)c.push({values:a.processValues(b[a.entity].series[d].values)});a.trigger("dataset:change",c)}else console.log("Information not expected:"),console.log(b)}})},getDataset:function(){console.log("DEPRECATION ALERT")},getDataURL:function(){var a="json/"+this.get("url")+"?";this.daterange&&(a+="start="+Math.floor(this.daterange[0].getTime()/1E3)+"&end="+Math.floor(this.daterange[1].getTime()/1E3)+"&");this.intervalinput&&(a+="interval="+this.intervalinput);return a},
getDatasetType:function(){return"bars"==this.get("type")?"category":"table"==this.get("type")?"table":"time"==this.get("type")?"time":"text"==this.get("type")?"text":"category"},getWidget:function(){var a=this.get("type");if("bars"==a)var b=new Cloudwalkers.Views.Widgets.Charts.Barchart({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this});else"pie"==a?b=new Cloudwalkers.Views.Widgets.Charts.Piechart({model:this,title:(this.stream?this.stream.name:
"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"table"==a?b=new Cloudwalkers.Views.Widgets.Charts.Table({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"time"==a?b=new Cloudwalkers.Views.Widgets.Charts.Intervalchart({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"comparison"==a?b=new Cloudwalkers.Views.Widgets.Charts.Comparison({model:this,title:(this.stream?
this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"number"==a?b=new Cloudwalkers.Views.Widgets.Charts.Numberstat({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):"text"==a?b=new Cloudwalkers.Views.Widgets.Charts.Textstat({model:this,title:(this.stream?this.stream.name:"")+" "+this.get("name"),stream:this.get("stream"),report:this}):alert("Report type not found: "+a);return b},setDateRange:function(a,b){this.daterange=
[a,b];this.refresh()},setInterval:function(a){this.intervalinput=a},getDisplay:function(){return this.display},getInterval:function(){return this.interval},getEvolution:function(){return this.evolution},getValues:function(a){this.getSeries(function(b){0<b.length?a(b[0].values):a(null)})},getSeries:function(a){var b=this;this.isFetched=!0;$.ajax(this.getDataURL(),{success:function(c){if("undefined"==typeof c[b.entity])a(!1);else{for(var d=[],e=0;e<c[b.entity].series.length;e++)d.push({values:b.processValues(c[b.entity].series[e].values)});
b.setInternalParameters(c[b.entity].series[0]);a(d)}}})},setInternalParameters:function(a){"undefined"!=typeof a.display&&(this.display=a.display);"undefined"!=typeof a.evolution&&(this.evolution=a.evolution);"undefined"!=typeof a.interval&&(this.interval=a.interval)},processValues:function(a){var b=[],c;if(!a)return[];if("table"==this.type)return a;for(var d=0;d<a.length;d++)c="time"==this.type?(new Date(a[d].date)).getTime():"category"==this.type||"text"==this.type||"pie"==this.type?a[d].category:
d,b.push([c,"text"!=this.type?parseInt(a[d].value):a[d].value]);return b}});Cloudwalkers.Collections.Accounts=Backbone.Collection.extend({model:Cloudwalkers.Models.Account,fetch:function(a,b,c){return Cloudwalkers.Session.user.get("accounts")},updates:function(a){for(n in a){var b=this.get(a[n]);b&&(Store.set(this.typestring,{id:a[n],outdated:!0}),b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])}});Cloudwalkers.Collections.Services=Backbone.Collection.extend({model:Cloudwalkers.Models.Service,url:function(){return CONFIG_BASE_URL+"json/account/"+Cloudwalkers.Session.getAccount().id+"/service"}});Cloudwalkers.Collections.Campaigns=Backbone.Collection.extend({model:Cloudwalkers.Models.Campaign,initialize:function(){this.on("destroy",this.store.bind(this,"delete"))},url:function(){return CONFIG_BASE_URL+"json/account/"+Cloudwalkers.Session.getAccount().id+"/campaigns"},parse:function(a){return a.campaigns},store:function(a,b){"delete"==a&&Store.remove("campaigns",{id:b.id})}});Cloudwalkers.Collections.Users=Backbone.Collection.extend({model:Cloudwalkers.Models.User,typestring:"users",modelstring:"user",processing:!1,initialize:function(a,b){Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getUsers().listenTo(this,"add",Cloudwalkers.Session.getUsers().distantAdd)},url:function(){return CONFIG_BASE_URL+"json/account/"+Cloudwalkers.Session.getAccount().id+"/"+this.typestring+this.parameters},parse:function(a){this.parameters="";this.processing=!1;a[this.typestring]||
a.account[this.typestring];return a[this.typestring]},distantAdd:function(a){this.get(a.id)||this.add(a)},sync:function(a,b,c){"read"==a&&Store.get(this.url(),null,function(a){a&&this.add(a)}.bind(this));return Backbone.sync(a,b,c)},updates:function(a){for(n in a){var b=this.get(a[n]);b&&(Store.set(this.typestring,{id:a[n],outdated:!0}),b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])},hook:function(a){a.records&&
(this.parameters.records=a.records);this.processing?this.length&&a.success(this):this.fetch({error:a.error});this.on("sync",a.success)}});Cloudwalkers.Collections.Contacts=Cloudwalkers.Collections.Users.extend({model:Cloudwalkers.Models.Contact,typestring:"contacts",modelstring:"contact",comparator:"displayname",processing:!1,initialize:function(a,b){Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getContacts().listenTo(this,"add",Cloudwalkers.Session.getContacts().distantAdd)},sync:function(a,b,c){"read"==a&&(this.processing=!0,this.parameters=c.parameters?"?"+$.param(c.parameters):"");return Backbone.sync(a,b,c)},updates:function(a){for(n in a){var b=
this.get(a[n]);b&&b.get("objectType")&&(Store.set(this.typestring,{id:a[n],outdated:!0}),b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])}});Cloudwalkers.Collections.Channels=Backbone.Collection.extend({model:Cloudwalkers.Models.Channel,initialize:function(){Cloudwalkers.Session.user.account&&(Cloudwalkers.Session.getChannels().listenTo(this,"add",Cloudwalkers.Session.getChannels().distantAdd),this.on("destroy",this.cleanModel))},url:function(){var a=this.parameters?"?"+$.param(this.parameters):"";return CONFIG_BASE_URL+"json/account/"+Cloudwalkers.Session.getAccount().id+"/channels"+a},parse:function(a){this.parameters=!1;return a.channels},
distantAdd:function(a){this.get(a.id)||this.add(a)},seed:function(a){if(!a||!a.length)return[];var b=[];a=_.compact(a.map(function(a){channel=Cloudwalkers.Session.getChannel(a);this.add(channel?channel:{id:a});b.push(channel?channel:this.get(a));if(!channel||channel.outdated)return a},this));a.length&&(this.parameters={ids:a.join(",")},this.fetch());return b},cleanModel:function(a){a.get("parent")&&Cloudwalkers.Session.getChannel(a.get("parent")).set({channels:this.pluck("id")});Store.remove("channels",
{id:a.id})},updates:function(a){for(n in a){var b=this.get(a[n]);b&&b.get("objectType")&&(Store.set(this.typestring,{id:a[n],outdated:!0}),b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])}});Cloudwalkers.Collections.Streams=Backbone.Collection.extend({model:Cloudwalkers.Models.Stream,initialize:function(){Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getStreams().listenTo(this,"add",Cloudwalkers.Session.getStreams().distantAdd)},url:function(){var a=this.parameters?"?"+$.param(this.parameters):"";return CONFIG_BASE_URL+"json/account/"+Cloudwalkers.Session.getAccount().id+"/streams"+a},parse:function(a){this.parameters=!1;return a.streams},sync:function(a,b,c){return Backbone.sync(a,
b,c)},distantAdd:function(a){this.get(a.id)||this.add(a)},updates:function(a){for(n in a){var b=this.get(a[n]);b&&b.get("objectType")&&(Store.set(this.typestring,{id:b.id,outdated:!0}),b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])},seed:function(a){if(!a||!a.length)return[];var b=[];a=_.compact(a.map(function(a){stream=Cloudwalkers.Session.getStream(a);this.add(stream?stream:{id:a});b.push(stream?stream:this.get(a));
if(!stream||stream.outdated)return a},this));a.length&&(this.parameters={ids:a.join(",")},this.fetch());return b},filterNetworks:function(a,b){a||(a=this.models);var c={};$.each(a,function(a,b){var d=b.attributes?b.get("network"):b.network;c[d.token]||(c[d.token]={ids:[],icon:d.icon});c[d.token].ids.push(b.id)});if(!b)return c;var d=[];$.each(c,function(a,b){b.ids=b.ids.join(" ");d.push(b)});return d},filterReportStreams:function(){return{}}});Cloudwalkers.Collections.Messages=Backbone.Collection.extend({model:Cloudwalkers.Models.Message,typestring:"messages",modelstring:"message",processing:!1,parameters:{},paging:{},cursor:!1,initialize:function(a){a&&$.extend(this,a);Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getMessages().listenTo(this,"add",Cloudwalkers.Session.getMessages().distantAdd)},distantAdd:function(a){this.get(a.id)||this.add(a)},url:function(a){this.parentmodel&&!this.parenttype&&(this.parenttype=this.parentmodel.get("objectType"));
a=this.parentmodel?CONFIG_BASE_URL+"json/"+this.parenttype+"/"+this.parentmodel.id:CONFIG_BASE_URL+"json/"+this.typestring;this.endpoint&&(a+="/"+this.endpoint);return this.parameters?a+"?"+$.param(this.parameters):a},parse:function(a){this.parentmodel&&(a=a[this.parenttype]);this.setcursor(a.paging);return a[this.typestring]},sync:function(a,b,c){this.processing=!0;return Backbone.sync(a,b,c)},updates:function(a){for(n in a){var b=this.get(a[n]);b&&b.get("objectType")&&(Store.set(this.typestring,
{id:a[n],outdated:!0}),b.outdated=!0,b.trigger("outdated"))}},outdated:function(a){if(!a)return this.filter(function(a){return a.outdated});this.updates([a])},setcursor:function(a){if(!a)return!1;this.cursor=a.cursors?a.cursors.after:!1},touch:function(a,b){this.parentmodel=a;this.endpoint=this.modelstring+"ids";this.parameters=b;Store.get("touches",{id:this.url(),ping:Cloudwalkers.Session.getPing().cursor},this.touchlocal.bind(this))},touchlocal:function(a){a&&a.modelids.length?(this.seed(a.modelids),
this.cursor=a.cursor):this.fetch({success:this.touchresponse.bind(this,this.url())})},touchresponse:function(a,b,c){b=c[this.parenttype][this.typestring];Store.set("touches",{id:a,modelids:b,cursor:this.cursor,ping:Cloudwalkers.Session.getPing().cursor});this.seed(b)},seed:function(a){a||(a=[]);var b=[];a=_.compact(a.map(function(a){model=Cloudwalkers.Session.getMessage(a);this.add(model?model:{id:a});model||(model=this.get(a));b.push(model.stamp());if(!model||!model.get("objectType")||model.outdated)return a},
this));a.length&&(this.endpoint=this.parentmodel?this.typestring:null,this.parameters={ids:a.join(",")},this.fetch());this.trigger("seed",b);return b},more:function(a,b){if(!this.cursor)return!1;b.after=this.cursor;this.touch(a,b);return this}});Cloudwalkers.Collections.Notifications=Cloudwalkers.Collections.Messages.extend({model:Cloudwalkers.Models.Comment,typestring:"notifications",modelstring:"notification",initialize:function(){Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getNotifications().listenTo(this,"add",Cloudwalkers.Session.getNotifications().distantAdd)}});Cloudwalkers.Collections.Comments=Cloudwalkers.Collections.Messages.extend({model:Cloudwalkers.Models.Comment,parameters:{records:20},initialize:function(){Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getComments().listenTo(this,"add",Cloudwalkers.Session.getComments().distantAdd)},url:function(){return CONFIG_BASE_URL+"json/message/"+this.parentid+"?"+$.param(this.parameters)},parse:function(a){if(a.message)return a.message.children}});Cloudwalkers.Collections.Reports=Backbone.Collection.extend({model:Cloudwalkers.Models.Report,typestring:"reports",modelstring:"report",processing:!1,parameters:{complete:1},paging:{},cursor:!1,initialize:function(a){a&&$.extend(this,a);Cloudwalkers.Session.user.account&&Cloudwalkers.Session.getReports().listenTo(this,"add",Cloudwalkers.Session.getReports().distantAdd)},distantAdd:function(a){this.get(a.id)||this.add(a)},url:function(){return CONFIG_BASE_URL+"json/stream/"+this.streamid+"/reports?complete=1"},
parse:function(a){for(n in a.reports)a.reports[n].streamid=this.streamid;return a.reports},sync:function(a,b,c){this.processing=!0;return Backbone.sync(a,b,c)},hook:function(a){this.processing?this.length&&a.success():this.fetch({error:a.error});this.on("sync",a.success)}});Cloudwalkers.Collections.Channel=Backbone.Collection.extend({id:null,model:Cloudwalkers.Models.Message,name:null,nextPageParameters:null,streams:null,canHaveFilters:!0,filters:{},canLoadMore:!0,showMoreButton:!1,_cancelCallback:!1,fetch_url:"json/channel/",since:null,initialize:function(a,b){var c=this;this.id=b.id;this.name=b.name;this.amount="undefined"==typeof b.amount?50:b.amount;this.canLoadMore="undefined"==typeof b.canLoadMore?!0:b.canLoadMore;this.showMoreButton="undefined"==typeof b.showMoreButton?
!1:b.showMoreButton;this.setComparator();"undefined"!=typeof b.since&&(this.since=b.since);this.on("change:date",function(){c.sort()})},setComparator:function(){this.comparator=function(a,b){return a.date().getTime()<b.date().getTime()?1:-1}},loadMore:function(a){var b=function(){};"undefined"!=typeof a.success&&(b=a.success);this.nextPageParameters&&this.fetch({remove:!1,page:this.nextPageParameters,success:function(){b()}})},getStreams:function(a,b){"undefined"==typeof b&&(b=!1);var c=_.extend({type:"GET",
dataType:"json",url:b?CONFIG_BASE_URL+this.fetch_url+this.id+"/streams?descendants=1":CONFIG_BASE_URL+this.fetch_url+this.id+"/streams?descendants=0",cache:!1},{success:function(b){"undefined"!=typeof b.streams?a(b.streams):a([])}});return $.ajax(c)},getChannels:function(a){var b=Cloudwalkers.Session.getChannel(Number(this.id));a(b)},sync:function(a,b,c){var d=this,e=c.success;c.success=function(a){c.resumeCallback&&(d._cancelCallback=!1);"undefined"!=typeof a.channel&&(Cloudwalkers.Utilities.StreamLibrary.parseFromChannel(a.channel.streams),
d.nextPageParameters=a.channel.next,d.streams=a.channel.streams,e(a.channel.messages))};b=c.page?c.page:{records:d.amount};for(var f in this.filters)b[f]=this.filters[f].join(",");this.since&&(b.since=Math.floor(this.since.getTime()/1E3));f=CONFIG_BASE_URL+this.fetch_url+this.id+"?"+jQuery.param(b);a=_.extend({type:"GET",dataType:"json",url:"read"==a?f:"",cache:!1},c);return $.ajax(a)},setFilters:function(a){this._cancelCallback=!0;this.filters=a;this.reset();this.fetch({resumeCallback:!0})},getFilters:function(a){return this.filters},
update:function(a){"undefined"==typeof a&&(a={});a.remove=!1;this.fetch(a)}});Cloudwalkers.Collections.Trending=Backbone.Collection.extend({id:null,model:Cloudwalkers.Models.Message,name:null,nextPageParameters:null,streams:null,canHaveFilters:!0,filters:{},canLoadMore:!0,showMoreButton:!1,_cancelCallback:!1,fetch_url:"json/trending/",since:null,initialize:function(a,b){var c=this;this.id=b.id;this.name=b.name;this.amount="undefined"==typeof b.amount?50:b.amount;this.canLoadMore="undefined"==typeof b.canLoadMore?!0:b.canLoadMore;this.showMoreButton="undefined"==typeof b.showMoreButton?
!1:b.showMoreButton;this.setComparator();"undefined"!=typeof b.since&&(this.since=b.since);this.on("change:date",function(){c.sort()})},setComparator:function(){this.comparator=function(a,b){return parseInt(a.get("engagement"))==parseInt(b.get("engagement"))?a.date().getTime()<b.date().getTime()?1:-1:parseInt(a.get("engagement"))<parseInt(b.get("engagement"))?1:-1}},loadMore:function(a){var b=function(){};"undefined"!=typeof a.success&&(b=a.success);this.nextPageParameters&&this.fetch({remove:!1,
page:this.nextPageParameters,success:function(){b()}})},getStreams:function(a,b){"undefined"==typeof b&&(b=!1);var c=_.extend({type:"GET",dataType:"json",url:b?CONFIG_BASE_URL+this.fetch_url+this.id+"/streams?descendants=1":CONFIG_BASE_URL+this.fetch_url+this.id+"/streams?descendants=0",cache:!1},{success:function(b){"undefined"!=typeof b.streams?a(b.streams):a([])}});return $.ajax(c)},getChannels:function(a){var b=Cloudwalkers.Session.getChannel(Number(this.id));a(b)},sync:function(a,b,c){var d=
this,e=c.success;c.success=function(a){c.resumeCallback&&(d._cancelCallback=!1);"undefined"!=typeof a.channel&&(Cloudwalkers.Utilities.StreamLibrary.parseFromChannel(a.channel.streams),d.nextPageParameters=a.channel.next,d.streams=a.channel.streams,e(a.channel.messages))};b=c.page?c.page:{records:d.amount};for(var f in this.filters)b[f]=this.filters[f].join(",");this.since&&(b.since=Math.floor(this.since.getTime()/1E3));f=CONFIG_BASE_URL+this.fetch_url+this.id+"?"+jQuery.param(b);a=_.extend({type:"POST",
dataType:"json",url:"read"==a?f:"",cache:!1},c);return $.ajax(a)},setFilters:function(a){this._cancelCallback=!0;this.filters=a;this.reset();this.fetch({resumeCallback:!0})},getFilters:function(a){return this.filters},update:function(a){"undefined"==typeof a&&(a={});a.remove=!1;this.fetch(a)}});Cloudwalkers.Collections.Scheduled=Backbone.Collection.extend({model:Cloudwalkers.Models.Message,name:null,nextPageParameters:null,canHaveFilters:!1,filters:{},initialize:function(a,b){this.name=b.name;var c,d;this.comparator=function(a,b){c=a.scheduledate(!1);d=b.scheduledate(!1);return(c?c.getTime():0)>(d?d.getTime():0)?1:-1}},sync:function(a,b,c){var d=c.success;c.success=function(a){d(a.messages)};b={};for(var e in this.filters)b[e]=this.filters[e].join(",");e=CONFIG_BASE_URL+"json/account/"+
Cloudwalkers.Session.getAccount().get("id")+"/scheduled?"+jQuery.param(b);a=_.extend({type:"POST",dataType:"json",url:"read"==a?e:"",cache:!1},c);return $.ajax(a)},setFilters:function(a){this._cancelCallback=!0;this.filters=a;this.reset();this.fetch({resumeCallback:!0})},update:function(a){"undefined"==typeof a&&(a={});a.remove=!1;this.fetch(a)},loadCounters:function(a){$.ajax(CONFIG_BASE_URL+"json/account/"+Cloudwalkers.Session.getAccount().get("id")+"/scheduled/summary",{success:function(b){a(b)}})}});Cloudwalkers.Collections.Drafts=Backbone.Collection.extend({model:Cloudwalkers.Models.Message,name:null,nextPageParameters:null,canHaveFilters:!1,filter:"",initialize:function(a,b){this.name=b.name;this.filter="undefined"!=typeof b.filter?b.filter:"";var c,d;this.comparator=function(a,b){c=a.date(!1);d=b.date(!1);return(c?c.getTime():0)<(d?d.getTime():0)?1:-1}},sync:function(a,b,c){var d=c.success;c.success=function(a){d(a.messages)};b=this.filter;b=CONFIG_BASE_URL+"json/account/"+Cloudwalkers.Session.getAccount().get("id")+
"/drafts/"+b;a=_.extend({type:"POST",dataType:"json",url:"read"==a?b:"",cache:!1},c);return $.ajax(a)},update:function(a){"undefined"==typeof a&&(a={});a.remove=!1;this.fetch(a)}});Cloudwalkers.Views.Root=Backbone.View.extend({view:null,header:null,footer:null,initialize:function(){this.navigation=new Cloudwalkers.Views.Navigation;this.navigation.fit();$(window).on("resize",this.resize.bind(this));this.resize()},render:function(){$("#inner-content").html(this.view.render().el);this.view.finish&&this.view.finish();this.navigation.handleSidebarMenu()},setView:function(a){this.view&&this.view.remove();Cloudwalkers.Session.trigger("destroy:view");this.view=a;this.render();Cloudwalkers.Session.manage()},
viewshare:function(){this.share.show()},height:function(a){var b=$(window).height(),c=$(c).height();return a?c>b?c:b:b},resize:function(){var a=this.height(!0);this.trigger("resize",a);$("#inner-content").css("min-height",a-42+"px")},popup:function(a){var b=this,c=$(Templates.uipopup).modal();c.find(".modalcontainer").html(a.render().el);a.on("popup:close",function(){c.modal("hide")});a.on("content:change",function(){b.trigger("content:change")})},writeMessage:function(a){a.preventDefault();this.setView(new Cloudwalkers.Views.Write({redirect:!1}))},
editMessage:function(a){Cloudwalkers.RootView.popup(new Cloudwalkers.Views.Write({model:a.clone(),redirect:!1}))},writeDialog:function(a,b){this.popup(new Cloudwalkers.Views.Write({model:a.clone(),clone:!0,actionparameters:b.parameters,redirect:!1}))},shareMessage:function(a){this.popup(new Cloudwalkers.Views.Write({model:a.clone(),clone:!0,redirect:!1}))},confirm:function(a,b){var c={};c.message=a;c.options=[{token:"confirm",label:"Yes",description:"Confirm your action"}];var c=Mustache.render(Templates.uiconfirm,
c),c=$(c),d=c.modal();c.find("[data-response=confirm]").click(function(){b();d.modal("hide")})},alert:function(a,b){var c={};c.message=a;var c=Mustache.render(Templates.uiconfirm,c),c=$(c),d=c.modal();c.find("[data-response=confirm]").click(function(){b();d.modal("hide")})},growl:function(a,b){$.gritter.add({title:a,text:b,time:4E3})},information:function(a,b){$("#inner-content .container-fluid").prepend("<div class='alert alert-info'><button type='button' class='close' data-dismiss='alert'>&times;</button><strong>"+
a+"</strong> "+b+"</div>")},dialog:function(a,b,c){var d={};d.message=a;d.options=b;a=Mustache.render(Templates.uidialog,d);var e=$(a),f=e.modal();a=function(a){e.find("[data-response="+a.token+"]").click(function(){c(a);f.modal("hide")})};for(d=0;d<b.length;d++)a(b[d])},imagePopups:function(){$("a.image-popup-viewer").fancybox()}});Cloudwalkers.Views.Navigation=Backbone.View.extend({events:{"click .notification-toggle":"toggleNotifications"},initialize:function(){Cloudwalkers.Session.on("change:accounts",this.renderHeader,this);this.listenTo(Cloudwalkers.Session.getChannels(),"sync",this.render);this.listenTo(Cloudwalkers.Session.getChannels(),"remove",this.render);$.get(CONFIG_BASE_URL+"json/version",this.version.bind(this))},fit:function(){$("#header").html(this.renderHeader().header);$("#sidebar").html(this.render().el);
this.render()},version:function(a){"TESTING"==a.platform.name&&(this.development=!0,$("#header").html(this.renderHeader().header))},renderHeader:function(){var a={dev:this.development};a.user=Cloudwalkers.Session.user.attributes;a.accounts=[];Cloudwalkers.Session.user.accounts.each(function(b){a.accounts.push({name:b.get("name"),id:b.id,active:b.id==Cloudwalkers.Session.get("currentAccount")})});this.header=Mustache.render(Templates.header,a);return this},render:function(){var a=Cloudwalkers.Session.getAccount(),
b={reports:[]};b.level=Number(a.get("currentuser").level);b.scheduled={channelid:Cloudwalkers.Session.getChannel("internal").id};b.scheduled.streams=a.streams.where({outgoing:1});var c=Cloudwalkers.Session.getChannel("inbox");c&&(b.inbox={channelid:c.id,streams:c.streams.models,name:c.get("name")});c=a.channels.findWhere({type:"profiles"});b.profiles={channelid:c.id,streams:c.streams.models,name:c.get("name")};c=a.channels.findWhere({type:"news"});b.news={channelid:c.id,streams:c.streams.models,name:c.get("name")};
c=a.channels.findWhere({type:"monitoring"});b.monitoring={channelid:c.id,channels:c.channels.models,name:c.get("name")};b.reports=a.streams.where({statistics:1}).map(function(a){return a.attributes});this.$el.html(Mustache.render(Templates.navigation,b));this.handleSidebarMenu();return this},handleSidebarMenu:function(){var a=Backbone.history.fragment;if(!a)return null;this.setActive(a)},setActive:function(a){$("#sidebar .active").removeClass("active");$('a[href="#'+a+'"]').parents("#sidebar .page-sidebar-menu *").addClass("active")},
setNotifications:function(a){this.$el.find(".popup-frame ul").html("");for(var b=0;b<a.length;b++)this.addNotification(a[b])},addNotification:function(a){this.$el.find(".popup-frame ul").append('<li><div class="text account"><p>'+a.message+'</p><div class="row"><span class="time"></span></div></div></li>')},toggleNotifications:function(){this.$el.find(".notification-popup").toggle()}});Cloudwalkers.Views.Share=Backbone.View.extend({events:{"click .notification-toggle":"toggleNotifications"},initialize:function(){},fit:function(){$("#share").html(this.render().el)},render:function(){this.$el.html(Mustache.render(Templates.share,{streams:[{icon:"twitter",name:"bmgroup"},{icon:"facebook",name:"bmgroup"},{icon:"linkedin",name:"Cloudwalkers"}]}));return this},show:function(){$("#share").removeClass("collapsed");$("#sidebar, #inner-content").addClass("collapsed");this.spanheight()},hide:function(){$("#share").addClass("collapsed");
$("#sidebar, #inner-content").removeClass("collapsed")},toggle:function(){$("#share").hasClass("collapsed")?this.show():this.hide()},spanheight:function(){this.$el.height($(".page-container").height()+"px")}});Cloudwalkers.Views.Pageview=Backbone.View.extend({title:"Page",className:"container-fluid",span:0,widgets:[],widgetviews:[],events:{remove:"destroy"},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);this.appendWidgets();return this},appendWidgets:function(){for(n in this.widgets){var a=this.widgets[n].view(this.widgets[n].data);this.appendWidget(a,this.widgets[n].size)}},appendWidget:function(a,b){this.span||
this.$container.append(Templates.row);this.span=12>b+this.span?b+this.span:0;this.$container.children().last().append(a.render().el);this.widgetviews.push(a);a.$el.addClass("span"+b);a.negotiateFunctionalities()},appendhtml:function(a){this.$container.children().last().append(a)},destroy:function(){$.each(this.widgetviews,function(a,b){b.remove()})}});Cloudwalkers.Views.Message=Backbone.View.extend({events:{"click .message-action[data-action]":"messageAction","click .children-button.message-children":"showchildren"},className:"message-view",template:"message",tagName:"tr",commentsVisible:!1,commentsView:null,childrencontainer:"comment-container",initialize:function(){var a=this;this.model.on("change",function(){a.render()})},prepareData:function(){var a=jQuery.extend(!0,{},this.model.attributes);a.shortBody=this.model.shortBody();a.humandate=this.model.humandate();
a.dateonly=this.model.shortdate();a.time=this.model.time();a.sortedattachments={};var b=this.model.getProcessedAttachments();if(0<b.length)for(var c=0;c<b.length;c++)"undefined"==typeof a.sortedattachments[a.attachments[c].type]&&(a.sortedattachments[b[c].type]=[]),a.sortedattachments[b[c].type].push(b[c]);this.model.getStream()&&(a.stream=this.model.getStream().attributes);this.model.collection&&(a.channel=this.model.collection.id);if("undefined"!=typeof a.statistics)for(c=0;c<a.statistics.length;c++)"undefined"!=
typeof a.statistics[c].i18n&&(a.statistics[c].name=1!=a.statistics[c].value?a.statistics[c].i18n[1]:a.statistics[c].i18n[0]);return this.additionalData(a)},additionalData:function(a){"OUTGOING"==this.model.get("type")&&(a.scheduledate=this.model.scheduledate());return a},render:function(){var a=this.prepareData(),b=this;"undefined"!=typeof a.parentmodel&&"undefined"!=typeof this.options.childtemplate?$(this.el).html(Mustache.render(Templates[this.options.childtemplate],a)):"undefined"!=typeof this.options.template?
$(this.el).html(Mustache.render(Templates[this.options.template],a)):"undefined"!=typeof a.parentmodel?$(this.el).html(Mustache.render(Templates.messagecomment,a)):$(this.el).html(Mustache.render(Templates[this.template],a));a.parentmodel&&(a={model:a.parentmodel},"undefined"!=typeof this.options.originaltemplate&&(a.template=this.options.originaltemplate),a=new Cloudwalkers.Views.OriginalMessage(a),this.$el.find(".parent-message-view").html(a.render().el));this.$el.find(".actions.dropdown").on("click",
function(a){a.stopPropagation();b.$el.find(".dropdown-menu").dropdown("toggle");b.$el.find("[data-action]").unbind("click").click(function(a){b.messageAction(a)})});(this.commentsVisible||this.options.showcomments)&&this.showchildrenexec();this.afterRender();this.model.setRead();return this},messageAction:function(a){a=$(a.currentTarget).is("[data-action]")?$(a.currentTarget).attr("data-action"):$(a.target).is("[data-action]")?$(a.target).attr("data-action"):$(a.target).parent("[data-action]").attr("data-action");
action=this.model.getAction(a);null==action?console.log("Action not found: "+a):(a=this.model,"undefined"!=typeof action.target&&(a=action.target,"undefined"!=typeof action.originalaction&&(action=action.originalaction)),"undefined"!=typeof action.callback?action.callback(a):action&&("dialog"==action.type?(a=new Cloudwalkers.Views.ActionParameters({message:a,action:action}),Cloudwalkers.RootView.popup(a)):"simple"==action.type?a.act(action,{},function(){}):"write"==action.type&&Cloudwalkers.RootView.writeDialog(a,
action)))},afterRender:function(){this.time()},showchildren:function(a){a.stopPropagation();a.preventDefault();this.commentsVisible?(this.commentsVisible=!1,this.$el.find(".comment-label").html("Show comments"),this.$el.find("."+this.childrencontainer).hide()):this.showchildrenexec()},showchildrenexec:function(){if(null==this.commentsView){var a={};a.parent=this.model;"undefined"!=typeof this.options.selectedchild&&(a.selectedchild=this.options.selectedchild);this.commentsView=new Cloudwalkers.Views.Comments(a);
this.commentsView.render()}this.commentsVisible=!0;this.$el.find(".comment-label").html("Hide comments");this.$el.find("."+this.childrencontainer).html(this.commentsView.el).show()},time:function(){var a=new Date,b=new Date(this.$el.find("[data-date]").attr("data-date")),a=Math.round(0.0010*(a.getTime()-b.getTime())),a=60>a?"now":3600>a?Math.round(a/60)+"m":86400>a?Math.round(a/3600)+"h":2592E3>a?Math.round(a/86400)+"d":Math.round(a/2592E3)+"mo";this.$el.find("[data-date]").html(a)}});Cloudwalkers.Widget=Backbone.View.extend({title:"...",color:"blue",icon:"cloud",events:{"click .portlet-title.line":"collapse"},initialize:function(){this.bind("destroy",this.destroy)},innerRender:function(){this.$el.addClass("inner-empty")},render:function(){this.$el.html(Mustache.render(Templates.widget,{title:this.options.title|this.title,color:this.options.color|this.color,icon:this.options.icon|this.icon}));"auto"==this.options.height&&this.$el.find(".scroller").remove();"undefined"!=typeof this.options.counter&&
this.appendCounter();this.options.collapsible&&this.appendCollapsible();this.innerRender();this.addScroll();return this},appendCounter:function(a){this.$el.find(".tools").append($('<span class="count">'+a+"</span>"))},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",position:"right",height:$(this).attr("data-height"),alwaysVisible:"1"==$(this).attr("data-always-visible")?!0:!1,railVisible:"1"==$(this).attr("data-rail-visible")?!0:!1,disableFadeOut:!0})},appendCollapsible:function(a){this.$el.find(".tools .count").length?
this.$el.find(".tools .count").addClass("collapse"):this.$el.find(".tools").append($('<span class="collapse pull-right"></span>'));this.$el.addClass(a?"collapse-open":"collapse-closed")},collapse:function(){this.$el.toggleClass("collapse-closed collapse-open")},destroy:function(){this.$el.find(".scroller").slimScroll({destroy:1})}});Cloudwalkers.Views.Widgets.WidgetContainer=Backbone.View.extend({widgets:[],title:"Widget Container",isLoaded:!1,currentLine:null,sizecounter:0,newline:!0,templatename:"widgetcontainer",events:{remove:"destroy"},initialize:function(){this.widgets=[];this.initializeWidgets();this.isLoaded=!1;this.newline=!0;this.sizecounter=0;this.title=this.options.title?this.options.title:this.title},initializeWidgets:function(){},add:function(a,b){"undefined"==typeof b&&(b=a.size);b="full"==b?12:"half"==b?6:b?parseInt(b):
12;this.sizecounter+=b;12<this.sizecounter&&(this.sizecounter=b,this.newline=!0);this.addWidgetSize(a,this.newline,b);this.newline=!1},addHalfWidget:function(a,b){"undefined"==typeof b&&(b=!1);var c=this;a.on("content:change",function(){c.trigger("content:change")});this.widgets.push({widget:a,size:"half",newline:b});this.isLoaded&&this.addWidgetsDOM([{widget:a,size:"half",newline:b}])},addWidget:function(a,b){"undefined"==typeof b&&(b=!1);var c=this;a.on("content:change",function(){c.trigger("content:change")});
this.widgets.push({widget:a,size:"full",newline:b});this.isLoaded&&this.addWidgetsDOM([{widget:a,size:"full",newline:b}])},addWidgetSize:function(a,b,c){"undefined"==typeof b&&(b=!1);var d=this;a.on("content:change",function(){d.trigger("content:change")});this.widgets.push({widget:a,size:c,newline:b});this.isLoaded&&this.addWidgetsDOM([{widget:a,size:c,newline:b}])},render:function(){this.isLoaded=!0;this.$el.addClass("container-fluid");this.$el.html(Mustache.render(Templates[this.templatename],
{title:this.title}));this.currentline=$(document.createElement("div"));this.currentline.addClass("row-fluid");this.$el.find("#widgetcontainer").append(this.currentline);this.addWidgetsDOM(this.widgets);return this},addWidgetsDOM:function(a){for(var b=this,c=0;c<a.length;c++)a[c].newline&&(this.currentline=$(document.createElement("div")),this.currentline.addClass("row-fluid"),this.$el.find("#widgetcontainer").append(this.currentline)),container=$(document.createElement("div")),"half"==a[c].size?container.addClass("span6"):
"full"==a[c].size?container.addClass("span12"):container.addClass("span"+a[c].size),container.append(a[c].widget.render().el),this.currentline.append(container),a[c].widget.negotiateFunctionalities();setTimeout(function(){b.trigger("content:change")},1)},destroy:function(){for(n in this.widgets)this.widgets[n].widget.trigger("destroy")}});Cloudwalkers.Views.Dashboard=Cloudwalkers.Views.Pageview.extend({title:"Dashboard",widgets:[{widget:"messagescounters",type:"inbox",source:"streams",size:4,title:"Inbox",icon:"inbox",open:!0,counter:!0,link:"#inbox",countString:"incomingUnread"},{widget:"messagescounters",type:"monitoring",source:"channels",size:4,title:"Keywords",icon:"tags",open:!0,counter:!0,countString:"incoming"},{widget:"schedulecounter",type:"schedule",source:"outgoing",size:4,title:"Schedule",icon:"time",open:!0,counter:!0,
countString:"scheduled"},{widget:"coworkers",type:"drafts",size:4,title:"Co-workers wall",color:"yellow",icon:"edit",open:!0,link:"#coworkers"},{widget:"trending",type:"profiles",size:4,title:"Trending Company Posts",color:"grey",icon:"thumbs-up",open:!0,since:7},{widget:"trending",type:"news",size:4,title:"Trending Profiles we follow",color:"red",icon:"thumbs-up",open:!0,since:1}],initialize:function(){Cloudwalkers.Session.ping()},addDynamicReports:function(){var a=Cloudwalkers.Session.getStreams().where({statistics:1}),
b=[];for(n in a)switch(a[n].get("network").token){case "facebook":b.push({widget:"report",size:3,stream:a[n],type:"numbercomparison/likes",dashboard:!0});b.push({widget:"report",size:3,stream:a[n],type:"besttimetoposttext/",dashboard:!0});break;case "twitter":b.push({widget:"report",size:3,stream:a[n],type:"numbercomparison/followers_count",dashboard:!0}),b.push({widget:"report",size:3,stream:a[n],type:"besttimetoposttext/",dashboard:!0})}return b},render:function(){this.$el.html(Mustache.render(Templates.pageview,
{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);var a=this.widgets.concat(this.addDynamicReports());for(i in a){switch(a[i].widget){case "messagescounters":var b=this.addMessagesCounters(a[i]);break;case "schedulecounter":b=this.addScheduleCounters(a[i]);break;case "coworkers":b=this.addDashboardDrafts(a[i]);break;case "trending":b=this.addDashboardTrending(a[i]);break;case "report":b=new Cloudwalkers.Views.Widgets.Report(a[i])}this.appendWidget(b,Number(a[i].size))}return this},
addMessagesCounters:function(a){var b=Cloudwalkers.Session.getChannel(a.type);$.extend(a,{name:b.get("name"),open:1,channel:b});return new Cloudwalkers.Views.Widgets.MessagesCounters(a)},addScheduleCounters:function(a){var b=Cloudwalkers.Session.getChannel("internal");b.outgoing=new Cloudwalkers.Collections.Streams(b.get("additional").outgoing);$.extend(a,{name:b.get("name"),open:1,channel:b});return new Cloudwalkers.Views.Widgets.MessagesCounters(a)},addDashboardDrafts:function(a){var b=Cloudwalkers.Session.getChannel("internal");
a.model=b.getStream("draft");a.link="#coworkers";return new Cloudwalkers.Views.Widgets.DashboardMessageList(a)},addDashboardTrending:function(a){a.model=Cloudwalkers.Session.getChannel(a.type);a.filters={sort:"engagement",since:3600*Math.round(Date.now()/36E5)-86400*a.since};return new Cloudwalkers.Views.Widgets.DashboardMessageList(a)}});Cloudwalkers.Views.MessageBoard=Cloudwalkers.Views.Widgets.WidgetContainer.extend({title:"Message Board",widgets:{}});Cloudwalkers.Views.Inbox=Cloudwalkers.Views.Pageview.extend({title:"Inbox",className:"container-fluid inbox",render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.options.type}));this.$container=this.$el.find("#widgetcontainer").eq(0);this.options.channel.childtype=this.options.type.slice(0,-1);var a="message"==this.options.channel.childtype?new Cloudwalkers.Views.Widgets.InboxMessageList(this.options):new Cloudwalkers.Views.Widgets.InboxNotificationList(this.options);this.appendWidget(a,
4);this.appendhtml(Templates.inboxcontainer);this.listenTo(Cloudwalkers.RootView,"resize",this.resize);return this},resize:function(a){this.$el.find("#widgetcontainer").height(a-140)},finish:function(){this.resize(Cloudwalkers.RootView.height());$message=this.$el.find(".inbox-container").wrap("<div class='scroller'>");$message.parent().slimScroll({height:"inherit"})}});Cloudwalkers.Views.Coworkers=Cloudwalkers.Views.Pageview.extend({title:"Co-workers wall",className:"container-fluid coworkers",initialize:function(){this.model=Cloudwalkers.Session.getChannel("internal").getStream("coworkers");if(!this.model)return Cloudwalkers.Session.home();this.listenTo(this.model,"outdated",this.model.fetch);this.listenTo(this.model,"sync",this.render)},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);
var a=new Cloudwalkers.Views.Widgets.CoworkersFilters({model:this.model});this.appendWidget(a,4);var b=new Cloudwalkers.Views.Widgets.CoworkersList({model:this.model});this.appendWidget(b,8);a.list=b;return this}});Cloudwalkers.Views.Timeline=Cloudwalkers.Views.Pageview.extend({parameters:{records:20},entries:[],events:{"click *[data-action]":"action","click .load-more":"more"},initialize:function(a){a&&$.extend(this,a);this.collection=this.model.messages;this.listenTo(this.collection,"seed",this.fill);this.listenTo(this.collection,"request",this.showloading)},showloading:function(){this.$el.find(".timeline-loading").show()},hideloading:function(){this.$el.find(".timeline-loading").hide()},render:function(){this.$el.html(Mustache.render(Templates.timeline,
{}));this.$container=this.$el.find("ul.timeline").eq(0);this.$loadmore=this.$el.find(".load-more").remove();this.collection.touch(this.model,this.filterparameters());return this},filterparameters:function(){return this.parameters},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],template:"messagetimeline",type:this.trending?"fulltrending":"full"});this.entries.push(b);this.$container.append(b.render().el)}a.length&&
this.$container.append(this.$loadmore);this.hideloading()},more:function(){this.incremental=!0;this.collection.more(this.model,this.filterparameters())||this.$el.find(".load-more").hide()}});Cloudwalkers.Views.Trending=Cloudwalkers.Views.Pageview.extend({initialize:function(a){a&&$.extend(this,a);this.listenTo(this.model.streams,"seed",this.fill);this.listenTo(this.model.streams,"request",this.showloading);this.listenTo(this.model.streams,"sync",this.hideloading)},render:function(){var a={streams:[],networks:this.model.streams.filterNetworks(null,!0)};this.model.streams.each(function(b){a.streams.push({id:b.id,icon:b.get("network").icon,name:b.get("defaultname")})});this.$el.html(Mustache.render(Templates.trending,
a));this.collection.touch(this.model,{records:40,sort:"engagement",since:3600*Math.round(Date.now()/36E5)-86400*this.span});return this}});Cloudwalkers.Views.KeywordMonitoring=Cloudwalkers.Views.Pageview.extend({title:"Keyword Monitoring",className:"container-fluid monitoring",initialize:function(){if(!this.options.category)return Cloudwalkers.Session.home();this.category=this.options.category},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);var a=new Cloudwalkers.Views.Widgets.MonitorFilters({category:this.category});this.appendWidget(a,
4);var b=new Cloudwalkers.Views.Widgets.MonitorList({category:this.category});this.appendWidget(b,8);a.list=b;return this}});Cloudwalkers.Views.ManageKeywords=Cloudwalkers.Views.Pageview.extend({title:"Manage Keywords",className:"container-fluid managekeywords",render:function(){setTimeout(this.limitlistener,50);this.listenTo(Cloudwalkers.Session.getChannels(),"sync remove",this.limitlistener);this.$el.html(Mustache.render(Templates.pageview,{title:this.title}));this.$container=this.$el.find("#widgetcontainer").eq(0);var a=new Cloudwalkers.Views.Widgets.KeywordsEditor;this.appendWidget(a,4);var b=new Cloudwalkers.Views.Widgets.KeywordsOverview({editor:a});
this.appendWidget(b,8);this.widgets=[a,b];return this},limitlistener:function(){var a=Cloudwalkers.Session.getChannel("monitoring").channels.reduce(function(a,c){return("number"==typeof a?a:a.get("channels").length)+c.get("channels").length});Cloudwalkers.Session.getAccount().monitorlimit("keywords",a,".add-keyword")}});Cloudwalkers.Views.Reports=Cloudwalkers.Views.Widgets.WidgetContainer.extend({navclass:"reports",title:"Report",datepicker:null,initializeWidgets:function(){this.title=this.title+" "+this.options.stream.get("customname");this.datepicker=new Cloudwalkers.Views.Widgets.Datepicker;if("undefined"!=typeof this.options.stream&&this.options.stream)this.addStreamWidgets(this.options.stream);else for(var a=Cloudwalkers.Session.getStreams(),b=0;b<a.length;b++)a[b].get("statistics")&&this.addStreamWidgets(a[b])},
addStreamWidgets:function(a){var b=this;$.ajax(CONFIG_BASE_URL+"json/stream/"+a.get("id")+"/statistics",{success:function(c){if(0<c.statistics.length){for(var d=[],e=[],f=0;f<c.statistics.length;f++)"time"==c.statistics[f].type?d.push(c.statistics[f]):e.push(c.statistics[f]);b.addCombinedWidget(a.attributes,d);for(c=0;c<e.length;c++)b.addReportWidget(a.attributes,e[c])}}})},addCombinedWidget:function(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d],f=void 0;b[d].stream=a;f=new Cloudwalkers.Models.Report(e);
c.push(f)}c=new Cloudwalkers.Views.Widgets.CombinedStatistics({reports:c,stream:a});c.color=a.network.icon+"-color";c.network=a.network;this.add(c)},addReportWidget:function(a,b){b.stream=a;var c=new Cloudwalkers.Models.Report(b),d=c.getWidget(),e=this.datepicker.getDateRange();c.setDateRange(e[0],e[1]);d.color=a.network.icon+"-color";d.network=a.network;d.showLink=!1;d.showStreamName=!1;this.datepicker.on("date:change",function(a,b){d.getDataset().setDateRange(a,b)});this.add(d)}});Cloudwalkers.Views.Statistics=Cloudwalkers.Views.Pageview.extend({id:"statistics",initialize:function(a){a&&$.extend(this,a)},render:function(){this.$el.html(Mustache.render(Templates.pageview,{title:""}));this.$container=this.$el.find("#widgetcontainer").eq(0);return this}});Cloudwalkers.Views.Settings=Cloudwalkers.Views.Pageview.extend({title:"Settings",tabs:[],initialize:function(){this.endpoint=this.options.endpoint;this.level=Cloudwalkers.Session.user.level},setAction:function(a){this.action=a},render:function(){this.level&&(this.tabs=[{url:"#settings/users",name:"Manage users"},{url:"#settings/services",name:"Social connections"},{url:"#settings/account",name:"Account settings"}]);this.tabs.push({url:"#settings/profile",name:"Profile settings"});this.$el.html(Mustache.render(Templates.tabview,
{title:this.title,tabs:this.tabs}));this.$container=this.$el.find("#widgetcontainer").eq(0);this.$el.find('.nav-tabs a[href="#settings/'+this.endpoint+'"]').parent().addClass("active");switch(this.endpoint){case "users":var a=new Cloudwalkers.Views.Settings.Users;break;case "services":a=new Cloudwalkers.Views.Settings.Services;break;case "account":a=new Cloudwalkers.Views.Settings.Account;break;default:a=new Cloudwalkers.Views.Settings.Profile}this.appendWidget(a,12);return this}});Cloudwalkers.Views.Firsttime=Cloudwalkers.Views.Pageview.extend({title:"First Time",events:{remove:"destroy","click [data-add-service]":"addServiceCall"},initialize:function(){var a=Cloudwalkers.Session.getAccount();Cloudwalkers.Net.get("wizard/service/available",{account:a.id},this.appendOptions.bind(this))},render:function(){Backbone.history.fragment="settings/services";$("#sidebar").addClass("collapsed");$("#inner-content").addClass("expanded");params={displayname:Cloudwalkers.Session.user.get("displayname")};
this.$el.html(Mustache.render(Templates.firsttime,params));return this},appendOptions:function(a){var b=this.$el.find(".networks-list");for(n in a.services)b.append(Mustache.render(Templates.settings.service_option,a.services[n]))},addService:function(a,b){Cloudwalkers.Net.post("wizard/service/add",{account:Cloudwalkers.Session.getAccount().get("id")},{id:a},b)},processLink:function(a){return a=0<a.indexOf("?")?a+"&return="+encodeURIComponent(window.location):a+"?return="+encodeURIComponent(window.location)},
addServiceCall:function(a){a.preventDefault();var b=this;a=$(a.target).attr("data-add-service");this.addService(a,function(a){"undefined"!=typeof a.error?Cloudwalkers.RootView.alert(a.error.message):($.each(a.service.settings,function(a,c){if("link"==c.type){var f=b.processLink(c.url);window.location=f}}),b.render())})},destroy:function(){$("#sidebar, #inner-content").removeClass("collapsed expanded")}});Cloudwalkers.Views.Widgets.Widget=Backbone.View.extend({title:"Untitled widget",icon:"inbox",color:"blue",network:null,entries:[],events:{},tools:[],initialize:function(){this.options.color||(this.options.color=this.color);this.initializeWidget()},initializeWidget:function(){this.bind("destroy",this.onDestroy);this.bind("add",function(){console.log("View add triggrered")})},innerRender:function(a){a.html("No inner content set.")},render:function(){"undefined"!=typeof this.options.title&&(this.title=
this.options.title);"undefined"!=typeof this.options.icon&&this.options.icon&&(this.icon=this.options.icon);this.$el.html(Mustache.render(Templates.widget,{title:this.title,color:this.color,icon:this.icon,tools:this.tools,network:this.network}));for(var a=0;a<this.tools.length;a++)this.attachToolEvents(this.tools[a]);this.$innerEl=$(this.$el.find(".portlet-body"));this.innerRender(this.$innerEl);return this},attachToolEvents:function(a){var b=this;this.$el.find("."+a["class"]).click(function(c){b[a.event](c)})},
negotiateFunctionalities:function(){this.$el.find(".scroller").length&&this.addScroll();this.options.counter&&this.appendCounter();"undefined"!=typeof this.options.open&&this.appendCollapseble(this.options.open)},appendCollapseble:function(a){this.$el.addClass(a?"collapse-open":"collapse-closed");this.$el.find(".tools .count").length?this.$el.find(".tools .count").addClass("collapse"):this.$el.find(".tools").append($('<span class="collapse pull-right"></span>'));this.$el.find(".portlet-title.line").on("click",
this.collapse.bind(this))},appendCounter:function(a){var b=0;this.$el.find("li .number, li .count").each(function(){b+=Number($(this).text())});999<b&&(b="+999");0>b&&(b=0);this.$el.find(".tools").append($('<span class="count">'+b+"</span>"))},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",position:"right",height:$(this).attr("data-height"),alwaysVisible:"1"==$(this).attr("data-always-visible")?!0:!1,railVisible:"1"==$(this).attr("data-rail-visible")?!0:!1,
disableFadeOut:!0})},onDestroy:function(){$.each(this.entries,function(a,b){b.trigger("destroy")});this.$el.find(".scroller").slimScroll({destroy:1});this.remove()},collapse:function(){this.$el.toggleClass("collapse-closed collapse-open")}});Cloudwalkers.Views.Entry=Backbone.View.extend({tagName:"li",template:"messageentry",notifications:[],events:{remove:"destroy","click *[data-action]":"action","click [data-notifications]":"loadNotifications",click:"toggle"},initialize:function(a){a&&$.extend(this,a);this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html(Mustache.render(Templates[this.template],this.model.filterData(this.type)));this.$el.find("[data-date]")&&this.time();"inbox"==this.type&&this.model.get("objectType")&&
this.checkUnread();return this},toggle:function(){this.trigger("toggle",this)},checkUnread:function(){this.model.get("read")?this.$el.removeClass("unread"):this.$el.addClass("unread")},loadNotifications:function(){this.model.notifications||(this.model.notifications=new Cloudwalkers.Collections.Notifications);this.listenTo(this.model.notifications,"seed",this.fillNotifications);this.model.notifications.touch(this.model,{records:50})},fillNotifications:function(a){$.each(this.notifications,function(a,
b){b.remove()});this.notifications=[];a.models&&(a=a.models);var b=this.$el.find(".timeline-comments").eq(0).html("");for(n in a){var c=new Cloudwalkers.Views.Notification({model:a[n],template:"timelinecomment"});this.notifications.push(c);b.append(c.render().el)}},action:function(a){a=$(a.currentTarget).is("[data-action]")?$(a.currentTarget).attr("data-action"):$(a.target).is("[data-action]")?$(a.target).attr("data-action"):$(a.target).parent("[data-action]").attr("data-action");action=this.model.getAction(a);
null==action?console.log("No action found: "+a):(a=this.model,"undefined"!=typeof action.target&&(a=action.target,"undefined"!=typeof action.originalaction&&(action=action.originalaction)),"undefined"!=typeof action.callback?action.callback(a):action&&("dialog"==action.type?(a=new Cloudwalkers.Views.ActionParameters({message:a,action:action}),Cloudwalkers.RootView.popup(a)):"simple"==action.type?a.act(action,{},function(){}):"write"==action.type&&Cloudwalkers.RootView.writeDialog(a,action)))},time:function(){var a=
new Date,b=new Date(this.$el.find("[data-date]").attr("data-date")),a=Math.round(0.0010*(a.getTime()-b.getTime())),a=60>a?"now":3600>a?Math.round(a/60)+"m":86400>a?Math.round(a/3600)+"h":2592E3>a?Math.round(a/86400)+"d":Math.round(a/2592E3)+"mo";this.$el.find("[data-date]").html(a);this.tm=setTimeout(this.time.bind(this),6E4)},destroy:function(){window.clearTimeout(this.tm)}});Cloudwalkers.Views.User=Backbone.View.extend({tagName:"li",template:"user",events:{click:"select"},initialize:function(a){a&&$.extend(this,a);this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html(Mustache.render(Templates[this.template],this.model.filterData(this.type)));return this},select:function(){this.trigger("select",this)}});Cloudwalkers.Views.Write=Backbone.View.extend({events:{"submit form":"submit","keyup textarea[name=message]":"updateCounter","keyup input[name=title]":"updateCounter","click #schedule-btn-toggle":"toggleSchedule","click button[value=draft]":"setDraft","click [name=delay]":"setWithinDate","change select[name=schedule_day],select[name=schedule_month],select[name=schedule_year],select[name=schedule_time]":"resetWithin","click #button-response[value=send]":"sendNow","click .btnShortenURL":"shortenUrl",
"change select[name=campaign]":"selectCampaign","click [name=add-campaign]":"addCampaign"},files:[],draft:!1,sendnow:!1,navclass:"write",setDraft:function(){this.draft=!0},sendNow:function(a){a.preventDefault();a.stopPropagation();this.sendnow=!0;this.$el.find(".message-schedule").is(":visible")?this.model&&confirm("Are you sure you want to sent this scheduled message now?")?(this.clearScheduleDate(),$(a.toElement.form).trigger("submit")):confirm("Are you sure you want to send your message right now? Your schedule details will be lost.")&&
(this.clearScheduleDate(),$(a.toElement.form).trigger("submit")):(this.clearScheduleDate(),$(a.toElement.form).trigger("submit"))},selectCampaign:function(a){Number(this.$el.find("select[name=campaign]").val())||this.$el.find(".new-campaign, select[name=campaign]").toggleClass("inactive")},addCampaign:function(a){},getAvailableStreams:function(){var a=Cloudwalkers.Session.getChannel("internal"),a=new Cloudwalkers.Collections.Streams(a.get("additional").outgoing);if("undefined"!=typeof this.options.actionparameters&&
"undefined"!=typeof this.model){var b=Cloudwalkers.Session.getStream(this.model.get("stream"));if(b){for(var c=new Backbone.Collection,d=0;d<a.models.length;d++)a.models[d].get("network").name==b.get("network").name&&c.add(a.models[d]);return c}}return a},render:function(){this.files=[];this.sendnow=this.draft=!1;var a=Cloudwalkers.Session.getAccount();this.actionparameters={};if("undefined"!=typeof this.options.actionparameters)for(var b=0;b<this.options.actionparameters.length;b++)this.actionparameters[this.options.actionparameters[b].token]=
this.options.actionparameters[b];var c=this,d={},e=this.getAvailableStreams(),f={};if(this.model&&this.model.get("streams"))for(b=0;b<this.model.get("streams").length;b++)f[this.model.get("streams")[b].id]=!0;d.channels=[];$.each(e.where({outgoing:1}),function(a,b){b.attributes.checked="undefined"!=typeof f[b.id];d.channels.push(b.attributes)});d.BASE_URL=CONFIG_BASE_URL;var e=this.model?this.model.scheduledate(!1):!1,g=this.model?this.model.repeat():!1;d.days=[];d.months=[];d.years=[];d.times=[];
d.endrepeat={days:[],months:[],years:[]};for(b=1;31>=b;b++)d.days.push({day:b,checked:e?e.getDate()==b:!1}),d.endrepeat.days.push({day:b,checked:g&&g.end&&g.end.getDate()==b});for(b=1;12>=b;b++)d.months.push({month:b,display:Cloudwalkers.Utils.month(b),checked:e?e.getMonth()==b-1:!1}),d.endrepeat.months.push({month:b,display:Cloudwalkers.Utils.month(b),checked:g&&g.end&&g.end.getMonth()==b-1});for(var h=null,b=0;10>b;b++)h=(new Date).getFullYear()+b,d.years.push({year:h,checked:e?e.getFullYear()==
h:!1}),d.endrepeat.years.push({year:h,checked:g&&g.end&&g.end.getFullYear()==h});d.weekdays=[];h="monday tuesday wednesday thursday friday saturday sunday".split(" ");for(b=0;b<h.length;b++){var k=h[b],k=k.charAt(0).toUpperCase()+k.substr(1);d.weekdays.push({name:k,weekday:h[b],checked:g&&g.weekdays&&g.weekdays[h[b].toUpperCase()]})}d.repeatinterval={amount:[],unit:[]};for(b=0;72>b;b++)d.repeatinterval.amount.push({value:b,name:b,selected:g&&g.interval==b});d.repeatinterval.unit.push({value:"minutes",
name:"Minute(s)",selected:g&&"minutes"==g.unit});d.repeatinterval.unit.push({value:"hours",name:"Hour(s)",selected:g&&"hours"==g.unit});d.repeatinterval.unit.push({value:"days",name:"Day(s)",selected:g&&"days"==g.unit});d.repeatinterval.unit.push({value:"weeks",name:"Week(s)",selected:g&&"weeks"==g.unit});d.repeatinterval.unit.push({value:"months",name:"Month(s)",selected:g&&"months"==g.unit});for(b=0;24>b;b+=0.25)g=Math.floor(b),h=60*(b-Math.floor(b)),10>g&&(g="0"+g),10>h&&(h="0"+h),e&&e.setMinutes(15*
Math.floor(e.getMinutes()/15)),d.times.push({time:g+":"+h,checked:e&&e.getHours()==g&&e.getMinutes()==h});d.canSchedule=!0;d.canSave=!0;d.canSendNow=!0;if(this.model){d.canSave="SCHEDULED"!=this.model.get("status");d.message=jQuery.extend(!0,{},this.model.attributes);"undefined"!=typeof this.actionparameters.message&&""!=this.actionparameters.message.value&&(d.message.body.plaintext=Cloudwalkers.Utilities.Parser.parseFromMessage(this.actionparameters.message.value,this.model),d.message.body.html=
Cloudwalkers.Utilities.Parser.parseFromMessage(this.actionparameters.message.value,this.model));d.sortedattachments={};if(this.model.get("attachments"))for(b=0;b<this.model.get("attachments").length;b++)d.sortedattachments[this.model.get("attachments")[b].type]=[this.model.get("attachments")[b]];d.showschedule=!1;if(this.model.scheduledate(!1)||"undefined"!=typeof this.model.repeat().interval)d.showschedule=!0}d.campaigns=a.get("campaigns");a=Mustache.render(Templates.write,d);c.$el.html(a);c.$el.find("[name=url]").change(function(){c.updateCounter()});
c.afterRender();this.model&&setTimeout(function(){var a=c.model.get("attachments");if("undefined"!=typeof a)for(var b=0;b<a.length;b++)"image"==a[b].type&&c.addUploadedFileToList({name:a[b].name,url:a[b].url,delete_url:"bla"})},100);c.updateCounter();c.$el.find("[name=schedule_random]").click(function(){c.randomTime()});c.$el.find("[data-toggle-id].inactive").hide();c.$el.find("[data-toggle-target]").click(function(){var a=$(this).attr("data-toggle-target"),b;c.$el.find("[data-toggle-id="+a+"]").is(":visible")?
(c.$el.find("[data-toggle-id="+a+"]").hide(),b=!1):(b=!0,c.$el.find("[data-toggle-id="+a+"]").show());$(this).toggleClass("black",b);$(this).toggleClass("blue",!b)}).each(function(){var a=$(this);setTimeout(function(){var b=a.attr("data-toggle-target"),b=c.$el.find("[data-toggle-id="+b+"]").is(":visible");a.toggleClass("black",b);a.toggleClass("blue",!b)},200)});c.$el.find(".inactive[data-toggle-id]").hide();setTimeout(function(){c.trigger("content:change");c.$el.find("#schedule-btn-toggle").toggleClass("black",
c.$el.find(".message-schedule").is(":visible"));c.$el.find("#schedule-btn-toggle").toggleClass("blue",!c.$el.find(".message-schedule").is(":visible"))},200);return this},addUploadedFileToList:function(a){var b=this,c=$(document.createElement("div"));c.addClass("uploaded-file");var d=$(document.createElement("img")),e=$(document.createElement("a"));d.attr("src",a.url);c.append(d);e.html("Delete");e.attr("href","javascript:void(0);");b.files.push(a.url);e.click(function(){for(var d=0;d<b.files.length;d++)if(b.files[d]==
a.url){b.files.splice(d,1);break}c.remove();b.updateCounter();jQuery.ajax({async:!0,cache:!1,data:"",dataType:"json",type:"get",url:a.delete_url})});c.append(e);b.$el.find(".fileupload-feedback").append(c);b.updateCounter()},getValidationRules:function(){var a=this,b=Cloudwalkers.Session.getStreams(),c=[];$.each(b.where({outgoing:1}),function(b,d){a.$el.find("#channel_"+d.id).is(":checked")&&c.push(d.attributes)});for(var b={},d=0;d<c.length;d++)for(var e in c[d].network.limitations)if("undefined"==
typeof b[e])b[e]=c[d].network.limitations[e].limit;else{var f=b[e];"MAXIMUM"==c[d].network.limitations[e].type?f>c[d].network.limitations[e].limit&&(b[e]=c[d].network.limitations[e].limit):"MINIMUM"==c[d].network.limitations[e].type?f<c[d].network.limitations[e].limit&&(b[e]=c[d].network.limitations[e].limit):alert("Unexpected limitation type: "+c[d].network.limitations[e].type)}return b},afterRender:function(){var a=this;a.$el.find("form").find(".channels label").click(function(){var b=$(this);setTimeout(function(){a.$el.find("form").find("input[type=checkbox]#"+
b.attr("for")).is(":checked")?(b.parent().addClass("active"),b.parent().removeClass("inactive")):(b.parent().addClass("inactive"),b.parent().removeClass("active"));a.updateCounter()},100)}).each(function(){var b=$(this);setTimeout(function(){a.$el.find("form").find("input[type=checkbox]#"+b.attr("for")).each(function(){$(this).is(":checked")?(b.parent().addClass("active"),b.parent().removeClass("inactive")):(b.parent().addClass("inactive"),b.parent().removeClass("active"))})},100)});a.$el.find("form").find(".social-icon-colors input[type=checkbox]").hide();
a.$el.find("form").find(".channels label").addClass("inactive");a.$el.find("form").find("h2.schedule-message-title").click(function(){a.$el.find("form").find("div.schedule-message-container").toggle()});a.$el.find("form").find("div.schedule-message-container").hide();a.$el.find("form .fileupload").fileupload({dataType:"json",done:function(b,c){$.each(c.result.files,function(b,c){a.addUploadedFileToList(c)})}})},isClone:function(){return"undefined"!=typeof this.options.clone&&this.options.clone},submit:function(a){a.preventDefault();
var b=this;setTimeout(function(){var c=b.$el.find(a.currentTarget);"Add a title to post"==c.find("input[name=title]").val()&&c.find("input[name=title]").val("");"URL"==c.find("input[name=url]").val()&&c.find("input[name=url]").val("");for(var c=c.serialize(),d=0;d<b.files.length;d++)c+="&files[]="+escape(b.files[d]);d=CONFIG_BASE_URL+"post/?account="+Cloudwalkers.Session.getAccount().get("id");b.model&&!b.isClone()?d+="&id="+b.model.get("id"):b.isClone()&&(c+="&original_message="+b.model.get("id"));
b.draft&&(c+="&draft=true");b.validate(!0)&&(b.trigger("popup:close"),b.$el.html("<p>Please wait, storing message.</p>"),jQuery.ajax({async:!0,cache:!1,data:c,dataType:"json",type:"post",url:d,success:function(a){if(a.success)return b.$el.html("<p>Your message has been scheduled.</p>"),"undefined"!=typeof b.options.redirect&&b.options.redirect||(b.draft?(Cloudwalkers.RootView.alert("Your message was saved."),b.render()):"#schedule"!=window.location.hash?window.location="#schedule":Cloudwalkers.Router.Instance.schedule(null)),
Cloudwalkers.Session.trigger("message:add"),!0;Cloudwalkers.RootView.alert(a.error.message)}}))},1)},validate:function(a){"undefined"==typeof a&&(a=!1);var b=this.$el.find("textarea[name=message]").val().length;this.$el.find(".total-text-counter").html(b);var c=this.getValidationRules(),d=""!=this.$el.find("[name=url]").val()?1:0,e=this.files.length,f=0;"undefined"!=typeof c["picture-url-length"]&&(f+=c["picture-url-length"]*e);"undefined"!=typeof c["picture-url-length"]&&(f+=c["url-length"]*d);"undefined"!=
typeof c["include-title-in-max-length"]&&(d=this.$el.find("input[name=title]").val(),0<d.length&&(f+=d.length,"undefined"!=typeof c["title-spacing-length"]&&(f+=c["title-spacing-length"])));"undefined"==typeof c["max-length"]&&"undefined"!=typeof c["max-length-hardlimit"]&&(c["max-length"]=c["max-length-hardlimit"]);"undefined"!=typeof c["max-length"]?(c["max-length"]-=f,this.$el.find(".total-max-counter").html(c["max-length"]),b>c["max-length"]&&this.$el.find(".error").html("You can only use "+c["max-length"]+
" characters")):this.$el.find(".total-max-counter").html("\u221e");if("undefined"!=typeof c["max-length-hardlimit"]&&b+f>c["max-length-hardlimit"])return a&&this.throwError("You message cannot be longer than "+c["max-length-hardlimit"]+" characters."),!1;this.$el.find(".error").html("");if((b=this.getScheduleDate())&&!this.model&&b<new Date)return a&&this.throwError("Even CloudWalkers is unable to send messages to the past \u00af\\_(\u30c4)_/\u00af"),!1;if(a){if("minutes"==this.$el.find("[name=repeat_delay_unit]").val()&&
0<this.$el.find("[name=repeat_delay_amount]").val()&&20>this.$el.find("[name=repeat_delay_amount]").val())return confirm("Are you sure you want to repeat this message within such a short time?");if(!this.draft&&0==this.$el.find(".channels input[type=checkbox]:checked").length)return this.throwError("Please select at least one stream to send too."),!1}return!0},throwError:function(a){alert(a)},updateCounter:function(){return this.validate()},clearScheduleDate:function(){this.$el.find("select[name=schedule_day]").val("Day");
this.$el.find("select[name=schedule_month]").val("Month");this.$el.find("select[name=schedule_year]").val("Year")},setScheduleDate:function(a){this.$el.find("select[name=schedule_day]").val(a.getDate());this.$el.find("select[name=schedule_month]").val(a.getMonth()+1);this.$el.find("select[name=schedule_year]").val(a.getFullYear());var b=String(15*Math.floor(a.getMinutes()/15));a=String(a.getHours());1==b.length&&(b="0"+b);1==a.length&&(a="0"+a);b=a+":"+b;this.$el.find("select[name=schedule_time]").val(b)},
setWithinDate:function(){var a=this.$el.find("[name=delay]:checked").val(),b=new Date;b.setSeconds(a);this.setScheduleDate(b);this.$el.find("[name=schedule_random]").prop("checked",!1).trigger("change");this.trigger("content:change")},getScheduleDate:function(){var a=new Date;if("Day"!=this.$el.find("select[name=schedule_day]").val())a.setDate(this.$el.find("select[name=schedule_day]").val());else return!1;if("Month"!=this.$el.find("select[name=schedule_month]").val())a.setMonth(this.$el.find("select[name=schedule_month]").val()-
1);else return!1;if("Year"!=this.$el.find("select[name=schedule_year]").val())a.setFullYear(this.$el.find("select[name=schedule_year]").val());else return!1;if("Time"!=this.$el.find("select[name=schedule_time]").val()){var b=this.$el.find("select[name=schedule_time]").val().split(":");2==b.length&&(a.setHours(b[0]),a.setMinutes(b[1]))}else return!1;return a},getSelectedDate:function(){var a=new Date,b=new Date;b.setFullYear(a.getFullYear(),a.getMonth(),a.getDate());b.setHours(0,0,0,0);"Day"!=this.$el.find("select[name=schedule_day]").val()&&
b.setDate(this.$el.find("select[name=schedule_day]").val());"Month"!=this.$el.find("select[name=schedule_month]").val()&&b.setMonth(this.$el.find("select[name=schedule_month]").val()-1);"Year"!=this.$el.find("select[name=schedule_year]").val()&&b.setFullYear(this.$el.find("select[name=schedule_year]").val());return b},randomTime:function(){var a=this.getSelectedDate(),b=[{start:480,end:540},{start:735,end:840},{start:1140,end:1439}][Math.floor(3*Math.random())],c=new Date,b=b.start+Math.random()*
(b.end-b.start);a.setMinutes(b);a<c&&(a=new Date,a.setHours(c.getHours()+1));this.setScheduleDate(a);this.resetWithin(!1);this.trigger("content:change")},resetWithin:function(a){"undefined"==typeof a&&(a=!0);this.$el.find("[name=delay]").prop("checked",!1).trigger("change");a&&this.$el.find("[name=schedule_random]").prop("checked",!1).trigger("change");var b=this;setTimeout(function(){b.trigger("content:change")},1);"Year"==this.$el.find("select[name=schedule_year]").val()&&this.$el.find("select[name=schedule_year]").val((new Date).getFullYear())},
toggleSchedule:function(){if(!this.getScheduleDate()){var a=new Date;a.setMinutes(a.getMinutes()+15);this.setScheduleDate(a)}this.$el.find(".message-schedule").toggleClass("hidden");this.$el.find("#schedule-btn-toggle").toggleClass("black",this.$el.find(".message-schedule").is(":visible"));this.$el.find("#schedule-btn-toggle").toggleClass("blue",!this.$el.find(".message-schedule").is(":visible"));this.trigger("content:change")},shortenUrl:function(a){a.preventDefault();var b=this.$el.find("[name=url]"),
c=this.$el.find("[name=message]");$.getJSON("http://wlk.rs/api/shorten?callback=?",{url:b.val(),output:"jsonp",format:"json"}).done(function(a){a.shortUrl?(c.val(c.val()+" "+a.shortUrl),b.val("")):Cloudwalkers.RootView.alert(a.error.message)})}});Cloudwalkers.Views.Comments=Backbone.View.extend({events:{"click .load-more-comments a":"loadMore"},render:function(){var a=this,b={},c=a.options.parent.getStream();b.textfields=c.get("textfields");$(this.el).html(Mustache.render(Templates.comments,b));a.$el.find(".loading-comments").show();a.$el.find(".load-more-comments").hide();a.$el.find(".comments-inner-container").hide();a.$el.find(".no-comments").hide();this.collection=b=new Cloudwalkers.Collections.Comments({id:this.options.parent.get("id")});
this.options.parent.on("change",function(){a.collection.fetch()});b.fetch({success:function(){a.$el.find(".comments-inner-container").show();a.$el.find(".loading-comments").hide();0==a.collection.length%10&&a.$el.find(".load-more-comments").show();0==a.collection.length&&(a.$el.find(".load-more-comments").hide(),a.$el.find(".no-comments").show(),a.$el.find(".comments-inner-container").hide())}});b.bind("add",this.addOne,this);b.bind("refresh",this.refresh,this);b.bind("reset",this.refresh,this);b.bind("remove",
this.removeMessage,this);return this},addOne:function(a){var b=a.collection.indexOf(a),c=!1;this.options.selectedchild&&(c=this.options.selectedchild.get("id")==a.get("id"));c=(new Cloudwalkers.Views.Comment({model:a,selected:c})).render().el;$(c).attr("data-message-id",a.get("id"));0===b?this.$el.find(".comments-inner-container").prepend(c):0<this.$el.find(".comments-inner-container .comments-row").eq(b-1).length?this.$el.find(".comments-inner-container .comments-row").eq(b-1).after(c):this.$el.find(".comments-inner-container").append(c)},
refresh:function(){this.$el.find(".messages-container").html("");this.options.channel.each(this.addOne,this);if(0==this.options.channel.length){var a=this.options.parent.getStream();this.$el.find(".comments-inner-container").html("<p>"+a.get("textfields").nochildren+"</p>")}},removeMessage:function(a){this.$el.find(".comments-inner-container [data-message-id="+a.get("id")+"]").remove()},loadMore:function(){var a=this;this.collection.loadMore({success:function(){a.$el.find(".loading-comments").hide();
0==a.collection.length%10&&0<a.collection.length&&a.$el.find(".load-more-comments").show()}});this.$el.find(".loading-comments").show();this.$el.find(".load-more-comments").hide()}});Cloudwalkers.Views.Comment=Cloudwalkers.Views.Message.extend({events:{"click .button-post.action.comment-message-action":"messageAction"},initialize:function(){var a=this;this.options.template="comment";this.model.on("change",function(){a.render()})},className:"comments-row",tagName:"li",additionalData:function(a){a.parent=!1;return a},afterRender:function(){this.options.selected&&this.$el.addClass("selected");this.delegateEvents(this.events)}});Cloudwalkers.Views.Notification=Backbone.View.extend({tagName:"li",template:"message",initialize:function(a){a&&$.extend(this,a);this.model.on("change",this.render.bind(this))},render:function(){var a={from:this.model.get("from"),body:this.model.get("body"),attachments:{}};this.model.get("date")&&(a.fulldate=moment(this.model.get("date")).format("DD MMM"));this.model.get("attachments")&&$.each(this.model.get("attachments"),function(b,c){a.attachments[c.type]=c});this.active&&this.$el.addClass("active");
this.$el.html(Mustache.render(Templates[this.template],a));this.model.get("objectType")&&0===this.model.get("read")&&this.markasread();return this},markasread:function(){this.model.save({read:1},{patch:!0,wait:!0});this.model.get("stream")&&Cloudwalkers.Session.getStreams().outdated(this.model.get("stream"))}});Cloudwalkers.Views.Widgets.MessageContainer=Cloudwalkers.Views.Widgets.Widget.extend({template:"messagecontainer",messageelement:"tr",canLoadMore:!0,events:{"click .load-more a":"loadMore"},initialize:function(){this.title=this.options.channel.name;this.canLoadMore="undefined"==typeof this.options.channel.canLoadMore?!0:this.options.channel.canLoadMore;this.initializeWidget()},refreshWidget:function(a){a.preventDefault();this.options.channel.update()},innerRender:function(a){var b=this,c={};jQuery.extend(!0,
c,this.options);c.showMoreButton="undefined"!=typeof this.options.channel.showMoreButton?this.options.channel.showMoreButton:!1;a.html(Mustache.render(Templates[this.template],c));a.find(".load-more").hide();a.find(".timeline-loading").show();this.options.channel.bind("sort",this.resort,this);this.options.channel.bind("remove",this.removeMessage,this);Cloudwalkers.Session.bind("message:add",function(){b.options.channel.reset();b.options.channel.fetch()},this);this.options.channel.fetch({success:function(c){b.canLoadMore&&
"undefined"!=typeof b.options.channel.loadMore&&(0<b.options.channel.length&&a.find(".load-more").show(),a.find(".timeline-loading").hide());a.find(".inner-loading").toggleClass(b.options.channel.length?"inner-loading":"inner-empty inner-loading");b.afterInit()}});this.interval=setInterval(function(){b.options.channel.update()},15E3);return this},loadMore:function(){var a=this;this.options.channel.loadMore({success:function(){a.$el.find(".timeline-loading").hide();a.$el.find(".load-more").show()}});
this.$el.find(".timeline-loading").show();this.$el.find(".load-more").hide()},onDestroy:function(){clearInterval(this.interval);this.$el.find(".scroller").slimScroll({destroy:1})},processMessageView:function(a){},getMessageView:function(a){var b;b=new Cloudwalkers.Views.Message({model:a,template:this.messagetemplate,tagName:this.messageelement});this.processMessageView(a,b);return b},onFirstAddEvent:function(a,b){var c=this;setTimeout(function(){c.onFirstAdd(a,b)},1)},onFirstAdd:function(a,b){},afterInit:function(){},
resort:function(){var a=this;a.$el.find("p.no-current-messages").remove();this.options.channel.each(function(b){var c=a.$el.find(".messages-container .message-view[data-message-id="+b.get("id")+"]"),d=b.collection.indexOf(b);if(!(0<c.length)){var e=a.getMessageView(b),c=e.render().el;$(c).attr("data-message-id",b.get("id"));if(0==d)a.onFirstAdd(b,e)}0==d?a.$el.find(".messages-container").prepend(c):(b=b.collection.at(d-1),b=a.$el.find(".messages-container .message-view[data-message-id="+b.get("id")+
"]"),0<b.length?b.after(c):console.log("PREVIOUS MESSAGE NOT FOUND"))});setTimeout(function(){a.trigger("content:change")},1)},removeMessage:function(a){this.$el.find(".messages-container .message-view[data-message-id="+a.get("id")+"]").remove()},refresh:function(){}});Cloudwalkers.Views.Widgets.MessageList=Cloudwalkers.Views.Widgets.MessageContainer.extend({messagetemplate:"messagelist"});Cloudwalkers.Views.Widgets.DashboardMessageList=Cloudwalkers.Views.Widgets.MessageContainer.extend({template:"dashboardmessagecontainer",messagetemplate:"dashboardmessage",entries:[],initialize:function(a){a&&$.extend(this,a);this.model.messages||(this.model.messages=new Cloudwalkers.Collections.Messages);this.listenTo(this.model.messages,"seed",this.fill);this.initializeWidget()},render:function(){this.$el.html(Mustache.render(Templates.dashboardmessagecontainer,this.options));this.$container=this.$el.find(".messages-container");
this.type="news"==this.type||"profiles"==this.type?"trending":this.type;this.options.filters||(this.options.filters={});this.options.filters.records=10;this.model.messages.touch(this.model,this.filters);return this},fill:function(a){this.$el.find(".inner-loading").toggleClass(a.length?"inner-loading":"inner-empty inner-loading");$.each(this.entries,function(a,b){b.remove()});this.entries=[];for(n in a){this.link&&(a[n].link=this.link);var b=new Cloudwalkers.Views.Entry({model:a[n],template:"smallentry",
type:this.type});this.entries.push(b);this.$container.append(b.render().el)}},fail:function(){Cloudwalkers.RootView.growl("Oops","Something went sideways, please reload the page.")}});Cloudwalkers.Views.Widgets.DetailedList=Cloudwalkers.Views.Widgets.MessageContainer.extend({template:"detailedlist",messagetemplate:"messagedetailedlist",messageelement:"tr",id:"inbox",currentSelected:null,render:function(){var a=this;this.$innerEl=this.$el;this.innerRender(this.$innerEl);this.$el.attr("id","list");this.on("content:change",function(){a.maximizeView();a.currentSelected&&a.currentSelected.$el.find("td").addClass("active")});return this},processMessageView:function(a,b){var c=this;b.$el.click(function(){c.$el.find("td").removeClass("active");
c.currentSelected=b;c.currentSelected.$el.find("td").addClass("active");c.trigger("select:message",a)})},onFirstAdd:function(a,b){this.options.selectmessage||setTimeout(function(){b.$el.click()},100)},afterInit:function(){this.options.selectmessage&&this.$el.find(".messages-container").find("[data-message-id="+this.options.selectmessage+"]").click()},maximizeView:function(){var a=$("#inner-content").height()-90;$("#inboxcontainer, #list .portlet-body").css({height:a+"px","max-height":a+"px"});this.addScroll()},
addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",position:"right",height:"auto",alwaysVisible:!1,railVisible:!1,disableFadeOut:!0})}});Cloudwalkers.Views.Widgets.CoworkersFilters=Cloudwalkers.Views.Widgets.Widget.extend({filters:{users:{string:"",list:[]}},events:{remove:"destroy","input .input-rounded":"comparesuggestions","click .load-more":"more"},initialize:function(a){a&&$.extend(this,a);this.model.childtype="message";this.model.users?this.model.users.reset():this.model.users=new Cloudwalkers.Collections.Users;this.listenTo(this.model.users,"add",this.comparesuggestions)},render:function(){this.$el.html(Mustache.render(Templates.coworkersfilters));
this.$container=this.$el.find("#users-list").eq(0);return this},comparesuggestions:function(a){var b=$("#filter_contacts input").val();if(b)b=b.toLowerCase();else return this.hidesuggestions();var c=this.model.users.filter(this.comparenamefilter.bind(this,b));5>c.length&&(!a.cid&&2<b.length)&&this.requestusers(b);if(c.length)this.showsuggestions(c.slice(0,10));else return this.hidesuggestions()},comparenamefilter:function(a,b){return 0<=b.get("displayname").toLowerCase().indexOf(a)||b.get("name")&&
0<=b.get("name").toLowerCase().indexOf(a)},hidesuggestions:function(){this.fill(this.model.users.models)},showsuggestions:function(a){this.fill(a)},requestusers:function(a){a!=this.filters.users.string&&(this.model.users.processing?this.filters.users.buffered=a:(this.$el.find(".loading-contacts").removeClass("hidden"),this.filters.users.string=a,this.model.users.fetch({remove:!1,parameters:{q:a},success:this.loadedusers.bind(this)})))},loadedusers:function(){this.$el.find(".loading-contacts").addClass("hidden");
this.filters.users.buffered&&(this.requestusers(this.filters.users.buffered),this.filters.users.buffered=!1)},filter:function(a){$(a.currentTarget).toggleClass("inactive active");a=this.$el.find(".filter.keyword-list .active");var b=[];if(!a.size())return this.list.$container.empty();a.each(function(){b.push($(this).attr("data-keyword-id"))});a=this.$el.find(".filter.network-list .active");var c=[];if(!a.size())return this.list.$container.empty();a.each(function(){c=c.concat($(this).attr("data-network-streams").split(" "))});
this.category.messages.touch(this.category,{records:40,channels:b.join(","),streams:c.join(",")});return this},fill:function(a){$.each(this.entries,function(a,b){b.remove()});this.entries=[];for(n in a){var b=new Cloudwalkers.Views.User({model:a[n],template:"smalluser",type:"listitem"});this.entries.push(b);this.listenTo(b,"select",this.select);this.$container.append(b.render().el)}this.$el.find(".inner-loading").removeClass("inner-loading")},select:function(a){this.list.render({users:a.model.id,
records:20})}});Cloudwalkers.Views.Widgets.CoworkersList=Cloudwalkers.Views.Widgets.Widget.extend({id:"coworkersparent",title:"Co-workers messages",parameters:{records:20},entries:[],events:{remove:"destroy","click .load-more":"more"},initialize:function(a){a&&$.extend(this,a);this.model.messages||(this.model.messages=new Cloudwalkers.Collections.Messages);this.listenTo(this.model.messages,"seed",this.fill);this.listenTo(this.model.messages,"request",this.showloading)},render:function(a){this.$el.html(Mustache.render(Templates.coworkerslist,
{title:this.title}));this.$container=this.$el.find(".messages-container");this.$el.find(".load-more").hide();this.model.messages.touch(this.model,a?a:this.paramters);return this},showloading:function(){this.$el.find(".icon-cloud-download").show();this.$el.find(".load-more").hide()},hideloading:function(){this.$el.find(".icon-cloud-download").hide();this.$el.find(".load-more").show();this.$container.removeClass("inner-loading")},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,
function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],type:"full",template:"coworkersmessage"});this.entries.push(b);a[n].get("from")?this.model.seedusers(a[n]):this.listenTo(a[n],"change:from",this.model.seedusers.bind(this.model));this.$container.append(b.render().el)}this.hideloading()},more:function(){this.incremental=!0;this.model.messages.more(this.model,this.model.parameters)||this.$el.find(".load-more").hide()},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,
"destroy:view",this.remove);this.addScroll()},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",color:"#a1b2bd",height:$("#inner-content").height()-165+"px",alwaysVisible:!1,railVisible:!1})},destroy:function(){$.each(this.entries,function(a,b){b.remove()})}});Cloudwalkers.Views.Widgets.MonitorFilters=Cloudwalkers.Views.Widgets.Widget.extend({events:{"click [data-network-streams]":"filter","click [data-keyword-id]":"filter"},initialize:function(){this.category=this.options.category;this.category.childtype="message";this.streams=[];this.category.channels.each(function(a){this.streams=this.streams.concat(a.streams.models)},this);this.initializeWidget()},render:function(){var a={keywords:this.category.channels.models};a.name=this.category.get("name");a.networks=
Cloudwalkers.Session.getStreams().filterNetworks(this.streams,!0);this.$el.html(Mustache.render(Templates.channelfilters,a));a.networks.length||this.$el.find(".building-notice").toggleClass("inactive");this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove);return this},filter:function(a){$(a.currentTarget).toggleClass("inactive active");a=this.$el.find(".filter.keyword-list .active");var b=[];if(!a.size())return this.list.$container.empty();a.each(function(){b.push($(this).attr("data-keyword-id"))});
a=this.$el.find(".filter.network-list .active");var c=[];if(!a.size())return this.list.$container.empty();a.each(function(){c=c.concat($(this).attr("data-network-streams").split(" "))});this.category.messages.touch(this.category,{records:40,channels:b.join(","),streams:c.join(",")});return this}});Cloudwalkers.Views.Widgets.MonitorList=Cloudwalkers.Views.Widgets.Widget.extend({id:"monitorparent",entries:[],events:{remove:"destroy","click .load-more":"more"},initialize:function(){this.category=this.options.category;this.category.set({messages:[]});this.listenTo(this.category.messages,"seed",this.fill);this.listenTo(this.category.messages,"request",this.showloading);this.listenTo(this.category.messages,"sync",this.hideloading)},render:function(){this.$el.html(Mustache.render(Templates.monitorlist,
{name:this.category.get("name")}));this.$container=this.$el.find(".messages-container");this.$el.find(".load-more").hide();this.category.messages.touch(this.category,{records:40});return this},showloading:function(){this.$el.find(".icon-cloud-download").show();this.$el.find(".load-more").hide()},hideloading:function(){this.$el.find(".icon-cloud-download").hide();this.$el.find(".load-more").show();this.$container.removeClass("inner-loading")},fill:function(a){this.incremental?this.incremental=!1:($.each(this.entries,
function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],type:"full",template:"messagefullentry"});this.entries.push(b);this.$container.append(b.render().el)}},more:function(){this.incremental=!0;this.category.messages.more(this.category,this.category.parameters)||this.$el.find(".load-more").hide()},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove);this.addScroll()},addScroll:function(){this.$el.find(".scroller").slimScroll({size:"6px",
color:"#a1b2bd",height:$("#inner-content").height()-165+"px",alwaysVisible:!1,railVisible:!1})},destroy:function(){$.each(this.entries,function(a,b){b.remove()})}});Cloudwalkers.Views.Widgets.KeywordsEditor=Cloudwalkers.Views.Widgets.Widget.extend({events:{"submit form[data-add-category]":"addCategory","click button.add-keyword":"addKeyword","click button.update-keyword":"updateKeyword","click .cancel-edit-keyword":"render","click button[data-keyword-filter]":"toggleFilter"},initialize:function(){this.channel=Cloudwalkers.Session.getChannel("monitoring");this.listenTo(Cloudwalkers.Session.getChannels(),"sync",this.render);this.listenTo(Cloudwalkers.Session.getChannels(),
"remove",this.render)},render:function(a){a&&a.preventDefault&&a.preventDefault();a=Cloudwalkers.Session.getAccount();var b=a.get("filteroptions");b||a.fetch({endpoint:"filteroptions",success:this.render.bind(this)});this.$el.html(Mustache.render(Templates.keywordseditor,{filteroptions:b,categories:this.channel.channels.models}));this.$el.find("select").chosen({width:"100%"});return this},addCategory:function(a){a.preventDefault();a={name:$("#category_create_name").val()};this.channel.channels.create(a,
{parent:this.channel.id,wait:!0});this.$el.find(".addcategory .icon-cloud-upload").show()},addKeyword:function(a){a.preventDefault();a=Cloudwalkers.Session.getChannel(Number($("#keyword_manage_category").val()));a.channels.create(this.keywordParameters(),{parent:a.id,wait:!0});this.$el.find(".managekeyword .icon-cloud-upload").show()},fillKeyword:function(a,b){b.preventDefault();this.render();this.$el.find(".add-keyword, .edit-keyword").toggleClass("inactive");var c=this.editing=Cloudwalkers.Session.getChannel(a),
d=c.get("settings");$('#keyword_manage_category option[value="'+c.get("parent")+'"]').attr("selected","selected");$("#keyword_manage_name").val(c.get("name"));$("#filter_include").val(d.include?d.include.join(", "):"");$("#filter_exclude").val(d.exclude?d.exclude.join(", "):"");for(n in d.languages)$('#filter_languages option[value="'+d.languages[n]+'"]').attr("selected","selected");for(n in d.countries)$('#filter_countries option[value="'+d.countries[n]+'"]').attr("selected","selected");this.$el.find("select").trigger("chosen:updated")},
updateKeyword:function(a){a.preventDefault();this.editing.save(this.keywordParameters());this.$el.find(".managekeyword .icon-cloud-upload").show()},keywordParameters:function(){var a={name:$("#keyword_manage_name").val(),settings:{}};$("#filter_include").val()&&(a.settings.include=$("#filter_include").val().split(","));$("#filter_exclude").val()&&(a.settings.exclude=$("#filter_exclude").val().split(","));if(a.settings.include&&a.settings.include.length)for(n in a.settings.include)a.settings.include[n]=
a.settings.include[n].trim();if(a.settings.exclude&&a.settings.exclude.length)for(n in a.settings.exclude)a.settings.exclude[n]=a.settings.exclude[n].trim();a.settings.languages=$("#filter_languages").val();a.settings.countries=$("#filter_countries").val();return a},toggleFilter:function(a){a.preventDefault();a=$(a.target).attr("data-keyword-filter");this.$el.find("div[data-keyword-filter="+a+"]").toggleClass("inactive")}});Cloudwalkers.Views.Widgets.KeywordsOverview=Cloudwalkers.Views.Widgets.Widget.extend({id:"monitorparent",entries:[],events:{"submit form":"editCategory","click .edit-toggler":"toggleEditCategory","click .delete-category":"deleteCategory","click .delete-keyword":"deleteKeyword","click [data-keyword]":"toggleEditKeyword"},initialize:function(){this.channel=Cloudwalkers.Session.getChannel("monitoring");this.editor=this.options.editor;this.listenTo(Cloudwalkers.Session.getChannels(),"sync",this.render)},
render:function(){categories=this.channel.channels.map(function(a){return{id:a.id,name:a.get("name"),keywords:a.channels.models}});this.$el.html(Mustache.render(Templates.keywordsoverview,{categories:categories}));return this},toggleEditCategory:function(a){a.stopPropagation();$(a.target).closest("[data-category]").find(".category-name, .category-edit").toggle()},editCategory:function(a){a.stopPropagation();a=$(a.target).closest("[data-category]");var b=a.find('[name="name"]').val();Cloudwalkers.Session.getChannel(Number(a.attr("data-category"))).save({name:b});
a.find("h4").html(b);return!1},deleteCategory:function(a){a.stopPropagation();a=$(a.target).closest("[data-category]");Cloudwalkers.Session.getChannel(Number(a.attr("data-category"))).destroy();a.next().remove();a.remove()},toggleEditKeyword:function(a){a.stopPropagation();var b=Number($(a.target).closest("[data-keyword]").attr("data-keyword"));this.editor.fillKeyword(b,a)},deleteKeyword:function(a){a.stopPropagation();var b=Number($(a.target).closest("[data-keyword]").attr("data-keyword"));Cloudwalkers.Session.getChannel(b).destroy();
$(a.target).parent().remove()}});Cloudwalkers.Views.Widgets.DetailedView=Cloudwalkers.Views.Widgets.Widget.extend({id:"inbox",initialize:function(){var a=this;this.options.list.on("select:message",function(b){a.selectMessage(b)})},selectMessage:function(a){var b=a.get("parentmodel"),c=null;b&&(c=a,a=b);a=new Cloudwalkers.Views.Message({model:a,selectedchild:c,template:"messagedetailview",childtemplate:"messagedetailviewchild",originaltemplate:"messagedetailoriginal",tagName:"div",showcomments:!0});this.$el.html(a.render().el);this.setHeight(a.$el)},
render:function(){this.$el.html("");return this},setHeight:function(a){a.css("height",$("#inboxcontainer").height()-16+"px")}});Cloudwalkers.Views.Widgets.InboxMessageList=Cloudwalkers.Views.Widgets.Widget.extend({id:"inboxlist",entries:[],collectionstring:"messages",filters:{contacts:{string:"",list:[]},streams:[]},events:{remove:"destroy","click [data-toggle]":"togglefilter","input .input-rounded":"comparesuggestions","click [data-contact]":"filtercontacts","click [data-close-contact]":"filtercontacts","click [data-streams]":"filterstreams","click .load-more":"more"},initialize:function(){this.model=this.options.channel;
this.collection=this.model[this.collectionstring];this.listenTo(this.collection,"seed",this.fill);this.listenTo(this.collection,"request",this.showloading);this.listenTo(this.collection,"sync",this.hideloading);this.listenTo(this.model.contacts,"add",this.comparesuggestions)},render:function(){var a={streams:[],networks:this.model.streams.filterNetworks(null,!0)};this.model.streams.each(function(b){a.streams.push({id:b.id,icon:b.get("network").icon,name:b.get("defaultname")})});this.$el.html(Mustache.render(Templates.inboxlist,
a));this.$container=this.$el.find("ul.list");this.collection.touch(this.model,{records:50,group:1});return this},showloading:function(){this.$container.addClass("inner-loading");$(".inbox").addClass("loading");this.$el.find(".load-more").hide()},hideloading:function(a,b){a.cursor&&b.channel[this.collectionstring].length&&this.$el.find(".load-more").show();$(".inbox").removeClass("loading");this.$container.removeClass("inner-loading")},hidemore:function(){this.$el.find(".load-more").hide()},fill:function(a){this.incremental?
this.incremental=!1:($.each(this.entries,function(a,b){b.remove()}),this.entries=[]);for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],template:"smallentry",type:"inbox"});this.entries.push(b);this.listenTo(b,"toggle",this.toggle);this.$container.append(b.render().el);this.model.seedcontacts(a[n])}this.entries.length?setTimeout(this.toggle.bind(this,this.entries[0]),1):this.hidemore()},toggle:function(a){this.inboxmessage&&this.inboxmessage.remove();this.inboxmessage=new Cloudwalkers.Views.Widgets.InboxMessage({model:a.model});
$(".inbox-container").html(this.inboxmessage.render().el);this.inboxmessage.showrelated(a.model);this.$el.find(".list .active").removeClass("active");a.$el.addClass("active")},togglefilter:function(a){a=$(a.currentTarget);var b=a.data("toggle"),c=a.hasClass("selected");$("[data-toggle].selected").removeClass("selected");$("[id^=filter_]").addClass("hidden");c||(a.addClass("selected"),$("#filter_"+b).removeClass("hidden"))},comparesuggestions:function(a){var b=$("#filter_contacts input").val();if(b)b=
b.toLowerCase();else return this.hidesuggestions();var c=this.model.contacts.filter(this.comparenamefilter.bind(this,b));5>c.length&&(!a.cid&&2<b.length)&&this.requestcontacts(b);if(c.length)this.showsuggestions(c.slice(0,10));else return this.hidesuggestions()},comparenamefilter:function(a,b){return 0<=b.get("displayname").toLowerCase().indexOf(a)||b.get("name")&&0<=b.get("name").toLowerCase().indexOf(a)},showsuggestions:function(a){this.$el.find("#filter_contacts label").removeClass("hidden");this.$el.find("ul.contacts-suggestions").empty();
for(n in a)this.$el.find("ul.contacts-suggestions").append(Mustache.render(Templates.contactsuggestionentry,a[n].attributes))},hidesuggestions:function(){this.$el.find("#filter_contacts label").addClass("hidden");this.$el.find("ul.contacts-suggestions").empty()},requestcontacts:function(a){a!=this.filters.contacts.string&&(this.model.contacts.processing?this.filters.contacts.buffered=a:(this.$el.find(".loading-contacts").removeClass("hidden"),this.filters.contacts.string=a,this.model.contacts.fetch({remove:!1,
parameters:{q:a,channels:this.model.id},success:this.loadedcontacts.bind(this)})))},loadedcontacts:function(){this.$el.find(".loading-contacts").addClass("hidden");this.filters.contacts.buffered&&(this.requestcontacts(this.filters.contacts.buffered),this.filters.contacts.buffered=!1)},filtercontacts:function(a){a=$(a.currentTarget);if(a.data("contact"))a=Cloudwalkers.Session.getContact(a.data("contact")),0>this.filters.contacts.list.indexOf(a.id)&&(this.filters.contacts.list.push(a.id),this.$el.find("ul.contacts-placeholder").append(Mustache.render(Templates.contactselectedentry,
a.attributes)));else{var b=a.data("close-contact");this.filters.contacts.list=this.filters.contacts.list.filter(function(a){return a!=b});this.$el.find("[data-close-contact="+b+"]").parent().remove()}this.collection.touch(this.model,this.filterparameters());return this},filterstreams:function(a){a=$(a.currentTarget);var b=[];a.active=a.toggleClass("inactive active").hasClass("active");this.$el.find("div[data-streams].active");$(a.attr("data-streams").split(" ").map(function(a){return'[data-streams~="'+
a+'"]'}).join(",")).removeClass(a.active?"inactive":"active").addClass(a.active?"active":"inactive");this.$el.find("li[data-streams].active").each(function(){b.push($(this).data("streams"))});$(b.map(function(a){return'div[data-streams~="'+a+'"]'}).join(",")).removeClass("inactive").addClass("active");this.filters.streams=b;if(!b.length)return this.$container.empty(),$(".inbox-container").empty();this.collection.touch(this.model,this.filterparameters());return this},filterparameters:function(){var a=
{records:20,group:1};this.filters.contacts.list.length&&(a.contacts=this.filters.contacts.list.join(","));this.filters.streams.length&&(a.streams=this.filters.streams.join(","));return a},more:function(){this.incremental=!0;this.collection.more(this.model,this.filterparameters())||this.$el.find(".load-more").hide()},negotiateFunctionalities:function(){this.listenTo(Cloudwalkers.Session,"destroy:view",this.remove);this.addScroll()},addScroll:function(){this.$el.find(".scroller").slimScroll({height:"inherit"})},
destroy:function(){$.each(this.entries,function(a,b){b.remove()})}});Cloudwalkers.Views.Widgets.InboxNotificationList=Cloudwalkers.Views.Widgets.InboxMessageList.extend({collectionstring:"notifications",toggle:function(a){this.inboxmessage&&this.inboxmessage.remove();a.model.get("parent")?this.showmessage(a.model):this.listenToOnce(a.model,"change",this.showmessage);this.$el.find(".list .active").removeClass("active");a.$el.addClass("active")},showmessage:function(a){var b=Cloudwalkers.Session.getMessage(a.get("parent").id);b||(b=new Cloudwalkers.Models.Message({id:a.get("parent").id}));
this.model.messages.add(b);b.get("objectType")||b.fetch();this.inboxmessage=new Cloudwalkers.Views.Widgets.InboxMessage({model:b,notification:a});$(".inbox-container").html(this.inboxmessage.render().el)}});Cloudwalkers.Views.Widgets.InboxMessage=Cloudwalkers.Views.Entry.extend({tagName:"div",className:"message social-box-colors",related:[],notifications:[],events:{remove:"destroy","click *[data-action]":"action"},initialize:function(){this.message=this.options.model;this.listenTo(this.message,"change",this.render)},render:function(){this.loading(!this.message.get("objectType"));var a={};$.extend(a,this.message.attributes);a.date&&(a.fulldate=moment(a.date).format("DD MMM YYYY HH:mm"));a.attachments&&
(a.attachments={},$.each(this.message.get("attachments"),function(b,d){a.attachments[d.type]=d}));if(this.message.get("stream")){var b=Cloudwalkers.Session.getStream(this.message.get("stream"));a.icon=b.get("network").icon;a.networkdescription=b.get("defaultname");a.stream=b}this.options.notification&&(a.commented={from:this.options.notification.get("from")[0],timeago:moment(this.options.notification.get("date")).fromNow()});this.$el.html(Mustache.render(Templates.inboxmessage,a));this.options.notification&&
this.message.get("objectType")&&this.addNotifications();this.message.get("objectType")&&!this.message.get("read")&&this.markasread();return this},loading:function(a){a?$(".inbox").addClass("loading"):$(".inbox").removeClass("loading")},showrelated:function(){this.loading(!0);this.$related=$("<ul></ul>");this.$el.after(this.$related.addClass("related-messages social-box-colors"));this.message.related||(this.message.related=new Cloudwalkers.Collections.Messages({modelstring:"related",typestring:"related",
parenttype:"message"}));this.listenTo(this.message.related,"seed",this.fillrelated);this.message.related.touch(this.message,{records:20})},fillrelated:function(a){this.incremental?this.incremental=!1:($.each(this.related,function(a,b){b.remove()}),this.related=[]);a=a.filter(function(a){return a.id!=this.message.id}.bind(this));for(n in a){var b=new Cloudwalkers.Views.Entry({model:a[n],template:"inboxrelatedmessage",type:"inbox"});this.related.push(b);this.$related.append(b.render().el)}this.loading(!1)},
addNotifications:function(){this.loading(!0);this.message.notifications||(this.message.notifications=new Cloudwalkers.Collections.Notifications);this.listenTo(this.message.notifications,"seed",this.fillNotifications);this.message.notifications.touch(this.message,{records:50,group:1})},fillNotifications:function(a){this.notifications.length&&($.each(this.notifications,function(a,b){b.remove()}),this.notifications=[]);a.models&&(a=a.models);var b=this.$el.find(".message-comments ul").eq(0).html("");
for(n in a){var c=new Cloudwalkers.Views.Notification({model:a[n],template:"inboxcomment",active:a[n].id==this.options.notification.id});this.notifications.push(c);b.append(c.render().el)}this.loading(!1)},markasread:function(){this.message.save({read:1},{patch:!0,wait:!0});Cloudwalkers.Session.getStreams().outdated(this.message.get("stream"))},destroy:function(){$.each(this.notifications,function(a,b){b.remove()})}});Cloudwalkers.Views.Widgets.Timeline=Cloudwalkers.Views.Widgets.MessageContainer.extend({template:"timeline",messagetemplate:"messagetimeline",messageelement:"li",render:function(){if("undefined"!=typeof this.options.title)this.title=this.options.title;else{var a=this.options.channel.getFilters();"undefined"!=typeof a.streams&&0<a.streams.length&&(a=Cloudwalkers.Session.getStream(a.streams[0]))&&(this.title=a.customname)}"undefined"!=typeof this.options.color&&(this.color=this.options.color);this.$el.html(Mustache.render(Templates.widgetnoborder,
{color:this.color}));this.$innerEl=$(this.$el.find(".portlet-body"));this.innerRender(this.$innerEl);return this}});Cloudwalkers.Views.Widgets.ScheduledList=Cloudwalkers.Views.Widgets.MessageContainer.extend({messagetemplate:"messageschedulelist"});Cloudwalkers.Views.Widgets.ScheduledTable=Cloudwalkers.Views.Widgets.MessageContainer.extend({messagetemplate:"messageschedule",template:"messageschedulecontainer"});Cloudwalkers.Views.Widgets.DraftList=Cloudwalkers.Views.Widgets.MessageContainer.extend({template:"messagedraftcontainer",messagetemplate:"messagedraft"});Cloudwalkers.Views.Widgets.Datepicker=Cloudwalkers.Views.Widgets.Widget.extend({title:"Date range",icon:"calendar",color:"grey",start:Date.today().add({days:-6}),end:Date.today().add({days:1}),events:{"submit form":"submit"},getDateRange:function(){return[this.start,this.end]},render:function(){var a=this.$el,b=this;a.html(Mustache.render(Templates.datepicker,{}));a.find(".dashboard-report-range").daterangepicker({ranges:{"Last 2 Days":[Date.today().add({days:-1}),"today"],"Last 5 Days":[Date.today().add({days:-4}),
"today"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 10 Days":[Date.today().add({days:-9}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})]},opens:App.isRTL()?"right":"left",format:"MM/dd/yyyy",separator:" to ",startDate:this.start,endDate:this.end,locale:{applyLabel:"Submit",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom Range",
daysOfWeek:"Su Mo Tu We Th Fr Sa".split(" "),monthNames:"January February March April May June July August September October November December".split(" "),firstDay:1},showWeekNumbers:!0,buttonClasses:["btn-danger"]},function(c,d){a.find(".dashboard-report-range span").html(c.toString("MMMM d, yyyy")+" - "+d.toString("MMMM d, yyyy"));b.trigger("date:change",c,(new Date(d.getTime())).add({days:1}))});a.find(".dashboard-report-range").show();a.find(".dashboard-report-range span").html(this.start.toString("MMMM d, yyyy")+
" - "+(new Date(this.end)).add({days:-1}).toString("MMMM d, yyyy"));return this}});Cloudwalkers.Views.Widgets.MessagesCounters=Cloudwalkers.Views.Widgets.Widget.extend({entries:[],events:{"input .input-rounded":"comparesuggestions","click [data-contact]":"filtercontacts","click [data-close-contact]":"filtercontacts","click [data-streams]":"filterstreams","click .load-more":"more"},initialize:function(a){a.color||(this.options.color=this.color);this.list=a.channel[a.source];for(n in this.list.models)this.listenTo(this.list.models[n],"change",this.render),this.listenTo(this.list.models[n],
"change",this.negotiateFunctionalities),this.list.models[n].count=this.list.models[n].get("count")[a.countString]},render:function(){var a={list:[]};$.extend(a,this.options);this.list.comparator=function(a,c){return c.count-a.count};this.list.sort();this.list.each(function(b){var c=b.attributes;a.list.push({name:c.name,url:a.link?a.link:"#"+a.type+"/"+a.channel.id+"/"+b.id,count:b.count,icon:c.network?c.network.icon:a.icon})});this.$el.html(Mustache.render(Templates.messagescounters,a));return this},
negotiateFunctionalities:function(){this.$el.find(".scroller").length&&this.addScroll();this.options.counter&&this.appendCounter();"undefined"!=typeof this.options.open&&this.appendCollapseble(this.options.open)}});Cloudwalkers.Views.Widgets.CombinedStatistics=Cloudwalkers.Views.Widgets.Widget.extend({size:"full",currentReport:null,element:null,render:function(){function a(a){e.find('[data-report-id="'+a.get("uniqueid")+'"]').click(function(){c.setReport(a)})}function b(a){e.find('[data-interval-id="'+a.token+'"]').click(function(){e.find(".interval-value").html(a.name);var b=1;"day"==a.token?b=11:"7days"==a.token?b=77:"28days"==a.token&&(b=308);for(var d=new Date,d=new Date(d.getFullYear(),d.getMonth(),d.getDate()+
1),b=new Date(d.getTime()-864E5*b),f=0;f<c.options.reports.length;f++)c.options.reports[f].intervalinput=a.token,c.options.reports[f].daterange=[b,d],c.options.reports[f].refresh();c.currentReport&&c.currentReport.getDataset().refresh()})}var c=this,d={},e=this.$el;this.element=e;d.reports=[];d.stream=this.options.stream;for(var f=0;f<this.options.reports.length;f++)d.reports.push(this.options.reports[f].attributes);d.intervals=[{name:"Days",token:"day"},{name:"7 days",token:"7days"},{name:"28 days",
token:"28days"}];e.html(Mustache.render(Templates.combinedstatistics,d));for(f=0;f<this.options.reports.length;f++)a(this.options.reports[f]);for(f=0;f<d.intervals.length;f++)b(d.intervals[f]);e.find('[data-interval-id="'+d.intervals[0].token+'"]').click();0<this.options.reports.length?this.setReport(this.options.reports[0]):(this.$el.find(".statistic-container").html("<p>There is currently no information available.</p>"),this.$el.find(".statistic-title").html("Combined statistics"),this.$el.find(".statistic-description").html(""));
return this},setReport:function(a){this.element.find(".report-value").html(a.get("name"));this.currentReport=a;var b=$("<div></div>");this.$el.find(".statistic-container").html(b);this.$el.find(".statistic-title").html(a.get("name"));this.$el.find(".statistic-description").html(a.get("description"));a.getWidget().innerRender(b)}});Cloudwalkers.Views.Widgets.Report=Cloudwalkers.Views.Widgets.Widget.extend({template:"report",initialize:function(){this.stream=this.options.stream},render:function(){this.$el.html(Mustache.render(Templates[this.template],{network:this.stream.get("network")}));this.$el.find(".dashboard-stat").addClass("portlet-loading");this.stream.reports.hook({success:this.fill.bind(this),error:this.fail});return this},fill:function(){var a=this.stream.reports.findWhere({uniqueid:this.options.type});if(!a)return null;
a={dashboard:this.options.dashboard,streamid:this.stream.id,network:this.stream.get("network"),details:a.getDetails()};this.$el.html(Mustache.render(Templates[this.template],a));this.trigger("content:change")},fail:function(){Cloudwalkers.RootView.growl("Oops","Something went sideways, please reload the page.")}});Cloudwalkers.Views.Widgets.Charts.Linechart=Cloudwalkers.Views.Widgets.Widget.extend({title:"Line chart",placeholder:null,icon:"reorder",size:6,element:null,getDataset:function(){return this.options.model},initialize:function(){var a=this;this.options.model.on("dataset:change",function(b){a.plot(b[0].values)})},innerRender:function(a){this.element=a;var b=this;this.placeholder=$('<div class="chart" style="position: relative;"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)})},
showTooltip:function(a,b,c){$('<div id="tooltip">'+c+"</div>").css({position:"absolute",display:"none",top:b+5,left:a+15,border:"1px solid #333",padding:"4px",color:"#fff","border-radius":"3px","background-color":"#333",opacity:0.8}).appendTo(this.element).fadeIn(200)},plot:function(a){var b=this;$.plot(this.placeholder,[a],{xaxis:{mode:"time"},yaxis:{tickDecimals:0},series:{lines:{show:!0,lineWidth:2,fill:!0,fillColor:{colors:[{opacity:0.05},{opacity:0.01}]}},points:{show:!0},shadowSize:2},grid:{hoverable:!0,
clickable:!0,tickColor:"#eee",borderWidth:0},colors:["#d12610","#37b7f3","#52e136"]});var c=null;this.placeholder.bind("plothover",function(a,e,f){$("#x").text(e.x.toFixed(2));$("#y").text(e.y.toFixed(2));f?c!=f.dataIndex&&(c=f.dataIndex,$("#tooltip").remove(),a=f.datapoint[0],e=f.datapoint[1],a=(new Date(a)).toLocaleDateString(),b.showTooltip(f.pageX,f.pageY,a+": "+e)):($("#tooltip").remove(),c=null)})}});Cloudwalkers.Views.Widgets.Charts.Intervalchart=Cloudwalkers.Views.Widgets.Widget.extend({title:"Bar chart",placeholder:null,icon:"reorder",size:6,getDataset:function(){return this.options.model},innerRender:function(a){var b=this;this.placeholder=$('<div class="chart" style="position: relative;"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)});this.options.model.on("dataset:change",function(a){b.plot(a[0].values)})},numberOutput:function(a){return 0<=
a?"+ "+a:"- "+Math.abs(a)},plot:function(a){if(a){var b=[],c=[],d=[],e,f=0;for(10<a.length&&(f=1);10>a.length;)a.unshift([null,0]);for(;f<a.length;f++)null!=a[f][0]?(e=new Date(a[f][0]),e=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear()):e="",b.push([f,e]),a[f][0]=f,0==f?(c.push([f,a[f][1]]),d.push([f,0])):a[f-1][1]<=a[f][1]?(c.push([f,a[f-1][1]]),d.push([f,a[f][1]-a[f-1][1]])):(c.push([f,a[f][1]]),d.push([f,0]));b=$.plot(this.placeholder,[c,d],{xaxis:{ticks:b},yaxis:{tickDecimals:0,min:0},series:{stack:!0,
shadowSize:2,bars:{show:!0,align:"center",barWidth:0.8,fill:0.78,lineWidth:1}},grid:{borderWidth:0},colors:["#2bbedc","#ffb848","#852b99","#e02222","#ffe399"]});for(f=0;f<a.length;f++)0<f&&(a[f][1]=parseInt(a[f][1]),0<a[f][1]&&0<a[f-1][1]&&(d=(a[f][1]-a[f-1][1])/Math.max(1,a[f-1][1]),d*=100,d=Math.floor(d),d=this.numberOutput(d)+"%",c=b.pointOffset({x:a[f][0],y:a[f][1]}),this.placeholder.append('<div style="background: white; position: absolute; left: '+(c.left-30)+"px; top: "+(c.top-25)+'px; width: 60px; text-align: center;">'+
d+"</div>")))}}});Cloudwalkers.Views.Widgets.Charts.Numberstat=Cloudwalkers.Views.Widgets.Widget.extend({title:"Number stat",icon:"reorder",color:null,network:null,template:"dashboardstat",size:3,showLink:!0,showStreamName:!0,getDataset:function(){return this.options.model},render:function(){var a=this.$el,b=this;this.color&&(this.options.color=this.color);this.network&&(this.options.network=this.network);this.dashboard&&(this.options.dashboard=this.dashboard);this.showLink&&(this.options.showLink=this.showLink);this.showStreamName&&
(this.options.showStreamName=this.showStreamName);a.html(Mustache.render(Templates[this.template],this.options));this.options.model.getValues(function(a){b.setValue(a)});this.options.model.on("dataset:change",function(a){b.setValue(a[0].values)});return this},numberOutput:function(a,b){"undefined"==typeof b&&(b=!1);return 0>a?"- "+Math.abs(a):b?"+ "+Math.abs(a):a},setValue:function(a){var b=this.$el,c=this.options.model.getDisplay(),d={};$.extend(!0,d,this.options);var e=this.options.model.getInterval();
d.details=[];d.footer="&nbsp;";d.report=this.options.report.attributes;a&&0<a.length?"comparison"==c?(c=this.numberOutput(a[0][1]),1<a.length?(d.footer="<strong>"+this.numberOutput(a[0][1]-a[1][1],!0)+"</strong> (",d.footer+=this.numberOutput(Math.round(100*this.options.model.getEvolution()),!0)+"%) Since last "+e):d.footer="Last "+e,a=this.options.showStreamName?"Foo "+d.title:d.title,d.details.push({content:c,descr:a})):this.$el.find(".number").html(this.numberOutput(a[a.length-1][1])):d.details.push({content:"\u2639",
descr:"No info"});this.trigger("content:change");b.html(Mustache.render(Templates[this.template],d));b.find(".portlet-loading").toggleClass("portlet-loading")}});Cloudwalkers.Views.Widgets.Charts.Textstat=Cloudwalkers.Views.Widgets.Widget.extend({title:"Line chart",icon:"reorder",color:null,network:null,template:"dashboardstat",size:3,getDataset:function(){return this.options.model},render:function(){var a=this.$el,b=this;this.color&&(this.options.color=this.color);this.network&&(this.options.network=this.network);this.options.footer="&nbsp;";a.html(Mustache.render(Templates[this.template],this.options));this.options.model.getValues(function(a){b.setValue(a)});
this.options.model.on("dataset:change",function(a){b.setValue(a[0].values)});return this},setValue:function(a){var b=this.$el,c={};$.extend(!0,c,this.options);c.footer="<strong>"+this.options.stream.customname+"</strong> "+this.options.title;c.details=[];a&&0<a.length?c.details.push({content:a[0][1],descr:a[0][0]}):c.details.push({content:"\u2639",descr:"No info"});b.html(Mustache.render(Templates[this.template],c));b.find(".portlet-loading").toggleClass("portlet-loading")}});Cloudwalkers.Views.Widgets.Charts.Comparison=Cloudwalkers.Views.Widgets.Charts.Numberstat.extend({template:"dashboardstat"});Cloudwalkers.Views.Widgets.Charts.Barchart=Cloudwalkers.Views.Widgets.Widget.extend({title:"Bar chart",placeholder:null,icon:"reorder",size:6,getDataset:function(){return this.options.model},innerRender:function(a){var b=this;this.placeholder=$('<div class="chart" style="position: relative;"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)});this.options.model.on("dataset:change",function(a){b.plot(a[0].values)})},plot:function(a){if(a){for(var b=[],
c=0;c<a.length;c++)b.push([c,a[c][0]]),a[c][0]=c;$.plot(this.placeholder,[a],{xaxis:{ticks:b},yaxis:{tickDecimals:0},bars:{show:!0,align:"center",fill:0.78,lineWidth:1},colors:["#2bbedc","#ffb848","#852b99","#e02222","#ffe399"]})}}});Cloudwalkers.Views.Widgets.Charts.Piechart=Cloudwalkers.Views.Widgets.Widget.extend({title:"Pie chart",placeholder:null,icon:"reorder",size:6,maxSlices:10,getDataset:function(){return this.options.model},innerRender:function(a){var b=this;this.placeholder=$('<div class="chart" style="position: relative;"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)});this.options.model.on("dataset:change",function(a){b.plot(a[0].values)})},plot:function(a){if(0==
a.length)this.placeholder.html("<p>At this time there is no information available.</p>");else{a.sort(function(a,b){return b[1]-a[1]});var b=0;if(a.length>this.maxSlices){for(;a.length>this.maxSlices-1;)b+=a.pop()[1];a.push(["Other",b])}for(var b=[],c=0;c<a.length;c++)b.push({label:a[c][0],data:a[c][1]});$.plot(this.placeholder,b,{series:{pie:{show:!0}},colors:"#2bbedc #ffb848 #852b99 #e02222 #ffe399 #AFD8F8 #A23C3C #4DA74D #BD9B33 #8CACC6".split(" ")})}}});Cloudwalkers.Views.Widgets.Charts.Table=Cloudwalkers.Views.Widgets.Widget.extend({title:"Line chart",placeholder:null,size:"full",icon:"reorder",getDataset:function(){return this.options.model},innerRender:function(a){var b=this;this.placeholder=$('<div class="table-container"></div>');a.html("");a.append(this.placeholder);this.options.model.getValues(function(a){b.plot(a)});this.options.model.on("dataset:change",function(a){b.plot(a[0].values)})},plot:function(a){for(var b={header:[]},c=[],d=0;d<
a.header.length;d++)b.header.push({name:a.header[d],"class":"undefined"!=typeof a.classes[d]?a.classes[d]:null}),c.push({sSortDataType:"dom-text"});b.rows=[];for(d=0;d<a.rows.length;d++){for(var c=[],e=0;e<a.rows[d].length;e++)c.push({value:a.rows[d][e],"class":"undefined"!=typeof a.classes[e]?a.classes[e]:null});b.rows.push({columns:c})}this.placeholder.html(Mustache.render(Templates.charttable,b))}});Cloudwalkers.Views.Loading=Backbone.View.extend({render:function(){$(this.el).html(Mustache.render(Templates.loading,{}));return this}});Cloudwalkers.Views.Error=Backbone.View.extend({render:function(){var a={};a.error=this.options.error;$(this.el).html(Mustache.render(Templates.error,a));return this}});Cloudwalkers.Views.OriginalMessage=Cloudwalkers.Views.Message.extend({template:"originalmessage",className:"originalmessage-view",tagName:"div",childrencontainer:"original-comment-container",events:{"click .original-message-action.action":"messageAction","click .original-message-children":"showchildren"}});Cloudwalkers.Views.ActionParameters=Backbone.View.extend({events:{"submit form":"submit"},render:function(){this.$el.html(Templates["action-parameters"]);var a=this.options.action,b=this.options.message,c={};c.action=a;c.title=a.name;c.input={};jQuery.each(a.parameters,function(a,e){"undefined"==typeof c.input[e.type]&&(c.input[e.type]=[]);""!=e.value&&(e.value=Cloudwalkers.Utilities.Parser.parseFromMessage(e.value,b));c.input[e.type]=e});this.$el.html(Mustache.render(Templates["action-parameters"],
c));return this},submit:function(a){a.preventDefault();var b={};a=$(a.currentTarget).serializeArray();for(var c=0;c<a.length;c++)b[a[c].name]=a[c].value;this.options.message.act(this.options.action,b);this.trigger("popup:close")}});Cloudwalkers.Views.Widgets.Title=Backbone.View.extend({size:"full",render:function(){this.$el.html('<h3 style="margin-bottom: 25px;">'+this.options.title+"</h3>");return this},negotiateFunctionalities:function(){}});Cloudwalkers.Views.Settings.Services=Backbone.View.extend({events:{"click [data-open-service]":"openService","click [data-add-service]":"addServiceCall"},render:function(){var a=Cloudwalkers.Session.getAccount();this.$el.html(Mustache.render(Templates.settings.services,{}));Cloudwalkers.Net.get("wizard/service/available",{account:a.id},this.appendOptions.bind(this));Cloudwalkers.Net.get("wizard/service/list",{account:a.id},this.appendConnected.bind(this));return this},appendOptions:function(a){var b=
this.$el.find("#service-options .portlet-body").removeClass("inner-loading");for(n in a.services)b.append(Mustache.render(Templates.settings.service_option,a.services[n]))},appendConnected:function(a){var b=this.$el.find("#service-connected .inner-loading").removeClass("inner-loading"),c=0;for(n in a.services)b.find(".social-container").append(Mustache.render(Templates.settings.service_connected,a.services[n])),c++;Cloudwalkers.Session.getAccount().monitorlimit("networks",c,$(".service-options"))},
addService:function(a,b){Cloudwalkers.Net.post("wizard/service/add",{account:Cloudwalkers.Session.getAccount().get("id")},{id:a},b)},openService:function(a){a.preventDefault();var b=$(a.target).attr("data-open-service"),c=this;a=c.$el.find("[data-service-container="+b+"]");a.is(":visible")?a.hide():(b=new Cloudwalkers.Views.Settings.Service({serviceid:b}),a.show(),a.html(b.render().el),b.on("service:delete",function(){c.render()}))},processLink:function(a){return a=0<a.indexOf("?")?a+"&return="+encodeURIComponent(window.location):
a+"?return="+encodeURIComponent(window.location)},addServiceCall:function(a){a.preventDefault();var b=this;a=$(a.target).attr("data-add-service");this.addService(a,function(a){"undefined"!=typeof a.error?Cloudwalkers.RootView.alert(a.error.message):($.each(a.service.settings,function(a,c){if("link"==c.type){var f=b.processLink(c.url);window.location=f}}),b.render())})},negotiateFunctionalities:function(a){}});Cloudwalkers.Views.Settings.Service=Backbone.View.extend({events:{"submit form":"submit","click [data-delete]":"deleteServiceClick","click [data-stream-details-id]":"streamDetailView"},service:null,render:function(){var a=this;a.getServiceData(this.options.serviceid,function(b){a.$el.closest(".inner-loading").removeClass("inner-loading");a.service=b.service;for(var c={},d=0;d<b.service.settings.length;d++)"undefined"==typeof c[b.service.settings[d].type]&&(c[b.service.settings[d].type]=[]),c[b.service.settings[d].type].push(b.service.settings[d]);
b.service.groupedsettings=c;a.setStreamChannels(b.service);a.$el.html(Mustache.render(Templates.settings.service,b.service,{service_channel:Templates.settings.service_channel,service_stream:Templates.settings.service_stream}))});return this},processSettings:function(a){var b=this;$.each(a,function(c,d){"link"==d.type&&(a[c].url=b.processLink(d.url))})},processLink:function(a){return a=0<a.indexOf("?")?a+"&return="+encodeURIComponent(window.location):a+"?return="+encodeURIComponent(window.location)},
getServiceData:function(a,b){var c=this;Cloudwalkers.Net.get("wizard/service/"+a,{account:Cloudwalkers.Session.getAccount().get("id")},function(a){c.processSettings(a.service.settings);b(a)})},storeServiceData:function(a,b,c){Cloudwalkers.Net.put("wizard/service/"+a,{account:Cloudwalkers.Session.getAccount().get("id")},b,c)},deleteService:function(a,b){Cloudwalkers.Net.remove("wizard/service/"+a,{account:Cloudwalkers.Session.getAccount().get("id")},b)},setStreamChannels:function(a){function b(a,b){var c=
[];b.each(function(b){if(!b.get("parent")&&b.get("name")){for(var d=!1,e=0;e<a.channels.length;e++)if(a.channels[e]==b.get("id")){d=!0;break}d={channel:b.attributes,selected:d,channels:[]};b.attributes&&b.get("channels");c.push(d)}});return c}function c(a){for(var b={string:[],"boolean":[]},c=0;c<a.settings.length;c++)"undefined"==typeof b[a.settings[c].type]&&(b[a.settings[c].type]=[]),b[a.settings[c].type].push(a.settings[c]);a.groupedsettings=b}function d(f){var g=[];$.each(a.streams,function(a,
k){"undefined"!=typeof k.parent&&k.parent.id==f.id&&(c(k),g.push({parsedchannels:b(k,e),stream:k,substreams:d(k)}))});return g}var e=Cloudwalkers.Session.getChannels();a.parsedstreams=function(){for(var f=[],g=0;g<a.streams.length;g++)a.streams[g].canSetChannels&&"undefined"==typeof a.streams[g].parent&&(c(a.streams[g]),f.push({parsedchannels:b(a.streams[g],e),stream:a.streams[g],substreams:d(a.streams[g])}));return f}()},submit:function(a){var b=this;a.preventDefault();var c=$(a.target),d={streams:{}};
c.find("[data-channel-setting]").each(function(a,b){"checkbox"==$(b).attr("type")?d[$(b).attr("name")]=$(b).is(":checked"):d[$(b).attr("name")]=$(b).val()});$.each(this.service.streams,function(a,b){var g=[];c.find("[data-stream-id="+b.id+"][data-channel-id]:checked").each(function(a,b){g.push($(b).attr("data-channel-id"))});d.streams[b.id]={channels:g};c.find("[data-stream-setting="+b.id+"]").each(function(a,c){"checkbox"==$(c).attr("type")?d.streams[b.id][$(c).attr("name")]=$(c).is(":checked"):
d.streams[b.id][$(c).attr("name")]=$(c).val()})});this.storeServiceData(this.service.id,d,function(){b.render()})},deleteServiceClick:function(a){a.preventDefault();var b=this;Cloudwalkers.RootView.confirm("Are you sure you want to remove this service? All statistics will be lost.",function(){b.deleteService(b.service.id,function(){b.trigger("service:delete")})})},streamDetailView:function(a){a.preventDefault();a=$(a.target).attr("data-stream-details-id");a=new Cloudwalkers.Views.Settings.StreamSettings({streamid:a});
Cloudwalkers.RootView.popup(a)}});Cloudwalkers.Views.Settings.Users=Backbone.View.extend({events:{"submit .users-invite":"addUser"},"class":"section",collections:[],initialize:function(){},render:function(){var a=Cloudwalkers.Session.getAccount();this.$el.html(Mustache.render(Templates.settings.users,{}));a.users.hook({success:this.fill.bind(this),error:this.fail});this.$el.find(".collapse-closed, .collapse-open").each(this.negotiateFunctionalities);return this},fill:function(a){Cloudwalkers.Session.getAccount().monitorlimit("users",
a.length,$(".invite-user"));var b=this.$el.find(".user-container").eq(-1);a.each(function(a){a=new Cloudwalkers.Views.Settings.User({model:a});b.append(a.render().el)})},addUserContainer:function(a,b){var c=Cloudwalkers.Session.getUser(),d=this,e={};e.title=a;e.user=c.attributes;var f=$(Mustache.render(Templates.settings.users,e));b.on("reset",function(){f.find(".user-container").html("")});b.on("reset:all",function(){for(var a=0;a<d.collections.length;a++)d.collections[a].reset(),d.collections[a].fetch()});
b.on("add",function(a){a=new Cloudwalkers.Views.Settings.User({model:a});f.find(".user-container").append(a.render().el)});f.find(".loading").show();b.fetch({success:function(){f.find(".loading").hide()}});this.$el.append(f)},addUser:function(){var a={email:$("input[name=invite-email]").val()},b="account/"+Cloudwalkers.Session.getAccount().get("id")+"/users";Cloudwalkers.Net.post(b,{},a,function(a){a.error?Cloudwalkers.RootView.growl("Oops","There's something fishy about that e-mail address."):Cloudwalkers.RootView.growl("User Management",
"Invitation on it's way.")})},deleteUser:function(){},negotiateFunctionalities:function(a){$(this).find(".portlet-title").on("click",function(){$(this).parents(".collapse-closed, .collapse-open").toggleClass("collapse-closed collapse-open")})},fail:function(){Cloudwalkers.RootView.growl("Oops","Something went sideways, please reload the page.")}});Cloudwalkers.Views.Settings.User=Backbone.View.extend({tagName:"tr",events:{"click [data-edit-user-id]":"openDetails","click [data-delete-user-id]":"deleteUser"},render:function(){var a={};a.user=this.model.attributes;a.user.role=this.model.getRole();this.$el.html(Mustache.render(Templates.settings.user,a));return this},openDetails:function(){var a=new Cloudwalkers.Views.Settings.UserDetails({model:this.model});$(".manage-users-edit-widget .portlet-body").html(a.render().el)},deleteUser:function(a){var b=
this,c=$(a.currentTarget).parents("tr");Cloudwalkers.RootView.confirm("You are about to remove "+this.model.get("firstname")+". Sure?",function(){c.remove();var a="account/"+Cloudwalkers.Session.getAccount().get("id")+"/users/"+b.model.get("id");Cloudwalkers.Net.remove(a,{},function(){Cloudwalkers.RootView.growl("Manage Users","That's an ex-user.")})})}});Cloudwalkers.Views.Settings.UserDetails=Backbone.View.extend({events:{"submit form.edit-managed-user":"submit"},render:function(){var a={},b=Number(this.model.get("level")),c=[{level:0,name:"Co-Workers"},{level:10,name:"Administrators"}];c[b?1:0].checked=!0;a.user=this.model.attributes;a.title=a.user.name;a.levels=[];for(b=0;b<c.length;b++){var d=c[b];d.checked=this.model.get("level")==c[b].level;a.levels.push(d)}this.$el.html(Mustache.render(Templates.settings.userdetails,a));return this},submit:function(a){a=
{level:$("#level").val()};var b="account/"+Cloudwalkers.Session.getAccount().get("id")+"/users/"+this.model.get("id");Cloudwalkers.Net.put(b,{},a,function(){Cloudwalkers.RootView.growl("Manage Users","The user clearance is updated.")})}});Cloudwalkers.Views.Settings.Profile=Backbone.View.extend({events:{"click .add-user":"addUser","submit .edit-user-profile":"editUserProfile","submit .edit-user-password":"editUserPassword","submit .edit-user-avatar":"editUserAvatar","click .invite-user":"addUser"},"class":"section",collections:[],render:function(){var a=Cloudwalkers.Session.getUser(),b=this,a={user:{firstname:a.get("firstname"),name:a.get("name"),avatar:a.get("avatar")}};this.$el.html(Mustache.render(Templates.settings.profile,a));
this.$el.find(".collapse-closed, .collapse-open").each(function(){b.negotiateFunctionalities(this)});return this},editUserProfile:function(a){a=Cloudwalkers.Session.getUser();var b=this.$el.find("[name=firstname]").val(),c=this.$el.find("[name=name]").val();a.set("firstname",b);a.set("name",c);a.saveProfile(function(){Cloudwalkers.RootView.growl("User Profile","Your profile settings are updated")})},editUserAvatar:function(){var a=$("form.edit-user-avatar input[type=file]").get(0).files;if(a[0]){var b=
new FileReader;b.onload=function(a){var b=Cloudwalkers.Session.getUser(),e=a.target.result;b.set("avatarBase64",e);b.saveProfile(function(){Cloudwalkers.RootView.growl("User Profile","You have a brand new avatar now.");$(".avatar-big").css("background-image","url("+e+")")})};b.readAsDataURL(a[0])}},editUserPassword:function(){if(this.$el.find("[name=pass1]").val()!=this.$el.find("[name=pass2]").val())return Cloudwalkers.RootView.growl("Oops","Please re-type your new password."),null;var a=Cloudwalkers.Session.getUser();
this.$el.find("[name=firstname]").val();this.$el.find("[name=name]").val();a.savePassword(this.$el.find("[name=pass0]").val(),this.$el.find("[name=pass1]").val(),function(a){a.error?Cloudwalkers.RootView.growl("Oops","That's not correct."):Cloudwalkers.RootView.growl("User Profile","You have a new password now.")})},negotiateFunctionalities:function(a){$(a).find(".portlet-title").on("click",function(){$(this).parents(".collapse-closed, .collapse-open").toggleClass("collapse-closed collapse-open")})}});Cloudwalkers.Views.Settings.Account=Backbone.View.extend({events:{"submit .edit-account":"editAccount","click i[data-delete-campaign-id]":"deleteCampaign"},render:function(){var a=Cloudwalkers.Session.getAccount().attributes;this.$el.html(Mustache.render(Templates.settings.account,a));return this},editAccount:function(a){a=Cloudwalkers.Session.getAccount();var b=this.$el.find("[name=name]").val();a.set("name",b);a.save(function(){Cloudwalkers.RootView.growl("Account settings","Your account settings are updated")})},
deleteCampaign:function(a){Cloudwalkers.Session.getAccount().campaigns.get($(a.target).attr("data-delete-campaign-id")).destroy({success:function(){this.closest("li").remove()}.bind($(a.target))})},negotiateFunctionalities:function(a){this.$el.find(".portlet-title").on("click",function(){$(this).parents(".collapse-closed, .collapse-open").toggleClass("collapse-closed collapse-open")})}});Cloudwalkers.Views.Settings.StreamSettings=Backbone.View.extend({events:{"submit form":"submit"},streamid:null,render:function(){var a=this;this.streamid=this.options.streamid;a.$el.html("<p>Please wait, loading data.</p>");a.getStreamSettings(function(b){var c={};c.events=JSON.stringify(b.events);a.$el.html(Mustache.render(Templates.settings.streamsettings,c))});return this},getStreamSettings:function(a){Cloudwalkers.Net.get("stream/"+this.streamid+"/events",null,a)},setStreamSettings:function(a,
b){Cloudwalkers.Net.put("stream/"+this.streamid+"/events",null,a,b)},submit:function(a){var b=this;a.preventDefault();a=JSON.parse(this.$el.find('[name="events"]').val());this.setStreamSettings({events:a},function(a){"undefined"!=typeof a.error?Cloudwalkers.RootView.alert(a.error.message):b.trigger("popup:close")})}});
